{"pageProps":{"postData":{"id":["2023","aws_from_scratch_apply_before_merge"],"path":"2023/aws_from_scratch_apply_before_merge","contentHtml":"<p>Following this article will get you setup with an AWS Root account that can be\nmanaged through through Terraform Cloud with OIDC and github actions. As a best practice you\nshould not keep long-lived access keys in your CI/CD pipelines when\ndeploying to AWS, instead you should use OIDC (OpenID Connect) to securely\ndeploy to AWS when using Terraform Cloud or Github Actions.</p>\n<iframe width=\"854\" height=\"480\" src=\"https://www.youtube.com/embed/3oZd1m8_KIo\" title=\"AWS From Scratch - Preparing your account to be managed by IaC via Terraform and Github Actions\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;web-share\" allowfullscreen></iframe>\n<h1>TL;DR</h1>\n<p>Download all the terraform from the blog post here:</p>\n<ul>\n<li><a href=\"https://github.com/sontek/aws-apply-before-merge\">https://github.com/sontek/aws-apply-before-merge</a></li>\n<li><a href=\"https://github.com/sontek/aws-terraform-github-actions\">https://github.com/sontek/aws-terraform-github-actions</a></li>\n</ul>\n<h1>How does OIDC work</h1>\n<p>OIDC enables us to request a short-lived access token directly from AWS. We\njust have to create trust relationship that controls which workflows are able\nto request the access tokens.</p>\n<ul>\n<li>No need to duplicate AWS credentials as long-lived GitHub secrets.</li>\n<li>Since we are using a short-lived access token that is only valid for a single\njob there is no reason to worry about rotating secrets.</li>\n</ul>\n<p>The following diagram gives an overview of how we can use Terraform Cloud's\nOIDC provider to integrate with AWS:</p>\n<div class=\"remark-mermaid remark-mermaid-default\"><svg aria-roledescription=\"flowchart-v2\" role=\"graphics-document document\" viewBox=\"-8 -8 843.078125 320\" style=\"max-width: 843.078px; background-color: transparent;\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"mermaid-1689994130347\"><style>#mermaid-1689994130347{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1689994130347 .error-icon{fill:#552222;}#mermaid-1689994130347 .error-text{fill:#552222;stroke:#552222;}#mermaid-1689994130347 .edge-thickness-normal{stroke-width:2px;}#mermaid-1689994130347 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1689994130347 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1689994130347 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1689994130347 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1689994130347 .marker{fill:#333333;stroke:#333333;}#mermaid-1689994130347 .marker.cross{stroke:#333333;}#mermaid-1689994130347 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1689994130347 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-1689994130347 .cluster-label text{fill:#333;}#mermaid-1689994130347 .cluster-label span{color:#333;}#mermaid-1689994130347 .label text,#mermaid-1689994130347 span{fill:#333;color:#333;}#mermaid-1689994130347 .node rect,#mermaid-1689994130347 .node circle,#mermaid-1689994130347 .node ellipse,#mermaid-1689994130347 .node polygon,#mermaid-1689994130347 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1689994130347 .node .label{text-align:center;}#mermaid-1689994130347 .node.clickable{cursor:pointer;}#mermaid-1689994130347 .arrowheadPath{fill:#333333;}#mermaid-1689994130347 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1689994130347 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1689994130347 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1689994130347 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1689994130347 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1689994130347 .cluster text{fill:#333;}#mermaid-1689994130347 .cluster span{color:#333;}#mermaid-1689994130347 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1689994130347 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1689994130347 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g><marker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"10\" viewBox=\"0 0 12 20\" class=\"marker flowchart\" id=\"flowchart-pointEnd\"><path style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"></path></marker><marker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"0\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointStart\"><path style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"></path></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleEnd\"><circle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"></circle></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleStart\"><circle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"></circle></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossEnd\"><path style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"></path></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossStart\"><path style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"></path></marker><g class=\"root\"><g class=\"clusters\"></g><g class=\"edgePaths\"><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token\" id=\"L-AWS-Token-0\" d=\"M185.671875,134.5L181.50520833333334,134.5C177.33854166666666,134.5,169.00520833333334,134.5,152.378260969764,145.875C135.75131360619469,157.25,110.83075221238937,180,98.37047151548673,191.375L85.91019081858407,202.75\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform\" id=\"L-Token-Terraform-0\" d=\"M85.91019081858407,235.75L98.37047151548673,247.125C110.83075221238937,258.5,135.75131360619469,281.25,164.46289638643069,292.625C193.17447916666666,304,225.67708333333334,304,258.1796875,304C290.6822916666667,304,323.1848958333333,304,359.3528645833333,304C395.5208333333333,304,435.3541666666667,304,475.1875,304C515.0208333333334,304,554.8541666666666,304,585.6956312991642,296.7916666666667C616.5370959316618,289.5833333333333,638.3866918633236,275.1666666666667,649.3114898291544,267.9583333333333L660.2362877949853,260.75\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT\" id=\"L-Terraform-JWT-0\" d=\"M660.2362877949853,177.75L649.3114898291544,170.54166666666666C638.3866918633236,163.33333333333334,616.5370959316618,148.91666666666666,601.4456312991642,141.70833333333334C586.3541666666666,134.5,578.0208333333334,134.5,573.8541666666666,134.5L569.6875,134.5\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS\" id=\"L-JWT-AWS-0\" d=\"M380.6875,134.5L376.5208333333333,134.5C372.3541666666667,134.5,364.0208333333333,134.5,355.6875,134.5C347.3541666666667,134.5,339.0208333333333,134.5,334.8541666666667,134.5L330.6875,134.5\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\"><g transform=\"translate(0, 0)\" class=\"label\"><foreignObject height=\"0\" width=\"0\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g transform=\"translate(0, 0)\" class=\"label\"><foreignObject height=\"0\" width=\"0\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g transform=\"translate(0, 0)\" class=\"label\"><foreignObject height=\"0\" width=\"0\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g transform=\"translate(0, 0)\" class=\"label\"><foreignObject height=\"0\" width=\"0\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g></g><g class=\"nodes\"><g transform=\"translate(621.1171875, 169.75)\" class=\"root\"><g class=\"clusters\"><g id=\"Terraform\" class=\"cluster default\"><rect height=\"83\" width=\"206.890625\" y=\"8\" x=\"-0.9296875\" ry=\"0\" rx=\"0\" style=\"\"></rect><g transform=\"translate(-0.9296875, 8)\" class=\"cluster-label\"><foreignObject height=\"18\" width=\"206.890625\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Terraform Cloud Workflow #2</span></div></foreignObject></g></g></g><g class=\"edgePaths\"></g><g class=\"edgeLabels\"></g><g class=\"nodes\"><g transform=\"translate(102.515625, 49.5)\" id=\"flowchart-OIDCProvider-23\" class=\"node default default\"><rect height=\"33\" width=\"119.03125\" y=\"-16.5\" x=\"-59.515625\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-52.015625, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"104.03125\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">OIDC Provider</span></div></foreignObject></g></g></g></g><g transform=\"translate(178.171875, -8)\" class=\"root\"><g class=\"clusters\"><g id=\"AWS\" class=\"cluster default\"><rect height=\"269\" width=\"145.015625\" y=\"8\" x=\"8\" ry=\"0\" rx=\"0\" style=\"\"></rect><g transform=\"translate(51.4609375, 8)\" class=\"cluster-label\"><foreignObject height=\"18\" width=\"58.09375\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">AWS #1</span></div></foreignObject></g></g></g><g class=\"edgePaths\"></g><g class=\"edgeLabels\"></g><g class=\"nodes\"><g transform=\"translate(80.5078125, 59.5)\" id=\"flowchart-OIDC-20\" class=\"node default default\"><rect height=\"33\" width=\"95.015625\" y=\"-16.5\" x=\"-47.5078125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-40.0078125, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"80.015625\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">OIDC Trust</span></div></foreignObject></g></g><g transform=\"translate(80.5078125, 142.5)\" id=\"flowchart-Roles-21\" class=\"node default default\"><rect height=\"33\" width=\"55.90625\" y=\"-16.5\" x=\"-27.953125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-20.453125, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"40.90625\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Roles</span></div></foreignObject></g></g><g transform=\"translate(80.5078125, 225.5)\" id=\"flowchart-Resources-22\" class=\"node default default\"><rect height=\"33\" width=\"91.484375\" y=\"-16.5\" x=\"-45.7421875\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-38.2421875, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"76.484375\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Resources</span></div></foreignObject></g></g></g></g><g transform=\"translate(67.8359375, 219.25)\" id=\"flowchart-Token-25\" class=\"node default default\"><rect height=\"33\" width=\"135.671875\" y=\"-16.5\" x=\"-67.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-60.3359375, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"120.671875\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Access Token #4</span></div></foreignObject></g></g><g transform=\"translate(475.1875, 134.5)\" id=\"flowchart-JWT-28\" class=\"node default default\"><rect height=\"33\" width=\"189\" y=\"-16.5\" x=\"-94.5\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-87, -9)\" style=\"\" class=\"label\"><foreignObject height=\"18\" width=\"174\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">JWT &#x26; Cloud Role ID #3</span></div></foreignObject></g></g></g></g></g></svg></div>\n<ol>\n<li>In AWS, create an OIDC trust between a role and our terraform cloud\nworkflow(s) that need access to the cloud.</li>\n<li>Every time a job runs, TFC's OIDC Provider auto-generates an OIDC token.\nThis token contains multiple claims to establish a security-hardened and\nverifiable identity about the specific workflow that is trying to authenticate.</li>\n<li>Request this token from TFC's OIDC provider, and present it to AWS</li>\n<li>Once AWS successfully validates the claims presented in the token, it then\nprovides a short-lived cloud access token that is available only for the duration\nof the job.</li>\n</ol>\n<h1>What does this post accomplish</h1>\n<ul>\n<li>Setup a root AWS account that is managed througuh terraform</li>\n<li>Setup OIDC authentication with Terraform Cloud so it can talk to AWS</li>\n<li>Setup Github Actions authentication with Terraform Cloud so we can run plan\nand apply through the CI/CD pipeline.</li>\n</ul>\n<h1>Setup AWS Access</h1>\n<p>It is very bad practice to use the root account for much of anything but for\nbootstrapping the account it is necessary, so the first step is to get your\n<code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></p>\n<p>To do this click your account and choose <code>Security Credentials</code> in the top\nright:</p>\n<center>\n<img src=\"/images/posts/aws_root_account/security_credentials.png\" height=\"200\">\n</center>\n<p>Then choose <code>Create Access key</code>:</p>\n<center>\n<img src=\"/images/posts/aws_root_account/create_access_token.png\" width=\"200\">\n</center>\n<p>You need to set these environment variables in your shell so that your local\nshell has access to AWS. After you set them you can verify you set them correct\nby running:</p>\n<pre><code class=\"hljs language-bash\">❯ aws sts get-caller-identity\n</code></pre>\n<p>and you should get a result similar to:</p>\n<pre><code class=\"hljs language-json\"><span class=\"hljs-punctuation\">{</span>\n    <span class=\"hljs-attr\">\"UserId\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"777777777777\"</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"Account\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"888888888888\"</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"Arn\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"arn:aws:iam::888888888888:root\"</span>\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<h2>Bootstrap</h2>\n<p>Before you can manage any of your accounts through Terraform Cloud you'll need\nbootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate\nsecurely and manage AWS Resources on your behalf.</p>\n<p>I personally prefer doing this in two repositories:</p>\n<ul>\n<li>\n<p><code>infra-bootstrap</code>: This repository does the bare minimum to hook up terraform\ncloud with your AWS account and stores the state in git.  Its the only infra\nthat will not be controlled by your CI/CD pipeline.ccccccug</p>\n</li>\n<li>\n<p><code>infra</code>: The actual repository where all the rest of your AWS resources are\nmanaged.  It will store state in Terraform Cloud and you can introduce a\nCI/CD pipeline for approving changes.</p>\n<p><strong>Note</strong>: This repository will be generated with the terraform code.</p>\n</li>\n</ul>\n<p>After manually creating the git repository <code>infra-boostrap</code> in your Github\naccount We will need 3 providers to bootstrap the account <code>aws</code>, <code>github</code>, and\n<code>tfe</code>.</p>\n<h3>Variables</h3>\n<p>Create a <code>1-variables.tf</code> where we can define the variables we'll need\nfor creating these resources.</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_aws_audience\"</span> {\n  type        = string\n  default     = <span class=\"hljs-string\">\"aws.workload.identity\"</span>\n  description = <span class=\"hljs-string\">\"The audience value to use in run identity tokens\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_hostname\"</span> {\n  type        = string\n  default     = <span class=\"hljs-string\">\"app.terraform.io\"</span>\n  description = <span class=\"hljs-string\">\"The hostname of the TFC or TFE instance you'd like to use with AWS\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_project_name\"</span> {\n  type        = string\n  default     = <span class=\"hljs-string\">\"Default Project\"</span>\n  description = <span class=\"hljs-string\">\"The project under which a workspace will be created\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_organization_name\"</span> {\n  type        = string\n  description = <span class=\"hljs-string\">\"The name of your Terraform Cloud organization\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_organization_owner\"</span> {\n  type        = string\n  description = <span class=\"hljs-string\">\"The owner of the TFC organization\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"tfc_workspaces\"</span> {\n  type        = list(string)\n  description = <span class=\"hljs-string\">\"The list of TFC workspaces\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"github_organization\"</span> {\n  description = <span class=\"hljs-string\">\"The organization the repositories are owned by\"</span>\n  type        = string\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"github_repo_name\"</span> {\n  description = <span class=\"hljs-string\">\"The name of the git reppository we'll create for managing infra\"</span>\n  type        = string\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"github_default_branch\"</span> {\n  description = <span class=\"hljs-string\">\"The default branch to utilize\"</span>\n  type        = string\n  default     = <span class=\"hljs-string\">\"main\"</span>\n}\n\n<span class=\"hljs-keyword\">variable</span> <span class=\"hljs-string\">\"aws_root_account_id\"</span> {\n  description = <span class=\"hljs-string\">\"The AWS root account we want to apply these changes to\"</span>\n  type        = string\n}\n</code></pre>\n<p>We will use these variables in the later modules but they are mostly metadata\naround the terraform and github accounts you'll need to setup manually.</p>\n<h3>Providers</h3>\n<p>Create a file called <code>2-providers.tf</code> and define the providers:</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">terraform</span> {\n  required_providers {\n    tfe = {\n      source  = <span class=\"hljs-string\">\"hashicorp/tfe\"</span>\n      version = <span class=\"hljs-string\">\"0.41.0\"</span>\n    }\n\n    aws = {\n      source  = <span class=\"hljs-string\">\"hashicorp/aws\"</span>\n      version = <span class=\"hljs-string\">\"4.58.0\"</span>\n    }\n\n    github = {\n      source  = <span class=\"hljs-string\">\"integrations/github\"</span>\n      version = <span class=\"hljs-string\">\"5.18.3\"</span>\n    }\n  }\n}\n\n<span class=\"hljs-keyword\">provider</span> <span class=\"hljs-string\">\"aws\"</span> {\n  region = <span class=\"hljs-string\">\"us-east-1\"</span>\n\n  <span class=\"hljs-comment\"># Root account, all other accounts should be provisioned</span>\n  <span class=\"hljs-comment\"># via pull requests</span>\n  allowed_account_ids = [var.aws_root_account_id]\n}\n\n<span class=\"hljs-keyword\">provider</span> <span class=\"hljs-string\">\"github\"</span> {\n  owner = var.github_organization\n}\n</code></pre>\n<p>The key things there are we define <code>allowed_account_ids</code> to prevent us from\nworking against any account that isn't the root and we are using one of the\nvariables we defines earlier.</p>\n<h3>Github</h3>\n<p>We will utilize <code>terraform</code> to create the second git repository where the rest\nof the infrastructure will go. Create a file called <code>3-github.tf</code>:</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"github_repository\"</span> <span class=\"hljs-string\">\"repo\"</span> {\n  name        = var.github_repo_name\n  description = <span class=\"hljs-string\">\"Infrastructure Repository\"</span>\n  visibility  = <span class=\"hljs-string\">\"private\"</span>\n  auto_init   = true\n  has_issues  = true\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"github_branch_default\"</span> <span class=\"hljs-string\">\"default\"</span> {\n  repository = github_repository.repo.name\n  branch     = var.github_default_branch\n}\n\n<span class=\"hljs-keyword\">data</span> <span class=\"hljs-string\">\"tfe_team\"</span> <span class=\"hljs-string\">\"owners\"</span> {\n  name         = <span class=\"hljs-string\">\"owners\"</span>\n  organization = tfe_organization.organization.name\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"tfe_team_token\"</span> <span class=\"hljs-string\">\"github_actions_token\"</span> {\n  team_id = <span class=\"hljs-keyword\">data</span>.tfe_team.owners.id\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"github_actions_secret\"</span> <span class=\"hljs-string\">\"tfe_secret\"</span> {\n  repository      = github_repository.repo.name\n  secret_name     = <span class=\"hljs-string\">\"TFE_TOKEN\"</span>\n  plaintext_value = tfe_team_token.github_actions_token.token\n}\n\n<span class=\"hljs-keyword\">output</span> <span class=\"hljs-string\">\"repository_id\"</span> {\n  value = github_repository.repo.id\n}\n</code></pre>\n<p>This will generate a new repository in your account called <code>infra</code>.</p>\n<p>For the terraform provider to have access to github you need to create a new\npersonal access token with full <code>repo</code> access and set it as an environment\nvariable named <code>GITHUB_TOKEN</code>.</p>\n<h3>Terraform Cloud</h3>\n<p>Now we need to setup dynamic credentials so the terraform cloud agent is\nallowed to take actions on your behalf.   To do this we'll setup an IAM\nrole and an OIDC provider. Create a file called <code>4-tfc.tf</code>:</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"tfe_organization\"</span> <span class=\"hljs-string\">\"organization\"</span> {\n  name  = var.tfc_organization_name\n  email = var.tfc_organization_owner\n}\n\n/* AWS will use this TLS certificate to verify that requests for dynamic\ncredentials come from Terraform Cloud.*/\n<span class=\"hljs-keyword\">data</span> <span class=\"hljs-string\">\"tls_certificate\"</span> <span class=\"hljs-string\">\"tfc_certificate\"</span> {\n  url = <span class=\"hljs-string\">\"https://<span class=\"hljs-variable\">${var.tfc_hostname}</span>\"</span>\n}\n\n/* sets up an OIDC <span class=\"hljs-keyword\">provider</span> in AWS with Terraform Cloud's TLS certificate,\nthe SHA1 fingerprint from the TLS certificate\n*/\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"aws_iam_openid_connect_provider\"</span> <span class=\"hljs-string\">\"tfc_provider\"</span> {\n  url            = <span class=\"hljs-keyword\">data</span>.tls_certificate.tfc_certificate.url\n  client_id_list = [var.tfc_aws_audience]\n  thumbprint_list = [\n    <span class=\"hljs-keyword\">data</span>.tls_certificate.tfc_certificate.certificates[<span class=\"hljs-number\">0</span>].sha1_fingerprint\n  ]\n}\n\n/* Policy to allow TFC to assume the AWS IAM role in our account */\n<span class=\"hljs-keyword\">data</span> <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"assume_role\"</span> {\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n\n    principals {\n      type        = <span class=\"hljs-string\">\"Federated\"</span>\n      identifiers = [aws_iam_openid_connect_provider.tfc_provider.arn]\n    }\n    condition {\n      test     = <span class=\"hljs-string\">\"StringEquals\"</span>\n      <span class=\"hljs-keyword\">variable</span> = <span class=\"hljs-string\">\"<span class=\"hljs-variable\">${var.tfc_hostname}</span>:aud\"</span>\n\n      values = [\n        <span class=\"hljs-string\">\"<span class=\"hljs-variable\">${<span class=\"hljs-meta\">one(aws_iam_openid_connect_provider.tfc_provider.client_id_list)</span>}</span>\"</span>\n      ]\n    }\n\n    condition {\n      test     = <span class=\"hljs-string\">\"StringLike\"</span>\n      <span class=\"hljs-keyword\">variable</span> = <span class=\"hljs-string\">\"<span class=\"hljs-variable\">${var.tfc_hostname}</span>:sub\"</span>\n\n      values = [\n        for workspace in var.tfc_workspaces : <span class=\"hljs-string\">\"organization:<span class=\"hljs-variable\">${tfe_organization.organization.name}</span>:project:<span class=\"hljs-variable\">${var.tfc_project_name}</span>:workspace:<span class=\"hljs-variable\">${workspace}</span>:run_phase:*\"</span>\n      ]\n    }\n    actions = [<span class=\"hljs-string\">\"sts:AssumeRoleWithWebIdentity\"</span>]\n  }\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"aws_iam_role\"</span> <span class=\"hljs-string\">\"tfc-agent\"</span> {\n  name               = <span class=\"hljs-string\">\"tfc-agent\"</span>\n  assume_role_policy = <span class=\"hljs-keyword\">data</span>.aws_iam_policy_document.assume_role.json\n}\n\n/* Policy for what the TFC agent is allowed to do */\n<span class=\"hljs-keyword\">data</span> <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"tfc-agent\"</span> {\n  version = <span class=\"hljs-string\">\"2012-10-17\"</span>\n\n  statement {\n    actions   = [<span class=\"hljs-string\">\"*\"</span>]\n    effect    = <span class=\"hljs-string\">\"Allow\"</span>\n    resources = [<span class=\"hljs-string\">\"*\"</span>]\n  }\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"aws_iam_policy\"</span> <span class=\"hljs-string\">\"tfc-agent\"</span> {\n  name        = <span class=\"hljs-string\">\"tfc-agent-access-policy\"</span>\n  description = <span class=\"hljs-string\">\"Access policy for the TFC agent\"</span>\n  policy      = <span class=\"hljs-keyword\">data</span>.aws_iam_policy_document.tfc-agent.json\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"aws_iam_role_policy_attachment\"</span> <span class=\"hljs-string\">\"tfc-access-attach\"</span> {\n  role       = aws_iam_role.tfc-agent.name\n  policy_arn = aws_iam_policy.tfc-agent.arn\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"tfe_workspace\"</span> <span class=\"hljs-string\">\"workspaces\"</span> {\n  count        = length(var.tfc_workspaces)\n  name         = var.tfc_workspaces[count.index]\n  organization = tfe_organization.organization.name\n\n  working_directory = var.tfc_workspaces[count.index]\n}\n\n/* These variables tell the agent to use dynamic credentials */\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"tfe_variable\"</span> <span class=\"hljs-string\">\"tfc-auth\"</span> {\n  count        = length(var.tfc_workspaces)\n  key          = <span class=\"hljs-string\">\"TFC_AWS_PROVIDER_AUTH\"</span>\n  value        = true\n  category     = <span class=\"hljs-string\">\"env\"</span>\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = <span class=\"hljs-string\">\"Enable dynamic auth on the TFC agents\"</span>\n}\n\n<span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"tfe_variable\"</span> <span class=\"hljs-string\">\"tfc-role\"</span> {\n  count        = length(var.tfc_workspaces)\n  key          = <span class=\"hljs-string\">\"TFC_AWS_RUN_ROLE_ARN\"</span>\n  value        = aws_iam_role.tfc-agent.arn\n  category     = <span class=\"hljs-string\">\"env\"</span>\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = <span class=\"hljs-string\">\"Tell TFC what Role to run as\"</span>\n}\n</code></pre>\n<p>This module is dynamic because there is one piece that will require a\nmanual oauth setup for github.  So the first pass will apply without it\nand then later on we'll create it and run the apply again.</p>\n<h2>Applying the changes</h2>\n<p>Now we just need to define our settings for the module and we'll get our\ninfrastructure applied.  Create a file called <code>settings.auto.tfvars</code> and\npopulate it with the content for your account.  This is an example of what\nthis should look like:</p>\n<pre><code class=\"hljs language-hcl\">tfc_organization_name  = <span class=\"hljs-string\">\"sontek\"</span>\ntfc_organization_owner = <span class=\"hljs-string\">\"john@sontek.net\"</span>\n\n<span class=\"hljs-comment\"># The workspaces you want to create and be able to manage with IaC</span>\ntfc_workspaces = [\n  <span class=\"hljs-string\">\"root\"</span>\n]\n<span class=\"hljs-comment\"># this can be your username</span>\ngithub_organization    = <span class=\"hljs-string\">\"sontek\"</span>\ngithub_repo_name       = <span class=\"hljs-string\">\"sontek-infra\"</span>\naws_root_account_id    =  <span class=\"hljs-string\">\"888888888888\"</span>\n</code></pre>\n<p>Now run:</p>\n<pre><code class=\"hljs language-bash\">❯ terraform login\n❯ terraform init\n</code></pre>\n<p>and you should see:</p>\n<pre><code class=\"hljs\">Terraform has been successfully initialized!\n</code></pre>\n<p>Now lets run our plan:</p>\n<pre><code class=\"hljs language-hcl\">❯ <span class=\"hljs-keyword\">terraform</span> plan\n</code></pre>\n<p>You should see a result:</p>\n<pre><code class=\"hljs language-vbnet\"><span class=\"hljs-symbol\">Plan:</span> <span class=\"hljs-number\">10</span> <span class=\"hljs-keyword\">to</span> add, <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">to</span> change, <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">to</span> destroy.\n</code></pre>\n<p>Apply it to make those resources:</p>\n<pre><code class=\"hljs language-hcl\">❯ <span class=\"hljs-keyword\">terraform</span> apply\n</code></pre>\n<p>At this point it:</p>\n<ol>\n<li>Created a terraform cloud organization</li>\n<li>Created a terraform cloud workspace</li>\n<li>Created a git repository</li>\n</ol>\n<h1>Verify TFC can talk to AWS</h1>\n<p>To verify that TFC can communicate with AWS through the dynamic credentials,\nlets clone the <em>NEW</em> repository we just generated and make some dummy resources. After\nyou've cloned the repository lets make a folder for the workspace <code>root</code> that we\ndefined in bootstrap:</p>\n<pre><code class=\"hljs language-bash\">❯ <span class=\"hljs-built_in\">mkdir</span> root\n❯ <span class=\"hljs-built_in\">cd</span> root\n</code></pre>\n<p>Now create a <code>1-providers.tf</code>:</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">terraform</span> {\n  cloud {\n    organization = <span class=\"hljs-string\">\"sontek\"</span>\n\n    workspaces {\n      name = <span class=\"hljs-string\">\"root\"</span>\n    }\n  }\n\n  required_providers {\n    aws = {\n      source  = <span class=\"hljs-string\">\"hashicorp/aws\"</span>\n      version = <span class=\"hljs-string\">\"4.58.0\"</span>\n    }\n\n    tfe = {\n      source  = <span class=\"hljs-string\">\"hashicorp/tfe\"</span>\n      version = <span class=\"hljs-string\">\"0.42.0\"</span>\n    }\n  }\n}\n\n<span class=\"hljs-keyword\">provider</span> <span class=\"hljs-string\">\"aws\"</span> {\n  region = <span class=\"hljs-string\">\"us-east-1\"</span>\n\n  default_tags {\n    tags = {\n      Owner   = <span class=\"hljs-string\">\"john@sontek.net\"</span>\n      Env     = <span class=\"hljs-string\">\"Root\"</span>\n      Service = <span class=\"hljs-string\">\"BusinessOperations\"</span>\n    }\n  }\n}\n</code></pre>\n<p><strong>NOTE</strong>: You should replace <code>organization</code>, <code>workspaces.name</code>, and\n<code>tags.Owner</code> to be your own values.</p>\n<p>Now create a small resource to prove everything is working, we'll use SQS for\nthis. Create a file called <code>2-sqs.tf</code>:</p>\n<pre><code class=\"hljs language-hcl\"><span class=\"hljs-keyword\">resource</span> <span class=\"hljs-string\">\"aws_sqs_queue\"</span> <span class=\"hljs-string\">\"example-sqs\"</span> {\n  name                        = <span class=\"hljs-string\">\"example-sqs\"</span>\n  message_retention_seconds = <span class=\"hljs-number\">86400</span>\n  receive_wait_time_seconds = <span class=\"hljs-number\">10</span>\n}\n</code></pre>\n<p>If you run the plan you should see the resource it wants to create:</p>\n<pre><code class=\"hljs language-bash\">❯ terraform init\n❯ terraform plan\n\n</code></pre>\n<p>and you should see the run is executing in terraform cloud:</p>\n<pre><code class=\"hljs language-arduino\">Running plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C\nwill stop streaming the logs, but will <span class=\"hljs-keyword\">not</span> stop the plan running remotely.\n</code></pre>\n<p>You can click the link it provides to see the logs. Now lets apply this\nresource to see it all working:</p>\n<pre><code class=\"hljs language-hcl\">❯ <span class=\"hljs-keyword\">terraform</span> apply\n</code></pre>\n<p>You should get a response like:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-string\">Apply</span> <span class=\"hljs-string\">complete!</span> <span class=\"hljs-attr\">Resources:</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-string\">added,</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-string\">changed,</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-string\">destroyed.</span>\n</code></pre>\n<p>So Terraform Cloud has full access to create AWS resources!   The final step\nis to get github running the plan/apply on pull requests. Commit these files\nto your repository and we'll remove them in a pull request. Create a\n<code>.gitignore</code> file in the root:</p>\n<pre><code class=\"hljs language-hcl\">.<span class=\"hljs-keyword\">terraform</span>*\n</code></pre>\n<p>and commit all the files:</p>\n<pre><code class=\"hljs language-bash\">❯ git add *\n❯ git commit -m <span class=\"hljs-string\">\"initial infra\"</span>\n❯ git push origin <span class=\"hljs-built_in\">head</span>\n</code></pre>\n<h1>Github Actions</h1>\n<p>The two most popular workflows when using terraform are:</p>\n<ul>\n<li>\n<p><strong>Apply after Merge</strong>: This is the default for things like\n<a href=\"https://terraform.io\">terraform cloud</a> and most github actions.</p>\n</li>\n<li>\n<p><strong>Apply before Merge</strong>: This is the default for things like\n<a href=\"https://www.runatlantis.io/\">Atlantis</a>.</p>\n</li>\n</ul>\n<p>I don't like apply-after-merge.  There are a lot of ways where a <code>plan</code>\ncan succeed but an <code>apply</code> will fail and you end up with broken configuration\nin <code>main</code>.</p>\n<p>So in this article I'll show you how to implement <strong>apply-before-merge</strong> with\ngithub actions.</p>\n<p>All of these changes will be in the <code>infra</code> repository that was generated from\n<code>bootstrap</code>.  We are done with the bootstrap at this point.</p>\n<p>First, lets setup the <code>.github</code> folder, the end result we want is:</p>\n<pre><code class=\"hljs language-bash\">.github/\n└── workflows\n    ├── on-apply-finished.yml\n    ├── on-pull-request-labeled.yml\n    └── on-pull-request.yml\n</code></pre>\n<p>So create the folders:</p>\n<pre><code class=\"hljs language-bash\">❯ <span class=\"hljs-built_in\">mkdir</span> -p .github/workflows\n</code></pre>\n<h1>On Pull Request</h1>\n<p>The first flow we'll create is the <code>terraform plan</code> workflow which should be\nran whenever a pull request is opened. Create the file\n<code>.github/workflows/on-pull-request.yml</code> and put this content in it:</p>\n<pre><code class=\"hljs language-yml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">pr_build</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">branches:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">main</span>\n\n<span class=\"hljs-attr\">env:</span>\n  <span class=\"hljs-attr\">TERRAFORM_CLOUD_TOKENS:</span> <span class=\"hljs-string\">app.terraform.io=${{</span> <span class=\"hljs-string\">secrets.TFE_TOKEN</span> <span class=\"hljs-string\">}}</span>\n  <span class=\"hljs-attr\">GITHUB_TOKEN:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">terraform_validate:</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">strategy:</span>\n      <span class=\"hljs-attr\">fail-fast:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">matrix:</span>\n        <span class=\"hljs-attr\">folder:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">root</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">validate</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">dflook/terraform-validate@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">workspace:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n\n  <span class=\"hljs-attr\">terraform_fmt:</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">strategy:</span>\n      <span class=\"hljs-attr\">fail-fast:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">matrix:</span>\n        <span class=\"hljs-attr\">folder:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">root</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">fmt</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">dflook/terraform-fmt-check@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">workspace:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n\n  <span class=\"hljs-attr\">terraform_plan:</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">read</span>\n      <span class=\"hljs-attr\">pull-requests:</span> <span class=\"hljs-string\">write</span>\n    <span class=\"hljs-attr\">strategy:</span>\n      <span class=\"hljs-attr\">fail-fast:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">matrix:</span>\n        <span class=\"hljs-attr\">folder:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">root</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">plan</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">dflook/terraform-plan@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">workspace:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n</code></pre>\n<p>This creates three jobs:</p>\n<ul>\n<li><strong>terraform_validate</strong>: This validates the terraform via <code>terraform validate</code>\ncommand to make sure that it is correct and doesn't have duplicate resources\nor anything like that.</li>\n<li><strong>terraform_fmt</strong>: This verifies that the terraform is well formatted by\nrunning the <code>terraform fmt</code> command.`</li>\n<li><strong>terraform_plan</strong>: This runs the <code>terraform</code> plan and comments on the PR a\ndiff of the changes for you to verify.</li>\n</ul>\n<p>To verify this is working, lets delete <code>root/2-sqs.tf</code>, then lets push a branch\nand make a pull request to see the result so far:</p>\n<pre><code class=\"hljs language-bash\">❯ <span class=\"hljs-built_in\">rm</span> root/2-sqs.tf\n❯ git add .github/ root/\n❯ git checkout -b apply-before-merge\n❯ git commit -m <span class=\"hljs-string\">\"Implemented on-pull-request\"</span>\n❯ git push origin <span class=\"hljs-built_in\">head</span>\n</code></pre>\n<p>After you make the pull request you should 3 checks on it and a comment that\nshows the plan:</p>\n<center>\n<img src=\"/images/posts/aws_apply_before_merge/github_comment.png\" width=\"400\">\n<img src=\"/images/posts/aws_apply_before_merge/github_checks.png\" width=\"400\">\n</center>\n<h1>Apply on Label</h1>\n<p>So now that the plan is working we need some way to <code>apply</code> the changes. I've\nfound the best way to do this is via a label rather than a comment because of\nthe way github actions work. Their event based actions like <code>on-comment</code> aren't\nexecuted in the context of a pull-request.</p>\n<p>Since we will be using a label to signal a plan is ready to be applied lets\ncreate a new file <code>.github/workflows/on-pull-request-labeled.yml</code> and provide\nthis content:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">pr_apply</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">types:</span> [ <span class=\"hljs-string\">labeled</span> ]\n\n<span class=\"hljs-attr\">env:</span>\n  <span class=\"hljs-attr\">TERRAFORM_CLOUD_TOKENS:</span> <span class=\"hljs-string\">app.terraform.io=${{</span> <span class=\"hljs-string\">secrets.TFE_TOKEN</span> <span class=\"hljs-string\">}}</span>\n  <span class=\"hljs-attr\">GITHUB_TOKEN:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">terraform_apply:</span>\n    <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.label.name</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'tfc-apply'</span> <span class=\"hljs-string\">}}</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">read</span>\n      <span class=\"hljs-attr\">pull-requests:</span> <span class=\"hljs-string\">write</span>\n    <span class=\"hljs-attr\">strategy:</span>\n      <span class=\"hljs-attr\">fail-fast:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">matrix:</span>\n        <span class=\"hljs-attr\">folder:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">root</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">dflook/terraform-apply@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">workspace:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">matrix.folder</span> <span class=\"hljs-string\">}}</span>\n</code></pre>\n<p>This will fire whenever a pull request is labeled with the <code>tfc-apply</code> label.\nYou will need to create this label for the repository.</p>\n<p>It will run the <code>apply</code> and update the previous plan comment to let you\nknow the status.</p>\n<center>\n<img src=\"/images/posts/aws_apply_before_merge/tfc_applying.png\" width=\"400\">\n<img src=\"/images/posts/aws_apply_before_merge/tfc_applying_comment.png\" width=\"400\">\n</center>\n<h1>Merge on Apply</h1>\n<p>One thing you'll notice is that the pull request stayed open even after the\ninfrastructure is applied and we don't want that. We want any changes that have\nmade it into the environment to be merged into <code>main</code> automatically. To do\nthis we'll create our final action.</p>\n<p>Create a new file <code>.github/workflows/on-apply-finished.yml</code> with this content:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">pr_merge</span>\n\n<span class=\"hljs-comment\"># Only trigger, when the build workflow succeeded</span>\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">workflow_run:</span>\n    <span class=\"hljs-attr\">workflows:</span> [<span class=\"hljs-string\">pr_apply</span>]\n    <span class=\"hljs-attr\">types:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">completed</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">merge:</span>\n    <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.workflow_run.conclusion</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'success'</span> <span class=\"hljs-string\">}}</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">pull-requests:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">checks:</span> <span class=\"hljs-string\">read</span>\n      <span class=\"hljs-attr\">statuses:</span> <span class=\"hljs-string\">read</span>\n      <span class=\"hljs-attr\">actions:</span> <span class=\"hljs-string\">read</span>\n    <span class=\"hljs-attr\">outputs:</span>\n      <span class=\"hljs-attr\">pullRequestNumber:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">steps.workflow-run-info.outputs.pullRequestNumber</span> <span class=\"hljs-string\">}}</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">\"Get information about the current run\"</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">potiuk/get-workflow-origin@v1_5</span>\n        <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">workflow-run-info</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">token:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">sourceRunId:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.workflow_run.id</span> <span class=\"hljs-string\">}}</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">merge</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">pull</span> <span class=\"hljs-string\">request</span> <span class=\"hljs-string\">after</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">apply</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">sudo-bot/action-pull-request-merge@v1.2.0</span>\n        <span class=\"hljs-attr\">with:</span>\n            <span class=\"hljs-attr\">github-token:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n            <span class=\"hljs-attr\">number:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">steps.workflow-run-info.outputs.pullRequestNumber</span> <span class=\"hljs-string\">}}</span>\n</code></pre>\n<p>This will wait until the <code>pr_apply</code> job completes and as long as it was\nsuccessful it'll merge the branch!</p>\n<p><strong>NOTE</strong>: As I mentioned earlier, the event based actions do not run in the\ncontext of the pull request which means you cannot test changes to them during\nthe PR either.  You must merge the <code>on-apply-finished.yml</code> file to <code>main</code>\nbefore it starts working.</p>\n<h1>Branch Protection</h1>\n<p>The final step to the process is to make sure you go to your github settings\nand make sure these status checks are required before merging. Branch protection\nis a feature that will prevent merging changes into a branch unless all\nrequired checks are passing.</p>\n<p>Go to <code>Settings</code> -> <code>Branches</code> -> <code>Branch Protection</code> and add a branch\nprotection rule:</p>\n<center>\n<img src=\"/images/posts/aws_apply_before_merge/branch_protection.png\" width=\"500\">\n</center>\n<p>You want to enable the following settings:</p>\n<ul>\n<li><strong>Branch Name</strong>: main</li>\n<li>✅ Require a pull request before merging</li>\n<li>✅ Require status checks to pass before merging</li>\n</ul>\n<p>Then for <code>Status checks that are required.</code> select all of the ones we've\ncreated:</p>\n<center>\n<img src=\"/images/posts/aws_apply_before_merge/required_checks.png\" height=\"200\">\n</center>\n<h1>Helpful Resources</h1>\n<ul>\n<li><a href=\"https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform\">Terraform Dynamic Credentials Tutorial</a></li>\n<li><a href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration\">Terraform docs on Dynamic Credentials</a></li>\n<li><a href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token\">Github's understanding OIDC</a></li>\n</ul>","category":"AWS","date":"2023-06-23T00:00:00Z","tags":["AWS","DevOps","SRE"],"title":"AWS From Scratch with Terraform - Setting up your Root Account for IaC  with Terraform Cloud and Github actions."}},"__N_SSG":true}