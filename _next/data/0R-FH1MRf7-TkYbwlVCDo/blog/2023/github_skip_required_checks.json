{"pageProps":{"postData":{"id":["2023","github_skip_required_checks"],"path":"2023/github_skip_required_checks","contentHtml":"<p>Having every github action run on every pull request will end up slowing you\ndown and sometimes even discourage you from making changes.  For example, if you\nsee an error in the <code>README.md</code> but you know you'll have to wait for the entire\ntest suite to run you may choose not to push the change.</p>\n<h1>Path Filtering</h1>\n<p>To address this problem, Github has a feature called <a href=\"https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore\">path filtering</a>\nwhich works really well!  You can include and excluxe paths with a simple syntax:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">paths:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'*'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'*/**'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'!README.md'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'!.gitignore'</span>\n</code></pre>\n<p>Which will run on any changes except for <code>README.md</code> and <code>.gitignore</code>.  There is\neven a simpler format to this by using <code>paths-ignore</code>:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">paths-ignore:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'README.md'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'.gitignore'</span>\n</code></pre>\n<p>Although this works, I do not recommend using it.</p>\n<h1>Branch Protection / Required Checks</h1>\n<p>Path Filtering has one major flaw which is that it skips the run of the job\ncompletely which means if you are using <a href=\"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches\">branch protection</a>\nyour PR will be stuck in <code>pending</code> state.</p>\n<p>To resolve this we will have to run the job, but skip the actions inside it that\nare slow conditionally. There are a few opensource actions out there that make\nthis easy but the one I recommend is:</p>\n<p>https://github.com/tj-actions/changed-files</p>\n<p>I creates a lot of useful outputs you can use in your conditional out of the box\nwhich makes your action easy to write.</p>\n<h1>Skipping a required check</h1>\n<p>So using <code>tj-actions/changed-files</code> to skip a required check, it will look very\nsimilar to the path filtering from github.  You first define what files you care\nabout:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">terraform-lint:</span> \n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Check</span> <span class=\"hljs-string\">if</span> <span class=\"hljs-string\">files</span> <span class=\"hljs-string\">changed</span>\n        <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">changed-files-yaml</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">tj-actions/changed-files@v40</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">files_yaml:</span> <span class=\"hljs-string\">|\n            src:\n              - '*'\n              - '*/**'\n              - '!README.md'\n              - '!.gitignore'\n</span></code></pre>\n<p>The <code>src</code> is just a key selection I made here.  You can have many groups of\nfiles like <code>tests</code>, <code>docs</code>, etc. and conditionally do things if each of them\nchanged.</p>\n<p>So from our example, this step will generate output we can use <code>steps.changed-files-yaml.outputs.src_any_changed</code>\nthat is either <code>true</code> or <code>false.</code>. To use this we can us the <code>if</code> conditional\nblock on our jobs.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">steps:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">steps.changed-files-yaml.outputs.src_any_changed</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'true'</span>\n    <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n        earthly \\\n        +ci-terraform-lint \\\n            --TERRAFORM_VERSION=${{ env.RTX_TERRAFORM_VERSION }}\n</span></code></pre>\n<p>This will then skip linting if we didn't change any terraform and the job will\nbe marked successful!</p>\n<center>\n<img src=\"/images/posts/github_skip_required_checks/skipped_checks.png\">\n</center>\n<p>This can be confusing sometimes and the people you work with (or future you!)\nmay wonder why these critical checks are being skipped.   I like to include\na message with the decision that was made so its obvious that we wanted to skip\nthem:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">steps.changed-files-yaml.outputs.src_any_changed</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'false'</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n    echo \"No terraform files changed\"```\n</span>\n</code></pre>\n<p>Which will output:</p>\n<pre><code class=\"hljs language-arduino\">âœ… <span class=\"hljs-string\">\"No terraform files changed\"</span>\n</code></pre>\n<p>Right next to the skipped job which is exactly what we wanted to see! So the end\nresult would look something like this:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    \n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">terraform-lint:</span> \n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-22.04</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Check</span> <span class=\"hljs-string\">if</span> <span class=\"hljs-string\">real</span> <span class=\"hljs-string\">files</span> <span class=\"hljs-string\">changed</span>\n        <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">changed-files-yaml</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">tj-actions/changed-files@v40</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">files_yaml:</span> <span class=\"hljs-string\">|\n            src:\n              - '*'\n              - '*/**'\n              - '!README.md'\n              - '!.gitignore'\n</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">steps.changed-files-yaml.outputs.src_any_changed</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'true'</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          earthly \\\n            +ci-terraform-lint \\\n              --TERRAFORM_VERSION=${{ env.RTX_TERRAFORM_VERSION }}\n</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">steps.changed-files-yaml.outputs.src_any_changed</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">'false'</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          echo \"No terraform files changed\"\n</span></code></pre>\n<h1>Conclusion</h1>\n<p>Hopefully with this you can start speeding up your github actions and making the\ndeveloper experience enjoyable!</p>","category":"Development","date":"2023-10-29T00:00:00Z","tags":["git","github"],"title":"Speed up github actions with conditional jobs, even with required checks"}},"__N_SSG":true}