{"pageProps":{"postData":{"id":["2023","nuking_aws_account"],"path":"2023/nuking_aws_account","contentHtml":"<p>When you're an SRE/DevOps engineer you'll end up making AWS accounts and\ncreate a lot of cruft in your sandbox and development accounts. AWS\ndoes not make it easy to clear these up but there is a tool called\n<a href=\"https://github.com/rebuy-de/aws-nuke\">aws-nuke</a> that will do it for you!</p>\n<h1>Safe Guards</h1>\n<p>aws-nuke has a few safeguards in place to prevent inadvertent data loss.\nThe first of which is it requires you to alias the targetted account. I\nlike to put <code>nuke</code> in the alias to make it clear.</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">iam</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">create-account-alias</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--account-alias</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">nuke-</span><span style=\"color: #F47067\">&#x3C;</span><span style=\"color: #96D0FF\">accoun</span><span style=\"color: #ADBAC7\">t</span><span style=\"color: #F47067\">></span></span></code></pre></div>\n<p>The second safe-guard is the config takes a key called <code>account-blocklist</code>\nthat will guarantee nuke will not run against it no matter what.</p>\n<p>The final safety switch it has is it will not take any action by default,\nit will only execute a dry-run.   You need to run the CLI with\n<code>--no-dry-run</code> if you want it to take action.</p>\n<h1>Getting Started</h1>\n<p>You configure <code>aws-nuke</code> with YAML, so the first step is to define that:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">regions:</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">  - us-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">  - global</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\"></span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">account-blocklist:</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">  - \"888888888888\" # production</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\"></span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">accounts:</span></span>\n<span data-line=\"\"><span style=\"color: #adbac7\">  \"777777777777\": {} # nuke-&#x3C;account></span></span></code></pre></div>\n<p>This will prevent us from nuking our production account and target all resources\nin the account we actually want to nuke.</p>\n<p>You might want to have it nuke <em>ALL REGIONS</em> in AWS since you may not know which\nregions resources are deployed in.   To do this you can query the regions from AWS:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">ec2</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">describe-regions</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--all-regions</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--query</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"Regions[*].RegionName\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--output</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">text</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F69D50\">xargs</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-n</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F47067\">|</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #F69D50\">sort</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">af-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-northeast-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-northeast-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-northeast-3</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-south-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-southeast-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-southeast-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-southeast-3</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ap-southeast-4</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">ca-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-central-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-north-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-south-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-west-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-west-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">eu-west-3</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">me-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">me-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">sa-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-2</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-west-1</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-west-2</span></span></code></pre></div>\n<p>Which would give you an updated config of:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">regions</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">global</span><span style=\"color: #ADBAC7\">  </span><span style=\"color: #768390\"># Global resources like IAM</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">af-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-northeast-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-northeast-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-northeast-3</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-south-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-southeast-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-southeast-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-southeast-3</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ap-southeast-4</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">ca-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-central-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-north-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-south-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-west-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-west-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">eu-west-3</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">me-central-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">me-south-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">sa-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">us-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">us-east-2</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">us-west-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">us-west-2</span></span></code></pre></div>\n<p>I personally don't recommend targetting all AWS regions at the same time.  It\nwill generate a lot of output and be slow.  You could do it if necessary but\nmost people only have a few regions they use and so they can set those directly.\nFor example it, maybe you only use <code>us-</code> based regions?</p>\n<p>So lets run the dry-run and see what it wants to nuke:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws-nuke</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-c</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">nuke.yaml</span></span></code></pre></div>\n<p>This should output something like:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">Do</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">you</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">really</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">want</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">nuke</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">account</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">with</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">ID</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">777777777777</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">and</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">alias</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">'nuke-sandbox'?</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Do</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">you</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">want</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">continue?</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Enter</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">account</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">alias</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">continue.</span></span>\n<span data-line=\"\"><span style=\"color: #F47067\">></span><span style=\"color: #ADBAC7\"> nuke-sandbox</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-0cd9975a443a6304b</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-0be39d02e399a371c</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-02d7017bd4730ea63</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-0ec04b28c32708ab2</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-0eea1b4be084840ed</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2Subnet</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">subnet-05a294cc04736012e</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultForAz: </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">DefaultVPC:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"true\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">OwnerID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"777777777777\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2RouteTable</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">rtb-0abda0e94015064ca</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultVPC: </span><span style=\"color: #96D0FF\">\"true\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2DefaultSecurityGroupRule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sgr-0368525f77bf566ac</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [SecurityGroupId: </span><span style=\"color: #96D0FF\">\"sg-0a59900b52ced5e10\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2DefaultSecurityGroupRule</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">sgr-0890a837ed6148729</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [SecurityGroupId: </span><span style=\"color: #96D0FF\">\"sg-0a59900b52ced5e10\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">EC2InternetGatewayAttachment</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">igw-0acfb474f1fd71375</span><span style=\"color: #ADBAC7\"> -</span><span style=\"color: #F47067\">></span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">vpc-0be5d310ab44c239a</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [DefaultVPC: </span><span style=\"color: #96D0FF\">\"true\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">us-east-1</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">SQSQueue</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">https://sqs.us-east-1.amazonaws.com/777777777777/example-sqs</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMSAMLProvider</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMOpenIDConnectProvider</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::777777777777:oidc-provider/app.terraform.io</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [Arn: </span><span style=\"color: #96D0FF\">\"arn:aws:iam::777777777777:oidc-provider/app.terraform.io\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMPolicy</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::777777777777:policy/tfc-agent-access-policy</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [ARN: </span><span style=\"color: #96D0FF\">\"arn:aws:iam::777777777777:policy/tfc-agent-access-policy\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Name:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"tfc-agent-access-policy\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Path:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">PolicyID:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"ANPA2T6PZOBNWI76TKQRF\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMRole</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">tfc-agent</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [CreateDate: </span><span style=\"color: #96D0FF\">\"2023-04-02T17:55:23Z\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">LastUsedDate:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-06-22T13:45:02Z\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Name:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"tfc-agent\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Path:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMRolePolicyAttachment</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">tfc-agent</span><span style=\"color: #ADBAC7\"> -</span><span style=\"color: #F47067\">></span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">tfc-agent-access-policy</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> [PolicyArn: </span><span style=\"color: #96D0FF\">\"arn:aws:iam::777777777777:policy/tfc-agent-access-policy\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">PolicyName:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"tfc-agent-access-policy\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">RoleCreateDate:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-04-02T17:55:23Z\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">RoleLastUsed:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"2023-06-22T13:45:02Z\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">RoleName:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"tfc-agent\",</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">RolePath:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">\"/\"]</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">remove</span></span>\n<span data-line=\"\"><span style=\"color: #F69D50\">Scan</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">complete:</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">85</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">total,</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">19</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">nukeable,</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">66</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">filtered.</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #F69D50\">The</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">above</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resources</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">would</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">be</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">deleted</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">with</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">the</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">supplied</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">configuration.</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">Provide</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--no-dry-run</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">to</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">actually</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">destroy</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">resources.</span></span></code></pre></div>\n<p>This is great, it fully scanned the account and found every resource to delete!\nIt even wants to delete the DefaultVPC which is usually a good idea.  The one\nresource that should catch your eye that you probably do not want to delete:</p>\n<ul>\n<li><code>arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE</code></li>\n</ul>\n<p>AWS clearly doesn't want us to delete that!</p>\n<h1>Filters</h1>\n<p>To prevent nuke from deleting resources you want to keep you can define presets\nthat you use on each account.  So with our SSO example we want to prevent it\nfrom deleting those resources in a preset.</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">presets</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">sso</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">filters</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMSAMLProvider</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"regex\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"AWSSSO_.*_DO_NOT_DELETE\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRole</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"glob\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"AWSReservedSSO_*\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRolePolicyAttachment</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"glob\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"AWSReservedSSO_*\"</span></span></code></pre></div>\n<p>You can see in this example I'm targetting specific resource types and then\nmatching them with both <code>regex</code> and <code>glob</code> filter types. These are super\npowerful but a lot of times the simpler filters can be used.  I start with\n<code>contains</code> filter and then go from there:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">contains</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">AWSReservedSSO</span></span></code></pre></div>\n<p>Then the other thing you may have noticed is that I was repeating\n<code>AWSReservedSSO</code> multiple times.  To reduce that you can use standard YAML\nanchors.   So the final config for your preset would look like this:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">presets</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">sso</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">filters</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">_DEFAULT_FILTERS</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">&#x26;</span><span style=\"color: #F69D50\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"contains\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"DO_NOT_DELETE\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"contains\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"AWSReservedSSO\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMSAMLProvider</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRole</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRolePolicyAttachment</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span></code></pre></div>\n<p>Now we can use that preset in our accounts configuration:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">accounts</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #96D0FF\">\"777777777777\"</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #96D0FF\">\"presets\"</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">sso</span></span></code></pre></div>\n<p>So your final config should look something like this:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">regions</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">us-east-1</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">global</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #8DDB8C\">account-blocklist</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  - </span><span style=\"color: #96D0FF\">\"888888888888\"</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #768390\"># production</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #8DDB8C\">presets</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">sso</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">filters</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">_DEFAULT_FILTERS</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">&#x26;</span><span style=\"color: #F69D50\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"contains\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"DO_NOT_DELETE\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        - </span><span style=\"color: #8DDB8C\">type</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"contains\"</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">value</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">\"AWSReservedSSO\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMSAMLProvider</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRole</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      </span><span style=\"color: #8DDB8C\">IAMRolePolicyAttachment</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">*</span><span style=\"color: #ADBAC7\">DEFAULT</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #8DDB8C\">accounts</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #96D0FF\">\"777777777777\"</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #96D0FF\">\"presets\"</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">sso</span></span></code></pre></div>\n<p>When you run this you should see now the resources we want to keep are filtered\nout:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">global</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">IAMSAMLProvider</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">-</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">filtered</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">by</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">config</span></span></code></pre></div>\n<p>Once you are ready and have your filters in place you can run it for real!</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"><code data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #F69D50\">❯</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">aws-nuke</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">-c</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #96D0FF\">nuke.yaml</span><span style=\"color: #ADBAC7\"> </span><span style=\"color: #6CB6FF\">--no-dry-run</span></span></code></pre></div>\n<h1>Next steps</h1>\n<p>One final note about it is that it does not understand the relationship between\nresources and so it could try deleting an EBS volume that is still in use by an\nEC2 instance.  There isn't a great solution for this outside of running nuke a\nfew times.</p>\n<p>The tool is well documented and so you can find the rest of information going to\n<a href=\"https://github.com/rebuy-de/aws-nuke\">https://github.com/rebuy-de/aws-nuke</a>!</p>","category":"AWS","date":"2023-06-21T19:00:00-05:00","tags":["AWS","DevOps","SRE"],"title":"Wiping an AWS Account with aws-nuke"}},"__N_SSG":true}