{"pageProps":{"postData":{"id":["2023","github_skip_required_checks"],"path":"2023/github_skip_required_checks","contentHtml":"<p>Having every github action run on every pull request will end up slowing you\ndown and sometimes even discourage you from making changes.  For example, if you\nsee an error in the <code>README.md</code> but you know you'll have to wait for the entire\ntest suite to run you may choose not to push the change.</p>\n<h1>Path Filtering</h1>\n<p>To address this problem, Github has a feature called <a href=\"https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore\">path filtering</a>\nwhich works really well!  You can include and exclude paths with a simple syntax:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #6CB6FF\">on</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">pull_request</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">paths</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'*'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'*/**'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'!README.md'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'!.gitignore'</span></span></code></pre></div>\n<p>Which will run on any changes except for <code>README.md</code> and <code>.gitignore</code>.  There is\neven a simpler format to this by using <code>paths-ignore</code>:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #6CB6FF\">on</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">pull_request</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">paths-ignore</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'README.md'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #96D0FF\">'.gitignore'</span></span></code></pre></div>\n<p>Although the path filtering feature of github works, I do not recommend using\nit because it has some critical issues that I'll talk about below!</p>\n<h1>Branch Protection / Required Checks</h1>\n<p>Path Filtering has one major flaw which is that it skips the run of the job\ncompletely which means if you are using <a href=\"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches\">branch protection</a>\nyour PR will be stuck in <code>pending</code> state.</p>\n<p>To resolve this we will have to run the job, but skip the actions inside it that\nare slow conditionally. There are a few opensource actions out there that make\nthis easy but the one I recommend is:</p>\n<p><a href=\"https://github.com/tj-actions/changed-files\">https://github.com/tj-actions/changed-files</a></p>\n<p>It creates a lot of useful outputs you can use in your conditional out of the box\nwhich makes your action easy to write.</p>\n<h1>Skipping a required check</h1>\n<p>So using <code>tj-actions/changed-files</code> to skip a required check, it will look very\nsimilar to the path filtering from github.  You first define what files you care\nabout:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">jobs</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">terraform-lint</span><span style=\"color: #ADBAC7\">: </span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">runs-on</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">ubuntu-22.04</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">steps</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">uses</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">actions/checkout@v3</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">name</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">Check if files changed</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">id</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">changed-files-yaml</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">uses</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">tj-actions/changed-files@v40</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">with</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">files_yaml</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">            src:</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '*'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '*/**'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '!README.md'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '!.gitignore'</span></span></code></pre></div>\n<p>The <code>src</code> is just a key selection I made here.  You can have many groups of\nfiles like <code>tests</code>, <code>docs</code>, etc. and conditionally do things if each of them\nchanged.</p>\n<p>So from our example, this step will generate output we can use <code>steps.changed-files-yaml.outputs.src_any_changed</code>\nthat is either <code>true</code> or <code>false.</code>. To use this we can us the <code>if</code> conditional\nblock on our jobs.</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #8DDB8C\">steps</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    - </span><span style=\"color: #8DDB8C\">if</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">steps.changed-files-yaml.outputs.src_any_changed == 'true'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">run</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">        earthly \\</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">        +ci-terraform-lint \\</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">            --TERRAFORM_VERSION=${{ env.RTX_TERRAFORM_VERSION }}</span></span></code></pre></div>\n<p>This will then skip linting if we didn't change any terraform and the job will\nbe marked successful!</p>\n<center>\n<img src=\"/images/posts/github_skip_required_checks/skipped_checks.png\">\n</center>\n<p>This can be confusing sometimes and the people you work with (or future you!)\nmay wonder why these critical checks are being skipped.   I like to include\na message with the decision that was made so its obvious that we wanted to skip\nthem:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #ADBAC7\">- </span><span style=\"color: #8DDB8C\">if</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">steps.changed-files-yaml.outputs.src_any_changed == 'false'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">run</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">    echo \"No terraform files changed\"</span></span></code></pre></div>\n<p>Which will output:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"><code data-language=\"\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #adbac7\">✅ \"No terraform files changed\"</span></span></code></pre></div>\n<p>Right next to the skipped job which is exactly what we wanted to see! So the end\nresult would look something like this:</p>\n<div data-rehype-pretty-code-fragment=\"\"><pre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"><code data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color: #6CB6FF\">on</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">pull_request</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span></span>\n<span data-line=\"\"><span style=\"color: #8DDB8C\">jobs</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">  </span><span style=\"color: #8DDB8C\">terraform-lint</span><span style=\"color: #ADBAC7\">: </span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">runs-on</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">ubuntu-22.04</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">    </span><span style=\"color: #8DDB8C\">steps</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">uses</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">actions/checkout@v3</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">name</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">Check if real files changed</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">id</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">changed-files-yaml</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">uses</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">tj-actions/changed-files@v40</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">with</span><span style=\"color: #ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">          </span><span style=\"color: #8DDB8C\">files_yaml</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">            src:</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '*'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '*/**'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '!README.md'</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              - '!.gitignore'</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">if</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">steps.changed-files-yaml.outputs.src_any_changed == 'true'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">run</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">          earthly \\</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">            +ci-terraform-lint \\</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">              --TERRAFORM_VERSION=${{ env.RTX_TERRAFORM_VERSION }}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">      - </span><span style=\"color: #8DDB8C\">if</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #96D0FF\">steps.changed-files-yaml.outputs.src_any_changed == 'false'</span></span>\n<span data-line=\"\"><span style=\"color: #ADBAC7\">        </span><span style=\"color: #8DDB8C\">run</span><span style=\"color: #ADBAC7\">: </span><span style=\"color: #F47067\">|</span></span>\n<span data-line=\"\"><span style=\"color: #96D0FF\">          echo \"No terraform files changed\"</span></span></code></pre></div>\n<h1>Conclusion</h1>\n<p>Hopefully with this you can start speeding up your github actions and making the\ndeveloper experience enjoyable!</p>","category":"Development","date":"2023-10-28T19:00:00-05:00","tags":["git","github"],"title":"Speed up github actions with conditional jobs, even with required checks"}},"__N_SSG":true}