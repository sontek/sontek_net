<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4e645f88d9d5f47b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e645f88d9d5f47b.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2e2b8b955a26d1f2.js" defer=""></script><script src="/_next/static/chunks/pages/rss-68d9a13692feb682.js" defer=""></script><script src="/_next/static/or2yRsjMlE6FOwtaFG-IP/_buildManifest.js" defer=""></script><script src="/_next/static/or2yRsjMlE6FOwtaFG-IP/_ssgManifest.js" defer=""></script><script src="/_next/static/or2yRsjMlE6FOwtaFG-IP/_middlewareManifest.js" defer=""></script></head><body><div id="__next">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;rss xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:content=&quot;http://purl.org/rss/1.0/modules/content/&quot; xmlns:atom=&quot;http://www.w3.org/2005/Atom&quot; version=&quot;2.0&quot;&gt;
    &lt;channel&gt;
        &lt;title&gt;&lt;![CDATA[sontek.net Blog posts]]&gt;&lt;/title&gt;
        &lt;description&gt;&lt;![CDATA[Blog about SRE, Kubernetes, Python, GoLang, and anything development related.]]&gt;&lt;/description&gt;
        &lt;link&gt;https://sontek.net&lt;/link&gt;
        &lt;image&gt;
            &lt;url&gt;https://sontek.net/logo.png&lt;/url&gt;
            &lt;title&gt;sontek.net Blog posts&lt;/title&gt;
            &lt;link&gt;https://sontek.net&lt;/link&gt;
        &lt;/image&gt;
        &lt;generator&gt;RSS for Node&lt;/generator&gt;
        &lt;lastBuildDate&gt;Mon, 03 Apr 2023 04:44:05 GMT&lt;/lastBuildDate&gt;
        &lt;atom:link href=&quot;https://sontek.net/rss.xml&quot; rel=&quot;self&quot; type=&quot;application/rss+xml&quot;/&gt;
        &lt;pubDate&gt;Mon, 03 Apr 2023 04:44:02 GMT&lt;/pubDate&gt;
        &lt;copyright&gt;&lt;![CDATA[All rights reserved 2023, @sontek]]&gt;&lt;/copyright&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[AWS From Scratch with Terraform - Apply before Merge with Github Actions]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;The two most popular workflows when using terraform are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Apply after Merge&lt;/strong&gt;: This is the default for things like
&lt;a href=&quot;https://terraform.io&quot;&gt;terraform cloud&lt;/a&gt; and most github actions.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Apply before Merge&lt;/strong&gt;: This is the default for things like
&lt;a href=&quot;https://www.runatlantis.io/&quot;&gt;Atlantis&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I don&#x27;t like apply-after-merge.  There are a lot of ways where a &lt;code&gt;plan&lt;/code&gt;
can succeed but an &lt;code&gt;apply&lt;/code&gt; will fail and you end up with broken configuration
in &lt;code&gt;main&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So in this article I&#x27;ll show you how to implement &lt;strong&gt;apply-before-merge&lt;/strong&gt; with
github actions.&lt;/p&gt;
&lt;p&gt;If you haven&#x27;t ready my &lt;a href=&quot;/blog/2023/aws_from_scratch_root_account&quot;&gt;previous article&lt;/a&gt;,
it covers how to setup terraform cloud with apply after merge and bootstrap your AWS
account with terraform.  I will assume you have read that article going forward.&lt;/p&gt;
&lt;h1&gt;TL;DR&lt;/h1&gt;
&lt;p&gt;The code for the github actions we create in this post can be found
&lt;a href=&quot;https://github.com/sontek/aws-terraform-github-actions&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;Repairing the bootstrap&lt;/h1&gt;
&lt;p&gt;With apply-before-merge we need to implement it in github actions rather than
utilizing the terraform cloud webhooks.  So lets drop the VCS repo and usage of
the webhook from our github repository. Basically anything that references
&lt;code&gt;github_oauth_client&lt;/code&gt; can be removed because we will no longer be using OAuth
with Github for our CI/CD pipeline.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-diff&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;diff --git a/1-variables.tf b/1-variables.tf&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;index bf1f434..7109924 100644&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;--- a/1-variables.tf&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;+++ b/1-variables.tf&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@@ -47,12 +47,6 @@&lt;/span&gt; variable &quot;github_default_branch&quot; {
   default     = &quot;main&quot;
 }
 
&lt;span class=&quot;hljs-deletion&quot;&gt;-variable &quot;github_oauth_client_id&quot; {&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  description = &quot;The token for the TFC OAuth client shown under VCS providers&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  type        = string&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  default     = null&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-}&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-&lt;/span&gt;
 variable &quot;aws_root_account_id&quot; {
   description = &quot;The AWS root account we want to apply these changes to&quot;
   type        = string
&lt;span class=&quot;hljs-comment&quot;&gt;diff --git a/4-tfc.tf b/4-tfc.tf&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;index a8217b7..9852228 100644&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;--- a/4-tfc.tf&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;+++ b/4-tfc.tf&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@@ -77,31 +77,12 @@&lt;/span&gt; resource &quot;aws_iam_role_policy_attachment&quot; &quot;tfc-access-attach&quot; {
   policy_arn = aws_iam_policy.tfc-agent.arn
 }
 
&lt;span class=&quot;hljs-deletion&quot;&gt;-/* Fetch an oauth token from the client */&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-data &quot;tfe_oauth_client&quot; &quot;github&quot; {&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  /* Don&#x27;t fetch the client if we don&#x27;t have the client_id */&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  count           = var.github_oauth_client_id != null ? 1 : 0&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  oauth_client_id = var.github_oauth_client_id&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-}&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-&lt;/span&gt;
 resource &quot;tfe_workspace&quot; &quot;workspaces&quot; {
   count        = length(var.tfc_workspaces)
   name         = var.tfc_workspaces[count.index]
   organization = tfe_organization.organization.name
 
   working_directory = var.tfc_workspaces[count.index]
&lt;span class=&quot;hljs-deletion&quot;&gt;-&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  /* This generates a webhook on the github repository so plans are triggered&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  automatically.   We dynamically set the setting because we will not have the&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  oauth client ID on first pass.&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  */&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  dynamic &quot;vcs_repo&quot; {&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-    content {&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-      identifier     = format(&quot;%s/%s&quot;, var.github_organization, github_repository.repo.name)&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-      oauth_token_id = data.tfe_oauth_client.github[0].oauth_token_id&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-    }&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-  }&lt;/span&gt;
 }
 
 /* These variables tell the agent to use dynamic credentials */
&lt;span class=&quot;hljs-comment&quot;&gt;diff --git a/settings.auto.tfvars.example b/settings.auto.tfvars.example&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;index 3327f02..79221c1 100644&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;--- a/settings.auto.tfvars.example&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;+++ b/settings.auto.tfvars.example&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@@ -4,6 +4,5 @@&lt;/span&gt; tfc_workspaces = [
   &quot;root&quot;
 ]
 github_organization    = &quot;github-org&quot;
&lt;span class=&quot;hljs-deletion&quot;&gt;-github_oauth_client_id = &quot;oc-...&quot;&lt;/span&gt;
 github_repo_name       = &quot;my-infra&quot;
 aws_root_account_id    =  &quot;888888888888&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once that is removed from your &lt;code&gt;infra-bootstrap&lt;/code&gt; repository we need to create
a new github secret with a token for Github to be able to talk with TFC. Make
a new file called &lt;code&gt;5-github-actions.tf&lt;/code&gt; with the following content:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_team&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;owners&quot;&lt;/span&gt; {
  name         = &lt;span class=&quot;hljs-string&quot;&gt;&quot;owners&quot;&lt;/span&gt;
  organization = tfe_organization.organization.name
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_team_token&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_actions_token&quot;&lt;/span&gt; {
  team_id = &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.tfe_team.owners.id
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_actions_secret&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_secret&quot;&lt;/span&gt; {
  repository      = github_repository.repo.name
  secret_name     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;TFE_TOKEN&quot;&lt;/span&gt;
  plaintext_value = tfe_team_token.github_actions_token.token
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then you should &lt;code&gt;plan&lt;/code&gt; and &lt;code&gt;apply&lt;/code&gt; the change:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ terraform plan
❯ terraform apply
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The only change to the infrastructure should be to remove the VCS link and
adding the secret:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-diff&quot;&gt;  # tfe_workspace.workspaces[0] will be updated in-place
  ~ resource &quot;tfe_workspace&quot; &quot;workspaces&quot; {
        id                            = &quot;ws-K1M4tdXUUeASgmUR&quot;
        name                          = &quot;root&quot;
        # (20 unchanged attributes hidden)

&lt;span class=&quot;hljs-deletion&quot;&gt;-       vcs_repo {&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-           identifier         = &quot;sontek/sontek-infra&quot; -&gt; null&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-           ingress_submodules = false -&gt; null&lt;/span&gt;
&lt;span class=&quot;hljs-deletion&quot;&gt;-           oauth_token_id     = &quot;ot-nMYJRbBb2SH9zCP7&quot; -&gt; null&lt;/span&gt;
        }
    }

  # github_actions_secret.tfe_secret will be created
&lt;span class=&quot;hljs-addition&quot;&gt;+   resource &quot;github_actions_secret&quot; &quot;tfe_secret&quot; {&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       created_at      = (known after apply)&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       id              = (known after apply)&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       plaintext_value = (sensitive value)&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       repository      = &quot;sontek-infra&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       secret_name     = &quot;TFE_TOKEN&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       updated_at      = (known after apply)&lt;/span&gt;
    }

  # tfe_team_token.github_actions_token will be created
&lt;span class=&quot;hljs-addition&quot;&gt;+   resource &quot;tfe_team_token&quot; &quot;github_actions_token&quot; {&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       id      = (known after apply)&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       team_id = &quot;team-...&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-addition&quot;&gt;+       token   = (sensitive value)&lt;/span&gt;
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Github Actions&lt;/h1&gt;
&lt;p&gt;Now we need to connect the github actions to replace the plan and apply actions
that were being taken by the TFC webhook previously. All of these changes will
be in the &lt;code&gt;infra&lt;/code&gt; repository that was generated from &lt;code&gt;bootstrap&lt;/code&gt;.  We are done
with the bootstrap at this point.&lt;/p&gt;
&lt;p&gt;First, lets setup the &lt;code&gt;.github&lt;/code&gt; folder, the end result we want is:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;.github/
└── workflows
    ├── on-apply-finished.yml
    ├── on-pull-request-labeled.yml
    └── on-pull-request.yml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So create the folders:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; -p .github/workflows
❯ terraform apply
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;On Pull Request&lt;/h1&gt;
&lt;p&gt;The first flow we&#x27;ll create is the &lt;code&gt;terraform plan&lt;/code&gt; workflow which should be
ran whenever a pull request is opened. Create the file
&lt;code&gt;.github/workflows/on-pull-request.yml&lt;/code&gt; and put this content in it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yml&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;pr_build&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;on:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;pull_request:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;branches:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;env:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;TERRAFORM_CLOUD_TOKENS:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;app.terraform.io=${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.TFE_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;GITHUB_TOKEN:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.GITHUB_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;jobs:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;terraform_validate:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;runs-on:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;ubuntu-22.04&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;strategy:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;fail-fast:&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;matrix:&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;folder:&lt;/span&gt;
          &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;root&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;steps:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;Checkout&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;actions/checkout@v3&lt;/span&gt;

      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;terraform&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;validate&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;dflook/terraform-validate@v1&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;workspace:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;

  &lt;span class=&quot;hljs-attr&quot;&gt;terraform_fmt:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;runs-on:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;ubuntu-22.04&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;strategy:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;fail-fast:&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;matrix:&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;folder:&lt;/span&gt;
          &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;root&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;steps:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;actions/checkout@v3&lt;/span&gt;

      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;terraform&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;fmt&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;dflook/terraform-fmt-check@v1&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;workspace:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;

  &lt;span class=&quot;hljs-attr&quot;&gt;terraform_plan:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;runs-on:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;ubuntu-22.04&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;permissions:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;contents:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;read&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;pull-requests:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;write&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;strategy:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;fail-fast:&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;matrix:&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;folder:&lt;/span&gt;
          &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;root&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;steps:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;actions/checkout@v3&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;terraform&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;plan&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;dflook/terraform-plan@v1&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;workspace:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This creates three jobs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;terraform_validate&lt;/strong&gt;: This validates the terraform via &lt;code&gt;terraform validate&lt;/code&gt;
command to make sure that it is correct and doesn&#x27;t have duplicate resources
or anything like that.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;terraform_fmt&lt;/strong&gt;: This verifies that the terraform is well formatted by
running the &lt;code&gt;terraform fmt&lt;/code&gt; command.`&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;terraform_plan&lt;/strong&gt;: This runs the &lt;code&gt;terraform&lt;/code&gt; plan and comments on the PR a
diff of the changes for you to verify.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To verify this is working, lets make a change to the infrastructure so that we
can see a plan executed. We can bring back the &lt;code&gt;SQS&lt;/code&gt; resource we destroyed in
the previous article. Create a file called &lt;code&gt;root/2-sqs.tf&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_sqs_queue&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;example-sqs&quot;&lt;/span&gt; {
  name                      = &lt;span class=&quot;hljs-string&quot;&gt;&quot;example-sqs&quot;&lt;/span&gt;
  message_retention_seconds = &lt;span class=&quot;hljs-number&quot;&gt;86400&lt;/span&gt;
  receive_wait_time_seconds = &lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Lets push a branch and make a pull request to see the result so far:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ git add .github/ root/
❯ git checkout -b apply-before-merge
❯ git commit -m &lt;span class=&quot;hljs-string&quot;&gt;&quot;Implemented on-pull-request&quot;&lt;/span&gt;
❯ git push origin &lt;span class=&quot;hljs-built_in&quot;&gt;head&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After you make the pull request you should 3 checks on it and a comment that
shows the plan:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/github_comment.png&quot; width=&quot;400&quot;&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/github_checks.png&quot; width=&quot;400&quot;&gt;
&lt;/center&gt;
&lt;h1&gt;Apply on Label&lt;/h1&gt;
&lt;p&gt;So now that the plan is working we need some way to &lt;code&gt;apply&lt;/code&gt; the changes. I&#x27;ve
found the best way to do this is via a label rather than a comment because of
the way github actions work. Their event based actions like &lt;code&gt;on-comment&lt;/code&gt; aren&#x27;t
executed in the context of a pull-request.&lt;/p&gt;
&lt;p&gt;Since we will be using a label to signal a plan is ready to be applied lets
create a new file &lt;code&gt;.github/workflows/on-pull-request-labeled.yml&lt;/code&gt; and provide
this content:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;pr_apply&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;on:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;pull_request:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;types:&lt;/span&gt; [ &lt;span class=&quot;hljs-string&quot;&gt;labeled&lt;/span&gt; ]

&lt;span class=&quot;hljs-attr&quot;&gt;env:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;TERRAFORM_CLOUD_TOKENS:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;app.terraform.io=${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.TFE_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;GITHUB_TOKEN:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.GITHUB_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;jobs:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;terraform_apply:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;if:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;github.event.label.name&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&#x27;tfc-apply&#x27;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;runs-on:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;ubuntu-22.04&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;permissions:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;contents:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;read&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;pull-requests:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;write&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;strategy:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;fail-fast:&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;matrix:&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;folder:&lt;/span&gt;
          &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;root&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;steps:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;actions/checkout@v3&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;dflook/terraform-apply@v1&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;workspace:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;matrix.folder&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will fire whenever a pull request is labeled with the &lt;code&gt;tfc-apply&lt;/code&gt; label.
It will run the &lt;code&gt;apply&lt;/code&gt; and update the previous plan comment to let you
know the status.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/tfc_applying.png&quot; width=&quot;400&quot;&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/tfc_applying_comment.png&quot; width=&quot;400&quot;&gt;
&lt;/center&gt;
&lt;h1&gt;Merge on Apply&lt;/h1&gt;
&lt;p&gt;One thing you&#x27;ll notice is that the pull request stayed open even after the
infrastructure is applied and we don&#x27;t want that. We want any changes that have
made it into the environment to be merged into &lt;code&gt;main&lt;/code&gt; automatically. To do
this we&#x27;ll create our final action.&lt;/p&gt;
&lt;p&gt;Create a new file &lt;code&gt;.github/workflows/on-apply-finished.yml&lt;/code&gt; with this content:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;pr_merge&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;# Only trigger, when the build workflow succeeded&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;on:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;workflow_run:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;workflows:&lt;/span&gt; [&lt;span class=&quot;hljs-string&quot;&gt;pr_apply&lt;/span&gt;]
    &lt;span class=&quot;hljs-attr&quot;&gt;types:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;completed&lt;/span&gt;

&lt;span class=&quot;hljs-attr&quot;&gt;jobs:&lt;/span&gt;
  &lt;span class=&quot;hljs-attr&quot;&gt;merge:&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;if:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;github.event.workflow_run.conclusion&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&#x27;success&#x27;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;runs-on:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;ubuntu-22.04&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;permissions:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;contents:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;write&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;pull-requests:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;write&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;checks:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;read&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;statuses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;read&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;actions:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;read&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;outputs:&lt;/span&gt;
      &lt;span class=&quot;hljs-attr&quot;&gt;pullRequestNumber:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;steps.workflow-run-info.outputs.pullRequestNumber&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;steps:&lt;/span&gt;
      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;Get information about the current run&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;potiuk/get-workflow-origin@v1_5&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;id:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;workflow-run-info&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;token:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.GITHUB_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
          &lt;span class=&quot;hljs-attr&quot;&gt;sourceRunId:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;github.event.workflow_run.id&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;

      &lt;span class=&quot;hljs-bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;merge&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;pull&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;after&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;terraform&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;apply&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;uses:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;sudo-bot/action-pull-request-merge@v1.2.0&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;with:&lt;/span&gt;
            &lt;span class=&quot;hljs-attr&quot;&gt;github-token:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;secrets.GITHUB_TOKEN&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
            &lt;span class=&quot;hljs-attr&quot;&gt;number:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;${{&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;steps.workflow-run-info.outputs.pullRequestNumber&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will wait until the &lt;code&gt;pr_apply&lt;/code&gt; job completes and as long as it was
successful it&#x27;ll merge the branch!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: As I mentioned earlier, the event based actions do not run in the
context of the pull request which means you cannot test changes to them during
the PR either.  You must merge the &lt;code&gt;on-apply-finished.yml&lt;/code&gt; file to &lt;code&gt;main&lt;/code&gt;
before it starts working.&lt;/p&gt;
&lt;h1&gt;Branch Protection&lt;/h1&gt;
&lt;p&gt;The final step to the process is to make sure you go to your github settings
and make sure these status checks are required before merging. Branch protection
is a feature that will prevent merging changes into a branch unless all
required checks are passing.&lt;/p&gt;
&lt;p&gt;Go to &lt;code&gt;Settings&lt;/code&gt; -&gt; &lt;code&gt;Branches&lt;/code&gt; -&gt; &lt;code&gt;Branch Protection&lt;/code&gt; and add a branch
protection rule:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/branch_protection.png&quot; width=&quot;500&quot;&gt;
&lt;/center&gt;
&lt;p&gt;You want to enable the following settings:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Branch Name&lt;/strong&gt;: main&lt;/li&gt;
&lt;li&gt;✅ Require a pull request before merging&lt;/li&gt;
&lt;li&gt;✅ Require status checks to pass before merging&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Then for &lt;code&gt;Status checks that are required.&lt;/code&gt; select all of the ones we&#x27;ve
created:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_apply_before_merge/required_checks.png&quot; height=&quot;200&quot;&gt;
&lt;/center&gt;
&lt;h1&gt;Next Steps&lt;/h1&gt;
&lt;p&gt;Now that you have the ability to manage your AWS accounts through terraform
via pull request the next step is to start creating infrastructure that can
create real workloads.   In my next post I&#x27;ll show you how to boostrap an
EKS (Kubernetes cluster) using terraform.&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2023/aws_from_scratch_apply_before_merge&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2023/aws_from_scratch_apply_before_merge&lt;/guid&gt;
            &lt;pubDate&gt;Sun, 02 Apr 2023 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[AWS From Scratch with Terraform - Setting up your Root Account for IaC (using Terraform Cloud)]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;Following this article will get you setup with an AWS Root account that can be
managed through through Terraform Cloud with OIDC. As a best practice you
should not keep long-lived access keys in your CI/CD pipelines when
deploying to AWS, instead you should use OIDC (OpenID Connect) to securely
deploy to AWS when using Terraform Cloud or Github Actions.&lt;/p&gt;
&lt;h1&gt;TL;DR&lt;/h1&gt;
&lt;p&gt;Download all the source from the blog post here:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/sontek/aws-terraform-bootstrap&quot;&gt;https://github.com/sontek/aws-terraform-bootstrap&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;How does OIDC work&lt;/h1&gt;
&lt;p&gt;OIDC enables us to request a short-lived access token directly from AWS. We
just have to create trust relationship that controls which workflows are able
to request the access tokens.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No need to duplicate AWS credentials as long-lived GitHub secrets.&lt;/li&gt;
&lt;li&gt;Since we are using a short-lived access token that is only valid for a single
job there is no reason to worry about rotating secrets.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The following diagram gives an overview of how we can use Terraform Cloud&#x27;s
OIDC provider to integrate with AWS:&lt;/p&gt;
&lt;div class=&quot;remark-mermaid remark-mermaid-default&quot;&gt;&lt;svg aria-roledescription=&quot;flowchart-v2&quot; role=&quot;graphics-document document&quot; viewBox=&quot;-8 -8 827.9453125 321.5&quot; style=&quot;max-width: 827.945px; background-color: transparent;&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;100%&quot; id=&quot;mermaid-1680497044662&quot;&gt;&lt;style&gt;#mermaid-1680497044662{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1680497044662 .error-icon{fill:#552222;}#mermaid-1680497044662 .error-text{fill:#552222;stroke:#552222;}#mermaid-1680497044662 .edge-thickness-normal{stroke-width:2px;}#mermaid-1680497044662 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1680497044662 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1680497044662 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1680497044662 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1680497044662 .marker{fill:#333333;stroke:#333333;}#mermaid-1680497044662 .marker.cross{stroke:#333333;}#mermaid-1680497044662 svg{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;}#mermaid-1680497044662 .label{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;color:#333;}#mermaid-1680497044662 .cluster-label text{fill:#333;}#mermaid-1680497044662 .cluster-label span{color:#333;}#mermaid-1680497044662 .label text,#mermaid-1680497044662 span{fill:#333;color:#333;}#mermaid-1680497044662 .node rect,#mermaid-1680497044662 .node circle,#mermaid-1680497044662 .node ellipse,#mermaid-1680497044662 .node polygon,#mermaid-1680497044662 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1680497044662 .node .label{text-align:center;}#mermaid-1680497044662 .node.clickable{cursor:pointer;}#mermaid-1680497044662 .arrowheadPath{fill:#333333;}#mermaid-1680497044662 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1680497044662 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1680497044662 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1680497044662 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1680497044662 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1680497044662 .cluster text{fill:#333;}#mermaid-1680497044662 .cluster span{color:#333;}#mermaid-1680497044662 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1680497044662 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1680497044662 :root{--mermaid-font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;}&lt;/style&gt;&lt;g&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;12&quot; markerWidth=&quot;12&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5&quot; refX=&quot;10&quot; viewBox=&quot;0 0 12 20&quot; class=&quot;marker flowchart&quot; id=&quot;flowchart-pointEnd&quot;&gt;&lt;path style=&quot;stroke-width: 1; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; d=&quot;M 0 0 L 10 5 L 0 10 z&quot;&gt;&lt;/path&gt;&lt;/marker&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;12&quot; markerWidth=&quot;12&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5&quot; refX=&quot;0&quot; viewBox=&quot;0 0 10 10&quot; class=&quot;marker flowchart&quot; id=&quot;flowchart-pointStart&quot;&gt;&lt;path style=&quot;stroke-width: 1; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; d=&quot;M 0 5 L 10 10 L 10 0 z&quot;&gt;&lt;/path&gt;&lt;/marker&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;11&quot; markerWidth=&quot;11&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5&quot; refX=&quot;11&quot; viewBox=&quot;0 0 10 10&quot; class=&quot;marker flowchart&quot; id=&quot;flowchart-circleEnd&quot;&gt;&lt;circle style=&quot;stroke-width: 1; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; r=&quot;5&quot; cy=&quot;5&quot; cx=&quot;5&quot;&gt;&lt;/circle&gt;&lt;/marker&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;11&quot; markerWidth=&quot;11&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5&quot; refX=&quot;-1&quot; viewBox=&quot;0 0 10 10&quot; class=&quot;marker flowchart&quot; id=&quot;flowchart-circleStart&quot;&gt;&lt;circle style=&quot;stroke-width: 1; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; r=&quot;5&quot; cy=&quot;5&quot; cx=&quot;5&quot;&gt;&lt;/circle&gt;&lt;/marker&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;11&quot; markerWidth=&quot;11&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5.2&quot; refX=&quot;12&quot; viewBox=&quot;0 0 11 11&quot; class=&quot;marker cross flowchart&quot; id=&quot;flowchart-crossEnd&quot;&gt;&lt;path style=&quot;stroke-width: 2; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; d=&quot;M 1,1 l 9,9 M 10,1 l -9,9&quot;&gt;&lt;/path&gt;&lt;/marker&gt;&lt;marker orient=&quot;auto&quot; markerHeight=&quot;11&quot; markerWidth=&quot;11&quot; markerUnits=&quot;userSpaceOnUse&quot; refY=&quot;5.2&quot; refX=&quot;-1&quot; viewBox=&quot;0 0 11 11&quot; class=&quot;marker cross flowchart&quot; id=&quot;flowchart-crossStart&quot;&gt;&lt;path style=&quot;stroke-width: 2; stroke-dasharray: 1, 0;&quot; class=&quot;arrowMarkerPath&quot; d=&quot;M 1,1 l 9,9 M 10,1 l -9,9&quot;&gt;&lt;/path&gt;&lt;/marker&gt;&lt;g class=&quot;root&quot;&gt;&lt;g class=&quot;clusters&quot;&gt;&lt;/g&gt;&lt;g class=&quot;edgePaths&quot;&gt;&lt;path marker-end=&quot;url(#flowchart-pointEnd)&quot; style=&quot;fill:none;&quot; class=&quot;edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token&quot; id=&quot;L-AWS-Token-0&quot; d=&quot;M179.515625,135.25L175.34895833333334,135.25C171.18229166666666,135.25,162.84895833333334,135.25,146.6662555830886,146.64583333333334C130.48355283284386,158.04166666666666,106.45148066568771,180.83333333333334,94.43544458210964,192.22916666666666L82.41940849853157,203.625&quot;&gt;&lt;/path&gt;&lt;path marker-end=&quot;url(#flowchart-pointEnd)&quot; style=&quot;fill:none;&quot; class=&quot;edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform&quot; id=&quot;L-Token-Terraform-0&quot; d=&quot;M82.41940849853157,237.125L94.43544458210964,248.52083333333334C106.45148066568771,259.9166666666667,130.48355283284386,282.7083333333333,158.28800037475526,294.1041666666667C186.09244791666666,305.5,217.66927083333334,305.5,249.24609375,305.5C280.8229166666667,305.5,312.3997395833333,305.5,347.5989583333333,305.5C382.7981770833333,305.5,421.6197916666667,305.5,460.44140625,305.5C499.2630208333333,305.5,538.0846354166666,305.5,568.5160074033284,298.2708333333333C598.9473793899903,291.0416666666667,620.9885087799804,276.5833333333333,632.0090734749756,269.3541666666667L643.0296381699707,262.125&quot;&gt;&lt;/path&gt;&lt;path marker-end=&quot;url(#flowchart-pointEnd)&quot; style=&quot;fill:none;&quot; class=&quot;edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT&quot; id=&quot;L-Terraform-JWT-0&quot; d=&quot;M643.0296381699707,178.625L632.0090734749756,171.39583333333334C620.9885087799804,164.16666666666666,598.9473793899903,149.70833333333334,583.7601480283284,142.47916666666666C568.5729166666666,135.25,560.2395833333334,135.25,556.0729166666666,135.25L551.90625,135.25&quot;&gt;&lt;/path&gt;&lt;path marker-end=&quot;url(#flowchart-pointEnd)&quot; style=&quot;fill:none;&quot; class=&quot;edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS&quot; id=&quot;L-JWT-AWS-0&quot; d=&quot;M368.9765625,135.25L364.8098958333333,135.25C360.6432291666667,135.25,352.3098958333333,135.25,343.9765625,135.25C335.6432291666667,135.25,327.3098958333333,135.25,323.1432291666667,135.25L318.9765625,135.25&quot;&gt;&lt;/path&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabels&quot;&gt;&lt;g class=&quot;edgeLabel&quot;&gt;&lt;g transform=&quot;translate(0, 0)&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;0&quot; width=&quot;0&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;edgeLabel&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabel&quot;&gt;&lt;g transform=&quot;translate(0, 0)&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;0&quot; width=&quot;0&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;edgeLabel&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabel&quot;&gt;&lt;g transform=&quot;translate(0, 0)&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;0&quot; width=&quot;0&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;edgeLabel&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabel&quot;&gt;&lt;g transform=&quot;translate(0, 0)&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;0&quot; width=&quot;0&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;edgeLabel&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;nodes&quot;&gt;&lt;g transform=&quot;translate(607.33984375, 170.625)&quot; class=&quot;root&quot;&gt;&lt;g class=&quot;clusters&quot;&gt;&lt;g id=&quot;Terraform&quot; class=&quot;cluster default&quot;&gt;&lt;rect height=&quot;83.5&quot; width=&quot;209.5390625&quot; y=&quot;8&quot; x=&quot;-4.93359375&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-4.93359375, 8)&quot; class=&quot;cluster-label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;209.5390625&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;Terraform Cloud Workflow #2&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;edgePaths&quot;&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabels&quot;&gt;&lt;/g&gt;&lt;g class=&quot;nodes&quot;&gt;&lt;g transform=&quot;translate(99.8359375, 49.75)&quot; id=&quot;flowchart-OIDCProvider-23&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;113.671875&quot; y=&quot;-16.75&quot; x=&quot;-56.8359375&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-49.3359375, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;98.671875&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;OIDC Provider&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;g transform=&quot;translate(172.015625, -8)&quot; class=&quot;root&quot;&gt;&lt;g class=&quot;clusters&quot;&gt;&lt;g id=&quot;AWS&quot; class=&quot;cluster default&quot;&gt;&lt;rect height=&quot;270.5&quot; width=&quot;139.4609375&quot; y=&quot;8&quot; x=&quot;8&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(52.25, 8)&quot; class=&quot;cluster-label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;50.9609375&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;AWS #1&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;g class=&quot;edgePaths&quot;&gt;&lt;/g&gt;&lt;g class=&quot;edgeLabels&quot;&gt;&lt;/g&gt;&lt;g class=&quot;nodes&quot;&gt;&lt;g transform=&quot;translate(77.73046875, 59.75)&quot; id=&quot;flowchart-OIDC-20&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;89.4609375&quot; y=&quot;-16.75&quot; x=&quot;-44.73046875&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-37.23046875, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;74.4609375&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;OIDC Trust&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g transform=&quot;translate(77.73046875, 143.25)&quot; id=&quot;flowchart-Roles-21&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;52.171875&quot; y=&quot;-16.75&quot; x=&quot;-26.0859375&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-18.5859375, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;37.171875&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;Roles&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g transform=&quot;translate(77.73046875, 226.75)&quot; id=&quot;flowchart-Resources-22&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;85.5390625&quot; y=&quot;-16.75&quot; x=&quot;-42.76953125&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-35.26953125, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;70.5390625&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;Resources&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;g transform=&quot;translate(64.7578125, 220.375)&quot; id=&quot;flowchart-Token-25&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;129.515625&quot; y=&quot;-16.75&quot; x=&quot;-64.7578125&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-57.2578125, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;114.515625&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;Access Token #4&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;g transform=&quot;translate(460.44140625, 135.25)&quot; id=&quot;flowchart-JWT-28&quot; class=&quot;node default default&quot;&gt;&lt;rect height=&quot;33.5&quot; width=&quot;182.9296875&quot; y=&quot;-16.75&quot; x=&quot;-91.46484375&quot; ry=&quot;0&quot; rx=&quot;0&quot; style=&quot;&quot; class=&quot;basic label-container&quot;&gt;&lt;/rect&gt;&lt;g transform=&quot;translate(-83.96484375, -9.25)&quot; style=&quot;&quot; class=&quot;label&quot;&gt;&lt;foreignObject height=&quot;18.5&quot; width=&quot;167.9296875&quot;&gt;&lt;div style=&quot;display: inline-block; white-space: nowrap;&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;span class=&quot;nodeLabel&quot;&gt;JWT &amp;#x26; Cloud Role ID #3&lt;/span&gt;&lt;/div&gt;&lt;/foreignObject&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;/g&gt;&lt;/svg&gt;&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;In AWS, create an OIDC trust between a role and our terraform cloud
workflow(s) that need access to the cloud.&lt;/li&gt;
&lt;li&gt;Every time a job runs, TFC&#x27;s OIDC Provider auto-generates an OIDC token.
This token contains multiple claims to establish a security-hardened and
verifiable identity about the specific workflow that is trying to authenticate.&lt;/li&gt;
&lt;li&gt;Request this token from TFC&#x27;s OIDC provider, and present it to AWS&lt;/li&gt;
&lt;li&gt;Once AWS successfully validates the claims presented in the token, it then
provides a short-lived cloud access token that is available only for the duration
of the job.&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;What does this post accomplish&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Setup a root AWS account that is managed througuh terraform&lt;/li&gt;
&lt;li&gt;Setup OIDC authentication with Terraform Cloud so it can talk to AWS&lt;/li&gt;
&lt;li&gt;Setup Github Actions authentication with Terraform Cloud so we can run plan
and apply through the CI/CD pipeline.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Setup AWS Access&lt;/h1&gt;
&lt;p&gt;It is very bad practice to use the root account for much of anything but for
bootstrapping the account it is necessary, so the first step is to get your
&lt;code&gt;AWS_ACCESS_KEY_ID&lt;/code&gt; and &lt;code&gt;AWS_SECRET_ACCESS_KEY&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;To do this click your account and choose &lt;code&gt;Security Credentials&lt;/code&gt; in the top
right:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/security_credentials.png&quot; height=&quot;200&quot;&gt;
&lt;/center&gt;
&lt;p&gt;Then choose &lt;code&gt;Create Access key&lt;/code&gt;:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/create_access_token.png&quot; width=&quot;200&quot;&gt;
&lt;/center&gt;
&lt;p&gt;You need to set these environment variables in your shell so that your local
shell has access to AWS. After you set them you can verify you set them correct
by running:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ aws sts get-caller-identity
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and you should get a result similar to:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-json&quot;&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;&quot;UserId&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;777777777777&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;&quot;Account&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;888888888888&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;&quot;Arn&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;arn:aws:iam::888888888888:root&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-punctuation&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Bootstrap&lt;/h2&gt;
&lt;p&gt;Before you can manage any of your accounts through Terraform Cloud you&#x27;ll need
bootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate
securely and manage AWS Resources on your behalf.&lt;/p&gt;
&lt;p&gt;I personally prefer doing this in two repositories:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;infra-bootstrap&lt;/code&gt;: This repository does the bare minimum to hook up terraform
cloud with your AWS account and stores the state in git.  Its the only infra
that will not be controlled by your CI/CD pipeline.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;infra&lt;/code&gt;: The actual repository where all the rest of your AWS resources are
managed.  It will store state in Terraform Cloud and you can introduce a
CI/CD pipeline for approving changes.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: This repository will be generated with the terraform code.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;After manually creating the git repository &lt;code&gt;infra-boostrap&lt;/code&gt; in your Github
account We will need 3 providers to bootstrap the account &lt;code&gt;aws&lt;/code&gt;, &lt;code&gt;github&lt;/code&gt;, and
&lt;code&gt;tfe&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Variables&lt;/h3&gt;
&lt;p&gt;Create a &lt;code&gt;1-variables.tf&lt;/code&gt; where we can define the variables we&#x27;ll need
for creating these resources.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_aws_audience&quot;&lt;/span&gt; {
  type        = string
  default     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws.workload.identity&quot;&lt;/span&gt;
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The audience value to use in run identity tokens&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_hostname&quot;&lt;/span&gt; {
  type        = string
  default     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;app.terraform.io&quot;&lt;/span&gt;
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The hostname of the TFC or TFE instance you&#x27;d like to use with AWS&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_project_name&quot;&lt;/span&gt; {
  type        = string
  default     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Default Project&quot;&lt;/span&gt;
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The project under which a workspace will be created&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_organization_name&quot;&lt;/span&gt; {
  type        = string
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The name of your Terraform Cloud organization&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_organization_owner&quot;&lt;/span&gt; {
  type        = string
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The owner of the TFC organization&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_workspaces&quot;&lt;/span&gt; {
  type        = list(string)
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The list of TFC workspaces&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_organization&quot;&lt;/span&gt; {
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The organization the repositories are owned by&quot;&lt;/span&gt;
  type        = string
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_repo_name&quot;&lt;/span&gt; {
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The name of the git reppository we&#x27;ll create for managing infra&quot;&lt;/span&gt;
  type        = string
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_default_branch&quot;&lt;/span&gt; {
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The default branch to utilize&quot;&lt;/span&gt;
  type        = string
  default     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;main&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_oauth_client_id&quot;&lt;/span&gt; {
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The token for the TFC OAuth client shown under VCS providers&quot;&lt;/span&gt;
  type        = string
  default     = null
}

&lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_root_account_id&quot;&lt;/span&gt; {
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;The AWS root account we want to apply these changes to&quot;&lt;/span&gt;
  type        = string
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We will use these variables in the later modules but they are mostly metadata
around the terraform and github accounts you&#x27;ll need to setup manually.&lt;/p&gt;
&lt;h3&gt;Providers&lt;/h3&gt;
&lt;p&gt;Create a file called &lt;code&gt;2-main.tf&lt;/code&gt; and define the providers:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; {
  required_providers {
    tfe = {
      source  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;hashicorp/tfe&quot;&lt;/span&gt;
      version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;0.41.0&quot;&lt;/span&gt;
    }

    aws = {
      source  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;hashicorp/aws&quot;&lt;/span&gt;
      version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;4.58.0&quot;&lt;/span&gt;
    }

    github = {
      source  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;integrations/github&quot;&lt;/span&gt;
      version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;5.18.3&quot;&lt;/span&gt;
    }
  }
}

&lt;span class=&quot;hljs-keyword&quot;&gt;provider&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws&quot;&lt;/span&gt; {
  region = &lt;span class=&quot;hljs-string&quot;&gt;&quot;us-east-1&quot;&lt;/span&gt;

  &lt;span class=&quot;hljs-comment&quot;&gt;# Root account, all other accounts should be provisioned&lt;/span&gt;
  &lt;span class=&quot;hljs-comment&quot;&gt;# via pull requests&lt;/span&gt;
  allowed_account_ids = [var.aws_root_account_id]
}

&lt;span class=&quot;hljs-keyword&quot;&gt;provider&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github&quot;&lt;/span&gt; {
  owner = var.github_organization
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The key things there are we define &lt;code&gt;allowed_account_ids&lt;/code&gt; to prevent us from
working against any account that isn&#x27;t the root and we are using one of the
variables we defines earlier.&lt;/p&gt;
&lt;h3&gt;Github&lt;/h3&gt;
&lt;p&gt;We will utilize &lt;code&gt;terraform&lt;/code&gt; to create the second git repository where the rest
of the infrastructure will go. Create a file called &lt;code&gt;3-github.tf&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_repository&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;repo&quot;&lt;/span&gt; {
  name        = var.github_repo_name
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Infrastructure Repository&quot;&lt;/span&gt;
  visibility  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;private&quot;&lt;/span&gt;
  auto_init   = true
  has_issues  = true
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github_branch_default&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;default&quot;&lt;/span&gt; {
  repository = github_repository.repo.name
  branch     = var.github_default_branch
}

&lt;span class=&quot;hljs-keyword&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;repository_id&quot;&lt;/span&gt; {
  value = github_repository.repo.id
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will generate a new repository in your account called &lt;code&gt;infra&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Terraform Cloud&lt;/h3&gt;
&lt;p&gt;Now we need to setup dynamic credentials so the terraform cloud agent is
allowed to take actions on your behalf.   To do this we&#x27;ll setup an IAM
role and an OIDC provider. Create a file called &lt;code&gt;4-tfc.tf&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_organization&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;organization&quot;&lt;/span&gt; {
  name  = var.tfc_organization_name
  email = var.tfc_organization_owner
}

/* AWS will use this TLS certificate to verify that requests for dynamic
credentials come from Terraform Cloud.*/
&lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tls_certificate&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_certificate&quot;&lt;/span&gt; {
  url = &lt;span class=&quot;hljs-string&quot;&gt;&quot;https://&lt;span class=&quot;hljs-variable&quot;&gt;${var.tfc_hostname}&lt;/span&gt;&quot;&lt;/span&gt;
}

/* sets up an OIDC &lt;span class=&quot;hljs-keyword&quot;&gt;provider&lt;/span&gt; in AWS with Terraform Cloud&#x27;s TLS certificate,
the SHA1 fingerprint from the TLS certificate 
*/
&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_openid_connect_provider&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc_provider&quot;&lt;/span&gt; {
  url            = &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.tls_certificate.tfc_certificate.url
  client_id_list = [var.tfc_aws_audience]
  thumbprint_list = [
    &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.tls_certificate.tfc_certificate.certificates[&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;].sha1_fingerprint
  ]
}

/* Policy to allow TFC to assume the AWS IAM role in our account */
&lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_policy_document&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;assume_role&quot;&lt;/span&gt; {
  statement {
    effect = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;

    principals {
      type        = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Federated&quot;&lt;/span&gt;
      identifiers = [aws_iam_openid_connect_provider.tfc_provider.arn]
    }
    condition {
      test     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;StringEquals&quot;&lt;/span&gt;
      &lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; = &lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;span class=&quot;hljs-variable&quot;&gt;${var.tfc_hostname}&lt;/span&gt;:aud&quot;&lt;/span&gt;

      values = [
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;span class=&quot;hljs-variable&quot;&gt;${&lt;span class=&quot;hljs-meta&quot;&gt;one(aws_iam_openid_connect_provider.tfc_provider.client_id_list)&lt;/span&gt;}&lt;/span&gt;&quot;&lt;/span&gt;
      ]
    }

    condition {
      test     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;StringLike&quot;&lt;/span&gt;
      &lt;span class=&quot;hljs-keyword&quot;&gt;variable&lt;/span&gt; = &lt;span class=&quot;hljs-string&quot;&gt;&quot;&lt;span class=&quot;hljs-variable&quot;&gt;${var.tfc_hostname}&lt;/span&gt;:sub&quot;&lt;/span&gt;

      values = [
        for workspace in var.tfc_workspaces : &lt;span class=&quot;hljs-string&quot;&gt;&quot;organization:&lt;span class=&quot;hljs-variable&quot;&gt;${tfe_organization.organization.name}&lt;/span&gt;:project:&lt;span class=&quot;hljs-variable&quot;&gt;${var.tfc_project_name}&lt;/span&gt;:workspace:&lt;span class=&quot;hljs-variable&quot;&gt;${workspace}&lt;/span&gt;:run_phase:*&quot;&lt;/span&gt;
      ]
    }
    actions = [&lt;span class=&quot;hljs-string&quot;&gt;&quot;sts:AssumeRoleWithWebIdentity&quot;&lt;/span&gt;]
  }
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_role&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-agent&quot;&lt;/span&gt; {
  name               = &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-agent&quot;&lt;/span&gt;
  assume_role_policy = &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.aws_iam_policy_document.assume_role.json
}

/* Policy for what the TFC agent is allowed to do */
&lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_policy_document&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-agent&quot;&lt;/span&gt; {
  version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;

  statement {
    actions   = [&lt;span class=&quot;hljs-string&quot;&gt;&quot;*&quot;&lt;/span&gt;]
    effect    = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;
    resources = [&lt;span class=&quot;hljs-string&quot;&gt;&quot;*&quot;&lt;/span&gt;]
  }
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_policy&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-agent&quot;&lt;/span&gt; {
  name        = &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-agent-access-policy&quot;&lt;/span&gt;
  description = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Access policy for the TFC agent&quot;&lt;/span&gt;
  policy      = &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.aws_iam_policy_document.tfc-agent.json
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_iam_role_policy_attachment&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-access-attach&quot;&lt;/span&gt; {
  role       = aws_iam_role.tfc-agent.name
  policy_arn = aws_iam_policy.tfc-agent.arn
}

/* Fetch an oauth token from the client */
&lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_oauth_client&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;github&quot;&lt;/span&gt; {
  /* Don&#x27;t fetch the client if we don&#x27;t have the client_id */
  count           = var.github_oauth_client_id != null ? &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; : &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
  oauth_client_id = var.github_oauth_client_id
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_workspace&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;workspaces&quot;&lt;/span&gt; {
  count        = length(var.tfc_workspaces)
  name         = var.tfc_workspaces[count.index]
  organization = tfe_organization.organization.name

  working_directory = var.tfc_workspaces[count.index]

  /* This generates a webhook on the github repository so plans are triggered
  automatically.   We dynamically set the setting because we will not have the
  oauth client ID on first pass.
  */
  dynamic &lt;span class=&quot;hljs-string&quot;&gt;&quot;vcs_repo&quot;&lt;/span&gt; {
    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []
    content {
      identifier     = format(&lt;span class=&quot;hljs-string&quot;&gt;&quot;%s/%s&quot;&lt;/span&gt;, var.github_organization, github_repository.repo.name)
      oauth_token_id = &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt;.tfe_oauth_client.github[&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;].oauth_token_id
    }
  }
}

/* These variables tell the agent to use dynamic credentials */
&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_variable&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-auth&quot;&lt;/span&gt; {
  count        = length(var.tfc_workspaces)
  key          = &lt;span class=&quot;hljs-string&quot;&gt;&quot;TFC_AWS_PROVIDER_AUTH&quot;&lt;/span&gt;
  value        = true
  category     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;env&quot;&lt;/span&gt;
  workspace_id = tfe_workspace.workspaces[count.index].id
  description  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Enable dynamic auth on the TFC agents&quot;&lt;/span&gt;
}

&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_variable&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfc-role&quot;&lt;/span&gt; {
  count        = length(var.tfc_workspaces)
  key          = &lt;span class=&quot;hljs-string&quot;&gt;&quot;TFC_AWS_RUN_ROLE_ARN&quot;&lt;/span&gt;
  value        = aws_iam_role.tfc-agent.arn
  category     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;env&quot;&lt;/span&gt;
  workspace_id = tfe_workspace.workspaces[count.index].id
  description  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Tell TFC what Role to run as&quot;&lt;/span&gt;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This module is dynamic because there is one piece that will require a
manul oauth setup for github.  So the first pass will apply without it
and then later on we&#x27;ll create it and run the apply again.&lt;/p&gt;
&lt;h2&gt;Applying the changes&lt;/h2&gt;
&lt;p&gt;Now we just need to define our settings for the module and we&#x27;ll get our
infrastructure applied.  Create a file called &lt;code&gt;settings.auto.tfvars&lt;/code&gt; and
populate it with the content for your account.  This is an example of what
this should look like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;tfc_organization_name  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;sontek&quot;&lt;/span&gt;
tfc_organization_owner = &lt;span class=&quot;hljs-string&quot;&gt;&quot;john@sontek.net&quot;&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;# The workspaces you want to create and be able to manage with IaC&lt;/span&gt;
tfc_workspaces = [
  &lt;span class=&quot;hljs-string&quot;&gt;&quot;root&quot;&lt;/span&gt;
]
&lt;span class=&quot;hljs-comment&quot;&gt;# this can be your username&lt;/span&gt;
github_organization    = &lt;span class=&quot;hljs-string&quot;&gt;&quot;sontek&quot;&lt;/span&gt;
github_repo_name       = &lt;span class=&quot;hljs-string&quot;&gt;&quot;sontek-infra&quot;&lt;/span&gt;
aws_root_account_id    =  &lt;span class=&quot;hljs-string&quot;&gt;&quot;888888888888&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now run:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ terraform login
❯ terraform init
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and you should see:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs&quot;&gt;Terraform has been successfully initialized!
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now lets run our plan:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;❯ &lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; plan
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You should see a result:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-vbnet&quot;&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;Plan:&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;to&lt;/span&gt; add, &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;to&lt;/span&gt; change, &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;to&lt;/span&gt; destroy.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Apply it to make those resources:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;❯ &lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; apply
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point it:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Created a terraform cloud organization&lt;/li&gt;
&lt;li&gt;Created a terraform cloud workspace&lt;/li&gt;
&lt;li&gt;Created a git repository&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;Verify TFC can talk to AWS&lt;/h1&gt;
&lt;p&gt;To verify that TFC can communicate with AWS through the dynamic credentials,
lets clone the repository and make some dummy resources. After you&#x27;ve cloned
the repository lets make a folder for the workspace &lt;code&gt;root&lt;/code&gt; that we defined in
bootstrap:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; root
❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cd&lt;/span&gt; root
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now create a &lt;code&gt;1-providers.tf&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; {
  cloud {
    organization = &lt;span class=&quot;hljs-string&quot;&gt;&quot;sontek&quot;&lt;/span&gt;

    workspaces {
      name = &lt;span class=&quot;hljs-string&quot;&gt;&quot;root&quot;&lt;/span&gt;
    }
  }

  required_providers {
    aws = {
      source  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;hashicorp/aws&quot;&lt;/span&gt;
      version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;4.58.0&quot;&lt;/span&gt;
    }

    tfe = {
      source  = &lt;span class=&quot;hljs-string&quot;&gt;&quot;hashicorp/tfe&quot;&lt;/span&gt;
      version = &lt;span class=&quot;hljs-string&quot;&gt;&quot;0.42.0&quot;&lt;/span&gt;
    }
  }
}

&lt;span class=&quot;hljs-keyword&quot;&gt;provider&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws&quot;&lt;/span&gt; {
  region = &lt;span class=&quot;hljs-string&quot;&gt;&quot;us-east-1&quot;&lt;/span&gt;

  default_tags {
    tags = {
      Owner   = &lt;span class=&quot;hljs-string&quot;&gt;&quot;john@sontek.net&quot;&lt;/span&gt;
      Env     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;Root&quot;&lt;/span&gt;
      Service = &lt;span class=&quot;hljs-string&quot;&gt;&quot;BusinessOperations&quot;&lt;/span&gt;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: You should replace &lt;code&gt;organization&lt;/code&gt;, &lt;code&gt;workspaces.name&lt;/code&gt;, and
&lt;code&gt;tags.Owner&lt;/code&gt; to be your own values.&lt;/p&gt;
&lt;p&gt;Now create a small resource to prove everything is working, we&#x27;ll use SQS for
this. Create a file called &lt;code&gt;2-sqs.tf&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;resource&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;aws_sqs_queue&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;example-sqs&quot;&lt;/span&gt; {
  name                        = &lt;span class=&quot;hljs-string&quot;&gt;&quot;example-sqs&quot;&lt;/span&gt;
  message_retention_seconds = &lt;span class=&quot;hljs-number&quot;&gt;86400&lt;/span&gt;
  receive_wait_time_seconds = &lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you run the plan you should see the resource it wants to create:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ terraform init
❯ terraform plan

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and you should see the run is executing in terraform cloud:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;Running plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C
will stop streaming the logs, but will &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; stop the plan running remotely.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can click the link it provides to see the logs. Now lets apply this
resource to see it all working:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;❯ &lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; apply
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You should get a response like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;Apply&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;complete!&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;Resources:&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;added,&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;changed,&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;destroyed.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So Terraform Cloud has full access to create AWS resources!   The final step
is to get github running the plan/apply on pull requests. Commit these files
to your repository and we&#x27;ll remove them in a pull request. Create a
&lt;code&gt;.gitignore&lt;/code&gt; file in the root:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;.&lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt;*
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and commit all the files:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ git add *
❯ git commit -m &lt;span class=&quot;hljs-string&quot;&gt;&quot;initial infra&quot;&lt;/span&gt;
❯ git push origin &lt;span class=&quot;hljs-built_in&quot;&gt;head&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Github VCS Provider&lt;/h1&gt;
&lt;p&gt;To setup oauth between github and terraform cloud so it can manage the webhooks
you need to login to the [https://app.terraform.io](Terraform Cloud Console) and
initiate the connection.&lt;/p&gt;
&lt;p&gt;Select the newly created organization and then click &lt;code&gt;Settings&lt;/code&gt;.  In the sidebar
there will be a section &lt;code&gt;Version Control&lt;/code&gt; and you want to select &lt;code&gt;Providers&lt;/code&gt; under
that.&lt;/p&gt;
&lt;p&gt;At this point you should see an &lt;code&gt;Add a VCS Provider&lt;/code&gt; button, you want to select
&lt;code&gt;Github.com (Custom)&lt;/code&gt;:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/tfc_vcs_provider.png&quot; height=&quot;250&quot;&gt;
&lt;/center&gt;
&lt;p&gt;Follow the on-screen instructions to create a new GitHub OAuth application on your
account. For me, I went to &lt;a href=&quot;https://github.com/settings/applications/new&quot;&gt;here&lt;/a&gt; and
provided the information TFC displayed:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/tfc_github_app.png&quot; height=&quot;300&quot;&gt;
&lt;/center&gt;
&lt;p&gt;On the Github side you need to save the &lt;code&gt;Client ID&lt;/code&gt; and you need to click
&lt;code&gt;Generate a new client secret&lt;/code&gt;.   Provide those details to terraform cloud and
then we should be ready to send our first PR!&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/tfc_oauth_settings.png&quot; height=&quot;300&quot;&gt;
&lt;/center&gt;
&lt;h2&gt;Finish Bootstrap&lt;/h2&gt;
&lt;p&gt;At this point we need to return to the bootstrap repository and provide it the
new OAuth Client ID for its &lt;code&gt;github_oauth_client_id&lt;/code&gt; setting.  To get the value
for this the easiest way is to drill into the VCS provider in terraform and click
&lt;code&gt;Edit Client&lt;/code&gt;.   In the URL you&#x27;ll see the Client ID, it should start with
&lt;code&gt;oc-...&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now return back to the &lt;code&gt;bootstrap&lt;/code&gt; repository and edit &lt;code&gt;settings.auto.tfvars&lt;/code&gt; and
set the final setting:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;github_oauth_client_id&lt;/span&gt; = &lt;span class=&quot;hljs-string&quot;&gt;&quot;oc-......&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now you should be able to run a plan and see the &lt;code&gt;vcs_repo&lt;/code&gt; get added in-place:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ terraform plan

  ~ update in-place

Terraform will perform the following actions:

  &lt;span class=&quot;hljs-comment&quot;&gt;# tfe_workspace.workspaces[0] will be updated in-place&lt;/span&gt;
  ~ resource &lt;span class=&quot;hljs-string&quot;&gt;&quot;tfe_workspace&quot;&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;workspaces&quot;&lt;/span&gt; {
        &lt;span class=&quot;hljs-built_in&quot;&gt;id&lt;/span&gt;                            = &lt;span class=&quot;hljs-string&quot;&gt;&quot;ws-...&quot;&lt;/span&gt;
        name                          = &lt;span class=&quot;hljs-string&quot;&gt;&quot;root&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-comment&quot;&gt;# (20 unchanged attributes hidden)&lt;/span&gt;

      + vcs_repo {
          + identifier         = &lt;span class=&quot;hljs-string&quot;&gt;&quot;sontek/sontek-infra&quot;&lt;/span&gt;
          + ingress_submodules = &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;
          + oauth_token_id     = &lt;span class=&quot;hljs-string&quot;&gt;&quot;ot-...&quot;&lt;/span&gt;
        }
    }

Plan: 0 to add, 1 to change, 0 to destroy.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Apply the change!&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-hcl&quot;&gt;❯ &lt;span class=&quot;hljs-keyword&quot;&gt;terraform&lt;/span&gt; apply
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After you apply the change, if you go to &lt;code&gt;Settings&lt;/code&gt; -&gt; &lt;code&gt;Webhooks&lt;/code&gt; of the &lt;code&gt;infra&lt;/code&gt;
repository that was created earlier you should see a new terraform cloud webhook
was created.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/aws_root_account/github_webhooks.png&quot; width=&quot;350&quot;&gt;
&lt;/center&gt;
&lt;h1&gt;Send your first pull request&lt;/h1&gt;
&lt;p&gt;Now you should be able to send a pull request tearing down the SQS resource we
generated at the beginning and terraform cloud will take care of the rest! Make
sure you are on the generated &lt;code&gt;infra&lt;/code&gt; repo and:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;rm&lt;/span&gt; root/sqs.tf
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and commit / push that to a branch and open a pull request. When you merge it
will apply the changes.&lt;/p&gt;
&lt;h1&gt;Next Steps&lt;/h1&gt;
&lt;p&gt;This should be good enough for you to manage your AWS cloud infrastructure as
code with terraform but I &lt;strong&gt;personally&lt;/strong&gt; don&#x27;t like that terraform cloud applies
the changes on merge.  There are a lot of ways where a &lt;code&gt;plan&lt;/code&gt; can succeed but an
&lt;code&gt;apply&lt;/code&gt; will fail and you end up with broken configuration in &lt;code&gt;main&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I prefer a worfklow called &lt;code&gt;apply-before-merge&lt;/code&gt; and in my next post I&#x27;ll show you
how to do that through github actions instead of utilizing the TFC webhook.&lt;/p&gt;
&lt;p&gt;Check out that post &lt;a href=&quot;/blog/2023/aws_from_scratch_apply_before_merge&quot;&gt;here&lt;/a&gt;!&lt;/p&gt;
&lt;h1&gt;Helpful Resources&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform&quot;&gt;Terraform Dynamic Credentials Tutorial&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration&quot;&gt;Terraform docs on Dynamic Credentials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token&quot;&gt;Github&#x27;s understanding OIDC&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2023/aws_from_scratch_root_account&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2023/aws_from_scratch_root_account&lt;/guid&gt;
            &lt;pubDate&gt;Sat, 01 Apr 2023 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[How to speak spanish like a colombian drug lord!]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;I&#x27;ve been living in Puerto Rico for 4 years but two of those have been COVID and so I haven&#x27;t been able to practice Spanish as much as I&#x27;d like. So to speed up my learning I&#x27;ve decided I want to watch a lot of spanish speaking television to start training my ears, but to do this I need a baseline of words I understand to be able to even know what they are saying!&lt;/p&gt;
&lt;p&gt;Learning through apps like Duolingo, Drops, etc start with weird topics like vegetables that don&#x27;t get you to a very good baseline for actually understanding daily conversations, so I think consuming TV is a better use of my time.&lt;/p&gt;
&lt;h2&gt;Subtitles&lt;/h2&gt;
&lt;p&gt;I&#x27;ve decided the way to understand what the best words to study are is to download every subtitle for every episode of a show I want to watch and then count each word.  The more a word is spoken the more important it is for me to know it since I&#x27;ll be hearing it a lot in the show.&lt;/p&gt;
&lt;p&gt;I&#x27;m going to download subtitles from Netflix. Subtitles in Netflix are in WebVTT format, which looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;&lt;span class=&quot;hljs-number&quot;&gt;248&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;17&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;58.285&lt;/span&gt; --&gt; &lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01.163&lt;/span&gt;  position:&lt;span class=&quot;hljs-number&quot;&gt;50.00&lt;/span&gt;%,middle  align:middle size:&lt;span class=&quot;hljs-number&quot;&gt;80.00&lt;/span&gt;%  line:&lt;span class=&quot;hljs-number&quot;&gt;79.33&lt;/span&gt;% 
Yo de verdad espero que ustedes
me vean como una amiga, ¿mmm?

&lt;span class=&quot;hljs-number&quot;&gt;249&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01.247&lt;/span&gt; --&gt; &lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;02.539&lt;/span&gt;  position:&lt;span class=&quot;hljs-number&quot;&gt;50.00&lt;/span&gt;%,middle  align:middle size:&lt;span class=&quot;hljs-number&quot;&gt;80.00&lt;/span&gt;%  line:&lt;span class=&quot;hljs-number&quot;&gt;84.67&lt;/span&gt;% 
No como una madrastra.

&lt;span class=&quot;hljs-number&quot;&gt;250&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;04.250&lt;/span&gt; --&gt; &lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;06.127&lt;/span&gt;  position:&lt;span class=&quot;hljs-number&quot;&gt;50.00&lt;/span&gt;%,middle  align:middle size:&lt;span class=&quot;hljs-number&quot;&gt;80.00&lt;/span&gt;%  line:&lt;span class=&quot;hljs-number&quot;&gt;84.67&lt;/span&gt;% 
Yo nunca te vi como una madrastra.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It gives you a start time, end time, and the text on the screen.   So my first process was parsing this format and just turning it into a list of words using https://github.com/glut23/webvtt-py.&lt;/p&gt;
&lt;h3&gt;Dummy parsing&lt;/h3&gt;
&lt;p&gt;What I basically did was &lt;code&gt;text.split(&quot; &quot;)&lt;/code&gt; and started counting the words.   This approach was quick and painless but it had a few downs falls.    Some words &lt;em&gt;look&lt;/em&gt; the same when in reality they are not and so this meant I&#x27;d have to study every meaning of a word even if it was more rare.&lt;/p&gt;
&lt;p&gt;An example of this is the word &quot;como&quot;, you can say:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Haz como te digo: &quot;Do as I say&quot;, where como means &quot;as&quot;&lt;/li&gt;
&lt;li&gt;como tacos todos los dias: &quot;I eat tacos every day&quot;, where como is a conjugated form of the verb &quot;to eat&quot;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I need to know which version of a word is being used so I can count it properly.&lt;/p&gt;
&lt;h3&gt;Regular Expressions are always the answer&lt;/h3&gt;
&lt;p&gt;I couldn&#x27;t figure out what the word was without it being in a complete sentence, but subtitles are fragments.   They are split up into timings for displaying on the screen but they don&#x27;t include entire sentences.  For example, it might look like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;&lt;span class=&quot;hljs-number&quot;&gt;23&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;21.960&lt;/span&gt; --&gt; &lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;23.520&lt;/span&gt;  position:&lt;span class=&quot;hljs-number&quot;&gt;50.00&lt;/span&gt;%,middle  align:middle size:&lt;span class=&quot;hljs-number&quot;&gt;80.00&lt;/span&gt;%  line:&lt;span class=&quot;hljs-number&quot;&gt;84.67&lt;/span&gt;% 
Solo las que luchan por ellos

&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;23.680&lt;/span&gt; --&gt; &lt;span class=&quot;hljs-number&quot;&gt;00&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;01&lt;/span&gt;:&lt;span class=&quot;hljs-number&quot;&gt;25.680&lt;/span&gt;  position:&lt;span class=&quot;hljs-number&quot;&gt;50.00&lt;/span&gt;%,middle  align:middle size:&lt;span class=&quot;hljs-number&quot;&gt;80.00&lt;/span&gt;%  line:&lt;span class=&quot;hljs-number&quot;&gt;84.67&lt;/span&gt;% 
consiguen sus sueños.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I want to detect the start of a sentence and the end of a sentence and then combine it, so that you end up with &quot;Solo las que luchan por ellos consiguen sus sueños.&quot;.   My first thought was a regular expression on punctuation.   This worked well &lt;em&gt;most&lt;/em&gt; of the time but there were enough exceptions to the rule that it broke often on generated a lot of broken sentences:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Abbreviations like &quot;EE. UU&quot; for estados unidos (united states)&lt;/li&gt;
&lt;li&gt;Ellipsis&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Splitting on spaces also didn&#x27;t work for identifying the parts of speech since I needed the context around the word.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/regex-extraction.png&quot;&gt;
&lt;/center&gt;
&lt;h2&gt;Natural Language Processing&lt;/h2&gt;
&lt;p&gt;So to solve my pain I decided to grab https://spacy.io/ and do some NLP on the subtitles so that I could identify the proper parts of speech and get an accurate representation of the words I needed to learn.&lt;/p&gt;
&lt;p&gt;The way spaCy works is you can send it a sentence and it&#x27;ll return you a set of tokens:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;&gt;&gt;&gt; &lt;/span&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; spacy
&lt;span class=&quot;hljs-meta&quot;&gt;&gt;&gt;&gt; &lt;/span&gt;nlp = spacy.load(&lt;span class=&quot;hljs-string&quot;&gt;&quot;es_core_news_sm&quot;&lt;/span&gt;)
&lt;span class=&quot;hljs-meta&quot;&gt;&gt;&gt;&gt; &lt;/span&gt;[x.pos_ &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; x &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; nlp(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Hola, como estas?&quot;&lt;/span&gt;)]
[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;PROPN&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;PUNCT&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;SCONJ&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;PRON&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;PUNCT&#x27;&lt;/span&gt;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So now I could identify the parts of speech and pull sentences together through end of sentence punctation.   The first thing I did was generate a CSV of sentences that looked like this:&lt;/p&gt;
&lt;table&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;th&gt;sentence&lt;/th&gt;
&lt;th&gt;start&lt;/th&gt;
&lt;th&gt;end&lt;/th&gt;
&lt;th&gt;show&lt;/th&gt;
&lt;th&gt;file&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Si no, le voy a cortar todos los deditos&lt;/td&gt;
&lt;td&gt;00:00:20.605&lt;/td&gt;
&lt;td&gt;00:00:24.125&lt;/td&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;El marginal S02E02 WEBRip Netflix es[cc].vtt&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;Once I had a CSV of sentences I could send those back through spaCy for NLP and then start counting words, to generate another CSV:&lt;/p&gt;
&lt;table&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;th&gt;word&lt;/th&gt;
&lt;th&gt;pos&lt;/th&gt;
&lt;th&gt;show&lt;/th&gt;
&lt;th&gt;file&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;a&lt;/td&gt;
&lt;td&gt;ADP&lt;/td&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;El marginal S02E02 WEBRip Netflix es[cc].vtt&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;cortar&lt;/td&gt;
&lt;td&gt;VERB&lt;/td&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;El marginal S02E02 WEBRip Netflix es[cc].vtt&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;todos&lt;/td&gt;
&lt;td&gt;PRON&lt;/td&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;El marginal S02E02 WEBRip Netflix es[cc].vtt&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;From there I had all the data I needed!   So now it was time to start doing some data analysis!&lt;/p&gt;
&lt;h2&gt;Data analysis&lt;/h2&gt;
&lt;p&gt;Using a jupyter notebook ( https://jupyter.org/ ) I grabbed pandas ( https://pandas.pydata.org/ ) and read in my CSVs to start analyzing the results.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-javascript&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; numpy &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; np
&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; pd
&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; matplotlib.&lt;span class=&quot;hljs-property&quot;&gt;pyplot&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; plt
pd.&lt;span class=&quot;hljs-title function_&quot;&gt;set_option&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;display.max_rows&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;1000&lt;/span&gt;)
words = pd.&lt;span class=&quot;hljs-title function_&quot;&gt;read_csv&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word_data.csv.gz&#x27;&lt;/span&gt;, compression=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;gzip&#x27;&lt;/span&gt;, delimiter=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;,&#x27;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The words dataframe is built up out of the second table I showed above with just words and their parts of speech.   I started off grouping the dataset by the word so I could get a count for how many times it was spoken in every series I parsed:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;grouped_result&lt;/span&gt; = (words.groupby(words.word).size() 
   .sort_values(&lt;span class=&quot;hljs-attr&quot;&gt;ascending&lt;/span&gt;=&lt;span class=&quot;hljs-literal&quot;&gt;False&lt;/span&gt;) 
   .reset_index(&lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;)
   .drop_duplicates(&lt;span class=&quot;hljs-attr&quot;&gt;subset&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;))

grouped_result.head(300)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Which returned a list of words and their count:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;	&lt;span class=&quot;hljs-type&quot;&gt;word&lt;/span&gt;	count
&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;	que	&lt;span class=&quot;hljs-number&quot;&gt;94430&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;	no	&lt;span class=&quot;hljs-number&quot;&gt;75931&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;	a	&lt;span class=&quot;hljs-number&quot;&gt;70968&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;	de	&lt;span class=&quot;hljs-number&quot;&gt;67982&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;	ser	&lt;span class=&quot;hljs-number&quot;&gt;64226&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;	la	&lt;span class=&quot;hljs-number&quot;&gt;52143&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;6&lt;/span&gt;	y	&lt;span class=&quot;hljs-number&quot;&gt;44390&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;7&lt;/span&gt;	estar	&lt;span class=&quot;hljs-number&quot;&gt;37819&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;	el	&lt;span class=&quot;hljs-number&quot;&gt;35920&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now I wanted to identify where my diminishing returns would be.   Is there a set of words that I must learn because they are spoken so often that I wouldn&#x27;t understand a conversation if they weren&#x27;t in my vocabulary?&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/diminishing_returns.png&quot;&gt;
&lt;/center&gt;
&lt;p&gt;As you can see in this chart, the usage for words drops off at around the ~200 mark.   So there are basically 150 words I &lt;em&gt;must&lt;/em&gt; know and then the rest are equally important.   I wasn&#x27;t quite happy with this because some parts of speech are higher priority than others, for example I think having a strong understanding of the popular verbs will go a long way.  So I also wanted to identify what are the most important verbs to learn:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;grouped_verbs&lt;/span&gt; = (words[words.pos == &lt;span class=&quot;hljs-string&quot;&gt;&#x27;VERB&#x27;&lt;/span&gt;].groupby([&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;pos&#x27;&lt;/span&gt;]).size() 
   .sort_values(&lt;span class=&quot;hljs-attr&quot;&gt;ascending&lt;/span&gt;=&lt;span class=&quot;hljs-literal&quot;&gt;False&lt;/span&gt;) 
   .reset_index(&lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;)
   .drop_duplicates(&lt;span class=&quot;hljs-attr&quot;&gt;subset&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;))

grouped_verbs.head(50)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Which got me this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;	&lt;span class=&quot;hljs-string&quot;&gt;word&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;pos&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;count&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;tener&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;22072&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;hacer&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;14946&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;ir&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;12570&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;decir&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;11314&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;querer&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;11083&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;ver&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;10269&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;6&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;estar&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;9780&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;7&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;saber&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;8704&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;ser&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;7674&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;9&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;dar&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;5722&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;pasar&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;5528&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;11&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;hablar&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;5355&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;12&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;venir&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;5145&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;13&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;creer&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;4895&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;14&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;salir&lt;/span&gt; 	&lt;span class=&quot;hljs-string&quot;&gt;VERB&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;3395&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Verbs had a slightly different drop-off pattern when I targeted them directly:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/diminishing_verbs.png&quot;&gt;
&lt;/center&gt;
&lt;p&gt;I get a big bang for my buck by learning those top 40 verbs.   Nouns on the other hand are much more spread out and most are evenly distributed:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;word&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;pos&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;count&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;gracias&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;4676&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;favor&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;4625&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;señor&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;4116&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;verdad&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;3566&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;vida&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2673&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;hombre&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2601&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;6&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;madre&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2597&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;7&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;vez&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2537&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;tiempo&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2492&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;9&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;hijo&lt;/span&gt;	&lt;span class=&quot;hljs-string&quot;&gt;NOUN&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;2215&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/diminishing_nouns.png&quot;&gt;
&lt;/center&gt;
&lt;p&gt;So then I thought to myself... How much of a show would I understand if I just learned these most important words?  So I started by excluding some of the easy parts of speech and focused on the most important:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;find_important_words&lt;/span&gt; = (words[~words.pos.isin([&lt;span class=&quot;hljs-string&quot;&gt;&#x27;PRON&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;CONJ&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;ADP&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;ADV&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;SCONJ&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;AUX&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;INTJ&#x27;&lt;/span&gt;])].groupby([&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;pos&#x27;&lt;/span&gt;]).size() 
   .sort_values(&lt;span class=&quot;hljs-attr&quot;&gt;ascending&lt;/span&gt;=&lt;span class=&quot;hljs-literal&quot;&gt;False&lt;/span&gt;) 
   .reset_index(&lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;)
   .drop_duplicates(&lt;span class=&quot;hljs-attr&quot;&gt;subset&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;))

find_important_words.head(50)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The top 20 were all verbs except for &lt;code&gt;bueno&lt;/code&gt; and &lt;code&gt;gracias&lt;/code&gt;.   So now with my list of what I considered &quot;important words&quot; I plotted it to find what amount of words I wanted to learn:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/important_words.png&quot;&gt;
&lt;/center&gt;
&lt;p&gt;It looks like 200 learned words would give me a reasonable amount of understanding for a series, so I decided to calculate how much of a series I would understand if I learned just those first 200 words:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;percentages&lt;/span&gt; = {}

for show_name in words&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;media&#x27;]&lt;/span&gt;.drop_duplicates().values:
    &lt;span class=&quot;hljs-attr&quot;&gt;words_in_show&lt;/span&gt; = (words[words.media == show_name].groupby(words.word).size() 
       .sort_values(&lt;span class=&quot;hljs-attr&quot;&gt;ascending&lt;/span&gt;=&lt;span class=&quot;hljs-literal&quot;&gt;False&lt;/span&gt;) 
       .reset_index(&lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;)
       .drop_duplicates(&lt;span class=&quot;hljs-attr&quot;&gt;subset&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;))
    
    &lt;span class=&quot;hljs-attr&quot;&gt;total_words_handled&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;

    for word in grouped_result&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;word&#x27;]&lt;/span&gt;&lt;span class=&quot;hljs-section&quot;&gt;[:200]&lt;/span&gt;:
        &lt;span class=&quot;hljs-attr&quot;&gt;values&lt;/span&gt; = words_in_show[words_in_show.word == word][&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;].values

        if values.size &gt; 0:
            total_words_handled += values&lt;span class=&quot;hljs-section&quot;&gt;[0]&lt;/span&gt;

    percentages&lt;span class=&quot;hljs-section&quot;&gt;[show_name]&lt;/span&gt; = total_words_handled / words_in_show.sum().loc&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;count&#x27;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now I had a table that would show me what percentage of the spoken words were covered by the first 200 words in my list:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;p_df&lt;/span&gt; = pd.DataFrame(percentages.items(), columns=[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;show&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;percentage&#x27;&lt;/span&gt;])
&lt;span class=&quot;hljs-attr&quot;&gt;p_df&lt;/span&gt; = p_df.sort_values(by=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;percentage&#x27;&lt;/span&gt;)
p_df&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;percentage&#x27;]&lt;/span&gt; = p_df&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;percentage&#x27;]&lt;/span&gt; * 100
&lt;span class=&quot;hljs-attr&quot;&gt;pd.options.display.float_format&lt;/span&gt; = &lt;span class=&quot;hljs-string&quot;&gt;&#x27;{:,.2f}%&#x27;&lt;/span&gt;.format
p_df
&lt;/code&gt;&lt;/pre&gt;




















&lt;table&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;th&gt;Show&lt;/th&gt;
&lt;th&gt;Percentage&lt;/th&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Verónica&lt;/td&gt;
&lt;td&gt;64.24%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El ciudadano ilustre&lt;/td&gt;
&lt;td&gt;65.28%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El Chapo&lt;/td&gt;
&lt;td&gt;66.68%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Neruda&lt;/td&gt;
&lt;td&gt;66.89%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La casa de papel&lt;/td&gt;
&lt;td&gt;67.56%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El Ministerio del Tiempo&lt;/td&gt;
&lt;td&gt;68.03%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Club de Cuervos&lt;/td&gt;
&lt;td&gt;68.19%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;68.47%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Ingobernable&lt;/td&gt;
&lt;td&gt;68.59%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Pablo Escobar&lt;/td&gt;
&lt;td&gt;70.20%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Fariña&lt;/td&gt;
&lt;td&gt;70.95&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La Reina del Sur&lt;/td&gt;
&lt;td&gt;71.52%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Gran Hotel&lt;/td&gt;
&lt;td&gt;73.15%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Las chicas del cable&lt;/td&gt;
&lt;td&gt;73.58%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Élite&lt;/td&gt;
&lt;td&gt;73.78%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La Piloto&lt;/td&gt;
&lt;td&gt;74.03%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El bar&lt;/td&gt;
&lt;td&gt;74.07%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La casa de las flores&lt;/td&gt;
&lt;td&gt;75.40%&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Tarde para la ira&lt;/td&gt;
&lt;td&gt;75.59%&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;But living in Puerto Rico, one thing I&#x27;ve realized is speed of speech is also important.  I have a much easier time speaking with people from Colombia and Mexico than I do with Puerto Ricans because they speak so much faster.   So even though I could understand 75% of &quot;Tarde para la ira&quot; if I learned the 200 words, I want to make sure they are speaking at a pace I could understand as well.&lt;/p&gt;
&lt;p&gt;So I loaded up the other CSV file that was the full sentences and added a &quot;time per word&quot; column:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-css&quot;&gt;sentences = pd&lt;span class=&quot;hljs-selector-class&quot;&gt;.read_csv&lt;/span&gt;(&#x27;sentences&lt;span class=&quot;hljs-selector-class&quot;&gt;.csv&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.gz&lt;/span&gt;&#x27;, compression=&#x27;gzip&#x27;, delimiter=&#x27;,&#x27;, parse_dates=&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;start&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;end&#x27;&lt;/span&gt;]&lt;/span&gt;)
sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;total_time&#x27;&lt;/span&gt;]&lt;/span&gt; = (sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;end&#x27;&lt;/span&gt;]&lt;/span&gt; - sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;start&#x27;&lt;/span&gt;]&lt;/span&gt;)&lt;span class=&quot;hljs-selector-class&quot;&gt;.dt&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.total_seconds&lt;/span&gt;()
sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word_count&#x27;&lt;/span&gt;]&lt;/span&gt; = sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sentence&#x27;&lt;/span&gt;]&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.str&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.split&lt;/span&gt;()&lt;span class=&quot;hljs-selector-class&quot;&gt;.str&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.len&lt;/span&gt;()
sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;time_per_word&#x27;&lt;/span&gt;]&lt;/span&gt; = sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;total_time&#x27;&lt;/span&gt;]&lt;/span&gt; / sentences&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word_count&#x27;&lt;/span&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then I was able to have a speed rating for each show:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-scss&quot;&gt;sentence_group = sentences&lt;span class=&quot;hljs-selector-class&quot;&gt;.groupby&lt;/span&gt;([sentences.media])
sentence_group&lt;span class=&quot;hljs-selector-class&quot;&gt;.time_per_word&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.mean&lt;/span&gt;()&lt;span class=&quot;hljs-selector-class&quot;&gt;.reset_index&lt;/span&gt;()&lt;span class=&quot;hljs-selector-class&quot;&gt;.sort_values&lt;/span&gt;(&#x27;time_per_word&#x27;)
&lt;/code&gt;&lt;/pre&gt;




















&lt;table&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;th&gt;media&lt;/th&gt;
&lt;th&gt;time_per_word&lt;/th&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Gran Hotel&lt;/td&gt;
&lt;td&gt;0.58&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El Chapo&lt;/td&gt;
&lt;td&gt;0.59&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Las chicas del cable&lt;/td&gt;
&lt;td&gt;0.61&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Élite&lt;/td&gt;
&lt;td&gt;0.63&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Ingobernable&lt;/td&gt;
&lt;td&gt;0.64&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El Ministerio del Tiempo&lt;/td&gt;
&lt;td&gt;0.64&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Fariña&lt;/td&gt;
&lt;td&gt;0.65&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El ciudadano ilustre&lt;/td&gt;
&lt;td&gt;0.67&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Neruda&lt;/td&gt;
&lt;td&gt;0.68&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La Piloto&lt;/td&gt;
&lt;td&gt;0.69&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La casa de papel&lt;/td&gt;
&lt;td&gt;0.70&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El bar&lt;/td&gt;
&lt;td&gt;0.70&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Verónica&lt;/td&gt;
&lt;td&gt;0.72&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La Reina del Sur&lt;/td&gt;
&lt;td&gt;0.75&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Club de Cuervos&lt;/td&gt;
&lt;td&gt;0.76&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;El marginal&lt;/td&gt;
&lt;td&gt;0.76&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Pablo Escobar&lt;/td&gt;
&lt;td&gt;0.77&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;Tarde para la ira&lt;/td&gt;
&lt;td&gt;0.77&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;La casa de las flores&lt;/td&gt;
&lt;td&gt;0.81&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;Luckily the two series that have the least amount of vocabulary also speak the slowest!   So these will be the series I start with.    The final question I wanted to answer is &quot;What are the top words I&#x27;m missing for a series&quot;.    Since I&#x27;ll know 75% of the series from the top 200 words, I&#x27;m hoping there are some top words from a specific series that I can also learn to get an even higher understanding.&lt;/p&gt;
&lt;p&gt;First, find which words are in each show but not in the top 200:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;missing_words_by_show&lt;/span&gt; = {}

for show_name in words&lt;span class=&quot;hljs-section&quot;&gt;[&#x27;media&#x27;]&lt;/span&gt;.drop_duplicates().values:
    &lt;span class=&quot;hljs-attr&quot;&gt;words_in_show&lt;/span&gt; = (words[words.media == show_name].groupby(words.word).size() 
       .sort_values(&lt;span class=&quot;hljs-attr&quot;&gt;ascending&lt;/span&gt;=&lt;span class=&quot;hljs-literal&quot;&gt;False&lt;/span&gt;) 
       .reset_index(&lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;count&#x27;&lt;/span&gt;)
       .drop_duplicates(&lt;span class=&quot;hljs-attr&quot;&gt;subset&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;))
    
    &lt;span class=&quot;hljs-attr&quot;&gt;frequency_words&lt;/span&gt; = grouped_result[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;word&#x27;&lt;/span&gt;][:&lt;span class=&quot;hljs-number&quot;&gt;200&lt;/span&gt;]

    &lt;span class=&quot;hljs-attr&quot;&gt;missing_words&lt;/span&gt; = words_in_show[~words_in_show.word.isin(frequency_words.values)]
    missing_words_by_show&lt;span class=&quot;hljs-section&quot;&gt;[show_name]&lt;/span&gt; = missing_words
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then we were able to grab them per show:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-css&quot;&gt;missing_words_by_show&lt;span class=&quot;hljs-selector-attr&quot;&gt;[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;La casa de las flores&#x27;&lt;/span&gt;]&lt;/span&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.head&lt;/span&gt;(&lt;span class=&quot;hljs-number&quot;&gt;50&lt;/span&gt;)

word	count
&lt;span class=&quot;hljs-number&quot;&gt;31&lt;/span&gt;	mamá	&lt;span class=&quot;hljs-number&quot;&gt;252&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;70&lt;/span&gt;	florerí&lt;span class=&quot;hljs-selector-tag&quot;&gt;a&lt;/span&gt;	&lt;span class=&quot;hljs-number&quot;&gt;87&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;98&lt;/span&gt;	perdón	&lt;span class=&quot;hljs-number&quot;&gt;56&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;102&lt;/span&gt;	sea	&lt;span class=&quot;hljs-number&quot;&gt;54&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;116&lt;/span&gt;	además	&lt;span class=&quot;hljs-number&quot;&gt;44&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;126&lt;/span&gt;	ahorita	&lt;span class=&quot;hljs-number&quot;&gt;40&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;132&lt;/span&gt;	cárcel	&lt;span class=&quot;hljs-number&quot;&gt;38&lt;/span&gt;
&lt;span class=&quot;hljs-number&quot;&gt;133&lt;/span&gt;	fiesta	&lt;span class=&quot;hljs-number&quot;&gt;38&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So adding those few words to my vocabulary will also give me a better understanding of the series.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I believe a data-driven approach to language learning will be an effective way to get me speaking better spanish.   It was a ton of fun to play with spaCy, pandas, and jupyter as well!&lt;/p&gt;
&lt;p&gt;I&#x27;ll improve the data analysis over time as well but I do believe this is a pretty good starting point!&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/images/posts/learning_spanish/meme.png&quot;&gt;
&lt;/center&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2022/learning_spanish&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2022/learning_spanish&lt;/guid&gt;
            &lt;pubDate&gt;Sat, 30 Apr 2022 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Running a kubernetes cluster locally with kubeadm]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;I’m going to show you how to get a real kubernetes cluster setup locally on top of virtual
machines!  I’ll be using multipass but feel free to use virtualbox, proxmox, or whatever your
favorite cloud provider is.&lt;/p&gt;
&lt;p&gt;kubeadm a production ready kubernetes install tool and I prefer to use it over minikube, kind,
etc. because it gives you a more real world experience for &lt;em&gt;managing&lt;/em&gt; the kubernetes cluster.
This isn’t important if you are a user of the cluster but if you have to run your own this is
a great way to gain some daily experience.&lt;/p&gt;
&lt;p&gt;The kubernetes documentation on kubeadm is great and you can find it &lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The differences between this blog and the kubernetes docs is that they leave a lot of decisions
up to the reader such as:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;choosing a container runtime&lt;/li&gt;
&lt;li&gt;Selecting and installing a CNI (container network interface)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’m going to be opinionated and make specific technology decisions such as using containerd and
cilium so that you don&#x27;t have to think about those decisions.&lt;/p&gt;
&lt;h2&gt;Getting your Virtual Machines setup!&lt;/h2&gt;
&lt;p&gt;The minimum requirements for a control plane node in kubernetes is 2gb of RAM and 2 CPUs.  Since
we actually want to be able to schedule workloads on the workers afterwards we are going to setup
a cluster that looks like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Control Plane: 2gb RAM, 2 CPU&lt;/li&gt;
&lt;li&gt;Worker: 4gb RAM, 2 CPU&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Since we’ll be using multipass to launch the nodes, we can do that now:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ multipass launch -c 2 -m 4G -d 10G -n controlplane 22.04
❯ multipass launch -c 2 -m 4G -d 10G -n worker 22.04
❯ multipass list
Name                    State             IPv4             Image
controlplane            Running           192.168.64.7     Ubuntu 22.04 LTS
worker                  Running           192.168.64.8     Ubuntu 22.04 LTS
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we can start working on our controlplane first, lets shell in:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ multipass shell controlplane
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Lets first add the kubernetes repo to the system so we have access to all the kubernetes tools:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;deb  http://apt.kubernetes.io/  kubernetes-xenial  main&quot;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/kubernetes.list

❯ curl -fsSL  https://packages.cloud.google.com/apt/doc/apt-key.gpg|sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/k8s.gpg
❯ sudo apt-get update &amp;#x26;&amp;#x26; sudo apt-get upgrade -y
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now that our system is setup, we can move on to getting a container runtime.&lt;/p&gt;
&lt;h2&gt;Getting your Container Runtime!&lt;/h2&gt;
&lt;p&gt;Before we start pulling in kubernetes components we need to get a container runtime setup on the
machine.   We we are going to use containerd for this purpose.  You can view the docs of for it
&lt;a href=&quot;https://github.com/containerd/containerd/blob/main/docs/getting-started.md&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Which will download the latest binary and set it up.   I’m going to walk you through how to do it
using the version packaged with Ubuntu which could be older than the latest release.&lt;/p&gt;
&lt;p&gt;First thing we want to do is configure the networking to allow iptables to manage:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF&lt;/span&gt;

❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
EOF&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We also need to disable some default systemd settings for &lt;code&gt;rp_filter&lt;/code&gt;  because
they are not compatible with cilium. See the bug report
&lt;a href=&quot;https://github.com/cilium/cilium/commit/cabc6581b8128681f4ed23f8d6dc463180eea61e&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo sed -i -e &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/net.ipv4.conf.*.rp_filter/d&#x27;&lt;/span&gt; $(grep -ril &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\.rp_filter&#x27;&lt;/span&gt; /etc/sysctl.d/ /usr/lib/sysctl.d/)
❯ sudo sysctl -a | grep &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\.rp_filter&#x27;&lt;/span&gt; | awk &lt;span class=&quot;hljs-string&quot;&gt;&#x27;{print $1&quot; = 0&quot;}&#x27;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; -a /etc/sysctl.d/1000-cilium.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then we need to refresh sysctl so those settings are applied:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo systemctl restart systemd-modules-load
❯ sudo sysctl --system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You should see it applying all the changes:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;* Applying /etc/sysctl.d/k8s.conf ...
&lt;span class=&quot;hljs-attr&quot;&gt;net.bridge.bridge-nf-call-ip6tables&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.bridge.bridge-nf-call-iptables&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.ip_forward&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you do not, the netfilter module may not have loaded properly:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ lsmod |grep br_netfilter
br_netfilter           28672  0
bridge                176128  1 br_netfilter
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You want to make sure &lt;code&gt;rp_filter&lt;/code&gt; is &lt;code&gt;0&lt;/code&gt; everywhere as well for cilium:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;❯ sudo sysctl -a | grep &#x27;\.rp_filter&#x27;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.all.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.cilium_host.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.cilium_net.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.cilium_vxlan.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.default.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.enp0s1.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.lo.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.lxc0965b7b545f7.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;net.ipv4.conf.lxcb05ffd84ab74.rp_filter&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now lets pull down the container runtime we’ll be using which is containerd.&lt;/p&gt;
&lt;p&gt;Ubuntu ships with a very old version of containerd so you need to upgrade to
the version shipped from the docker repos:
You can find which versions are available by running:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
❯ &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;deb https://download.docker.com/linux/ubuntu &lt;span class=&quot;hljs-subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt; stable&quot;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/docker.list
❯ sudo apt-get update
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo apt-cache madison containerd.io
containerd.io |    1.6.8-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
containerd.io |    1.6.7-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
containerd.io |    1.6.6-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
containerd.io |    1.6.4-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
containerd.io |   1.5.11-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
containerd.io |   1.5.10-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are going to use the latest version available which was 1.6.8-1&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo apt-get install containerd.io=1.6.8-1 -y
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then we&#x27;ll setup a configuration that enables containerd to use the systemd
cgroup.  We are hard coding this config instead of using &lt;code&gt;containerd config default&lt;/code&gt;
because that currently has had a &lt;a href=&quot;https://github.com/containerd/containerd/issues/4574&quot;&gt;bug&lt;/a&gt;
for many years that generates an invalid config.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/containerd/config.toml
version = 2
[plugins]
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]
   [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]
      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]
        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
          runtime_type = &quot;io.containerd.runc.v2&quot;
          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
            SystemdCgroup = true
EOF&lt;/span&gt;

❯ sudo systemctl restart containerd.service
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can verify its running with ctr:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo ctr --address /var/run/containerd/containerd.sock containers list
CONTAINER    IMAGE    RUNTIME
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now that this is working we can move on to getting kubernetes installed!&lt;/p&gt;
&lt;h2&gt;Using kubeadm!&lt;/h2&gt;
&lt;p&gt;Now we need to get the kubernetes tools installed onto the system.  I’m going to be using 1.23
but to find the latest version you can run:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo apt-cache madison kubeadm|&lt;span class=&quot;hljs-built_in&quot;&gt;head&lt;/span&gt; -n2
   kubeadm |  1.23.5-00 | http://apt.kubernetes.io kubernetes-xenial/main amd64 Packages
   kubeadm |  1.23.4-00 | http://apt.kubernetes.io kubernetes-xenial/main amd64 Packages
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then install the version you want, we install kubelet and kubeadm here to make
sure the versions align:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo apt-get install kubeadm=1.23.5-00 kubelet=1.23.5-00 kubectl=1.23.5-00 -y
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will pull in a few tools, including an alternative to &lt;code&gt;ctr&lt;/code&gt; that we used earlier called
&lt;code&gt;crictl&lt;/code&gt;.  You can check that it is available to you doing this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock ps
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can finally init our cluster:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo kubeadm init
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once that finishes running it should give you some tips setup your configuration, it should look like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; -p &lt;span class=&quot;hljs-variable&quot;&gt;$HOME&lt;/span&gt;/.kube
❯ sudo &lt;span class=&quot;hljs-built_in&quot;&gt;cp&lt;/span&gt; -i /etc/kubernetes/admin.conf &lt;span class=&quot;hljs-variable&quot;&gt;$HOME&lt;/span&gt;/.kube/config
❯ sudo &lt;span class=&quot;hljs-built_in&quot;&gt;chown&lt;/span&gt; $(&lt;span class=&quot;hljs-built_in&quot;&gt;id&lt;/span&gt; -u):$(&lt;span class=&quot;hljs-built_in&quot;&gt;id&lt;/span&gt; -g) &lt;span class=&quot;hljs-variable&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can run those on the master node for now, but later I&#x27;ll show you how to move
the config to your host computer.&lt;/p&gt;
&lt;p&gt;Now you should be able to check that your node is not ready yet:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubectl get nodes
NAME           STATUS     ROLES                  AGE     VERSION
controlplane   NotReady   control-plane,master   4m16s   v1.23.5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: If you recieve &quot;The connecto to the server was refused&quot; error,
The cluster starting up and getting all the dependencies running could take
a bit of time.  So if you aren&#x27;t able to communicate right away you can check
which pods are up and running with &lt;code&gt;crictl&lt;/code&gt;.  You&#x27;ll need &lt;code&gt;kube-apiserver&lt;/code&gt; up
and running.  If it isn&#x27;t you can check:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock ps -a
CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD
8322192c4605c       bd8cc6d582470       36 seconds ago      Running             kube-proxy                4                   344c4f7fffbe8       kube-proxy-drm46
30ce27c40adb2       81a4a8a4ac639       2 minutes ago       Exited              kube-controller-manager   4                   3a819c3a864b2       kube-controller-manager-controlplane
7709fd5e92898       bd8cc6d582470       2 minutes ago       Exited              kube-proxy                3                   7cc6922c82015       kube-proxy-drm46
10432b81d7c61       3767741e7fba7       2 minutes ago       Exited              kube-apiserver            4                   e64ddf3679d98       kube-apiserver-controlplane
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which will show you pods that have exited. You can grab the container ID for
kube-apiserver and read its logs:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock logs 10432b81d7c61
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There are a few ways to figure out why the node isn’t ready yet.  Usually I would check the
&lt;code&gt;kubelet&lt;/code&gt; logs first:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo journalctl -flu kubelet
-- Logs begin at Sun 2022-04-17 19:22:19 AST. --
Apr 17 20:53:15 controlplane kubelet[19727]: E0417 20:53:15.951350   19727 kubelet.go:2347] &lt;span class=&quot;hljs-string&quot;&gt;&quot;Container runtime network not ready&quot;&lt;/span&gt; networkReady=&lt;span class=&quot;hljs-string&quot;&gt;&quot;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;&lt;/span&gt;
Apr 17 20:53:20 controlplane kubelet[19727]: E0417 20:53:20.952148   19727 kubelet.go:2347] &lt;span class=&quot;hljs-string&quot;&gt;&quot;Container runtime network not ready&quot;&lt;/span&gt; networkReady=&lt;span class=&quot;hljs-string&quot;&gt;&quot;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It is clear the problem is that we are missing the CNI.  The other way you can find out what is
going on is describing the node:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubectl describe node controlplane
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will have a lot of information but if you scroll through there looking at &lt;code&gt;Reason&lt;/code&gt; you
might see something useful.  In this case under &lt;code&gt;Lease&lt;/code&gt; you would see:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubectl describe node controlplane|grep NotReady
Ready            False   Sun, 17 Apr 2022 20:53:37 -0400   Sun, 17 Apr 2022 20:43:07 -0400   KubeletNotReady              container runtime network not ready: NetworkReady=&lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt; reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialize
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Lets get our CNI installed, we’ll be using cilium!&lt;/p&gt;
&lt;h2&gt;Setting up your CNI!&lt;/h2&gt;
&lt;p&gt;Cilium has great documentation over &lt;a href=&quot;https://docs.cilium.io/en/v1.9/gettingstarted/k8s-install-kubeadm/&quot;&gt;here&lt;/a&gt;,
but I’ll walk you through it anyways.  I do recommend checking out their documentation so you
are familiar with it.   We will use &lt;code&gt;helm&lt;/code&gt; to pull down the version of cilium we want:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ curl -fsSL  https://baltocdn.com/helm/signing.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/helm.gpg

❯ sudo apt-get install apt-transport-https --&lt;span class=&quot;hljs-built_in&quot;&gt;yes&lt;/span&gt;

❯ &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;deb https://baltocdn.com/helm/stable/debian/ all main&quot;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/helm-stable-debian.list

❯ sudo apt-get update
❯ sudo apt-get install helm
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we can install cilium!  It is &lt;em&gt;very&lt;/em&gt; important that you pay attention to the
compatibility of cilium with the version of kubernetes you are intstalling. Check
the compatibility list &lt;a href=&quot;https://docs.cilium.io/en/v1.12/concepts/kubernetes/compatibility/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ helm repo add cilium https://helm.cilium.io/
❯ helm repo update
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once the repo is added you can list the versions available:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ helm search repo -l|&lt;span class=&quot;hljs-built_in&quot;&gt;head&lt;/span&gt; -n8
NAME           	CHART VERSION	APP VERSION	DESCRIPTION
cilium/cilium  	1.12.1       	1.12.1     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.12.0       	1.12.0     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.11.8       	1.11.8     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.11.7       	1.11.7     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.11.6       	1.11.6     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.11.5       	1.11.5     	eBPF-based Networking, Security, and Observability
cilium/cilium  	1.11.4       	1.11.4     	eBPF-based Networking, Security, and Observability
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So we want &lt;code&gt;1.11.4&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ helm install cilium cilium/cilium --namespace kube-system --version 1.11.4
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now our node should be ready!&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubectl get node
NAME           STATUS   ROLES                  AGE   VERSION
controlplane   Ready    control-plane,master   24m   v1.23.5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Time to join our worker to the cluster!&lt;/p&gt;
&lt;h2&gt;Joining a worker to the cluster!&lt;/h2&gt;
&lt;p&gt;We have to go through the same steps as the controlplane to get the point that we have a
container runtime and &lt;code&gt;kubeadm&lt;/code&gt;.   I’m not going to talk about the commands a second time but
I’ll re-iterate them here for ease of following along.&lt;/p&gt;
&lt;p&gt;First open up another shell and connect to the worker:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ multipass shell worker
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now run the following commands:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;deb  http://apt.kubernetes.io/  kubernetes-xenial  main&quot;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/kubernetes.list
❯ curl -fsSL  https://packages.cloud.google.com/apt/doc/apt-key.gpg|sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/k8s.gpg
❯ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
❯ &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;deb https://download.docker.com/linux/ubuntu &lt;span class=&quot;hljs-subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt; stable&quot;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/docker.list

❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF&lt;/span&gt;

❯ sudo sed -i -e &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/net.ipv4.conf.*.rp_filter/d&#x27;&lt;/span&gt; $(grep -ril &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\.rp_filter&#x27;&lt;/span&gt; /etc/sysctl.d/ /usr/lib/sysctl.d/)
❯ sudo sysctl -a | grep &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\.rp_filter&#x27;&lt;/span&gt; | awk &lt;span class=&quot;hljs-string&quot;&gt;&#x27;{print $1&quot; = 0&quot;}&#x27;&lt;/span&gt; | sudo &lt;span class=&quot;hljs-built_in&quot;&gt;tee&lt;/span&gt; -a /etc/sysctl.d/1000-cilium.conf

❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
EOF&lt;/span&gt;

❯ sudo systemctl restart systemd-modules-load
❯ sudo sysctl --system

❯ sudo apt-get update &amp;#x26;&amp;#x26; sudo apt-get upgrade -y
❯ sudo apt-get install containerd.io=1.6.8-1 -y

❯ &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; &amp;#x3C;&amp;#x3C;&lt;span class=&quot;hljs-string&quot;&gt;EOF | sudo tee /etc/containerd/config.toml
version = 2
[plugins]
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]
   [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]
      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]
        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
          runtime_type = &quot;io.containerd.runc.v2&quot;
          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
            SystemdCgroup = true
EOF&lt;/span&gt;

❯ sudo systemctl restart containerd.service
❯ sudo apt-get install kubeadm=1.23.5-00 kubelet=1.23.5-00 kubectl=1.23.5-00 -y

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From there we should be ready to join the cluster.   When we ran &lt;code&gt;kubeadm init&lt;/code&gt; previously it
printed a join command out that we could use but I’m going to show you how to do it if you
were coming back later and no longer had that token.&lt;/p&gt;
&lt;p&gt;Back on the &lt;em&gt;controplane&lt;/em&gt; node run:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubeadm token create --print-join-command
kubeadm &lt;span class=&quot;hljs-built_in&quot;&gt;join&lt;/span&gt; 192.168.64.7:6443 --token wxs197.cco6mjj9ricvu8ov --discovery-token-ca-cert-hash sha256:bd01c065240fa76f30a02ecb70a8cea6e329c9678994d4da1f6ccac7694b97fb
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now copy that command and run it with &lt;code&gt;sudo&lt;/code&gt; on the worker:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ sudo kubeadm &lt;span class=&quot;hljs-built_in&quot;&gt;join&lt;/span&gt; 192.168.64.7:6443 --token wxs197.cco6mjj9ricvu8ov --discovery-token-ca-cert-hash sha256:bd01c065240fa76f30a02ecb70a8cea6e329c9678994d4da1f6ccac7694b97fb
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After this completes it’ll take a minute or two for everything to be synced up but if you go
back to the master node you should have 2 ready nodes now:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ kubectl get nodes
NAME           STATUS   ROLES                  AGE   VERSION
controlplane   Ready    control-plane,master   46m   v1.23.5
worker         Ready    &amp;#x3C;none&gt;                 79s   v1.23.5
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Accessing the cluster outside of the VMs!&lt;/h2&gt;
&lt;p&gt;Now the final part is to get the &lt;code&gt;admin.conf&lt;/code&gt; as a kubeconfig on your machine so you can control
it from outside of the cluster.   To do this we can use scp&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;multipass transfer controlplane:/home/ubuntu/.kube/config local.config
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Normally kubernetes configuration is in ~/.kube/config but I like to maint a separate file for
each cluster and then I set the &lt;code&gt;KUBECONFIG&lt;/code&gt; env var to access it.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ &lt;span class=&quot;hljs-built_in&quot;&gt;export&lt;/span&gt; KUBECONFIG=local.config
❯ kubectl get nodes
NAME           STATUS   ROLES                  AGE   VERSION
controlplane   Ready    control-plane,master   56m   v1.23.5
worker         Ready    &amp;#x3C;none&gt;                 11m   v1.23.5
&lt;/code&gt;&lt;/pre&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2022/local_kubeadm_cluster&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2022/local_kubeadm_cluster&lt;/guid&gt;
            &lt;pubDate&gt;Sun, 17 Apr 2022 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Automate project workflows with the command runner Just!]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;I believe every project should have a CLI built around the standard workflows of developing
on the project.  Things like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Install dependencies&lt;/li&gt;
&lt;li&gt;Run tests&lt;/li&gt;
&lt;li&gt;Run linter and formatters&lt;/li&gt;
&lt;li&gt;Build project&lt;/li&gt;
&lt;li&gt;Start / Stop the docker environment&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The reason I think this is important is because it makes a nice consistent and discoverable
entrypoint for understanding how you should work in the project.   If you only provide the
instructions in the &lt;code&gt;README&lt;/code&gt; then you have to remember to update those docs every time you
add a new command.  Those docs aren&#x27;t easily testable either.&lt;/p&gt;
&lt;p&gt;Most of my career the command runner of choice for my projects as been &lt;code&gt;GNU Make&lt;/code&gt; but it was
definitely the wrong tool for the job.  It is a build tool that I bent into shape to work
as a command runner for me.   These days I use the tool &lt;a href=&quot;https://github.com/casey/just&quot;&gt;just&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Intro to just&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/casey/just&quot;&gt;Just&lt;/a&gt; is a modern command runner with a similar syntax to &lt;code&gt;make&lt;/code&gt;
that provides a nice way for building out your project CLI!  You create a file named &lt;code&gt;justfile&lt;/code&gt;
at the root of your project and then the basic syntax is:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-make&quot;&gt;&lt;span class=&quot;hljs-section&quot;&gt;help:&lt;/span&gt;
  @just --list

&lt;span class=&quot;hljs-comment&quot;&gt;# My first command&lt;/span&gt;
&lt;span class=&quot;hljs-section&quot;&gt;first:&lt;/span&gt;
  echo &lt;span class=&quot;hljs-string&quot;&gt;&quot;Any commands you want to run go here!&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The first &lt;code&gt;help&lt;/code&gt; line defines a command &quot;help&quot; for your CLI and it lists out all the other available
commans.  I always put this line first because &lt;code&gt;just&lt;/code&gt; runs the first command in the file if a specific
command isn&#x27;t requested.  The output of this file looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ just
Available recipes:
    first &lt;span class=&quot;hljs-comment&quot;&gt;# My first command&lt;/span&gt;
    &lt;span class=&quot;hljs-built_in&quot;&gt;help&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Having help automatically generated is fantastic!  Its also really helpful that it adds the comment
to the command so that each command is self-documenting.  If you run the &lt;code&gt;first&lt;/code&gt; command you&#x27;ll notice
it also has a feature where it prints out the commands being ran so the user knows exactly what is
happening:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ just first
&lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;Any commands you want to run go here!&quot;&lt;/span&gt;
Any commands you want to run go here!
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This doesn&#x27;t always make sense though, so you can quickly remove that behavior by putting an &lt;code&gt;@&lt;/code&gt; in front
of any of the commands, like I did for the &lt;code&gt;help&lt;/code&gt; command above.  You can also declare dependencies if
you have re-usable parts of your workflow that many of your commands need.&lt;/p&gt;
&lt;p&gt;For example, you might want to check versions of things like &lt;code&gt;node&lt;/code&gt; and &lt;code&gt;python&lt;/code&gt; before running the install
of their dependencies. So you could do something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-make&quot;&gt;&lt;span class=&quot;hljs-section&quot;&gt;help:&lt;/span&gt;
  @just --list

node_version := &lt;span class=&quot;hljs-string&quot;&gt;&quot;v17.6.0&quot;&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;# Verify system dependencies&lt;/span&gt;
&lt;span class=&quot;hljs-section&quot;&gt;check-dependencies:&lt;/span&gt;
  @if [ ! &lt;span class=&quot;hljs-string&quot;&gt;&quot;$(node --version)&quot;&lt;/span&gt; = {{ node_version }} ]; \
  then \
    echo &lt;span class=&quot;hljs-string&quot;&gt;&quot;Missing node version: {{ node_version }}&quot;&lt;/span&gt;; \
    exit 1; \
  fi

&lt;span class=&quot;hljs-comment&quot;&gt;# Install frontend&lt;/span&gt;
&lt;span class=&quot;hljs-section&quot;&gt;install: check-dependencies&lt;/span&gt;
  @echo &lt;span class=&quot;hljs-string&quot;&gt;&quot;yarn install&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which ends up with a CLI that looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ just
Available recipes:
    check-dependencies &lt;span class=&quot;hljs-comment&quot;&gt;# Verify system dependencies&lt;/span&gt;
    &lt;span class=&quot;hljs-built_in&quot;&gt;help&lt;/span&gt;
    install            &lt;span class=&quot;hljs-comment&quot;&gt;# Install frontend&lt;/span&gt;

❯ just install
Missing node version: v17.6.0
error: Recipe `check-dependencies` failed on line 12 with &lt;span class=&quot;hljs-built_in&quot;&gt;exit&lt;/span&gt; code 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This opens up a lot of possibilities! In the above &lt;code&gt;justfile&lt;/code&gt; you&#x27;ll notice I&#x27;m using a multi-line
command but I have &lt;code&gt;\&lt;/code&gt; at the end of each line.  This is because &lt;code&gt;just&lt;/code&gt; by default is going to run
each new line in their own shell.   So this just makes all those lines run in the same shell.&lt;/p&gt;
&lt;p&gt;You do not have to use this syntax though.  Just is &lt;code&gt;polyglot&lt;/code&gt; and can run commands from any language
you would like.&lt;/p&gt;
&lt;h3&gt;Polyglot&lt;/h3&gt;
&lt;p&gt;If you want to use a bash script as one of your commands, you can do so by adding a shebang at the top:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-make&quot;&gt;&lt;span class=&quot;hljs-section&quot;&gt;check-dependencies:&lt;/span&gt;
  &lt;span class=&quot;hljs-comment&quot;&gt;#!/usr/bin/env bash&lt;/span&gt;
  set -euxo pipefail
  if [ ! &lt;span class=&quot;hljs-string&quot;&gt;&quot;$(node --version)&quot;&lt;/span&gt; = {{ node_version }} ];
  then
    echo &lt;span class=&quot;hljs-string&quot;&gt;&quot;Missing node version: {{ node_version }}&quot;&lt;/span&gt;
    exit 1
  fi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now the entire command is using a bash script to execute! This gets really interesting if you want to start
using things like python, so if you&#x27;d like to change the dependency checker above to python:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;check-dependencies:
  &lt;span class=&quot;hljs-comment&quot;&gt;#!/usr/bin/env python3&lt;/span&gt;
  &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; subprocess
  result = subprocess.run(
    [&lt;span class=&quot;hljs-string&quot;&gt;&#x27;node&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;--version&#x27;&lt;/span&gt;],
    stdout=subprocess.PIPE
  )
  &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; result != &lt;span class=&quot;hljs-string&quot;&gt;&quot;{{ node_version }}&quot;&lt;/span&gt;:
    &lt;span class=&quot;hljs-built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;f&quot;Missing node version: {{ node_version }}&quot;&lt;/span&gt;)
    exit(&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can even tell &lt;code&gt;just&lt;/code&gt; that you want to use a specific language for all commands!&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;set shell := [&lt;span class=&quot;hljs-string&quot;&gt;&quot;python3&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;-c&quot;&lt;/span&gt;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This not only affects the commands you have in your recipe but also anything inside
backticks!  So something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-make&quot;&gt;`print(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Rust is the best programming language&quot;&lt;/span&gt;)`
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It would run through python instead of the shell.&lt;/p&gt;
&lt;h3&gt;Enviornment Files&lt;/h3&gt;
&lt;p&gt;One of the other modern things &lt;code&gt;just&lt;/code&gt; adds to your workflow is the ability to utilize dotenv
files.  So for example if you want to define which port you launch your http server on, you can
create a file called &lt;code&gt;.env&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;WEBSERVER_PORT=9000
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and then utilize it in your &lt;code&gt;justfile&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-make&quot;&gt;set dotenv-load

&lt;span class=&quot;hljs-section&quot;&gt;http:&lt;/span&gt;
  @echo &lt;span class=&quot;hljs-string&quot;&gt;&quot;Starting webserver in current directory&quot;&lt;/span&gt;
  python3 -m http.server $WEBSERVER_PORT
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;When you run &lt;code&gt;just http&lt;/code&gt; it&#x27;ll launch the http server on port 9000.  One important line
in this file is &lt;code&gt;set dotenv-load&lt;/code&gt;, it will not load the &lt;code&gt;.env&lt;/code&gt; file without you telling it to.&lt;/p&gt;
&lt;h2&gt;Don&#x27;t use language specific scripts!&lt;/h2&gt;
&lt;p&gt;I&#x27;n not a fan of language specific command runners like &lt;code&gt;package.json&lt;/code&gt; in the node community.&lt;/p&gt;
&lt;p&gt;It always frustrates me when I start working on a project that heavily uses &lt;code&gt;scripts&lt;/code&gt; in their
package.json instead of using a real command runner. &lt;code&gt;json&lt;/code&gt; is not a great format for writing
discoverable CLI commands. For example if you wanted to write a &lt;code&gt;next.js&lt;/code&gt; build script:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-json&quot;&gt;    &lt;span class=&quot;hljs-attr&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;&quot;predeploy&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;yarn build &amp;#x26;&amp;#x26; yarn export &amp;#x26;&amp;#x26; touch dist/.nojekyll &amp;#x26;&amp;#x26; echo sontek.net &gt; dist/CNAME&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;&quot;deploy&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;gh-pages -d dist -t true&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;&quot;build&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;next build&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;&quot;export&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;next export -o dist/&quot;&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;hljs-punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;hljs-punctuation&quot;&gt;,&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Combining all those commands is really messy and not easily understandable through &lt;code&gt;yarn run&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ yarn run
yarn run v1.22.17
info Commands available from binary scripts: autoprefixer, browserslist, css-blank-pseudo, css-has-pseudo, css-prefers-color-scheme, cssesc, esparse, esvalidate, extract-zip, gh-pages, gh-pages-clean, js-yaml, loose-envify, nanoid, next, prettier, resolve, rimraf, semver, svgo, uvu
info Project commands
   - build
      next build
   - deploy
      gh-pages -d dist -t &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;
   - &lt;span class=&quot;hljs-built_in&quot;&gt;export&lt;/span&gt;
      next &lt;span class=&quot;hljs-built_in&quot;&gt;export&lt;/span&gt; -o dist/
   - predeploy
      yarn build &amp;#x26;&amp;#x26; yarn &lt;span class=&quot;hljs-built_in&quot;&gt;export&lt;/span&gt; &amp;#x26;&amp;#x26; &lt;span class=&quot;hljs-built_in&quot;&gt;touch&lt;/span&gt; dist/.nojekyll &amp;#x26;&amp;#x26; &lt;span class=&quot;hljs-built_in&quot;&gt;echo&lt;/span&gt; sontek.net &gt; dist/CNAME
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I&#x27;d much rather have this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;❯ just
Available recipes:
    build       &lt;span class=&quot;hljs-comment&quot;&gt;# Build frontend assets&lt;/span&gt;
    deploy      &lt;span class=&quot;hljs-comment&quot;&gt;# Deploy assets to cloudfront&lt;/span&gt;
    &lt;span class=&quot;hljs-built_in&quot;&gt;export&lt;/span&gt;      &lt;span class=&quot;hljs-comment&quot;&gt;# Export to static assets (no SSR)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/casey/just&quot;&gt;Just&lt;/a&gt; is a wonderful tool for building project specific CLIs without much effort. It is
a great replacement for &lt;code&gt;Make&lt;/code&gt; if you are using it as a command runner and it has most of the features you&#x27;d need.&lt;/p&gt;
&lt;p&gt;I recommend adding a &lt;code&gt;justfile&lt;/code&gt; to your projects today! If you&#x27;d like to see a real world example of how to use &lt;code&gt;just&lt;/code&gt;,
you can check out the one I use to maintain my &lt;a href=&quot;https://github.com/sontek/homies/blob/master/justfile&quot;&gt;home directory&lt;/a&gt;!&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2022/intro_to_just&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2022/intro_to_just&lt;/guid&gt;
            &lt;pubDate&gt;Sat, 26 Feb 2022 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Use asdf to manage Python, NodeJS, GoLang and more!]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;&lt;a href=&quot;https://asdf-vm.com/&quot;&gt;asdf&lt;/a&gt; is a general purpose version manager that
can manage versions of most programming language runtimes through a set
of plugins.&lt;/p&gt;
&lt;p&gt;With micro-services being all the rage and the ever changing landscape
of the development world, it is rare to utilize a single version of
language runtime. Even when you want to upgrade from one to the other
you&#x27;ll need both usable on your system at the same time.&lt;/p&gt;
&lt;p&gt;I&#x27;ve used tools like &lt;code&gt;pyenv&lt;/code&gt; and &lt;code&gt;nvm&lt;/code&gt; in the past when I needed to change
versions depending on which project I&#x27;m contributing to. But with &lt;code&gt;asdf&lt;/code&gt;
you have one tool to rule them all!&lt;/p&gt;
&lt;h2&gt;Getting Started&lt;/h2&gt;
&lt;p&gt;The first thing you need to do when working with &lt;code&gt;asdf&lt;/code&gt; is grab the
plugins for the languages you are interested in working with. You can list
what plugins are available:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf plugin list all
golang                       *https://github.com/kennyp/asdf-golang.git
golangci-lint                 https://github.com/hypnoglow/asdf-golangci-lint.git
nodejs                       *https://github.com/asdf-vm/asdf-nodejs.git
poetry                       *https://github.com/asdf-community/asdf-poetry.git
python                       *https://github.com/danhper/asdf-python.git
yarn                         *https://github.com/twuni/asdf-yarn.git
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On the left will be the name of the plugin and on the right will be the repository
where it lives.  It&#x27;ll me marked with an asterisk if you already have it installed.&lt;/p&gt;
&lt;p&gt;To install a plugin you say &lt;code&gt;asdf plugin add &amp;#x3C;plugin&gt;&lt;/code&gt; to get it installed.  You can
also provide the repository where you want it pulled from, for example:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git
&gt; asdf plugin add python https://github.com/danhper/asdf-python.git
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will not give you any version of those languages, it is only installing the
plugin that knows how to work with those languages.   You are ready to pull down
any versions you want at that point:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf install nodejs 14.19.0
&gt; asdf install python 3.9.10
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once you have the versions installed you will be able to view them like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf list
golang
  1.17.7
nodejs
  --&lt;span class=&quot;hljs-built_in&quot;&gt;help&lt;/span&gt;
  12.22.10
  14.19.0
  16.14.0
  17.5.0
poetry
  1.1.13
python
  3.9.10
yarn
  1.22.17
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Using the installed languages&lt;/h2&gt;
&lt;p&gt;To activate a specific version of a language you have you have three options:&lt;/p&gt;
&lt;h3&gt;Make it global&lt;/h3&gt;
&lt;p&gt;You can make it global, meaning when you run the tool like &lt;code&gt;python&lt;/code&gt; it&#x27;ll use
this version for the system:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf global python 3.9.10
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;Make it local&lt;/h3&gt;
&lt;p&gt;You can make it local, which means it will generate a file in the current
directory named &lt;code&gt;.tool-versions&lt;/code&gt; and so whenever you change into a directory
it will activate the versions defined in there.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf &lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt; nodejs 12.22.10
&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;cat&lt;/span&gt; .tool-versions 
nodejs 12.22.10
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The great thing about this is you can commit that file to git and then anyone
who checks out the project and uses &lt;code&gt;asdf&lt;/code&gt; will have the same versions activated!&lt;/p&gt;
&lt;h3&gt;Temporary&lt;/h3&gt;
&lt;p&gt;If you want to activate a version of a language temporarily you can swap to it
for the current shell:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf shell golang 1.17.7
&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;env&lt;/span&gt;|grep -i ASDF
ASDF_GOLANG_VERSION=1.17.7
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It sets an environment variable that will have preference over the file. If you
ever wonder what versions a directory is using you can run:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;&gt; asdf current
golang          ______          No version &lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt;. Run &lt;span class=&quot;hljs-string&quot;&gt;&quot;asdf &amp;#x3C;global|shell|local&gt; golang &amp;#x3C;version&gt;&quot;&lt;/span&gt;
nodejs          12.22.10        .tool-versions
poetry          ______          No version &lt;span class=&quot;hljs-built_in&quot;&gt;set&lt;/span&gt;. Run &lt;span class=&quot;hljs-string&quot;&gt;&quot;asdf &amp;#x3C;global|shell|local&gt; poetry &amp;#x3C;version&gt;&quot;&lt;/span&gt;
python          3.9.10          .tool-versions
yarn            1.22.17         .tool-versions
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://asdf-vm.com/&quot;&gt;asdf&lt;/a&gt;  is an AWESOME tool to utilize if you find yourself using many
different languages or many different versions of the same language. You should check it out
and see if it can improve your workflow.&lt;/p&gt;
&lt;p&gt;I made a video of me using the tool here:&lt;/p&gt;
&lt;iframe width=&quot;854&quot; height=&quot;480&quot; src=&quot;https://www.youtube.com/embed/RTaqWRj-6Lg&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;&lt;/iframe&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/2022/intro_to_asdf&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/2022/intro_to_asdf&lt;/guid&gt;
            &lt;pubDate&gt;Fri, 18 Feb 2022 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Preparing custom images for OpenStack]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;This article will show you how to use libvirt to create base images that
can be uploaded to OpenStack.&lt;/p&gt;
&lt;h1&gt;Why would you want to do this?&lt;/h1&gt;
&lt;p&gt;Linux distributions like Fedora and Ubuntu already ship &quot;cloud&quot; images
and most providers also have their own custom images for you to use, but
I find it much more comforting to have full control of the software that
is installed and I like the ability to easily apply new security patches
to base images.&lt;/p&gt;
&lt;p&gt;I wouldn&#x27;t use images to replace config management (CM) with something
like &lt;a href=&quot;http://www.saltstack.com/&quot;&gt;Salt&lt;/a&gt; or
&lt;a href=&quot;http://www.ansible.com/&quot;&gt;Ansible&lt;/a&gt; but they are nice to give sane system
defaults in things like &lt;code&gt;grub.conf&lt;/code&gt;, &lt;code&gt;sysctl.conf&lt;/code&gt;, and shipping a Chef
or Salt agent so that your CM engine can communicate with your server
right away.&lt;/p&gt;
&lt;h1&gt;Setting up your environment&lt;/h1&gt;
&lt;p&gt;The first thing you need to do is get a minimal install disk for the
Linux distribution you want to use. I prefer using Fedora netinst disks
but another popular option is Ubuntu Server.&lt;/p&gt;
&lt;p&gt;To get the latest Fedora here, you can choose &quot;netinst&quot; under Direct
Downloads: &lt;a href=&quot;http://fedoraproject.org/en/get-fedora-all&quot;&gt;http://fedoraproject.org/en/get-fedora-all&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;To get the latest Ubuntu you can go here:
&lt;a href=&quot;http://www.ubuntu.com/download/server&quot;&gt;http://www.ubuntu.com/download/server&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Once you have acquired your distribution of choice you just need to
verify that you have &lt;code&gt;virt-install&lt;/code&gt; and &lt;code&gt;virt-viewer&lt;/code&gt; installed:&lt;/p&gt;
&lt;p&gt;Fedora:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;yum install virt-install virt-viewer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ubuntu:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;apt-get install virtinst virt-viewer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you prefer a graphical user interface, you may use &lt;code&gt;virt-manager&lt;/code&gt;
instead, but I try to keep everything in the CLI; that way it can be
repeated easily.&lt;/p&gt;
&lt;h1&gt;Preparing your disk&lt;/h1&gt;
&lt;p&gt;Now that you have a base ISO and the tools necessary, let&#x27;s get started
by creating a disk to install the virtual server into. Resizing an image
isn&#x27;t an impossible task but it is much easier to choose a reasonably
sized disk for the purpose it will be used for.&lt;/p&gt;
&lt;p&gt;I primarily use 8 GB disks -- that way we can fit all the system
components required as well as our own web applications. Any large files
should be placed in a SAN or something like Dreamhost&#x27;s dreamobjects.&lt;/p&gt;
&lt;p&gt;The other big decision you must make upfront is what disk format you
want to use -- the trade-off is disk space vs performance. The two
primary formats are qcow2 (QEMU Copy on Write) and Raw. qcow2 is great
if you have limited disk space and don&#x27;t want to allocate the full 8 GB
up front. Raw is preferred if you want the best performance.&lt;/p&gt;
&lt;p&gt;If you choose qcow2, you&#x27;ll also need to make sure you have &lt;code&gt;qemu-img&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;Fedora:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;yum install qemu-img
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ubuntu:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;apt-get install qemu-utils
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Create a raw disk:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;fallocate -l 8192M server.img
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Create a qcow2 disk:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;qemu-img create -f qcow2 server.qcow2 8G
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Installing your distribution onto the disk&lt;/h1&gt;
&lt;p&gt;We will use the &lt;code&gt;virt-install&lt;/code&gt; command to get the distribution installed
onto the disk image.&lt;/p&gt;
&lt;p&gt;To install Fedora on a qcow2 disk image:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;virt-install --name base_server --ram 1024 --cdrom=./Fedora-20-x86_64-netinst.iso \
--disk path=./server.qcow2,format=qcow2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To install Ubuntu Server on a raw disk image:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;virt-install --name base_server --ram 1024 --cdrom=./ubuntu-12.04.4-server-amd64.iso \
--disk path=./server.img,format=raw
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You should follow the standard install steps that you normally would
when setting up your distribution. But here are some tips for each:&lt;/p&gt;
&lt;p&gt;Fedora:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Choose minimal install -- by default it selects &quot;GNOME&quot;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Ubuntu:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Be sure to select OpenSSH server -- it won&#x27;t install it by
default.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;On Ubuntu 12.04, there is a bug that makes it hang after running
&lt;code&gt;fsck&lt;/code&gt;. You will need to edit grub to get it to boot, hit _&lt;a href=&quot;&quot;&gt;e&lt;/a&gt; at
the boot prompt and add &quot;nomodeset&quot; on the linux line. You will
know that you need to do this if your boot hangs on fsck:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;fsck from util-linux 2.20.1
/dev/mapper/ubuntu--vg-root: clean, 57106/441504 files, 286779/1764352 blocks
/dev/sda1: clean, 230/62248 files, 39833/248832 blocks
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Preparing image for openstack&lt;/h1&gt;
&lt;p&gt;To prepare a virtual machine for the cloud, you will need to install the
&lt;code&gt;cloud-init&lt;/code&gt; package, which allows the cloud providers to inject certain
system settings when creating servers based on the image. These are
things like hostname and ssh keys.&lt;/p&gt;
&lt;p&gt;On Fedora:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;yum install cloud-init
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On Ubuntu:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;apt-get install cloud-init
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then you need to just configure &lt;code&gt;cloud-init&lt;/code&gt; by editing
&lt;code&gt;/etc/cloud/cloud.cfg&lt;/code&gt; and update the &lt;code&gt;datasources_list&lt;/code&gt; section to
include EC2. OpenStack uses EC2 metadata for &lt;code&gt;cloud-init&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;You should also verify the user setting in this same config and define
the user you plan to use, it will be where the &lt;code&gt;authorized_keys&lt;/code&gt; file is
setup for when the cloud provider injects your SSH key into the server.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cloud-init&lt;/code&gt; will not create the user for you, it will just assign the
SSH keypair and reset the password. So make sure the user defined in
&lt;code&gt;cloud.cfg&lt;/code&gt; is also created on the system.&lt;/p&gt;
&lt;p&gt;Once you have your &lt;code&gt;cloud-init&lt;/code&gt; settings the way you want them, just
shutdown and run the &lt;code&gt;virt-sysprep&lt;/code&gt; command.&lt;/p&gt;
&lt;p&gt;On the guest machine:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;shutdown -h now
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On the host machine:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;virt-sysprep -d base_server
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Uploading your image to OpenStack&lt;/h1&gt;
&lt;p&gt;Using the glance API it is very straightforward to upload the image to
OpenStack. Just run the following command:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;glance image-create --name base_server --disk-format=qcow2 \
--container-format=bare --is-public=True --file server.qcow2 --progress
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once the image upload completes you will be able to use it immediately
within nova. You can reference it by name or by the id from [glance
image-list]{.title-ref}.&lt;/p&gt;
&lt;p&gt;To create your first instance from the image:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;nova boot --flavor m1.tiny --image base_server --key-name devops \
--security-groups free_for_all test_server
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Obviously the security groups, key name, and flavors are based on your
installation of OpenStack but can all easily be queried from the nova
API:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;nova flavor-list
nova secgroup-list
nova keypair-list
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And you are done! You&#x27;ll be able to re-use your new image as a base for
all new instances you spin up in openstack!&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/old/preparing_cloud_images_with_libvirt&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/old/preparing_cloud_images_with_libvirt&lt;/guid&gt;
            &lt;pubDate&gt;Sun, 03 Aug 2014 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Writing tests for Pyramid and SQLAlchemy]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;TL;DR: Putting it all together, the full code can be found here:
&lt;a href=&quot;https://gist.github.com/1420255&quot;&gt;https://gist.github.com/1420255&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;Intro&lt;/h1&gt;
&lt;p&gt;Pyramid&#x27;s documentation doesn&#x27;t cover the preferred way to test with
SQLAlchemy, because Pyramid tries to stay out of your way and allow you
to make your own decisions. However, I feel i&#x27;ts necessary to document
what I think is the best way to test.&lt;/p&gt;
&lt;p&gt;When I first started writing tests with SQLAlchemy I found plenty of
examples of how to to get started by doing something like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; db &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; session &lt;span class=&quot;hljs-comment&quot;&gt;# probably a contextbound sessionmaker&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; db &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; model

&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; sqlalchemy &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; create_engine

&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setup&lt;/span&gt;():
    engine = create_engine(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sqlite:///test.db&#x27;&lt;/span&gt;)
    session.configure(bind=engine)
    model.metadata.create_all(engine)

&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;teardown&lt;/span&gt;():
    model.metadata.drop_all(engine)

&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_something&lt;/span&gt;():
    &lt;span class=&quot;hljs-keyword&quot;&gt;pass&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I have seen this done so many times, but I feel there is so much wrong
with it! So let&#x27;s establish some base rules when testing:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Always test your system like it would be used in production.
SQLite does not enforce the same rules or have the same features
as Postgres or MySQL and will allow tests to pass that would
otherwise fail in production.&lt;/li&gt;
&lt;li&gt;Tests should be fast! You should be writing tests for all your
code. This is the main reason people do test against SQLite, but
we can&#x27;t violate rule number one. We have to make sure tests
against Postgres are fast, so we shouldn&#x27;t be tearing down and
recreating tables for every single test.&lt;/li&gt;
&lt;li&gt;You should be able to execute in parallel to speed up when you
have thousands of tests. Dropping and creating tables per test
would not work in a parallel environment.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;For an example, I have a project with 600+ tests and it would take 2 and
half minutes to execute running against SQLite. But when we swapped our
test configuration to execute against Postgres, testing took well over
an hour. That is unacceptable!&lt;/p&gt;
&lt;p&gt;But running them in parallel will give us a huge speed up. Check out the
results of the tests running in single proc mode vs using all 4 cores:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;$ &lt;span class=&quot;hljs-attr&quot;&gt;py.test&lt;/span&gt;
======= 616 passed in 143.67 &lt;span class=&quot;hljs-attr&quot;&gt;seconds&lt;/span&gt; =======

$ py.test &lt;span class=&quot;hljs-attr&quot;&gt;-n4&lt;/span&gt;
======= 616 passed in 68.12 &lt;span class=&quot;hljs-attr&quot;&gt;seconds&lt;/span&gt; =======
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;The right way&lt;/h1&gt;
&lt;p&gt;So what is the proper way to setup your tests? You should initialize the
database when you start your test runner and then use transactions to
rollback any data changes your tests made. This allows you to keep a
clean database for each test in a very efficient way.&lt;/p&gt;
&lt;p&gt;In py.test, you just have to create a file called conftest.py that looks
similar to:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; os

ROOT_PATH = os.path.dirname(__file__)

&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;pytest_sessionstart&lt;/span&gt;():
    &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; py.test &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; config

    &lt;span class=&quot;hljs-comment&quot;&gt;# Only run database setup on master (in case of xdist/multiproc mode)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;hasattr&lt;/span&gt;(config, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;slaveinput&#x27;&lt;/span&gt;):
        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; models &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; initialize_sql
        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; pyramid.config &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Configurator
        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; paste.deploy.loadwsgi &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; appconfig
        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; sqlalchemy &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; engine_from_config
        &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; os

        ROOT_PATH = os.path.dirname(__file__)
        settings = appconfig(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;config:&#x27;&lt;/span&gt; + os.path.join(ROOT_PATH, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;test.ini&#x27;&lt;/span&gt;))
        engine = engine_from_config(settings, prefix=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sqlalchemy.&#x27;&lt;/span&gt;)

        &lt;span class=&quot;hljs-built_in&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&#x27;Creating the tables on the test database %s&#x27;&lt;/span&gt; % engine

        config = Configurator(settings=settings)
        initialize_sql(settings, config)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With py.test, when you are running in parallel mode, the
pytest_sessionstart hook gets fired for each node, so we check that we
are on the master node. Then we just grab our test.ini configuration
file and execute the initialize_sql function.&lt;/p&gt;
&lt;p&gt;Now that you have your initial test configuration finished, you have to
define a base test class that does the transaction management in setUp
and teardown.&lt;/p&gt;
&lt;p&gt;First, lets setup the Base testing class what will manage our
transactions:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; unittest
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; pyramid &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; testing
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; paste.deploy.loadwsgi &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; appconfig

&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; webtest &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; TestApp
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; mock &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Mock

&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; sqlalchemy &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; engine_from_config
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; sqlalchemy.orm &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; sessionmaker
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; app.db &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Session
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; app.db &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Entity  &lt;span class=&quot;hljs-comment&quot;&gt;# base declarative object&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; app &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; main
&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; os
here = os.path.dirname(__file__)
settings = appconfig(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;config:&#x27;&lt;/span&gt; + os.path.join(here, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;../../&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;test.ini&#x27;&lt;/span&gt;))

&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;BaseTestCase&lt;/span&gt;(unittest.TestCase):
&lt;span class=&quot;hljs-meta&quot;&gt;    @classmethod&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setUpClass&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;cls&lt;/span&gt;):
        cls.engine = engine_from_config(settings, prefix=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sqlalchemy.&#x27;&lt;/span&gt;)
        cls.Session = sessionmaker()

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setUp&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        connection = self.engine.connect()

        &lt;span class=&quot;hljs-comment&quot;&gt;# begin a non-ORM transaction&lt;/span&gt;
        self.trans = connection.begin()

        &lt;span class=&quot;hljs-comment&quot;&gt;# bind an individual Session to the connection&lt;/span&gt;
        Session.configure(bind=connection)
        self.session = self.Session(bind=connection)
        Entity.session = self.session

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;tearDown&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-comment&quot;&gt;# rollback - everything that happened with the&lt;/span&gt;
        &lt;span class=&quot;hljs-comment&quot;&gt;# Session above (including calls to commit())&lt;/span&gt;
        &lt;span class=&quot;hljs-comment&quot;&gt;# is rolled back.&lt;/span&gt;
        testing.tearDown()
        self.trans.rollback()
        self.session.close()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This base test case will wrap all your sessions in an external
transaction so that you still have the ability to call flush/commit/etc
and it will still be able to rollback any data changes you make.&lt;/p&gt;
&lt;h1&gt;Unit Tests&lt;/h1&gt;
&lt;p&gt;Now there are a few different types of tests you will want to run.
First, you will want to do unit tests, which are small tests that only
test 1 thing at a time. This means you will skip the routes, templates,
etc. So let&#x27;s setup our Unit Test Base class:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UnitTestBase&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;BaseTestCase&lt;/span&gt;):
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setUp&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        self.config = testing.setUp(request=testing.DummyRequest())
        &lt;span class=&quot;hljs-built_in&quot;&gt;super&lt;/span&gt;(UnitTestBase, self).setUp()

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;get_csrf_request&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self, post=&lt;span class=&quot;hljs-literal&quot;&gt;None&lt;/span&gt;&lt;/span&gt;):
        csrf = &lt;span class=&quot;hljs-string&quot;&gt;&#x27;abc&#x27;&lt;/span&gt;

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;csrf_token&#x27;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; post.keys():
            post.update({
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;csrf_token&#x27;&lt;/span&gt;: csrf
            })

        request = testing.DummyRequest(post)

        request.session = Mock()
        csrf_token = Mock()
        csrf_token.return_value = csrf

        request.session.get_csrf_token = csrf_token

        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; request
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We built in a utility function to help us test requests that require a
csrf token as well. Here is how we would use this class:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;TestViews&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;UnitTestBase&lt;/span&gt;):
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_login_fails_empty&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot; Make sure we can&#x27;t login with empty credentials&quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; app.accounts.views &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; LoginView
        self.config.add_route(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;index&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/&#x27;&lt;/span&gt;)
        self.config.add_route(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;dashboard&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/&#x27;&lt;/span&gt;)

        request = testing.DummyRequest(post={
            &lt;span class=&quot;hljs-string&quot;&gt;&#x27;submit&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;,
        })

        view = LoginView(request)
        response = view.post()
        errors = response[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;errors&#x27;&lt;/span&gt;]

        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;].node.name == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;csrf_token&#x27;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;].msg == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;Required&#x27;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;].node.name == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;Username&#x27;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;].msg == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;Required&#x27;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;].node.name == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;Password&#x27;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; errors[&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;].msg == &lt;span class=&quot;hljs-string&quot;&gt;u&#x27;Required&#x27;&lt;/span&gt;


    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_login_succeeds&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot; Make sure we can login &quot;&quot;&quot;&lt;/span&gt;
        admin = User(username=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sontek&#x27;&lt;/span&gt;, password=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;temp&#x27;&lt;/span&gt;, kind=&lt;span class=&quot;hljs-string&quot;&gt;u&#x27;admin&#x27;&lt;/span&gt;)
        admin.activated = &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;
        self.session.add(admin)
        self.session.flush()

        &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; app.accounts.views &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; LoginView
        self.config.add_route(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;index&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/&#x27;&lt;/span&gt;)
        self.config.add_route(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;dashboard&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;/dashboard&#x27;&lt;/span&gt;)

        request = self.get_csrf_request(post={
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;submit&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;,
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;Username&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&#x27;sontek&#x27;&lt;/span&gt;,
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;Password&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&#x27;temp&#x27;&lt;/span&gt;,
            })

        view = LoginView(request)
        response = view.post()

        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; response.status_int == &lt;span class=&quot;hljs-number&quot;&gt;302&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Integration Tests&lt;/h1&gt;
&lt;p&gt;The second type of test you will want to write is an integration test.
This will integrate with the whole web framework and actually hit the
define routes, render the templates, and actually test the full stack of
your application.&lt;/p&gt;
&lt;p&gt;Luckily this is pretty easy to do with Pyramid using WebTest:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;IntegrationTestBase&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;BaseTestCase&lt;/span&gt;):
&lt;span class=&quot;hljs-meta&quot;&gt;    @classmethod&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setUpClass&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;cls&lt;/span&gt;):
        cls.app = main({}, **settings)
        &lt;span class=&quot;hljs-built_in&quot;&gt;super&lt;/span&gt;(IntegrationTestBase, cls).setUpClass()

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;setUp&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        self.app = TestApp(self.app)
        self.config = testing.setUp()
        &lt;span class=&quot;hljs-built_in&quot;&gt;super&lt;/span&gt;(IntegrationTestBase, self).setUp()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In setUpClass, we run the main function of the applications
__init__.py that sets up the WSGI application and then we wrap it in
a TestApp that gives us the ability to call get/post on it.&lt;/p&gt;
&lt;p&gt;Here is an example of it in use:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;TestViews&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;IntegrationTestBase&lt;/span&gt;):
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_get_login&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot; Call the login view, make sure routes are working &quot;&quot;&quot;&lt;/span&gt;
        res = self.app.get(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;/login&#x27;&lt;/span&gt;)
        self.assertEqual(res.status_int, &lt;span class=&quot;hljs-number&quot;&gt;200&lt;/span&gt;)

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_empty_login&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot; Empty login fails &quot;&quot;&quot;&lt;/span&gt;
        res = self.app.post(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;/login&#x27;&lt;/span&gt;, {&lt;span class=&quot;hljs-string&quot;&gt;&#x27;submit&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;})

        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;There was a problem with your submission&quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; res.body
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;Required&quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; res.body
        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; res.status_int == &lt;span class=&quot;hljs-number&quot;&gt;200&lt;/span&gt;

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;test_valid_login&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot; Call the login view, make sure routes are working &quot;&quot;&quot;&lt;/span&gt;
        admin = User(username=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;sontek&#x27;&lt;/span&gt;, password=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;temp&#x27;&lt;/span&gt;, kind=&lt;span class=&quot;hljs-string&quot;&gt;u&#x27;admin&#x27;&lt;/span&gt;)
        admin.activated = &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;
        self.session.add(admin)
        self.session.flush()

        res = self.app.get(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;/login&#x27;&lt;/span&gt;)

        csrf = res.form.fields[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;csrf_token&#x27;&lt;/span&gt;][&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;].value

        res = self.app.post(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;/login&#x27;&lt;/span&gt;,
            {
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;submit&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-literal&quot;&gt;True&lt;/span&gt;,
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;Username&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&#x27;sontek&#x27;&lt;/span&gt;,
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;Password&#x27;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&#x27;temp&#x27;&lt;/span&gt;,
                &lt;span class=&quot;hljs-string&quot;&gt;&#x27;csrf_token&#x27;&lt;/span&gt;: csrf
            }
        )

        &lt;span class=&quot;hljs-keyword&quot;&gt;assert&lt;/span&gt; res.status_int == &lt;span class=&quot;hljs-number&quot;&gt;302&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Problems with this approach&lt;/h1&gt;
&lt;p&gt;If a test causes an error that will prevent the transaction from rolling
back, such as closing the engine, then this approach will leave your
database in a state that might cause other tests to fail.&lt;/p&gt;
&lt;p&gt;If this happens tracing the root cause could be difficult but you should
be able to just look at the first failed test unless you are running the
tests in parallel.&lt;/p&gt;
&lt;p&gt;If you are good about writing and running your tests regularly you
should be able to catch individual tests causing issues like this fairly
quickly.&lt;/p&gt;
&lt;h1&gt;Resources&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html&quot;&gt;http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction&quot;&gt;http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;John Anderson &amp;#x3C;&lt;a href=&quot;mailto:sontek@gmail.com&quot;&gt;sontek@gmail.com&lt;/a&gt;&gt; 2011&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/old/writing_tests_for_pyramid_and_sqlalchemy&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/old/writing_tests_for_pyramid_and_sqlalchemy&lt;/guid&gt;
            &lt;pubDate&gt;Thu, 01 Dec 2011 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Turning Vim into a modern Python IDE]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;TL;DR:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-shell&quot;&gt;&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;git &lt;span class=&quot;hljs-built_in&quot;&gt;clone&lt;/span&gt; https://github.com/sontek/dotfiles.git&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;cd&lt;/span&gt; dotfiles&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;./install.sh vim&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Intro&lt;/h1&gt;
&lt;p&gt;Back in 2008, I wrote the article &lt;a href=&quot;http://sontek.net/python-with-a-modular-ide-vim&quot;&gt;Python with a modular IDE
(Vim)&lt;/a&gt;. Years later, I
have people e-mailing me and commenting daily asking for more
information, even though most of the information in it is outdated. Here
is the modern way to work with Python and Vim to achieve the perfect
environment.&lt;/p&gt;
&lt;p&gt;Because one of the most important parts about a development environment
is the ability to easily reproduce across machines, we are going to
store our vim configuration in git:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-shell&quot;&gt;&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; ~/.vim/&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; ~/.vim/{&lt;span class=&quot;hljs-built_in&quot;&gt;autoload&lt;/span&gt;,bundle}&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;cd&lt;/span&gt; ~/.vim/&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;git init&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The purpose of the autoload directory is to automatically load the vim
plugin &lt;a href=&quot;https://github.com/tpope/vim-pathogen&quot;&gt;Pathogen&lt;/a&gt;, which we&#x27;ll
then use to load all other plugins that are located in the bundle
directory. So download pathogen and put it in your autoload folder.&lt;/p&gt;
&lt;p&gt;You&#x27;ll need to add the following to your ~/.vimrc so that pathogen
will be loaded properly. Filetype detection must be off when you run the
commands so its best to execute them first:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-r&quot;&gt;filetype off
&lt;span class=&quot;hljs-built_in&quot;&gt;call&lt;/span&gt; pathogen&lt;span class=&quot;hljs-comment&quot;&gt;#runtime_append_all_bundles()&lt;/span&gt;
&lt;span class=&quot;hljs-built_in&quot;&gt;call&lt;/span&gt; pathogen&lt;span class=&quot;hljs-comment&quot;&gt;#helptags()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now lets add all of the vim plugins we plan on using as submodules to
our git repository:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-bash&quot;&gt;git submodule add http://github.com/tpope/vim-fugitive.git bundle/fugitive
git submodule add https://github.com/msanders/snipmate.vim.git bundle/snipmate
git submodule add https://github.com/tpope/vim-surround.git bundle/surround
git submodule add https://github.com/tpope/vim-git.git bundle/git
git submodule add https://github.com/ervandew/supertab.git bundle/supertab
git submodule add https://github.com/sontek/minibufexpl.vim.git bundle/minibufexpl
git submodule add https://github.com/wincent/Command-T.git bundle/command-t
git submodule add https://github.com/mitechie/pyflakes-pathogen.git
git submodule add https://github.com/mileszs/ack.vim.git bundle/ack
git submodule add https://github.com/sjl/gundo.vim.git bundle/gundo
git submodule add https://github.com/fs111/pydoc.vim.git bundle/pydoc
git submodule add https://github.com/vim-scripts/pep8.git bundle/pep8
git submodule add https://github.com/alfredodeza/pytest.vim.git bundle/py.test
git submodule add https://github.com/reinh/vim-makegreen bundle/makegreen
git submodule add https://github.com/vim-scripts/TaskList.vim.git bundle/tasklist
git submodule add https://github.com/vim-scripts/The-NERD-tree.git bundle/nerdtree
git submodule add https://github.com/sontek/rope-vim.git bundle/ropevim
git submodule init
git submodule update
git submodule foreach git submodule init
git submodule foreach git submodule update
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Thats it! Now that we&#x27;ve got our vim configuration in git!&lt;/p&gt;
&lt;p&gt;Now lets look at how to use each of these plugins to improve the power
of vim:&lt;/p&gt;
&lt;h1&gt;Basic Editing and Debugging&lt;/h1&gt;
&lt;h2&gt;Code Folding&lt;/h2&gt;
&lt;p&gt;Lets first enable code folding. This makes it a lot easier to organize
your code and hide portions that you aren&#x27;t interested in working on.
This is quite easy for Python, since whitespace is required.&lt;/p&gt;
&lt;p&gt;In your ~/.vimrc just add:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;set &lt;span class=&quot;hljs-attr&quot;&gt;foldmethod&lt;/span&gt;=indent
set &lt;span class=&quot;hljs-attr&quot;&gt;foldlevel&lt;/span&gt;=&lt;span class=&quot;hljs-number&quot;&gt;99&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then you will be able to be inside a method and type &#x27;za&#x27; to open and
close a fold.&lt;/p&gt;
&lt;h2&gt;Window Splits&lt;/h2&gt;
&lt;p&gt;Sometimes code folding isn&#x27;t enough; you may need to start opening up
multiple windows and working on multiple files at once or different
locations within the same file. To do this in vim, you can use these
shortcuts:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-yaml&quot;&gt;&lt;span class=&quot;hljs-attr&quot;&gt;Vertical Split :&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;Ctrl+w&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;v&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;Horizontal Split:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;Ctrl+w&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;s&lt;/span&gt;
&lt;span class=&quot;hljs-attr&quot;&gt;Close current windows:&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;Ctrl+w&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;q&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I also like to bind Ctrl+&amp;#x3C;movement&gt; keys to move around the windows,
instead of using Ctrl+w + &amp;#x3C;movement&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;map &amp;#x3C;c-j&gt; &amp;#x3C;c-w&gt;j
map &amp;#x3C;c-k&gt; &amp;#x3C;c-w&gt;k
map &amp;#x3C;c-l&gt; &amp;#x3C;c-w&gt;l
map &amp;#x3C;c-h&gt; &amp;#x3C;c-w&gt;h
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/krj0l.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h2&gt;Snippets&lt;/h2&gt;
&lt;p&gt;The next tweak that really speeds up development is using snipmate.
We&#x27;ve already included it in our bundle/ folder so its already enabled.
Try opening up a python file and typing &#x27;def&amp;#x3C;tab&gt;&#x27;. It should stub
out a method definition for you and allow you to tab through and fill
out the arguments, doc string, etc.&lt;/p&gt;
&lt;p&gt;I also like to create my own snippets folder to put in some custom
snippets:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-shell&quot;&gt;&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;mkdir&lt;/span&gt; ~/.vim/snippets&lt;/span&gt;
&lt;span class=&quot;hljs-meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;vim ~/.vim/snippets/python.snippets&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Put this in the file:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;snippet pdb
    &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; pdb; pdb.&lt;span class=&quot;hljs-built_in&quot;&gt;set_trace&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now you can type pdb&amp;#x3C;tab&gt; and it&#x27;ll insert your breakpoint!&lt;/p&gt;
&lt;h2&gt;Task lists&lt;/h2&gt;
&lt;p&gt;Another really useful thing is to mark some of your code as TODO or
FIXME! I know we all like to think we write perfect code, but sometimes
you just have to settle and leave a note for yourself to come back
later. One of the plugins we included was the tasklist plugin that will
allow us to search all open buffers for things to fix. Just add a
mapping to open it in ~/.vimrc:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;map &amp;#x3C;leader&gt;td &amp;#x3C;Plug&gt;TaskList
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now you can hit &amp;#x3C;leader&gt;td to open your task list and hit &#x27;q&#x27; to
close it. You can also hit enter on the task to jump to the buffer and
line that it is placed on.&lt;/p&gt;
&lt;h2&gt;Revision History&lt;/h2&gt;
&lt;p&gt;The final basic editing tweak I suggest everyone start utilizing is the
Gundo plugin. It&#x27;ll allow you to view diff&#x27;s of every save on a file
you&#x27;ve made and allow you to quickly revert back and forth:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/2NrPS.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;Just bind a key in your .vimrc to toggle the Gundo window:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ruby&quot;&gt;map &amp;#x3C;leader&gt;g &lt;span class=&quot;hljs-symbol&quot;&gt;:GundoToggle&amp;#x3C;CR&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Syntax Highlighting and Validation&lt;/h1&gt;
&lt;p&gt;Simply enable syntax highlighting in your ~/.vimrc:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-vbnet&quot;&gt;syntax &lt;span class=&quot;hljs-keyword&quot;&gt;on&lt;/span&gt;                           &lt;span class=&quot;hljs-string&quot;&gt;&quot; syntax highlighing
filetype on                          &quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;to&lt;/span&gt; detect filetypes
filetype plugin indent &lt;span class=&quot;hljs-keyword&quot;&gt;on&lt;/span&gt;    &lt;span class=&quot;hljs-string&quot;&gt;&quot; enable loading indent file for filetype
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Because we enabled pyflakes when we added it as a submodule in
~/.vim/bundle, it will notify you about unused imports and invalid
syntax. It will save you a lot of time saving and running just to find
out you missed a colon. I like to tell it not use the quickfix window:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;let g:&lt;span class=&quot;hljs-attr&quot;&gt;pyflakes_use_quickfix&lt;/span&gt; = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/ZfjFe.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h2&gt;Pep8&lt;/h2&gt;
&lt;p&gt;The final plugin that really helps validate your code is the pep8
plugin, it&#x27;ll make sure your code is consistent across all projects.
Add a key mapping to your ~/.vimrc and then you&#x27;ll be able to jump to
each of the pep8 violations in the quickfix window:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;let g:&lt;span class=&quot;hljs-attr&quot;&gt;pep8_map&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;&amp;#x3C;leader&gt;8&#x27;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/VU9AB.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h1&gt;Tab Completion and Documentation&lt;/h1&gt;
&lt;p&gt;Vim has many different code completion options. We are going to use the
SuperTab plugin to check the context of the code you are working on and
choose the best for the situation. We&#x27;ve already enabled the SuperTab
plugin in the bundle/ folder, so we just have to configure it to be
context sensitive and to enable omni code completion in your ~/.vimrc:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;au FileType python set &lt;span class=&quot;hljs-attr&quot;&gt;omnifunc&lt;/span&gt;=pythoncomplete&lt;span class=&quot;hljs-comment&quot;&gt;#Complete&lt;/span&gt;
let g:&lt;span class=&quot;hljs-attr&quot;&gt;SuperTabDefaultCompletionType&lt;/span&gt; = &lt;span class=&quot;hljs-string&quot;&gt;&quot;context&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we just enable the menu and pydoc preview to get the most useful
information out of the code completion:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;set &lt;span class=&quot;hljs-attr&quot;&gt;completeopt&lt;/span&gt;=menuone,longest,preview
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/g4lxP.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;We also enabled the pydoc plugin at the beginning with all the
submodules; that gives us the ability to hit &amp;#x3C;leader&gt;pw when our
cursor is on a module and have a new window open with the whole
documentation page for it.&lt;/p&gt;
&lt;h1&gt;Code Navigation&lt;/h1&gt;
&lt;h2&gt;Buffers&lt;/h2&gt;
&lt;p&gt;The most important part about navigating code within vim, is to
completely understand how to use buffers. There is no reason to use
tabs. Open files with :e &amp;#x3C;filename&gt; to place in a buffer. We already
installed the minibufexpl plugin, so you will already visually see every
buffer opened. You can also get a list of them doing :buffers.&lt;/p&gt;
&lt;p&gt;You can switch between the buffers using b&amp;#x3C;number&gt;, such as :b1 for
the first buffer. You can also use its name to match, so you can type :b
mod&amp;#x3C;tab&gt; to autocomplete opening the models.py buffer. You need to
make sure you are using the minibufexpl from my github since it has
patches that make it much better to work with.&lt;/p&gt;
&lt;p&gt;To close a buffer you use :bd or :bw.&lt;/p&gt;
&lt;h2&gt;Fuzzy Text File Search&lt;/h2&gt;
&lt;p&gt;To make finding and opening files within your project even easier, we
are going to use the command-t plugin. It does have some parts that need
to be compiled, so its not already installed by adding it as a
submodule. Go to your ~/.vim/bundle/command-t folder and run &#x27;rake
make&#x27;. Yes you need ruby installed. By default, command-t is bound to
&amp;#x3C;leader&gt;t. This will use fuzzy text matching to find any file in your
project.&lt;/p&gt;
&lt;p&gt;It also supports searching only through opened buffers, instead of files
using &amp;#x3C;leader&gt;b.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/hUcSl.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h2&gt;File Browser&lt;/h2&gt;
&lt;p&gt;NERD Tree is a project file browser. I must admit I used this heavily
back when I was migrating from Visual Studio and used to the Solution
Explorer, but I rarely use it anymore. Command-T is usually all you&#x27;ll
need. It is useful when you are getting to know a new codebase for the
first time though. Lets bind a shortcut key for opening it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ruby&quot;&gt;map &amp;#x3C;leader&gt;n &lt;span class=&quot;hljs-symbol&quot;&gt;:NERDTreeToggle&amp;#x3C;CR&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/R4ZzQ.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h2&gt;Refactoring and Go to definition&lt;/h2&gt;
&lt;p&gt;Ropevim is also a great tool that will allow you to navigate around your
code. It supports automatically inserting import statements, goto
definition, refactoring, and code completion. You&#x27;ll really want to
read up on everything it does, but the two big things I use it for is to
jump to function or class definitions quickly and to rename things
(including all their references).&lt;/p&gt;
&lt;p&gt;For instance, if you are using django and you place your cursor over the
class models.Model you reference and then called :RopeGotoDefintion, it
would jump you straight to the django library to that class definition.
We already have it installed in our bundles, so we bind it to a key to
use it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ruby&quot;&gt;map &amp;#x3C;leader&gt;j &lt;span class=&quot;hljs-symbol&quot;&gt;:RopeGotoDefinition&amp;#x3C;CR&gt;&lt;/span&gt;
map &amp;#x3C;leader&gt;r &lt;span class=&quot;hljs-symbol&quot;&gt;:RopeRename&amp;#x3C;CR&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Searching&lt;/h2&gt;
&lt;p&gt;The final tool that really speeds up navigating your code is the Ack
plugin. Ack is similar to grep, but much better in my opinion. You can
fuzzy text search for anything in your code (variable name, class,
method, etc) and it&#x27;ll give you a list of files and line numbers where
they are defined so you can quickly cycle through them. Just bind the
searching to a key:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-php-template&quot;&gt;&lt;span class=&quot;xml&quot;&gt;nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;leader&lt;/span&gt;&gt;&lt;/span&gt;a &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Ack!
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We use ! at the end of it so it doesn&#x27;t open the first result
automatically.&lt;/p&gt;
&lt;h1&gt;Integration with Git&lt;/h1&gt;
&lt;p&gt;We installed 2 plugins, git.vim and fugitive, that give us all the
integration we need. Git.vim will provide us syntax highlighting for git
configuration files; fugitive provides a great interface for interacting
with git including getting diffs, status updates, committing, and moving
files.&lt;/p&gt;
&lt;p&gt;Fugitive also allows you to view what branch you are working in directly
from vim. Add this to your statusline in ~/.vimrc:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-shell&quot;&gt;&lt;span class=&quot;hljs-meta prompt_&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt;{fugitive&lt;span class=&quot;hljs-comment&quot;&gt;#statusline()}&lt;/span&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The big commands you need to know:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Gblame&lt;/strong&gt;: This allows you to view a line by line comparison of who
the last person to touch that line of code is.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Gwrite&lt;/strong&gt;: This will stage your file for commit, basically doing
git add &amp;#x3C;filename&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Gread&lt;/strong&gt;: This will basically run a git checkout &amp;#x3C;filename&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Gcommit&lt;/strong&gt;: This will just run git commit. Since its in a vim
buffer, you can use keyword completion (Ctrl-N), like
test_all&amp;#x3C;Ctrl-N&gt; to find the method name in your buffer and
complete it for the commit message. You can also use + and - on the
filenames in the message to stage/unstage them for the commit.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/NuRRj.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h1&gt;Test Integration&lt;/h1&gt;
&lt;h2&gt;django nose&lt;/h2&gt;
&lt;p&gt;Test runner integration really depends on the testing library you are
using and what type of tests you are running but we included a great
generic plugin called MakeGreen that executes off of vim&#x27;s makeprg
variable. So for instance, if you are using django with django-nose you
could define a shortcut key in your ~/.vimrc like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-arduino&quot;&gt;map &amp;#x3C;leader&gt;dt :set makeprg=python\ manage.py\ test\|:call &lt;span class=&quot;hljs-built_in&quot;&gt;MakeGreen&lt;/span&gt;()&amp;#x3C;CR&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will just give you a green bar at the bottom of vim if your test
passed or a red bar with the message of the failed test if it doesn&#x27;t.
Very simple.&lt;/p&gt;
&lt;h2&gt;py.test&lt;/h2&gt;
&lt;p&gt;I also included the py.test vim plugin for those who prefer it. This
plugin has a lot more functionality including executing individual tests
by class, file, or method. You can also cycle through the individual
assertion errors. I have the following bindings:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-php-template&quot;&gt;&lt;span class=&quot;xml&quot;&gt;&quot; Execute the tests
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;tf &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest file&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;tc &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest class&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;tm &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest method&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
&quot; cycle through test errors
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;tn &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest next&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;tp &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest previous&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
nmap &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;silent&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Leader&lt;/span&gt;&gt;&lt;/span&gt;te &lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;Esc&lt;/span&gt;&gt;&lt;/span&gt;:Pytest error&lt;span class=&quot;hljs-tag&quot;&gt;&amp;#x3C;&lt;span class=&quot;hljs-name&quot;&gt;CR&lt;/span&gt;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/RAE7v.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h1&gt;Virtualenv&lt;/h1&gt;
&lt;p&gt;Vim doesn&#x27;t realize that you are in a virtualenv so it wont give you
code completion for libraries only installed there. Add the following
script to your ~/.vimrc to fix it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;&quot; Add the virtualenv&#x27;s site-packages to vim path
py &amp;#x3C;&amp;#x3C; EOF
import os.path
import sys
import vim
if &#x27;VIRTUAL_ENV&#x27; in os.environ:
    &lt;span class=&quot;hljs-attr&quot;&gt;project_base_dir&lt;/span&gt; = os.environ[&lt;span class=&quot;hljs-string&quot;&gt;&#x27;VIRTUAL_ENV&#x27;&lt;/span&gt;]
    sys.path.insert(0, project_base_dir)
    &lt;span class=&quot;hljs-attr&quot;&gt;activate_this&lt;/span&gt; = os.path.join(project_base_dir, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;bin/activate_this.py&#x27;&lt;/span&gt;)
    execfile(activate_this, dict(&lt;span class=&quot;hljs-attr&quot;&gt;__file__&lt;/span&gt;=activate_this))
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Django&lt;/h1&gt;
&lt;p&gt;The only true django tweak I make is before I open vim I&#x27;ll export the
DJANGO_SETTINGS_MODULE environment so that I get code completion for
django modules as well:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot;&gt;export &lt;span class=&quot;hljs-attr&quot;&gt;DJANGO_SETTINGS_MODULE&lt;/span&gt;=project.settings
&lt;/code&gt;&lt;/pre&gt;
&lt;h1&gt;Random Tips&lt;/h1&gt;
&lt;p&gt;If you want to find a new color scheme just go to
&lt;a href=&quot;http://code.google.com/p/vimcolorschemetest/&quot;&gt;http://code.google.com/p/vimcolorschemetest/&lt;/a&gt; to preview a large
selection.&lt;/p&gt;
&lt;p&gt;John Anderson &amp;#x3C;&lt;a href=&quot;mailto:sontek@gmail.com&quot;&gt;sontek@gmail.com&lt;/a&gt;&gt; 2011&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/old/turning_vim_into_a_modern_python_ide&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/old/turning_vim_into_a_modern_python_ide&lt;/guid&gt;
            &lt;pubDate&gt;Sat, 07 May 2011 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
        &lt;item&gt;
            &lt;title&gt;&lt;![CDATA[Tips and Tricks for the Python Interpreter]]&gt;&lt;/title&gt;
            &lt;description&gt;&lt;![CDATA[&lt;p&gt;I have seen a lot of people switch over to using ipython, bpython, etc
to get auto-complete support without realizing that the standard
interpreter does have this functionality.&lt;/p&gt;
&lt;p&gt;To enable auto-complete support in the python interpreter you need to
create a python startup file that enables readline support. A python
startup file is just a bunch of python code that gets executed at
startup of the interpreter. To do this you just setup PYTHONSTARTUP in
your ~/.bashrc and then create a ~/.pythonrc.py file:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;#.bashrc&lt;/span&gt;
PYTHONSTARTUP=~/.pythonrc.py
export PYTHONSTARTUP

&lt;span class=&quot;hljs-comment&quot;&gt;#.pythonrc.py&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt;:
    &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; readline
&lt;span class=&quot;hljs-keyword&quot;&gt;except&lt;/span&gt; ImportError:
    &lt;span class=&quot;hljs-built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Module readline not available.&quot;&lt;/span&gt;)
&lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt;:
    &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; rlcompleter
    readline.parse_and_bind(&lt;span class=&quot;hljs-string&quot;&gt;&quot;tab: complete&quot;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now when you are in python you have tab completion on importing, calling
methods on a module, etc.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;&gt;&gt;&gt; &lt;/span&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; o
&lt;span class=&quot;hljs-built_in&quot;&gt;object&lt;/span&gt;(  &lt;span class=&quot;hljs-built_in&quot;&gt;oct&lt;/span&gt;(     &lt;span class=&quot;hljs-built_in&quot;&gt;open&lt;/span&gt;(    &lt;span class=&quot;hljs-keyword&quot;&gt;or&lt;/span&gt;       &lt;span class=&quot;hljs-built_in&quot;&gt;ord&lt;/span&gt;(     os
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I always end up using the pretty print module for viewing long lists and
strings in the interpreter so I prefer to just use it by default:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;# Enable Pretty Printing for stdout&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; pprint
&lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;my_displayhook&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;value&lt;/span&gt;):
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; value &lt;span class=&quot;hljs-keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;None&lt;/span&gt;:
        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt;:
            &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; __builtin__
            __builtin__._ = value
        &lt;span class=&quot;hljs-keyword&quot;&gt;except&lt;/span&gt; ImportError:
            __builtins__._ = value

        pprint.pprint(value)

sys.displayhook = my_displayhook
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It is also very useful to be able to load up your favorite editor to
edit lines of code from the interpreter, you can do this by adding the
following into your ~/.pythonrc.py:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; os
&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; sys
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; code &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; InteractiveConsole
&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; tempfile &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; mkstemp

EDITOR = os.environ.get(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;EDITOR&#x27;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#x27;vi&#x27;&lt;/span&gt;)
EDIT_CMD = &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\e&#x27;&lt;/span&gt;

&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;EditableBufferInteractiveConsole&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;InteractiveConsole&lt;/span&gt;):
    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;__init__&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self, *args, **kwargs&lt;/span&gt;):
        self.last_buffer = [] &lt;span class=&quot;hljs-comment&quot;&gt;# This holds the last executed statement&lt;/span&gt;
        InteractiveConsole.__init__(self, *args, **kwargs)

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;runsource&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self, source, *args&lt;/span&gt;):
        self.last_buffer = [ source.encode(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;latin-1&#x27;&lt;/span&gt;) ]
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; InteractiveConsole.runsource(self, source, *args)

    &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;raw_input&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self, *args&lt;/span&gt;):
        line = InteractiveConsole.raw_input(self, *args)
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; line == EDIT_CMD:
            fd, tmpfl = mkstemp(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;.py&#x27;&lt;/span&gt;)
            os.write(fd, &lt;span class=&quot;hljs-string&quot;&gt;b&#x27;\n&#x27;&lt;/span&gt;.join(self.last_buffer))
            os.close(fd)
            os.system(&lt;span class=&quot;hljs-string&quot;&gt;&#x27;%s %s&#x27;&lt;/span&gt; % (EDITOR, tmpfl))
            line = &lt;span class=&quot;hljs-built_in&quot;&gt;open&lt;/span&gt;(tmpfl).read()
            os.unlink(tmpfl)
            tmpfl = &lt;span class=&quot;hljs-string&quot;&gt;&#x27;&#x27;&lt;/span&gt;
            lines = line.split( &lt;span class=&quot;hljs-string&quot;&gt;&#x27;\n&#x27;&lt;/span&gt; )
            &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;hljs-built_in&quot;&gt;len&lt;/span&gt;(lines) - &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;): self.push( lines[i] )
            line = lines[-&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;]
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; line

c = EditableBufferInteractiveConsole(&lt;span class=&quot;hljs-built_in&quot;&gt;locals&lt;/span&gt;=&lt;span class=&quot;hljs-built_in&quot;&gt;locals&lt;/span&gt;())
c.interact(banner=&lt;span class=&quot;hljs-string&quot;&gt;&#x27;&#x27;&lt;/span&gt;)

&lt;span class=&quot;hljs-comment&quot;&gt;# Exit the Python shell on exiting the InteractiveConsole&lt;/span&gt;
sys.exit()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For Django developers when you load up the ./manage.py shell it is nice
to have access to all your models and settings for testing:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-python&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;# If we&#x27;re working with a Django project, set up the environment&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&#x27;DJANGO_SETTINGS_MODULE&#x27;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; os.environ:
    &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; django.db.models.loading &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; get_models
    &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; django.test.client &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; Client
    &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; django.test.utils &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; setup_test_environment, teardown_test_environment
    &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; django.conf &lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; settings &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; S

    &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;DjangoModels&lt;/span&gt;(&lt;span class=&quot;hljs-title class_ inherited__&quot;&gt;object&lt;/span&gt;):
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&quot;Loop through all the models in INSTALLED_APPS and import them.&quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;__init__&lt;/span&gt;(&lt;span class=&quot;hljs-params&quot;&gt;self&lt;/span&gt;):
            &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; m &lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; get_models():
                &lt;span class=&quot;hljs-built_in&quot;&gt;setattr&lt;/span&gt;(self, m.__name__, m)

    A = DjangoModels()
    C = Client()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After these tweaks the python interpreter is a lot more powerful and you
really lose the need for the more interactive shells like ipython and
bpython. All of these settings work in both python2 and python3.&lt;/p&gt;
&lt;p&gt;If you want to see my complete ~/.pythonrc.py you can get it on
&lt;a href=&quot;https://github.com/sontek/dotfiles/blob/master/_pythonrc.py&quot;&gt;github&lt;/a&gt;&lt;/p&gt;]]&gt;&lt;/description&gt;
            &lt;link&gt;https://sontek.net/blog/old/tips_and_tricks_for_the_python_interpreter&lt;/link&gt;
            &lt;guid isPermaLink=&quot;true&quot;&gt;https://sontek.net/blog/old/tips_and_tricks_for_the_python_interpreter&lt;/guid&gt;
            &lt;pubDate&gt;Tue, 28 Dec 2010 00:00:00 GMT&lt;/pubDate&gt;
        &lt;/item&gt;
    &lt;/channel&gt;
&lt;/rss&gt;</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"rssFeed":"\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\u003crss xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:content=\"http://purl.org/rss/1.0/modules/content/\" xmlns:atom=\"http://www.w3.org/2005/Atom\" version=\"2.0\"\u003e\n    \u003cchannel\u003e\n        \u003ctitle\u003e\u003c![CDATA[sontek.net Blog posts]]\u003e\u003c/title\u003e\n        \u003cdescription\u003e\u003c![CDATA[Blog about SRE, Kubernetes, Python, GoLang, and anything development related.]]\u003e\u003c/description\u003e\n        \u003clink\u003ehttps://sontek.net\u003c/link\u003e\n        \u003cimage\u003e\n            \u003curl\u003ehttps://sontek.net/logo.png\u003c/url\u003e\n            \u003ctitle\u003esontek.net Blog posts\u003c/title\u003e\n            \u003clink\u003ehttps://sontek.net\u003c/link\u003e\n        \u003c/image\u003e\n        \u003cgenerator\u003eRSS for Node\u003c/generator\u003e\n        \u003clastBuildDate\u003eMon, 03 Apr 2023 04:44:05 GMT\u003c/lastBuildDate\u003e\n        \u003catom:link href=\"https://sontek.net/rss.xml\" rel=\"self\" type=\"application/rss+xml\"/\u003e\n        \u003cpubDate\u003eMon, 03 Apr 2023 04:44:02 GMT\u003c/pubDate\u003e\n        \u003ccopyright\u003e\u003c![CDATA[All rights reserved 2023, @sontek]]\u003e\u003c/copyright\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[AWS From Scratch with Terraform - Apply before Merge with Github Actions]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eThe two most popular workflows when using terraform are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply after Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://terraform.io\"\u003eterraform cloud\u003c/a\u003e and most github actions.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply before Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://www.runatlantis.io/\"\u003eAtlantis\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI don't like apply-after-merge.  There are a lot of ways where a \u003ccode\u003eplan\u003c/code\u003e\ncan succeed but an \u003ccode\u003eapply\u003c/code\u003e will fail and you end up with broken configuration\nin \u003ccode\u003emain\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eSo in this article I'll show you how to implement \u003cstrong\u003eapply-before-merge\u003c/strong\u003e with\ngithub actions.\u003c/p\u003e\n\u003cp\u003eIf you haven't ready my \u003ca href=\"/blog/2023/aws_from_scratch_root_account\"\u003eprevious article\u003c/a\u003e,\nit covers how to setup terraform cloud with apply after merge and bootstrap your AWS\naccount with terraform.  I will assume you have read that article going forward.\u003c/p\u003e\n\u003ch1\u003eTL;DR\u003c/h1\u003e\n\u003cp\u003eThe code for the github actions we create in this post can be found\n\u003ca href=\"https://github.com/sontek/aws-terraform-github-actions\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eRepairing the bootstrap\u003c/h1\u003e\n\u003cp\u003eWith apply-before-merge we need to implement it in github actions rather than\nutilizing the terraform cloud webhooks.  So lets drop the VCS repo and usage of\nthe webhook from our github repository. Basically anything that references\n\u003ccode\u003egithub_oauth_client\u003c/code\u003e can be removed because we will no longer be using OAuth\nwith Github for our CI/CD pipeline.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e\u003cspan class=\"hljs-comment\"\u003ediff --git a/1-variables.tf b/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex bf1f434..7109924 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -47,12 +47,6 @@\u003c/span\u003e variable \"github_default_branch\" {\n   default     = \"main\"\n }\n \n\u003cspan class=\"hljs-deletion\"\u003e-variable \"github_oauth_client_id\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  description = \"The token for the TFC OAuth client shown under VCS providers\"\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  type        = string\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  default     = null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-}\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n variable \"aws_root_account_id\" {\n   description = \"The AWS root account we want to apply these changes to\"\n   type        = string\n\u003cspan class=\"hljs-comment\"\u003ediff --git a/4-tfc.tf b/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex a8217b7..9852228 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -77,31 +77,12 @@\u003c/span\u003e resource \"aws_iam_role_policy_attachment\" \"tfc-access-attach\" {\n   policy_arn = aws_iam_policy.tfc-agent.arn\n }\n \n\u003cspan class=\"hljs-deletion\"\u003e-/* Fetch an oauth token from the client */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-data \"tfe_oauth_client\" \"github\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  /* Don't fetch the client if we don't have the client_id */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  count           = var.github_oauth_client_id != null ? 1 : 0\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  oauth_client_id = var.github_oauth_client_id\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-}\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n resource \"tfe_workspace\" \"workspaces\" {\n   count        = length(var.tfc_workspaces)\n   name         = var.tfc_workspaces[count.index]\n   organization = tfe_organization.organization.name\n \n   working_directory = var.tfc_workspaces[count.index]\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  /* This generates a webhook on the github repository so plans are triggered\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  automatically.   We dynamically set the setting because we will not have the\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  oauth client ID on first pass.\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  dynamic \"vcs_repo\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    content {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-      identifier     = format(\"%s/%s\", var.github_organization, github_repository.repo.name)\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-      oauth_token_id = data.tfe_oauth_client.github[0].oauth_token_id\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    }\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  }\u003c/span\u003e\n }\n \n /* These variables tell the agent to use dynamic credentials */\n\u003cspan class=\"hljs-comment\"\u003ediff --git a/settings.auto.tfvars.example b/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex 3327f02..79221c1 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -4,6 +4,5 @@\u003c/span\u003e tfc_workspaces = [\n   \"root\"\n ]\n github_organization    = \"github-org\"\n\u003cspan class=\"hljs-deletion\"\u003e-github_oauth_client_id = \"oc-...\"\u003c/span\u003e\n github_repo_name       = \"my-infra\"\n aws_root_account_id    =  \"888888888888\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce that is removed from your \u003ccode\u003einfra-bootstrap\u003c/code\u003e repository we need to create\na new github secret with a token for Github to be able to talk with TFC. Make\na new file called \u003ccode\u003e5-github-actions.tf\u003c/code\u003e with the following content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_team\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"owners\"\u003c/span\u003e {\n  name         = \u003cspan class=\"hljs-string\"\u003e\"owners\"\u003c/span\u003e\n  organization = tfe_organization.organization.name\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_team_token\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_actions_token\"\u003c/span\u003e {\n  team_id = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tfe_team.owners.id\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_actions_secret\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_secret\"\u003c/span\u003e {\n  repository      = github_repository.repo.name\n  secret_name     = \u003cspan class=\"hljs-string\"\u003e\"TFE_TOKEN\"\u003c/span\u003e\n  plaintext_value = tfe_team_token.github_actions_token.token\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen you should \u003ccode\u003eplan\u003c/code\u003e and \u003ccode\u003eapply\u003c/code\u003e the change:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform plan\n❯ terraform apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe only change to the infrastructure should be to remove the VCS link and\nadding the secret:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e  # tfe_workspace.workspaces[0] will be updated in-place\n  ~ resource \"tfe_workspace\" \"workspaces\" {\n        id                            = \"ws-K1M4tdXUUeASgmUR\"\n        name                          = \"root\"\n        # (20 unchanged attributes hidden)\n\n\u003cspan class=\"hljs-deletion\"\u003e-       vcs_repo {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           identifier         = \"sontek/sontek-infra\" -\u003e null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           ingress_submodules = false -\u003e null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           oauth_token_id     = \"ot-nMYJRbBb2SH9zCP7\" -\u003e null\u003c/span\u003e\n        }\n    }\n\n  # github_actions_secret.tfe_secret will be created\n\u003cspan class=\"hljs-addition\"\u003e+   resource \"github_actions_secret\" \"tfe_secret\" {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       created_at      = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       id              = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       plaintext_value = (sensitive value)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       repository      = \"sontek-infra\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       secret_name     = \"TFE_TOKEN\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       updated_at      = (known after apply)\u003c/span\u003e\n    }\n\n  # tfe_team_token.github_actions_token will be created\n\u003cspan class=\"hljs-addition\"\u003e+   resource \"tfe_team_token\" \"github_actions_token\" {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       id      = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       team_id = \"team-...\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       token   = (sensitive value)\u003c/span\u003e\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eGithub Actions\u003c/h1\u003e\n\u003cp\u003eNow we need to connect the github actions to replace the plan and apply actions\nthat were being taken by the TFC webhook previously. All of these changes will\nbe in the \u003ccode\u003einfra\u003c/code\u003e repository that was generated from \u003ccode\u003ebootstrap\u003c/code\u003e.  We are done\nwith the bootstrap at this point.\u003c/p\u003e\n\u003cp\u003eFirst, lets setup the \u003ccode\u003e.github\u003c/code\u003e folder, the end result we want is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e.github/\n└── workflows\n    ├── on-apply-finished.yml\n    ├── on-pull-request-labeled.yml\n    └── on-pull-request.yml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo create the folders:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p .github/workflows\n❯ terraform apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eOn Pull Request\u003c/h1\u003e\n\u003cp\u003eThe first flow we'll create is the \u003ccode\u003eterraform plan\u003c/code\u003e workflow which should be\nran whenever a pull request is opened. Create the file\n\u003ccode\u003e.github/workflows/on-pull-request.yml\u003c/code\u003e and put this content in it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_build\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epull_request:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emain\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eTERRAFORM_CLOUD_TOKENS:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapp.terraform.io=${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.TFE_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eGITHUB_TOKEN:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eterraform_validate:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCheckout\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003evalidate\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-validate@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003eterraform_fmt:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efmt\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-fmt-check@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003eterraform_plan:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eplan\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-plan@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis creates three jobs:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_validate\u003c/strong\u003e: This validates the terraform via \u003ccode\u003eterraform validate\u003c/code\u003e\ncommand to make sure that it is correct and doesn't have duplicate resources\nor anything like that.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_fmt\u003c/strong\u003e: This verifies that the terraform is well formatted by\nrunning the \u003ccode\u003eterraform fmt\u003c/code\u003e command.`\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_plan\u003c/strong\u003e: This runs the \u003ccode\u003eterraform\u003c/code\u003e plan and comments on the PR a\ndiff of the changes for you to verify.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTo verify this is working, lets make a change to the infrastructure so that we\ncan see a plan executed. We can bring back the \u003ccode\u003eSQS\u003c/code\u003e resource we destroyed in\nthe previous article. Create a file called \u003ccode\u003eroot/2-sqs.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_sqs_queue\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e {\n  name                      = \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e\n  message_retention_seconds = \u003cspan class=\"hljs-number\"\u003e86400\u003c/span\u003e\n  receive_wait_time_seconds = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets push a branch and make a pull request to see the result so far:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ git add .github/ root/\n❯ git checkout -b apply-before-merge\n❯ git commit -m \u003cspan class=\"hljs-string\"\u003e\"Implemented on-pull-request\"\u003c/span\u003e\n❯ git push origin \u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter you make the pull request you should 3 checks on it and a comment that\nshows the plan:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_comment.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_checks.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eApply on Label\u003c/h1\u003e\n\u003cp\u003eSo now that the plan is working we need some way to \u003ccode\u003eapply\u003c/code\u003e the changes. I've\nfound the best way to do this is via a label rather than a comment because of\nthe way github actions work. Their event based actions like \u003ccode\u003eon-comment\u003c/code\u003e aren't\nexecuted in the context of a pull-request.\u003c/p\u003e\n\u003cp\u003eSince we will be using a label to signal a plan is ready to be applied lets\ncreate a new file \u003ccode\u003e.github/workflows/on-pull-request-labeled.yml\u003c/code\u003e and provide\nthis content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_apply\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epull_request:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003etypes:\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003elabeled\u003c/span\u003e ]\n\n\u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eTERRAFORM_CLOUD_TOKENS:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapp.terraform.io=${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.TFE_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eGITHUB_TOKEN:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eterraform_apply:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eif:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.label.name\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'tfc-apply'\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-apply@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will fire whenever a pull request is labeled with the \u003ccode\u003etfc-apply\u003c/code\u003e label.\nIt will run the \u003ccode\u003eapply\u003c/code\u003e and update the previous plan comment to let you\nknow the status.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying_comment.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eMerge on Apply\u003c/h1\u003e\n\u003cp\u003eOne thing you'll notice is that the pull request stayed open even after the\ninfrastructure is applied and we don't want that. We want any changes that have\nmade it into the environment to be merged into \u003ccode\u003emain\u003c/code\u003e automatically. To do\nthis we'll create our final action.\u003c/p\u003e\n\u003cp\u003eCreate a new file \u003ccode\u003e.github/workflows/on-apply-finished.yml\u003c/code\u003e with this content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_merge\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Only trigger, when the build workflow succeeded\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eworkflow_run:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eworkflows:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003epr_apply\u003c/span\u003e]\n    \u003cspan class=\"hljs-attr\"\u003etypes:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecompleted\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003emerge:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eif:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.workflow_run.conclusion\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'success'\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003echecks:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003estatuses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eactions:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eoutputs:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epullRequestNumber:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esteps.workflow-run-info.outputs.pullRequestNumber\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Get information about the current run\"\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epotiuk/get-workflow-origin@v1_5\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eworkflow-run-info\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003etoken:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003esourceRunId:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.workflow_run.id\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emerge\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ea\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erequest\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eafter\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapply\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esudo-bot/action-pull-request-merge@v1.2.0\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003egithub-token:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003enumber:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esteps.workflow-run-info.outputs.pullRequestNumber\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will wait until the \u003ccode\u003epr_apply\u003c/code\u003e job completes and as long as it was\nsuccessful it'll merge the branch!\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: As I mentioned earlier, the event based actions do not run in the\ncontext of the pull request which means you cannot test changes to them during\nthe PR either.  You must merge the \u003ccode\u003eon-apply-finished.yml\u003c/code\u003e file to \u003ccode\u003emain\u003c/code\u003e\nbefore it starts working.\u003c/p\u003e\n\u003ch1\u003eBranch Protection\u003c/h1\u003e\n\u003cp\u003eThe final step to the process is to make sure you go to your github settings\nand make sure these status checks are required before merging. Branch protection\nis a feature that will prevent merging changes into a branch unless all\nrequired checks are passing.\u003c/p\u003e\n\u003cp\u003eGo to \u003ccode\u003eSettings\u003c/code\u003e -\u003e \u003ccode\u003eBranches\u003c/code\u003e -\u003e \u003ccode\u003eBranch Protection\u003c/code\u003e and add a branch\nprotection rule:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/branch_protection.png\" width=\"500\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou want to enable the following settings:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBranch Name\u003c/strong\u003e: main\u003c/li\u003e\n\u003cli\u003e✅ Require a pull request before merging\u003c/li\u003e\n\u003cli\u003e✅ Require status checks to pass before merging\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThen for \u003ccode\u003eStatus checks that are required.\u003c/code\u003e select all of the ones we've\ncreated:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/required_checks.png\" height=\"200\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eNext Steps\u003c/h1\u003e\n\u003cp\u003eNow that you have the ability to manage your AWS accounts through terraform\nvia pull request the next step is to start creating infrastructure that can\ncreate real workloads.   In my next post I'll show you how to boostrap an\nEKS (Kubernetes cluster) using terraform.\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2023/aws_from_scratch_apply_before_merge\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2023/aws_from_scratch_apply_before_merge\u003c/guid\u003e\n            \u003cpubDate\u003eSun, 02 Apr 2023 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[AWS From Scratch with Terraform - Setting up your Root Account for IaC (using Terraform Cloud)]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eFollowing this article will get you setup with an AWS Root account that can be\nmanaged through through Terraform Cloud with OIDC. As a best practice you\nshould not keep long-lived access keys in your CI/CD pipelines when\ndeploying to AWS, instead you should use OIDC (OpenID Connect) to securely\ndeploy to AWS when using Terraform Cloud or Github Actions.\u003c/p\u003e\n\u003ch1\u003eTL;DR\u003c/h1\u003e\n\u003cp\u003eDownload all the source from the blog post here:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/sontek/aws-terraform-bootstrap\"\u003ehttps://github.com/sontek/aws-terraform-bootstrap\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eHow does OIDC work\u003c/h1\u003e\n\u003cp\u003eOIDC enables us to request a short-lived access token directly from AWS. We\njust have to create trust relationship that controls which workflows are able\nto request the access tokens.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNo need to duplicate AWS credentials as long-lived GitHub secrets.\u003c/li\u003e\n\u003cli\u003eSince we are using a short-lived access token that is only valid for a single\njob there is no reason to worry about rotating secrets.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe following diagram gives an overview of how we can use Terraform Cloud's\nOIDC provider to integrate with AWS:\u003c/p\u003e\n\u003cdiv class=\"remark-mermaid remark-mermaid-default\"\u003e\u003csvg aria-roledescription=\"flowchart-v2\" role=\"graphics-document document\" viewBox=\"-8 -8 827.9453125 321.5\" style=\"max-width: 827.945px; background-color: transparent;\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"mermaid-1680497044662\"\u003e\u003cstyle\u003e#mermaid-1680497044662{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1680497044662 .error-icon{fill:#552222;}#mermaid-1680497044662 .error-text{fill:#552222;stroke:#552222;}#mermaid-1680497044662 .edge-thickness-normal{stroke-width:2px;}#mermaid-1680497044662 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1680497044662 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1680497044662 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1680497044662 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1680497044662 .marker{fill:#333333;stroke:#333333;}#mermaid-1680497044662 .marker.cross{stroke:#333333;}#mermaid-1680497044662 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1680497044662 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-1680497044662 .cluster-label text{fill:#333;}#mermaid-1680497044662 .cluster-label span{color:#333;}#mermaid-1680497044662 .label text,#mermaid-1680497044662 span{fill:#333;color:#333;}#mermaid-1680497044662 .node rect,#mermaid-1680497044662 .node circle,#mermaid-1680497044662 .node ellipse,#mermaid-1680497044662 .node polygon,#mermaid-1680497044662 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1680497044662 .node .label{text-align:center;}#mermaid-1680497044662 .node.clickable{cursor:pointer;}#mermaid-1680497044662 .arrowheadPath{fill:#333333;}#mermaid-1680497044662 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1680497044662 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1680497044662 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1680497044662 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1680497044662 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1680497044662 .cluster text{fill:#333;}#mermaid-1680497044662 .cluster span{color:#333;}#mermaid-1680497044662 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1680497044662 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1680497044662 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}\u003c/style\u003e\u003cg\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"10\" viewBox=\"0 0 12 20\" class=\"marker flowchart\" id=\"flowchart-pointEnd\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"0\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointStart\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleEnd\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleStart\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossEnd\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossStart\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cg class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token\" id=\"L-AWS-Token-0\" d=\"M179.515625,135.25L175.34895833333334,135.25C171.18229166666666,135.25,162.84895833333334,135.25,146.6662555830886,146.64583333333334C130.48355283284386,158.04166666666666,106.45148066568771,180.83333333333334,94.43544458210964,192.22916666666666L82.41940849853157,203.625\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform\" id=\"L-Token-Terraform-0\" d=\"M82.41940849853157,237.125L94.43544458210964,248.52083333333334C106.45148066568771,259.9166666666667,130.48355283284386,282.7083333333333,158.28800037475526,294.1041666666667C186.09244791666666,305.5,217.66927083333334,305.5,249.24609375,305.5C280.8229166666667,305.5,312.3997395833333,305.5,347.5989583333333,305.5C382.7981770833333,305.5,421.6197916666667,305.5,460.44140625,305.5C499.2630208333333,305.5,538.0846354166666,305.5,568.5160074033284,298.2708333333333C598.9473793899903,291.0416666666667,620.9885087799804,276.5833333333333,632.0090734749756,269.3541666666667L643.0296381699707,262.125\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT\" id=\"L-Terraform-JWT-0\" d=\"M643.0296381699707,178.625L632.0090734749756,171.39583333333334C620.9885087799804,164.16666666666666,598.9473793899903,149.70833333333334,583.7601480283284,142.47916666666666C568.5729166666666,135.25,560.2395833333334,135.25,556.0729166666666,135.25L551.90625,135.25\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS\" id=\"L-JWT-AWS-0\" d=\"M368.9765625,135.25L364.8098958333333,135.25C360.6432291666667,135.25,352.3098958333333,135.25,343.9765625,135.25C335.6432291666667,135.25,327.3098958333333,135.25,323.1432291666667,135.25L318.9765625,135.25\"\u003e\u003c/path\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(607.33984375, 170.625)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"Terraform\" class=\"cluster default\"\u003e\u003crect height=\"83.5\" width=\"209.5390625\" y=\"8\" x=\"-4.93359375\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-4.93359375, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18.5\" width=\"209.5390625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eTerraform Cloud Workflow #2\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(99.8359375, 49.75)\" id=\"flowchart-OIDCProvider-23\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"113.671875\" y=\"-16.75\" x=\"-56.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-49.3359375, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"98.671875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Provider\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(172.015625, -8)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"AWS\" class=\"cluster default\"\u003e\u003crect height=\"270.5\" width=\"139.4609375\" y=\"8\" x=\"8\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(52.25, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18.5\" width=\"50.9609375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAWS #1\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(77.73046875, 59.75)\" id=\"flowchart-OIDC-20\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"89.4609375\" y=\"-16.75\" x=\"-44.73046875\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-37.23046875, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"74.4609375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Trust\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(77.73046875, 143.25)\" id=\"flowchart-Roles-21\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"52.171875\" y=\"-16.75\" x=\"-26.0859375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-18.5859375, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"37.171875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eRoles\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(77.73046875, 226.75)\" id=\"flowchart-Resources-22\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"85.5390625\" y=\"-16.75\" x=\"-42.76953125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-35.26953125, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"70.5390625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eResources\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(64.7578125, 220.375)\" id=\"flowchart-Token-25\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"129.515625\" y=\"-16.75\" x=\"-64.7578125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-57.2578125, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"114.515625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAccess Token #4\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(460.44140625, 135.25)\" id=\"flowchart-JWT-28\" class=\"node default default\"\u003e\u003crect height=\"33.5\" width=\"182.9296875\" y=\"-16.75\" x=\"-91.46484375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-83.96484375, -9.25)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18.5\" width=\"167.9296875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eJWT \u0026#x26; Cloud Role ID #3\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/svg\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003eIn AWS, create an OIDC trust between a role and our terraform cloud\nworkflow(s) that need access to the cloud.\u003c/li\u003e\n\u003cli\u003eEvery time a job runs, TFC's OIDC Provider auto-generates an OIDC token.\nThis token contains multiple claims to establish a security-hardened and\nverifiable identity about the specific workflow that is trying to authenticate.\u003c/li\u003e\n\u003cli\u003eRequest this token from TFC's OIDC provider, and present it to AWS\u003c/li\u003e\n\u003cli\u003eOnce AWS successfully validates the claims presented in the token, it then\nprovides a short-lived cloud access token that is available only for the duration\nof the job.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eWhat does this post accomplish\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eSetup a root AWS account that is managed througuh terraform\u003c/li\u003e\n\u003cli\u003eSetup OIDC authentication with Terraform Cloud so it can talk to AWS\u003c/li\u003e\n\u003cli\u003eSetup Github Actions authentication with Terraform Cloud so we can run plan\nand apply through the CI/CD pipeline.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eSetup AWS Access\u003c/h1\u003e\n\u003cp\u003eIt is very bad practice to use the root account for much of anything but for\nbootstrapping the account it is necessary, so the first step is to get your\n\u003ccode\u003eAWS_ACCESS_KEY_ID\u003c/code\u003e and \u003ccode\u003eAWS_SECRET_ACCESS_KEY\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eTo do this click your account and choose \u003ccode\u003eSecurity Credentials\u003c/code\u003e in the top\nright:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/security_credentials.png\" height=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eThen choose \u003ccode\u003eCreate Access key\u003c/code\u003e:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/create_access_token.png\" width=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou need to set these environment variables in your shell so that your local\nshell has access to AWS. After you set them you can verify you set them correct\nby running:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ aws sts get-caller-identity\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should get a result similar to:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"UserId\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"Account\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"Arn\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::888888888888:root\"\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eBootstrap\u003c/h2\u003e\n\u003cp\u003eBefore you can manage any of your accounts through Terraform Cloud you'll need\nbootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate\nsecurely and manage AWS Resources on your behalf.\u003c/p\u003e\n\u003cp\u003eI personally prefer doing this in two repositories:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra-bootstrap\u003c/code\u003e: This repository does the bare minimum to hook up terraform\ncloud with your AWS account and stores the state in git.  Its the only infra\nthat will not be controlled by your CI/CD pipeline.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra\u003c/code\u003e: The actual repository where all the rest of your AWS resources are\nmanaged.  It will store state in Terraform Cloud and you can introduce a\nCI/CD pipeline for approving changes.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNote\u003c/strong\u003e: This repository will be generated with the terraform code.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAfter manually creating the git repository \u003ccode\u003einfra-boostrap\u003c/code\u003e in your Github\naccount We will need 3 providers to bootstrap the account \u003ccode\u003eaws\u003c/code\u003e, \u003ccode\u003egithub\u003c/code\u003e, and\n\u003ccode\u003etfe\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eVariables\u003c/h3\u003e\n\u003cp\u003eCreate a \u003ccode\u003e1-variables.tf\u003c/code\u003e where we can define the variables we'll need\nfor creating these resources.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_aws_audience\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"aws.workload.identity\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The audience value to use in run identity tokens\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_hostname\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"app.terraform.io\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The hostname of the TFC or TFE instance you'd like to use with AWS\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_project_name\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"Default Project\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The project under which a workspace will be created\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_organization_name\"\u003c/span\u003e {\n  type        = string\n  description = \u003cspan class=\"hljs-string\"\u003e\"The name of your Terraform Cloud organization\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_organization_owner\"\u003c/span\u003e {\n  type        = string\n  description = \u003cspan class=\"hljs-string\"\u003e\"The owner of the TFC organization\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_workspaces\"\u003c/span\u003e {\n  type        = list(string)\n  description = \u003cspan class=\"hljs-string\"\u003e\"The list of TFC workspaces\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_organization\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The organization the repositories are owned by\"\u003c/span\u003e\n  type        = string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_repo_name\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The name of the git reppository we'll create for managing infra\"\u003c/span\u003e\n  type        = string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_default_branch\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The default branch to utilize\"\u003c/span\u003e\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"main\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_oauth_client_id\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The token for the TFC OAuth client shown under VCS providers\"\u003c/span\u003e\n  type        = string\n  default     = null\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_root_account_id\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The AWS root account we want to apply these changes to\"\u003c/span\u003e\n  type        = string\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe will use these variables in the later modules but they are mostly metadata\naround the terraform and github accounts you'll need to setup manually.\u003c/p\u003e\n\u003ch3\u003eProviders\u003c/h3\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003e2-main.tf\u003c/code\u003e and define the providers:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e {\n  required_providers {\n    tfe = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"0.41.0\"\u003c/span\u003e\n    }\n\n    aws = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"4.58.0\"\u003c/span\u003e\n    }\n\n    github = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"integrations/github\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"5.18.3\"\u003c/span\u003e\n    }\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n\n  \u003cspan class=\"hljs-comment\"\u003e# Root account, all other accounts should be provisioned\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# via pull requests\u003c/span\u003e\n  allowed_account_ids = [var.aws_root_account_id]\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github\"\u003c/span\u003e {\n  owner = var.github_organization\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe key things there are we define \u003ccode\u003eallowed_account_ids\u003c/code\u003e to prevent us from\nworking against any account that isn't the root and we are using one of the\nvariables we defines earlier.\u003c/p\u003e\n\u003ch3\u003eGithub\u003c/h3\u003e\n\u003cp\u003eWe will utilize \u003ccode\u003eterraform\u003c/code\u003e to create the second git repository where the rest\nof the infrastructure will go. Create a file called \u003ccode\u003e3-github.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_repository\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"repo\"\u003c/span\u003e {\n  name        = var.github_repo_name\n  description = \u003cspan class=\"hljs-string\"\u003e\"Infrastructure Repository\"\u003c/span\u003e\n  visibility  = \u003cspan class=\"hljs-string\"\u003e\"private\"\u003c/span\u003e\n  auto_init   = true\n  has_issues  = true\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_branch_default\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"default\"\u003c/span\u003e {\n  repository = github_repository.repo.name\n  branch     = var.github_default_branch\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eoutput\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"repository_id\"\u003c/span\u003e {\n  value = github_repository.repo.id\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will generate a new repository in your account called \u003ccode\u003einfra\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eTerraform Cloud\u003c/h3\u003e\n\u003cp\u003eNow we need to setup dynamic credentials so the terraform cloud agent is\nallowed to take actions on your behalf.   To do this we'll setup an IAM\nrole and an OIDC provider. Create a file called \u003ccode\u003e4-tfc.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_organization\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"organization\"\u003c/span\u003e {\n  name  = var.tfc_organization_name\n  email = var.tfc_organization_owner\n}\n\n/* AWS will use this TLS certificate to verify that requests for dynamic\ncredentials come from Terraform Cloud.*/\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tls_certificate\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_certificate\"\u003c/span\u003e {\n  url = \u003cspan class=\"hljs-string\"\u003e\"https://\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e\"\u003c/span\u003e\n}\n\n/* sets up an OIDC \u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e in AWS with Terraform Cloud's TLS certificate,\nthe SHA1 fingerprint from the TLS certificate \n*/\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_openid_connect_provider\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_provider\"\u003c/span\u003e {\n  url            = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tls_certificate.tfc_certificate.url\n  client_id_list = [var.tfc_aws_audience]\n  thumbprint_list = [\n    \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tls_certificate.tfc_certificate.certificates[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].sha1_fingerprint\n  ]\n}\n\n/* Policy to allow TFC to assume the AWS IAM role in our account */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"assume_role\"\u003c/span\u003e {\n  statement {\n    effect = \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\n\n    principals {\n      type        = \u003cspan class=\"hljs-string\"\u003e\"Federated\"\u003c/span\u003e\n      identifiers = [aws_iam_openid_connect_provider.tfc_provider.arn]\n    }\n    condition {\n      test     = \u003cspan class=\"hljs-string\"\u003e\"StringEquals\"\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e:aud\"\u003c/span\u003e\n\n      values = [\n        \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${\u003cspan class=\"hljs-meta\"\u003eone(aws_iam_openid_connect_provider.tfc_provider.client_id_list)\u003c/span\u003e}\u003c/span\u003e\"\u003c/span\u003e\n      ]\n    }\n\n    condition {\n      test     = \u003cspan class=\"hljs-string\"\u003e\"StringLike\"\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e:sub\"\u003c/span\u003e\n\n      values = [\n        for workspace in var.tfc_workspaces : \u003cspan class=\"hljs-string\"\u003e\"organization:\u003cspan class=\"hljs-variable\"\u003e${tfe_organization.organization.name}\u003c/span\u003e:project:\u003cspan class=\"hljs-variable\"\u003e${var.tfc_project_name}\u003c/span\u003e:workspace:\u003cspan class=\"hljs-variable\"\u003e${workspace}\u003c/span\u003e:run_phase:*\"\u003c/span\u003e\n      ]\n    }\n    actions = [\u003cspan class=\"hljs-string\"\u003e\"sts:AssumeRoleWithWebIdentity\"\u003c/span\u003e]\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_role\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  name               = \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e\n  assume_role_policy = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.aws_iam_policy_document.assume_role.json\n}\n\n/* Policy for what the TFC agent is allowed to do */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  version = \u003cspan class=\"hljs-string\"\u003e\"2012-10-17\"\u003c/span\u003e\n\n  statement {\n    actions   = [\u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e]\n    effect    = \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\n    resources = [\u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e]\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  name        = \u003cspan class=\"hljs-string\"\u003e\"tfc-agent-access-policy\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"Access policy for the TFC agent\"\u003c/span\u003e\n  policy      = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.aws_iam_policy_document.tfc-agent.json\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-access-attach\"\u003c/span\u003e {\n  role       = aws_iam_role.tfc-agent.name\n  policy_arn = aws_iam_policy.tfc-agent.arn\n}\n\n/* Fetch an oauth token from the client */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_oauth_client\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github\"\u003c/span\u003e {\n  /* Don't fetch the client if we don't have the client_id */\n  count           = var.github_oauth_client_id != null ? \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e : \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n  oauth_client_id = var.github_oauth_client_id\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_workspace\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"workspaces\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  name         = var.tfc_workspaces[count.index]\n  organization = tfe_organization.organization.name\n\n  working_directory = var.tfc_workspaces[count.index]\n\n  /* This generates a webhook on the github repository so plans are triggered\n  automatically.   We dynamically set the setting because we will not have the\n  oauth client ID on first pass.\n  */\n  dynamic \u003cspan class=\"hljs-string\"\u003e\"vcs_repo\"\u003c/span\u003e {\n    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []\n    content {\n      identifier     = format(\u003cspan class=\"hljs-string\"\u003e\"%s/%s\"\u003c/span\u003e, var.github_organization, github_repository.repo.name)\n      oauth_token_id = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tfe_oauth_client.github[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].oauth_token_id\n    }\n  }\n}\n\n/* These variables tell the agent to use dynamic credentials */\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_variable\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-auth\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  key          = \u003cspan class=\"hljs-string\"\u003e\"TFC_AWS_PROVIDER_AUTH\"\u003c/span\u003e\n  value        = true\n  category     = \u003cspan class=\"hljs-string\"\u003e\"env\"\u003c/span\u003e\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = \u003cspan class=\"hljs-string\"\u003e\"Enable dynamic auth on the TFC agents\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_variable\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-role\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  key          = \u003cspan class=\"hljs-string\"\u003e\"TFC_AWS_RUN_ROLE_ARN\"\u003c/span\u003e\n  value        = aws_iam_role.tfc-agent.arn\n  category     = \u003cspan class=\"hljs-string\"\u003e\"env\"\u003c/span\u003e\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = \u003cspan class=\"hljs-string\"\u003e\"Tell TFC what Role to run as\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis module is dynamic because there is one piece that will require a\nmanul oauth setup for github.  So the first pass will apply without it\nand then later on we'll create it and run the apply again.\u003c/p\u003e\n\u003ch2\u003eApplying the changes\u003c/h2\u003e\n\u003cp\u003eNow we just need to define our settings for the module and we'll get our\ninfrastructure applied.  Create a file called \u003ccode\u003esettings.auto.tfvars\u003c/code\u003e and\npopulate it with the content for your account.  This is an example of what\nthis should look like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003etfc_organization_name  = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\ntfc_organization_owner = \u003cspan class=\"hljs-string\"\u003e\"john@sontek.net\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# The workspaces you want to create and be able to manage with IaC\u003c/span\u003e\ntfc_workspaces = [\n  \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n]\n\u003cspan class=\"hljs-comment\"\u003e# this can be your username\u003c/span\u003e\ngithub_organization    = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\ngithub_repo_name       = \u003cspan class=\"hljs-string\"\u003e\"sontek-infra\"\u003c/span\u003e\naws_root_account_id    =  \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform login\n❯ terraform init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should see:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs\"\u003eTerraform has been successfully initialized!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow lets run our plan:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e plan\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should see a result:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003e\u003cspan class=\"hljs-symbol\"\u003ePlan:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e add, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e change, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e destroy.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eApply it to make those resources:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt this point it:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eCreated a terraform cloud organization\u003c/li\u003e\n\u003cli\u003eCreated a terraform cloud workspace\u003c/li\u003e\n\u003cli\u003eCreated a git repository\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eVerify TFC can talk to AWS\u003c/h1\u003e\n\u003cp\u003eTo verify that TFC can communicate with AWS through the dynamic credentials,\nlets clone the repository and make some dummy resources. After you've cloned\nthe repository lets make a folder for the workspace \u003ccode\u003eroot\u003c/code\u003e that we defined in\nbootstrap:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e root\n❯ \u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e root\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow create a \u003ccode\u003e1-providers.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e {\n  cloud {\n    organization = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\n\n    workspaces {\n      name = \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n    }\n  }\n\n  required_providers {\n    aws = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"4.58.0\"\u003c/span\u003e\n    }\n\n    tfe = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"0.42.0\"\u003c/span\u003e\n    }\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n\n  default_tags {\n    tags = {\n      Owner   = \u003cspan class=\"hljs-string\"\u003e\"john@sontek.net\"\u003c/span\u003e\n      Env     = \u003cspan class=\"hljs-string\"\u003e\"Root\"\u003c/span\u003e\n      Service = \u003cspan class=\"hljs-string\"\u003e\"BusinessOperations\"\u003c/span\u003e\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: You should replace \u003ccode\u003eorganization\u003c/code\u003e, \u003ccode\u003eworkspaces.name\u003c/code\u003e, and\n\u003ccode\u003etags.Owner\u003c/code\u003e to be your own values.\u003c/p\u003e\n\u003cp\u003eNow create a small resource to prove everything is working, we'll use SQS for\nthis. Create a file called \u003ccode\u003e2-sqs.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_sqs_queue\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e {\n  name                        = \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e\n  message_retention_seconds = \u003cspan class=\"hljs-number\"\u003e86400\u003c/span\u003e\n  receive_wait_time_seconds = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf you run the plan you should see the resource it wants to create:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform init\n❯ terraform plan\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should see the run is executing in terraform cloud:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003eRunning plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C\nwill stop streaming the logs, but will \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e stop the plan running remotely.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can click the link it provides to see the logs. Now lets apply this\nresource to see it all working:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should get a response like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-string\"\u003eApply\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecomplete!\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eResources:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eadded,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003echanged,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edestroyed.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo Terraform Cloud has full access to create AWS resources!   The final step\nis to get github running the plan/apply on pull requests. Commit these files\nto your repository and we'll remove them in a pull request. Create a\n\u003ccode\u003e.gitignore\u003c/code\u003e file in the root:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e.\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e*\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand commit all the files:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ git add *\n❯ git commit -m \u003cspan class=\"hljs-string\"\u003e\"initial infra\"\u003c/span\u003e\n❯ git push origin \u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eGithub VCS Provider\u003c/h1\u003e\n\u003cp\u003eTo setup oauth between github and terraform cloud so it can manage the webhooks\nyou need to login to the [https://app.terraform.io](Terraform Cloud Console) and\ninitiate the connection.\u003c/p\u003e\n\u003cp\u003eSelect the newly created organization and then click \u003ccode\u003eSettings\u003c/code\u003e.  In the sidebar\nthere will be a section \u003ccode\u003eVersion Control\u003c/code\u003e and you want to select \u003ccode\u003eProviders\u003c/code\u003e under\nthat.\u003c/p\u003e\n\u003cp\u003eAt this point you should see an \u003ccode\u003eAdd a VCS Provider\u003c/code\u003e button, you want to select\n\u003ccode\u003eGithub.com (Custom)\u003c/code\u003e:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_vcs_provider.png\" height=\"250\"\u003e\n\u003c/center\u003e\n\u003cp\u003eFollow the on-screen instructions to create a new GitHub OAuth application on your\naccount. For me, I went to \u003ca href=\"https://github.com/settings/applications/new\"\u003ehere\u003c/a\u003e and\nprovided the information TFC displayed:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_github_app.png\" height=\"300\"\u003e\n\u003c/center\u003e\n\u003cp\u003eOn the Github side you need to save the \u003ccode\u003eClient ID\u003c/code\u003e and you need to click\n\u003ccode\u003eGenerate a new client secret\u003c/code\u003e.   Provide those details to terraform cloud and\nthen we should be ready to send our first PR!\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_oauth_settings.png\" height=\"300\"\u003e\n\u003c/center\u003e\n\u003ch2\u003eFinish Bootstrap\u003c/h2\u003e\n\u003cp\u003eAt this point we need to return to the bootstrap repository and provide it the\nnew OAuth Client ID for its \u003ccode\u003egithub_oauth_client_id\u003c/code\u003e setting.  To get the value\nfor this the easiest way is to drill into the VCS provider in terraform and click\n\u003ccode\u003eEdit Client\u003c/code\u003e.   In the URL you'll see the Client ID, it should start with\n\u003ccode\u003eoc-...\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eNow return back to the \u003ccode\u003ebootstrap\u003c/code\u003e repository and edit \u003ccode\u003esettings.auto.tfvars\u003c/code\u003e and\nset the final setting:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003egithub_oauth_client_id\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"oc-......\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow you should be able to run a plan and see the \u003ccode\u003evcs_repo\u003c/code\u003e get added in-place:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform plan\n\n  ~ update in-place\n\nTerraform will perform the following actions:\n\n  \u003cspan class=\"hljs-comment\"\u003e# tfe_workspace.workspaces[0] will be updated in-place\u003c/span\u003e\n  ~ resource \u003cspan class=\"hljs-string\"\u003e\"tfe_workspace\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"workspaces\"\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e                            = \u003cspan class=\"hljs-string\"\u003e\"ws-...\"\u003c/span\u003e\n        name                          = \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# (20 unchanged attributes hidden)\u003c/span\u003e\n\n      + vcs_repo {\n          + identifier         = \u003cspan class=\"hljs-string\"\u003e\"sontek/sontek-infra\"\u003c/span\u003e\n          + ingress_submodules = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n          + oauth_token_id     = \u003cspan class=\"hljs-string\"\u003e\"ot-...\"\u003c/span\u003e\n        }\n    }\n\nPlan: 0 to add, 1 to change, 0 to destroy.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eApply the change!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter you apply the change, if you go to \u003ccode\u003eSettings\u003c/code\u003e -\u003e \u003ccode\u003eWebhooks\u003c/code\u003e of the \u003ccode\u003einfra\u003c/code\u003e\nrepository that was created earlier you should see a new terraform cloud webhook\nwas created.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/github_webhooks.png\" width=\"350\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eSend your first pull request\u003c/h1\u003e\n\u003cp\u003eNow you should be able to send a pull request tearing down the SQS resource we\ngenerated at the beginning and terraform cloud will take care of the rest! Make\nsure you are on the generated \u003ccode\u003einfra\u003c/code\u003e repo and:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003erm\u003c/span\u003e root/sqs.tf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand commit / push that to a branch and open a pull request. When you merge it\nwill apply the changes.\u003c/p\u003e\n\u003ch1\u003eNext Steps\u003c/h1\u003e\n\u003cp\u003eThis should be good enough for you to manage your AWS cloud infrastructure as\ncode with terraform but I \u003cstrong\u003epersonally\u003c/strong\u003e don't like that terraform cloud applies\nthe changes on merge.  There are a lot of ways where a \u003ccode\u003eplan\u003c/code\u003e can succeed but an\n\u003ccode\u003eapply\u003c/code\u003e will fail and you end up with broken configuration in \u003ccode\u003emain\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eI prefer a worfklow called \u003ccode\u003eapply-before-merge\u003c/code\u003e and in my next post I'll show you\nhow to do that through github actions instead of utilizing the TFC webhook.\u003c/p\u003e\n\u003cp\u003eCheck out that post \u003ca href=\"/blog/2023/aws_from_scratch_apply_before_merge\"\u003ehere\u003c/a\u003e!\u003c/p\u003e\n\u003ch1\u003eHelpful Resources\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform\"\u003eTerraform Dynamic Credentials Tutorial\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration\"\u003eTerraform docs on Dynamic Credentials\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token\"\u003eGithub's understanding OIDC\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2023/aws_from_scratch_root_account\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2023/aws_from_scratch_root_account\u003c/guid\u003e\n            \u003cpubDate\u003eSat, 01 Apr 2023 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[How to speak spanish like a colombian drug lord!]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eI've been living in Puerto Rico for 4 years but two of those have been COVID and so I haven't been able to practice Spanish as much as I'd like. So to speed up my learning I've decided I want to watch a lot of spanish speaking television to start training my ears, but to do this I need a baseline of words I understand to be able to even know what they are saying!\u003c/p\u003e\n\u003cp\u003eLearning through apps like Duolingo, Drops, etc start with weird topics like vegetables that don't get you to a very good baseline for actually understanding daily conversations, so I think consuming TV is a better use of my time.\u003c/p\u003e\n\u003ch2\u003eSubtitles\u003c/h2\u003e\n\u003cp\u003eI've decided the way to understand what the best words to study are is to download every subtitle for every episode of a show I want to watch and then count each word.  The more a word is spoken the more important it is for me to know it since I'll be hearing it a lot in the show.\u003c/p\u003e\n\u003cp\u003eI'm going to download subtitles from Netflix. Subtitles in Netflix are in WebVTT format, which looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003e\u003cspan class=\"hljs-number\"\u003e248\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58.285\u003c/span\u003e --\u003e \u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01.163\u003c/span\u003e  position:\u003cspan class=\"hljs-number\"\u003e50.00\u003c/span\u003e%,middle  align:middle size:\u003cspan class=\"hljs-number\"\u003e80.00\u003c/span\u003e%  line:\u003cspan class=\"hljs-number\"\u003e79.33\u003c/span\u003e% \nYo de verdad espero que ustedes\nme vean como una amiga, ¿mmm?\n\n\u003cspan class=\"hljs-number\"\u003e249\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01.247\u003c/span\u003e --\u003e \u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02.539\u003c/span\u003e  position:\u003cspan class=\"hljs-number\"\u003e50.00\u003c/span\u003e%,middle  align:middle size:\u003cspan class=\"hljs-number\"\u003e80.00\u003c/span\u003e%  line:\u003cspan class=\"hljs-number\"\u003e84.67\u003c/span\u003e% \nNo como una madrastra.\n\n\u003cspan class=\"hljs-number\"\u003e250\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e04.250\u003c/span\u003e --\u003e \u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e06.127\u003c/span\u003e  position:\u003cspan class=\"hljs-number\"\u003e50.00\u003c/span\u003e%,middle  align:middle size:\u003cspan class=\"hljs-number\"\u003e80.00\u003c/span\u003e%  line:\u003cspan class=\"hljs-number\"\u003e84.67\u003c/span\u003e% \nYo nunca te vi como una madrastra.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt gives you a start time, end time, and the text on the screen.   So my first process was parsing this format and just turning it into a list of words using https://github.com/glut23/webvtt-py.\u003c/p\u003e\n\u003ch3\u003eDummy parsing\u003c/h3\u003e\n\u003cp\u003eWhat I basically did was \u003ccode\u003etext.split(\" \")\u003c/code\u003e and started counting the words.   This approach was quick and painless but it had a few downs falls.    Some words \u003cem\u003elook\u003c/em\u003e the same when in reality they are not and so this meant I'd have to study every meaning of a word even if it was more rare.\u003c/p\u003e\n\u003cp\u003eAn example of this is the word \"como\", you can say:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eHaz como te digo: \"Do as I say\", where como means \"as\"\u003c/li\u003e\n\u003cli\u003ecomo tacos todos los dias: \"I eat tacos every day\", where como is a conjugated form of the verb \"to eat\"\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI need to know which version of a word is being used so I can count it properly.\u003c/p\u003e\n\u003ch3\u003eRegular Expressions are always the answer\u003c/h3\u003e\n\u003cp\u003eI couldn't figure out what the word was without it being in a complete sentence, but subtitles are fragments.   They are split up into timings for displaying on the screen but they don't include entire sentences.  For example, it might look like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003e\u003cspan class=\"hljs-number\"\u003e23\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e21.960\u003c/span\u003e --\u003e \u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e23.520\u003c/span\u003e  position:\u003cspan class=\"hljs-number\"\u003e50.00\u003c/span\u003e%,middle  align:middle size:\u003cspan class=\"hljs-number\"\u003e80.00\u003c/span\u003e%  line:\u003cspan class=\"hljs-number\"\u003e84.67\u003c/span\u003e% \nSolo las que luchan por ellos\n\n\u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e23.680\u003c/span\u003e --\u003e \u003cspan class=\"hljs-number\"\u003e00\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e01\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e25.680\u003c/span\u003e  position:\u003cspan class=\"hljs-number\"\u003e50.00\u003c/span\u003e%,middle  align:middle size:\u003cspan class=\"hljs-number\"\u003e80.00\u003c/span\u003e%  line:\u003cspan class=\"hljs-number\"\u003e84.67\u003c/span\u003e% \nconsiguen sus sueños.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI want to detect the start of a sentence and the end of a sentence and then combine it, so that you end up with \"Solo las que luchan por ellos consiguen sus sueños.\".   My first thought was a regular expression on punctuation.   This worked well \u003cem\u003emost\u003c/em\u003e of the time but there were enough exceptions to the rule that it broke often on generated a lot of broken sentences:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAbbreviations like \"EE. UU\" for estados unidos (united states)\u003c/li\u003e\n\u003cli\u003eEllipsis\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSplitting on spaces also didn't work for identifying the parts of speech since I needed the context around the word.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/regex-extraction.png\"\u003e\n\u003c/center\u003e\n\u003ch2\u003eNatural Language Processing\u003c/h2\u003e\n\u003cp\u003eSo to solve my pain I decided to grab https://spacy.io/ and do some NLP on the subtitles so that I could identify the proper parts of speech and get an accurate representation of the words I needed to learn.\u003c/p\u003e\n\u003cp\u003eThe way spaCy works is you can send it a sentence and it'll return you a set of tokens:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e spacy\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003enlp = spacy.load(\u003cspan class=\"hljs-string\"\u003e\"es_core_news_sm\"\u003c/span\u003e)\n\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003e[x.pos_ \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e x \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e nlp(\u003cspan class=\"hljs-string\"\u003e\"Hola, como estas?\"\u003c/span\u003e)]\n[\u003cspan class=\"hljs-string\"\u003e'PROPN'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'PUNCT'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'SCONJ'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'PRON'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'PUNCT'\u003c/span\u003e]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo now I could identify the parts of speech and pull sentences together through end of sentence punctation.   The first thing I did was generate a CSV of sentences that looked like this:\u003c/p\u003e\n\u003ctable\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003cth\u003esentence\u003c/th\u003e\n\u003cth\u003estart\u003c/th\u003e\n\u003cth\u003eend\u003c/th\u003e\n\u003cth\u003eshow\u003c/th\u003e\n\u003cth\u003efile\u003c/th\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eSi no, le voy a cortar todos los deditos\u003c/td\u003e\n\u003ctd\u003e00:00:20.605\u003c/td\u003e\n\u003ctd\u003e00:00:24.125\u003c/td\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003eEl marginal S02E02 WEBRip Netflix es[cc].vtt\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eOnce I had a CSV of sentences I could send those back through spaCy for NLP and then start counting words, to generate another CSV:\u003c/p\u003e\n\u003ctable\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003cth\u003eword\u003c/th\u003e\n\u003cth\u003epos\u003c/th\u003e\n\u003cth\u003eshow\u003c/th\u003e\n\u003cth\u003efile\u003c/th\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ea\u003c/td\u003e\n\u003ctd\u003eADP\u003c/td\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003eEl marginal S02E02 WEBRip Netflix es[cc].vtt\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ecortar\u003c/td\u003e\n\u003ctd\u003eVERB\u003c/td\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003eEl marginal S02E02 WEBRip Netflix es[cc].vtt\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003etodos\u003c/td\u003e\n\u003ctd\u003ePRON\u003c/td\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003eEl marginal S02E02 WEBRip Netflix es[cc].vtt\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eFrom there I had all the data I needed!   So now it was time to start doing some data analysis!\u003c/p\u003e\n\u003ch2\u003eData analysis\u003c/h2\u003e\n\u003cp\u003eUsing a jupyter notebook ( https://jupyter.org/ ) I grabbed pandas ( https://pandas.pydata.org/ ) and read in my CSVs to start analyzing the results.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e numpy \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e np\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e pandas \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e pd\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e matplotlib.\u003cspan class=\"hljs-property\"\u003epyplot\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e plt\npd.\u003cspan class=\"hljs-title function_\"\u003eset_option\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'display.max_rows'\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e)\nwords = pd.\u003cspan class=\"hljs-title function_\"\u003eread_csv\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'word_data.csv.gz'\u003c/span\u003e, compression=\u003cspan class=\"hljs-string\"\u003e'gzip'\u003c/span\u003e, delimiter=\u003cspan class=\"hljs-string\"\u003e','\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe words dataframe is built up out of the second table I showed above with just words and their parts of speech.   I started off grouping the dataset by the word so I could get a count for how many times it was spoken in every series I parsed:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003egrouped_result\u003c/span\u003e = (words.groupby(words.word).size() \n   .sort_values(\u003cspan class=\"hljs-attr\"\u003eascending\u003c/span\u003e=\u003cspan class=\"hljs-literal\"\u003eFalse\u003c/span\u003e) \n   .reset_index(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e)\n   .drop_duplicates(\u003cspan class=\"hljs-attr\"\u003esubset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e))\n\ngrouped_result.head(300)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhich returned a list of words and their count:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003e\t\u003cspan class=\"hljs-type\"\u003eword\u003c/span\u003e\tcount\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\tque\t\u003cspan class=\"hljs-number\"\u003e94430\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\tno\t\u003cspan class=\"hljs-number\"\u003e75931\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\ta\t\u003cspan class=\"hljs-number\"\u003e70968\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\tde\t\u003cspan class=\"hljs-number\"\u003e67982\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\tser\t\u003cspan class=\"hljs-number\"\u003e64226\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\tla\t\u003cspan class=\"hljs-number\"\u003e52143\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e\ty\t\u003cspan class=\"hljs-number\"\u003e44390\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\testar\t\u003cspan class=\"hljs-number\"\u003e37819\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e\tel\t\u003cspan class=\"hljs-number\"\u003e35920\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow I wanted to identify where my diminishing returns would be.   Is there a set of words that I must learn because they are spoken so often that I wouldn't understand a conversation if they weren't in my vocabulary?\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/diminishing_returns.png\"\u003e\n\u003c/center\u003e\n\u003cp\u003eAs you can see in this chart, the usage for words drops off at around the ~200 mark.   So there are basically 150 words I \u003cem\u003emust\u003c/em\u003e know and then the rest are equally important.   I wasn't quite happy with this because some parts of speech are higher priority than others, for example I think having a strong understanding of the popular verbs will go a long way.  So I also wanted to identify what are the most important verbs to learn:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003egrouped_verbs\u003c/span\u003e = (words[words.pos == \u003cspan class=\"hljs-string\"\u003e'VERB'\u003c/span\u003e].groupby([\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'pos'\u003c/span\u003e]).size() \n   .sort_values(\u003cspan class=\"hljs-attr\"\u003eascending\u003c/span\u003e=\u003cspan class=\"hljs-literal\"\u003eFalse\u003c/span\u003e) \n   .reset_index(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e)\n   .drop_duplicates(\u003cspan class=\"hljs-attr\"\u003esubset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e))\n\ngrouped_verbs.head(50)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhich got me this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\t\u003cspan class=\"hljs-string\"\u003eword\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003epos\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ecount\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003etener\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e22072\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ehacer\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e14946\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eir\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e12570\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003edecir\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e11314\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003equerer\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e11083\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ever\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e10269\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eestar\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e9780\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003esaber\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e8704\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eser\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e7674\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003edar\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e5722\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003epasar\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e5528\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ehablar\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e5355\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003evenir\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e5145\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ecreer\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e4895\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003esalir\u003c/span\u003e \t\u003cspan class=\"hljs-string\"\u003eVERB\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e3395\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eVerbs had a slightly different drop-off pattern when I targeted them directly:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/diminishing_verbs.png\"\u003e\n\u003c/center\u003e\n\u003cp\u003eI get a big bang for my buck by learning those top 40 verbs.   Nouns on the other hand are much more spread out and most are evenly distributed:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-string\"\u003eword\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003epos\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ecount\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003egracias\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e4676\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003efavor\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e4625\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eseñor\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e4116\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003everdad\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e3566\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003evida\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2673\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ehombre\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2601\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003emadre\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2597\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003evez\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2537\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003etiempo\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2492\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003ehijo\u003c/span\u003e\t\u003cspan class=\"hljs-string\"\u003eNOUN\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e2215\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/diminishing_nouns.png\"\u003e\n\u003c/center\u003e\n\u003cp\u003eSo then I thought to myself... How much of a show would I understand if I just learned these most important words?  So I started by excluding some of the easy parts of speech and focused on the most important:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003efind_important_words\u003c/span\u003e = (words[~words.pos.isin([\u003cspan class=\"hljs-string\"\u003e'PRON'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'CONJ'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'ADP'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'ADV'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'SCONJ'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'AUX'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'INTJ'\u003c/span\u003e])].groupby([\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'pos'\u003c/span\u003e]).size() \n   .sort_values(\u003cspan class=\"hljs-attr\"\u003eascending\u003c/span\u003e=\u003cspan class=\"hljs-literal\"\u003eFalse\u003c/span\u003e) \n   .reset_index(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e)\n   .drop_duplicates(\u003cspan class=\"hljs-attr\"\u003esubset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e))\n\nfind_important_words.head(50)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe top 20 were all verbs except for \u003ccode\u003ebueno\u003c/code\u003e and \u003ccode\u003egracias\u003c/code\u003e.   So now with my list of what I considered \"important words\" I plotted it to find what amount of words I wanted to learn:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/important_words.png\"\u003e\n\u003c/center\u003e\n\u003cp\u003eIt looks like 200 learned words would give me a reasonable amount of understanding for a series, so I decided to calculate how much of a series I would understand if I learned just those first 200 words:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003epercentages\u003c/span\u003e = {}\n\nfor show_name in words\u003cspan class=\"hljs-section\"\u003e['media']\u003c/span\u003e.drop_duplicates().values:\n    \u003cspan class=\"hljs-attr\"\u003ewords_in_show\u003c/span\u003e = (words[words.media == show_name].groupby(words.word).size() \n       .sort_values(\u003cspan class=\"hljs-attr\"\u003eascending\u003c/span\u003e=\u003cspan class=\"hljs-literal\"\u003eFalse\u003c/span\u003e) \n       .reset_index(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e)\n       .drop_duplicates(\u003cspan class=\"hljs-attr\"\u003esubset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e))\n    \n    \u003cspan class=\"hljs-attr\"\u003etotal_words_handled\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\n    for word in grouped_result\u003cspan class=\"hljs-section\"\u003e['word']\u003c/span\u003e\u003cspan class=\"hljs-section\"\u003e[:200]\u003c/span\u003e:\n        \u003cspan class=\"hljs-attr\"\u003evalues\u003c/span\u003e = words_in_show[words_in_show.word == word][\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e].values\n\n        if values.size \u003e 0:\n            total_words_handled += values\u003cspan class=\"hljs-section\"\u003e[0]\u003c/span\u003e\n\n    percentages\u003cspan class=\"hljs-section\"\u003e[show_name]\u003c/span\u003e = total_words_handled / words_in_show.sum().loc\u003cspan class=\"hljs-section\"\u003e['count']\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow I had a table that would show me what percentage of the spoken words were covered by the first 200 words in my list:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003ep_df\u003c/span\u003e = pd.DataFrame(percentages.items(), columns=[\u003cspan class=\"hljs-string\"\u003e'show'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'percentage'\u003c/span\u003e])\n\u003cspan class=\"hljs-attr\"\u003ep_df\u003c/span\u003e = p_df.sort_values(by=\u003cspan class=\"hljs-string\"\u003e'percentage'\u003c/span\u003e)\np_df\u003cspan class=\"hljs-section\"\u003e['percentage']\u003c/span\u003e = p_df\u003cspan class=\"hljs-section\"\u003e['percentage']\u003c/span\u003e * 100\n\u003cspan class=\"hljs-attr\"\u003epd.options.display.float_format\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'{:,.2f}%'\u003c/span\u003e.format\np_df\n\u003c/code\u003e\u003c/pre\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003cth\u003eShow\u003c/th\u003e\n\u003cth\u003ePercentage\u003c/th\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eVerónica\u003c/td\u003e\n\u003ctd\u003e64.24%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl ciudadano ilustre\u003c/td\u003e\n\u003ctd\u003e65.28%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl Chapo\u003c/td\u003e\n\u003ctd\u003e66.68%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eNeruda\u003c/td\u003e\n\u003ctd\u003e66.89%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa casa de papel\u003c/td\u003e\n\u003ctd\u003e67.56%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl Ministerio del Tiempo\u003c/td\u003e\n\u003ctd\u003e68.03%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eClub de Cuervos\u003c/td\u003e\n\u003ctd\u003e68.19%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003e68.47%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eIngobernable\u003c/td\u003e\n\u003ctd\u003e68.59%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003ePablo Escobar\u003c/td\u003e\n\u003ctd\u003e70.20%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eFariña\u003c/td\u003e\n\u003ctd\u003e70.95\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa Reina del Sur\u003c/td\u003e\n\u003ctd\u003e71.52%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eGran Hotel\u003c/td\u003e\n\u003ctd\u003e73.15%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLas chicas del cable\u003c/td\u003e\n\u003ctd\u003e73.58%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eÉlite\u003c/td\u003e\n\u003ctd\u003e73.78%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa Piloto\u003c/td\u003e\n\u003ctd\u003e74.03%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl bar\u003c/td\u003e\n\u003ctd\u003e74.07%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa casa de las flores\u003c/td\u003e\n\u003ctd\u003e75.40%\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eTarde para la ira\u003c/td\u003e\n\u003ctd\u003e75.59%\u003c/td\u003e\n\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eBut living in Puerto Rico, one thing I've realized is speed of speech is also important.  I have a much easier time speaking with people from Colombia and Mexico than I do with Puerto Ricans because they speak so much faster.   So even though I could understand 75% of \"Tarde para la ira\" if I learned the 200 words, I want to make sure they are speaking at a pace I could understand as well.\u003c/p\u003e\n\u003cp\u003eSo I loaded up the other CSV file that was the full sentences and added a \"time per word\" column:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-css\"\u003esentences = pd\u003cspan class=\"hljs-selector-class\"\u003e.read_csv\u003c/span\u003e('sentences\u003cspan class=\"hljs-selector-class\"\u003e.csv\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.gz\u003c/span\u003e', compression='gzip', delimiter=',', parse_dates=\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'start'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'end'\u003c/span\u003e]\u003c/span\u003e)\nsentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'total_time'\u003c/span\u003e]\u003c/span\u003e = (sentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'end'\u003c/span\u003e]\u003c/span\u003e - sentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'start'\u003c/span\u003e]\u003c/span\u003e)\u003cspan class=\"hljs-selector-class\"\u003e.dt\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.total_seconds\u003c/span\u003e()\nsentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'word_count'\u003c/span\u003e]\u003c/span\u003e = sentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'sentence'\u003c/span\u003e]\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.str\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.split\u003c/span\u003e()\u003cspan class=\"hljs-selector-class\"\u003e.str\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.len\u003c/span\u003e()\nsentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'time_per_word'\u003c/span\u003e]\u003c/span\u003e = sentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'total_time'\u003c/span\u003e]\u003c/span\u003e / sentences\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'word_count'\u003c/span\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen I was able to have a speed rating for each show:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-scss\"\u003esentence_group = sentences\u003cspan class=\"hljs-selector-class\"\u003e.groupby\u003c/span\u003e([sentences.media])\nsentence_group\u003cspan class=\"hljs-selector-class\"\u003e.time_per_word\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.mean\u003c/span\u003e()\u003cspan class=\"hljs-selector-class\"\u003e.reset_index\u003c/span\u003e()\u003cspan class=\"hljs-selector-class\"\u003e.sort_values\u003c/span\u003e('time_per_word')\n\u003c/code\u003e\u003c/pre\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003cth\u003emedia\u003c/th\u003e\n\u003cth\u003etime_per_word\u003c/th\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eGran Hotel\u003c/td\u003e\n\u003ctd\u003e0.58\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl Chapo\u003c/td\u003e\n\u003ctd\u003e0.59\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLas chicas del cable\u003c/td\u003e\n\u003ctd\u003e0.61\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eÉlite\u003c/td\u003e\n\u003ctd\u003e0.63\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eIngobernable\u003c/td\u003e\n\u003ctd\u003e0.64\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl Ministerio del Tiempo\u003c/td\u003e\n\u003ctd\u003e0.64\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eFariña\u003c/td\u003e\n\u003ctd\u003e0.65\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl ciudadano ilustre\u003c/td\u003e\n\u003ctd\u003e0.67\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eNeruda\u003c/td\u003e\n\u003ctd\u003e0.68\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa Piloto\u003c/td\u003e\n\u003ctd\u003e0.69\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa casa de papel\u003c/td\u003e\n\u003ctd\u003e0.70\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl bar\u003c/td\u003e\n\u003ctd\u003e0.70\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eVerónica\u003c/td\u003e\n\u003ctd\u003e0.72\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa Reina del Sur\u003c/td\u003e\n\u003ctd\u003e0.75\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eClub de Cuervos\u003c/td\u003e\n\u003ctd\u003e0.76\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eEl marginal\u003c/td\u003e\n\u003ctd\u003e0.76\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003ePablo Escobar\u003c/td\u003e\n\u003ctd\u003e0.77\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eTarde para la ira\u003c/td\u003e\n\u003ctd\u003e0.77\u003c/td\u003e\n\u003c/tr\u003e\u003ctr\u003e\n\u003ctd\u003eLa casa de las flores\u003c/td\u003e\n\u003ctd\u003e0.81\u003c/td\u003e\n\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eLuckily the two series that have the least amount of vocabulary also speak the slowest!   So these will be the series I start with.    The final question I wanted to answer is \"What are the top words I'm missing for a series\".    Since I'll know 75% of the series from the top 200 words, I'm hoping there are some top words from a specific series that I can also learn to get an even higher understanding.\u003c/p\u003e\n\u003cp\u003eFirst, find which words are in each show but not in the top 200:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003emissing_words_by_show\u003c/span\u003e = {}\n\nfor show_name in words\u003cspan class=\"hljs-section\"\u003e['media']\u003c/span\u003e.drop_duplicates().values:\n    \u003cspan class=\"hljs-attr\"\u003ewords_in_show\u003c/span\u003e = (words[words.media == show_name].groupby(words.word).size() \n       .sort_values(\u003cspan class=\"hljs-attr\"\u003eascending\u003c/span\u003e=\u003cspan class=\"hljs-literal\"\u003eFalse\u003c/span\u003e) \n       .reset_index(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'count'\u003c/span\u003e)\n       .drop_duplicates(\u003cspan class=\"hljs-attr\"\u003esubset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e))\n    \n    \u003cspan class=\"hljs-attr\"\u003efrequency_words\u003c/span\u003e = grouped_result[\u003cspan class=\"hljs-string\"\u003e'word'\u003c/span\u003e][:\u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e]\n\n    \u003cspan class=\"hljs-attr\"\u003emissing_words\u003c/span\u003e = words_in_show[~words_in_show.word.isin(frequency_words.values)]\n    missing_words_by_show\u003cspan class=\"hljs-section\"\u003e[show_name]\u003c/span\u003e = missing_words\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen we were able to grab them per show:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-css\"\u003emissing_words_by_show\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'La casa de las flores'\u003c/span\u003e]\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.head\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e50\u003c/span\u003e)\n\nword\tcount\n\u003cspan class=\"hljs-number\"\u003e31\u003c/span\u003e\tmamá\t\u003cspan class=\"hljs-number\"\u003e252\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e70\u003c/span\u003e\tflorerí\u003cspan class=\"hljs-selector-tag\"\u003ea\u003c/span\u003e\t\u003cspan class=\"hljs-number\"\u003e87\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e98\u003c/span\u003e\tperdón\t\u003cspan class=\"hljs-number\"\u003e56\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e102\u003c/span\u003e\tsea\t\u003cspan class=\"hljs-number\"\u003e54\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e\tademás\t\u003cspan class=\"hljs-number\"\u003e44\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e126\u003c/span\u003e\tahorita\t\u003cspan class=\"hljs-number\"\u003e40\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e132\u003c/span\u003e\tcárcel\t\u003cspan class=\"hljs-number\"\u003e38\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\tfiesta\t\u003cspan class=\"hljs-number\"\u003e38\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo adding those few words to my vocabulary will also give me a better understanding of the series.\u003c/p\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eI believe a data-driven approach to language learning will be an effective way to get me speaking better spanish.   It was a ton of fun to play with spaCy, pandas, and jupyter as well!\u003c/p\u003e\n\u003cp\u003eI'll improve the data analysis over time as well but I do believe this is a pretty good starting point!\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/learning_spanish/meme.png\"\u003e\n\u003c/center\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2022/learning_spanish\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2022/learning_spanish\u003c/guid\u003e\n            \u003cpubDate\u003eSat, 30 Apr 2022 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Running a kubernetes cluster locally with kubeadm]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eI’m going to show you how to get a real kubernetes cluster setup locally on top of virtual\nmachines!  I’ll be using multipass but feel free to use virtualbox, proxmox, or whatever your\nfavorite cloud provider is.\u003c/p\u003e\n\u003cp\u003ekubeadm a production ready kubernetes install tool and I prefer to use it over minikube, kind,\netc. because it gives you a more real world experience for \u003cem\u003emanaging\u003c/em\u003e the kubernetes cluster.\nThis isn’t important if you are a user of the cluster but if you have to run your own this is\na great way to gain some daily experience.\u003c/p\u003e\n\u003cp\u003eThe kubernetes documentation on kubeadm is great and you can find it \u003ca href=\"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe differences between this blog and the kubernetes docs is that they leave a lot of decisions\nup to the reader such as:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003echoosing a container runtime\u003c/li\u003e\n\u003cli\u003eSelecting and installing a CNI (container network interface)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI’m going to be opinionated and make specific technology decisions such as using containerd and\ncilium so that you don't have to think about those decisions.\u003c/p\u003e\n\u003ch2\u003eGetting your Virtual Machines setup!\u003c/h2\u003e\n\u003cp\u003eThe minimum requirements for a control plane node in kubernetes is 2gb of RAM and 2 CPUs.  Since\nwe actually want to be able to schedule workloads on the workers afterwards we are going to setup\na cluster that looks like this:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eControl Plane: 2gb RAM, 2 CPU\u003c/li\u003e\n\u003cli\u003eWorker: 4gb RAM, 2 CPU\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSince we’ll be using multipass to launch the nodes, we can do that now:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ multipass launch -c 2 -m 4G -d 10G -n controlplane 22.04\n❯ multipass launch -c 2 -m 4G -d 10G -n worker 22.04\n❯ multipass list\nName                    State             IPv4             Image\ncontrolplane            Running           192.168.64.7     Ubuntu 22.04 LTS\nworker                  Running           192.168.64.8     Ubuntu 22.04 LTS\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can start working on our controlplane first, lets shell in:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ multipass shell controlplane\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets first add the kubernetes repo to the system so we have access to all the kubernetes tools:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"deb  http://apt.kubernetes.io/  kubernetes-xenial  main\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/apt/sources.list.d/kubernetes.list\n\n❯ curl -fsSL  https://packages.cloud.google.com/apt/doc/apt-key.gpg|sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/k8s.gpg\n❯ sudo apt-get update \u0026#x26;\u0026#x26; sudo apt-get upgrade -y\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow that our system is setup, we can move on to getting a container runtime.\u003c/p\u003e\n\u003ch2\u003eGetting your Container Runtime!\u003c/h2\u003e\n\u003cp\u003eBefore we start pulling in kubernetes components we need to get a container runtime setup on the\nmachine.   We we are going to use containerd for this purpose.  You can view the docs of for it\n\u003ca href=\"https://github.com/containerd/containerd/blob/main/docs/getting-started.md\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWhich will download the latest binary and set it up.   I’m going to walk you through how to do it\nusing the version packaged with Ubuntu which could be older than the latest release.\u003c/p\u003e\n\u003cp\u003eFirst thing we want to do is configure the networking to allow iptables to manage:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\u003c/span\u003e\n\n❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nEOF\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe also need to disable some default systemd settings for \u003ccode\u003erp_filter\u003c/code\u003e  because\nthey are not compatible with cilium. See the bug report\n\u003ca href=\"https://github.com/cilium/cilium/commit/cabc6581b8128681f4ed23f8d6dc463180eea61e\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo sed -i -e \u003cspan class=\"hljs-string\"\u003e'/net.ipv4.conf.*.rp_filter/d'\u003c/span\u003e $(grep -ril \u003cspan class=\"hljs-string\"\u003e'\\.rp_filter'\u003c/span\u003e /etc/sysctl.d/ /usr/lib/sysctl.d/)\n❯ sudo sysctl -a | grep \u003cspan class=\"hljs-string\"\u003e'\\.rp_filter'\u003c/span\u003e | awk \u003cspan class=\"hljs-string\"\u003e'{print $1\" = 0\"}'\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e -a /etc/sysctl.d/1000-cilium.conf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen we need to refresh sysctl so those settings are applied:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo systemctl restart systemd-modules-load\n❯ sudo sysctl --system\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should see it applying all the changes:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e* Applying /etc/sysctl.d/k8s.conf ...\n\u003cspan class=\"hljs-attr\"\u003enet.bridge.bridge-nf-call-ip6tables\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.bridge.bridge-nf-call-iptables\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.ip_forward\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf you do not, the netfilter module may not have loaded properly:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ lsmod |grep br_netfilter\nbr_netfilter           28672  0\nbridge                176128  1 br_netfilter\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou want to make sure \u003ccode\u003erp_filter\u003c/code\u003e is \u003ccode\u003e0\u003c/code\u003e everywhere as well for cilium:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e❯ sudo sysctl -a | grep '\\.rp_filter'\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.all.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.cilium_host.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.cilium_net.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.cilium_vxlan.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.default.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.enp0s1.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.lo.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.lxc0965b7b545f7.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003enet.ipv4.conf.lxcb05ffd84ab74.rp_filter\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow lets pull down the container runtime we’ll be using which is containerd.\u003c/p\u003e\n\u003cp\u003eUbuntu ships with a very old version of containerd so you need to upgrade to\nthe version shipped from the docker repos:\nYou can find which versions are available by running:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg\n❯ \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"deb https://download.docker.com/linux/ubuntu \u003cspan class=\"hljs-subst\"\u003e$(lsb_release -cs)\u003c/span\u003e stable\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/apt/sources.list.d/docker.list\n❯ sudo apt-get update\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo apt-cache madison containerd.io\ncontainerd.io |    1.6.8-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\ncontainerd.io |    1.6.7-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\ncontainerd.io |    1.6.6-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\ncontainerd.io |    1.6.4-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\ncontainerd.io |   1.5.11-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\ncontainerd.io |   1.5.10-1 | https://download.docker.com/linux/ubuntu jammy/stable arm64 Packages\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe are going to use the latest version available which was 1.6.8-1\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo apt-get install containerd.io=1.6.8-1 -y\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen we'll setup a configuration that enables containerd to use the systemd\ncgroup.  We are hard coding this config instead of using \u003ccode\u003econtainerd config default\u003c/code\u003e\nbecause that currently has had a \u003ca href=\"https://github.com/containerd/containerd/issues/4574\"\u003ebug\u003c/a\u003e\nfor many years that generates an invalid config.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/containerd/config.toml\nversion = 2\n[plugins]\n  [plugins.\"io.containerd.grpc.v1.cri\"]\n   [plugins.\"io.containerd.grpc.v1.cri\".containerd]\n      [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes]\n        [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc]\n          runtime_type = \"io.containerd.runc.v2\"\n          [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n            SystemdCgroup = true\nEOF\u003c/span\u003e\n\n❯ sudo systemctl restart containerd.service\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can verify its running with ctr:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo ctr --address /var/run/containerd/containerd.sock containers list\nCONTAINER    IMAGE    RUNTIME\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow that this is working we can move on to getting kubernetes installed!\u003c/p\u003e\n\u003ch2\u003eUsing kubeadm!\u003c/h2\u003e\n\u003cp\u003eNow we need to get the kubernetes tools installed onto the system.  I’m going to be using 1.23\nbut to find the latest version you can run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo apt-cache madison kubeadm|\u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e -n2\n   kubeadm |  1.23.5-00 | http://apt.kubernetes.io kubernetes-xenial/main amd64 Packages\n   kubeadm |  1.23.4-00 | http://apt.kubernetes.io kubernetes-xenial/main amd64 Packages\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen install the version you want, we install kubelet and kubeadm here to make\nsure the versions align:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo apt-get install kubeadm=1.23.5-00 kubelet=1.23.5-00 kubectl=1.23.5-00 -y\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will pull in a few tools, including an alternative to \u003ccode\u003ectr\u003c/code\u003e that we used earlier called\n\u003ccode\u003ecrictl\u003c/code\u003e.  You can check that it is available to you doing this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock ps\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe can finally init our cluster:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo kubeadm init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce that finishes running it should give you some tips setup your configuration, it should look like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube\n❯ sudo \u003cspan class=\"hljs-built_in\"\u003ecp\u003c/span\u003e -i /etc/kubernetes/admin.conf \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube/config\n❯ sudo \u003cspan class=\"hljs-built_in\"\u003echown\u003c/span\u003e $(\u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e -u):$(\u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e -g) \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube/config\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can run those on the master node for now, but later I'll show you how to move\nthe config to your host computer.\u003c/p\u003e\n\u003cp\u003eNow you should be able to check that your node is not ready yet:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubectl get nodes\nNAME           STATUS     ROLES                  AGE     VERSION\ncontrolplane   NotReady   control-plane,master   4m16s   v1.23.5\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cem\u003eNote\u003c/em\u003e: If you recieve \"The connecto to the server was refused\" error,\nThe cluster starting up and getting all the dependencies running could take\na bit of time.  So if you aren't able to communicate right away you can check\nwhich pods are up and running with \u003ccode\u003ecrictl\u003c/code\u003e.  You'll need \u003ccode\u003ekube-apiserver\u003c/code\u003e up\nand running.  If it isn't you can check:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock ps -a\nCONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD\n8322192c4605c       bd8cc6d582470       36 seconds ago      Running             kube-proxy                4                   344c4f7fffbe8       kube-proxy-drm46\n30ce27c40adb2       81a4a8a4ac639       2 minutes ago       Exited              kube-controller-manager   4                   3a819c3a864b2       kube-controller-manager-controlplane\n7709fd5e92898       bd8cc6d582470       2 minutes ago       Exited              kube-proxy                3                   7cc6922c82015       kube-proxy-drm46\n10432b81d7c61       3767741e7fba7       2 minutes ago       Exited              kube-apiserver            4                   e64ddf3679d98       kube-apiserver-controlplane\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ewhich will show you pods that have exited. You can grab the container ID for\nkube-apiserver and read its logs:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo crictl --runtime-endpoint=unix:///var/run/containerd/containerd.sock logs 10432b81d7c61\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere are a few ways to figure out why the node isn’t ready yet.  Usually I would check the\n\u003ccode\u003ekubelet\u003c/code\u003e logs first:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo journalctl -flu kubelet\n-- Logs begin at Sun 2022-04-17 19:22:19 AST. --\nApr 17 20:53:15 controlplane kubelet[19727]: E0417 20:53:15.951350   19727 kubelet.go:2347] \u003cspan class=\"hljs-string\"\u003e\"Container runtime network not ready\"\u003c/span\u003e networkReady=\u003cspan class=\"hljs-string\"\u003e\"NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized\"\u003c/span\u003e\nApr 17 20:53:20 controlplane kubelet[19727]: E0417 20:53:20.952148   19727 kubelet.go:2347] \u003cspan class=\"hljs-string\"\u003e\"Container runtime network not ready\"\u003c/span\u003e networkReady=\u003cspan class=\"hljs-string\"\u003e\"NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt is clear the problem is that we are missing the CNI.  The other way you can find out what is\ngoing on is describing the node:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubectl describe node controlplane\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will have a lot of information but if you scroll through there looking at \u003ccode\u003eReason\u003c/code\u003e you\nmight see something useful.  In this case under \u003ccode\u003eLease\u003c/code\u003e you would see:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubectl describe node controlplane|grep NotReady\nReady            False   Sun, 17 Apr 2022 20:53:37 -0400   Sun, 17 Apr 2022 20:43:07 -0400   KubeletNotReady              container runtime network not ready: NetworkReady=\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialize\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets get our CNI installed, we’ll be using cilium!\u003c/p\u003e\n\u003ch2\u003eSetting up your CNI!\u003c/h2\u003e\n\u003cp\u003eCilium has great documentation over \u003ca href=\"https://docs.cilium.io/en/v1.9/gettingstarted/k8s-install-kubeadm/\"\u003ehere\u003c/a\u003e,\nbut I’ll walk you through it anyways.  I do recommend checking out their documentation so you\nare familiar with it.   We will use \u003ccode\u003ehelm\u003c/code\u003e to pull down the version of cilium we want:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ curl -fsSL  https://baltocdn.com/helm/signing.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/helm.gpg\n\n❯ sudo apt-get install apt-transport-https --\u003cspan class=\"hljs-built_in\"\u003eyes\u003c/span\u003e\n\n❯ \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"deb https://baltocdn.com/helm/stable/debian/ all main\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/apt/sources.list.d/helm-stable-debian.list\n\n❯ sudo apt-get update\n❯ sudo apt-get install helm\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can install cilium!  It is \u003cem\u003every\u003c/em\u003e important that you pay attention to the\ncompatibility of cilium with the version of kubernetes you are intstalling. Check\nthe compatibility list \u003ca href=\"https://docs.cilium.io/en/v1.12/concepts/kubernetes/compatibility/\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ helm repo add cilium https://helm.cilium.io/\n❯ helm repo update\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce the repo is added you can list the versions available:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ helm search repo -l|\u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e -n8\nNAME           \tCHART VERSION\tAPP VERSION\tDESCRIPTION\ncilium/cilium  \t1.12.1       \t1.12.1     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.12.0       \t1.12.0     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.11.8       \t1.11.8     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.11.7       \t1.11.7     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.11.6       \t1.11.6     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.11.5       \t1.11.5     \teBPF-based Networking, Security, and Observability\ncilium/cilium  \t1.11.4       \t1.11.4     \teBPF-based Networking, Security, and Observability\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo we want \u003ccode\u003e1.11.4\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ helm install cilium cilium/cilium --namespace kube-system --version 1.11.4\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow our node should be ready!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubectl get node\nNAME           STATUS   ROLES                  AGE   VERSION\ncontrolplane   Ready    control-plane,master   24m   v1.23.5\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTime to join our worker to the cluster!\u003c/p\u003e\n\u003ch2\u003eJoining a worker to the cluster!\u003c/h2\u003e\n\u003cp\u003eWe have to go through the same steps as the controlplane to get the point that we have a\ncontainer runtime and \u003ccode\u003ekubeadm\u003c/code\u003e.   I’m not going to talk about the commands a second time but\nI’ll re-iterate them here for ease of following along.\u003c/p\u003e\n\u003cp\u003eFirst open up another shell and connect to the worker:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ multipass shell worker\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow run the following commands:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"deb  http://apt.kubernetes.io/  kubernetes-xenial  main\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/apt/sources.list.d/kubernetes.list\n❯ curl -fsSL  https://packages.cloud.google.com/apt/doc/apt-key.gpg|sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/k8s.gpg\n❯ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg\n❯ \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"deb https://download.docker.com/linux/ubuntu \u003cspan class=\"hljs-subst\"\u003e$(lsb_release -cs)\u003c/span\u003e stable\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/apt/sources.list.d/docker.list\n\n❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\u003c/span\u003e\n\n❯ sudo sed -i -e \u003cspan class=\"hljs-string\"\u003e'/net.ipv4.conf.*.rp_filter/d'\u003c/span\u003e $(grep -ril \u003cspan class=\"hljs-string\"\u003e'\\.rp_filter'\u003c/span\u003e /etc/sysctl.d/ /usr/lib/sysctl.d/)\n❯ sudo sysctl -a | grep \u003cspan class=\"hljs-string\"\u003e'\\.rp_filter'\u003c/span\u003e | awk \u003cspan class=\"hljs-string\"\u003e'{print $1\" = 0\"}'\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e -a /etc/sysctl.d/1000-cilium.conf\n\n❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nEOF\u003c/span\u003e\n\n❯ sudo systemctl restart systemd-modules-load\n❯ sudo sysctl --system\n\n❯ sudo apt-get update \u0026#x26;\u0026#x26; sudo apt-get upgrade -y\n❯ sudo apt-get install containerd.io=1.6.8-1 -y\n\n❯ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/containerd/config.toml\nversion = 2\n[plugins]\n  [plugins.\"io.containerd.grpc.v1.cri\"]\n   [plugins.\"io.containerd.grpc.v1.cri\".containerd]\n      [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes]\n        [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc]\n          runtime_type = \"io.containerd.runc.v2\"\n          [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n            SystemdCgroup = true\nEOF\u003c/span\u003e\n\n❯ sudo systemctl restart containerd.service\n❯ sudo apt-get install kubeadm=1.23.5-00 kubelet=1.23.5-00 kubectl=1.23.5-00 -y\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFrom there we should be ready to join the cluster.   When we ran \u003ccode\u003ekubeadm init\u003c/code\u003e previously it\nprinted a join command out that we could use but I’m going to show you how to do it if you\nwere coming back later and no longer had that token.\u003c/p\u003e\n\u003cp\u003eBack on the \u003cem\u003econtroplane\u003c/em\u003e node run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubeadm token create --print-join-command\nkubeadm \u003cspan class=\"hljs-built_in\"\u003ejoin\u003c/span\u003e 192.168.64.7:6443 --token wxs197.cco6mjj9ricvu8ov --discovery-token-ca-cert-hash sha256:bd01c065240fa76f30a02ecb70a8cea6e329c9678994d4da1f6ccac7694b97fb\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow copy that command and run it with \u003ccode\u003esudo\u003c/code\u003e on the worker:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ sudo kubeadm \u003cspan class=\"hljs-built_in\"\u003ejoin\u003c/span\u003e 192.168.64.7:6443 --token wxs197.cco6mjj9ricvu8ov --discovery-token-ca-cert-hash sha256:bd01c065240fa76f30a02ecb70a8cea6e329c9678994d4da1f6ccac7694b97fb\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter this completes it’ll take a minute or two for everything to be synced up but if you go\nback to the master node you should have 2 ready nodes now:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ kubectl get nodes\nNAME           STATUS   ROLES                  AGE   VERSION\ncontrolplane   Ready    control-plane,master   46m   v1.23.5\nworker         Ready    \u0026#x3C;none\u003e                 79s   v1.23.5\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eAccessing the cluster outside of the VMs!\u003c/h2\u003e\n\u003cp\u003eNow the final part is to get the \u003ccode\u003eadmin.conf\u003c/code\u003e as a kubeconfig on your machine so you can control\nit from outside of the cluster.   To do this we can use scp\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emultipass transfer controlplane:/home/ubuntu/.kube/config local.config\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNormally kubernetes configuration is in ~/.kube/config but I like to maint a separate file for\neach cluster and then I set the \u003ccode\u003eKUBECONFIG\u003c/code\u003e env var to access it.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e KUBECONFIG=local.config\n❯ kubectl get nodes\nNAME           STATUS   ROLES                  AGE   VERSION\ncontrolplane   Ready    control-plane,master   56m   v1.23.5\nworker         Ready    \u0026#x3C;none\u003e                 11m   v1.23.5\n\u003c/code\u003e\u003c/pre\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2022/local_kubeadm_cluster\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2022/local_kubeadm_cluster\u003c/guid\u003e\n            \u003cpubDate\u003eSun, 17 Apr 2022 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Automate project workflows with the command runner Just!]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eI believe every project should have a CLI built around the standard workflows of developing\non the project.  Things like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInstall dependencies\u003c/li\u003e\n\u003cli\u003eRun tests\u003c/li\u003e\n\u003cli\u003eRun linter and formatters\u003c/li\u003e\n\u003cli\u003eBuild project\u003c/li\u003e\n\u003cli\u003eStart / Stop the docker environment\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe reason I think this is important is because it makes a nice consistent and discoverable\nentrypoint for understanding how you should work in the project.   If you only provide the\ninstructions in the \u003ccode\u003eREADME\u003c/code\u003e then you have to remember to update those docs every time you\nadd a new command.  Those docs aren't easily testable either.\u003c/p\u003e\n\u003cp\u003eMost of my career the command runner of choice for my projects as been \u003ccode\u003eGNU Make\u003c/code\u003e but it was\ndefinitely the wrong tool for the job.  It is a build tool that I bent into shape to work\nas a command runner for me.   These days I use the tool \u003ca href=\"https://github.com/casey/just\"\u003ejust\u003c/a\u003e.\u003c/p\u003e\n\u003ch2\u003eIntro to just\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/casey/just\"\u003eJust\u003c/a\u003e is a modern command runner with a similar syntax to \u003ccode\u003emake\u003c/code\u003e\nthat provides a nice way for building out your project CLI!  You create a file named \u003ccode\u003ejustfile\u003c/code\u003e\nat the root of your project and then the basic syntax is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-make\"\u003e\u003cspan class=\"hljs-section\"\u003ehelp:\u003c/span\u003e\n  @just --list\n\n\u003cspan class=\"hljs-comment\"\u003e# My first command\u003c/span\u003e\n\u003cspan class=\"hljs-section\"\u003efirst:\u003c/span\u003e\n  echo \u003cspan class=\"hljs-string\"\u003e\"Any commands you want to run go here!\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe first \u003ccode\u003ehelp\u003c/code\u003e line defines a command \"help\" for your CLI and it lists out all the other available\ncommans.  I always put this line first because \u003ccode\u003ejust\u003c/code\u003e runs the first command in the file if a specific\ncommand isn't requested.  The output of this file looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ just\nAvailable recipes:\n    first \u003cspan class=\"hljs-comment\"\u003e# My first command\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHaving help automatically generated is fantastic!  Its also really helpful that it adds the comment\nto the command so that each command is self-documenting.  If you run the \u003ccode\u003efirst\u003c/code\u003e command you'll notice\nit also has a feature where it prints out the commands being ran so the user knows exactly what is\nhappening:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ just first\n\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Any commands you want to run go here!\"\u003c/span\u003e\nAny commands you want to run go here!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis doesn't always make sense though, so you can quickly remove that behavior by putting an \u003ccode\u003e@\u003c/code\u003e in front\nof any of the commands, like I did for the \u003ccode\u003ehelp\u003c/code\u003e command above.  You can also declare dependencies if\nyou have re-usable parts of your workflow that many of your commands need.\u003c/p\u003e\n\u003cp\u003eFor example, you might want to check versions of things like \u003ccode\u003enode\u003c/code\u003e and \u003ccode\u003epython\u003c/code\u003e before running the install\nof their dependencies. So you could do something like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-make\"\u003e\u003cspan class=\"hljs-section\"\u003ehelp:\u003c/span\u003e\n  @just --list\n\nnode_version := \u003cspan class=\"hljs-string\"\u003e\"v17.6.0\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Verify system dependencies\u003c/span\u003e\n\u003cspan class=\"hljs-section\"\u003echeck-dependencies:\u003c/span\u003e\n  @if [ ! \u003cspan class=\"hljs-string\"\u003e\"$(node --version)\"\u003c/span\u003e = {{ node_version }} ]; \\\n  then \\\n    echo \u003cspan class=\"hljs-string\"\u003e\"Missing node version: {{ node_version }}\"\u003c/span\u003e; \\\n    exit 1; \\\n  fi\n\n\u003cspan class=\"hljs-comment\"\u003e# Install frontend\u003c/span\u003e\n\u003cspan class=\"hljs-section\"\u003einstall: check-dependencies\u003c/span\u003e\n  @echo \u003cspan class=\"hljs-string\"\u003e\"yarn install\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ewhich ends up with a CLI that looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ just\nAvailable recipes:\n    check-dependencies \u003cspan class=\"hljs-comment\"\u003e# Verify system dependencies\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e\n    install            \u003cspan class=\"hljs-comment\"\u003e# Install frontend\u003c/span\u003e\n\n❯ just install\nMissing node version: v17.6.0\nerror: Recipe `check-dependencies` failed on line 12 with \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e code 1\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis opens up a lot of possibilities! In the above \u003ccode\u003ejustfile\u003c/code\u003e you'll notice I'm using a multi-line\ncommand but I have \u003ccode\u003e\\\u003c/code\u003e at the end of each line.  This is because \u003ccode\u003ejust\u003c/code\u003e by default is going to run\neach new line in their own shell.   So this just makes all those lines run in the same shell.\u003c/p\u003e\n\u003cp\u003eYou do not have to use this syntax though.  Just is \u003ccode\u003epolyglot\u003c/code\u003e and can run commands from any language\nyou would like.\u003c/p\u003e\n\u003ch3\u003ePolyglot\u003c/h3\u003e\n\u003cp\u003eIf you want to use a bash script as one of your commands, you can do so by adding a shebang at the top:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-make\"\u003e\u003cspan class=\"hljs-section\"\u003echeck-dependencies:\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e#!/usr/bin/env bash\u003c/span\u003e\n  set -euxo pipefail\n  if [ ! \u003cspan class=\"hljs-string\"\u003e\"$(node --version)\"\u003c/span\u003e = {{ node_version }} ];\n  then\n    echo \u003cspan class=\"hljs-string\"\u003e\"Missing node version: {{ node_version }}\"\u003c/span\u003e\n    exit 1\n  fi\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow the entire command is using a bash script to execute! This gets really interesting if you want to start\nusing things like python, so if you'd like to change the dependency checker above to python:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003echeck-dependencies:\n  \u003cspan class=\"hljs-comment\"\u003e#!/usr/bin/env python3\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e subprocess\n  result = subprocess.run(\n    [\u003cspan class=\"hljs-string\"\u003e'node'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'--version'\u003c/span\u003e],\n    stdout=subprocess.PIPE\n  )\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e result != \u003cspan class=\"hljs-string\"\u003e\"{{ node_version }}\"\u003c/span\u003e:\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003ef\"Missing node version: {{ node_version }}\"\u003c/span\u003e)\n    exit(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can even tell \u003ccode\u003ejust\u003c/code\u003e that you want to use a specific language for all commands!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003eset shell := [\u003cspan class=\"hljs-string\"\u003e\"python3\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"-c\"\u003c/span\u003e]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis not only affects the commands you have in your recipe but also anything inside\nbackticks!  So something like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-make\"\u003e`print(\u003cspan class=\"hljs-string\"\u003e\"Rust is the best programming language\"\u003c/span\u003e)`\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt would run through python instead of the shell.\u003c/p\u003e\n\u003ch3\u003eEnviornment Files\u003c/h3\u003e\n\u003cp\u003eOne of the other modern things \u003ccode\u003ejust\u003c/code\u003e adds to your workflow is the ability to utilize dotenv\nfiles.  So for example if you want to define which port you launch your http server on, you can\ncreate a file called \u003ccode\u003e.env\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eWEBSERVER_PORT=9000\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand then utilize it in your \u003ccode\u003ejustfile\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-make\"\u003eset dotenv-load\n\n\u003cspan class=\"hljs-section\"\u003ehttp:\u003c/span\u003e\n  @echo \u003cspan class=\"hljs-string\"\u003e\"Starting webserver in current directory\"\u003c/span\u003e\n  python3 -m http.server $WEBSERVER_PORT\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen you run \u003ccode\u003ejust http\u003c/code\u003e it'll launch the http server on port 9000.  One important line\nin this file is \u003ccode\u003eset dotenv-load\u003c/code\u003e, it will not load the \u003ccode\u003e.env\u003c/code\u003e file without you telling it to.\u003c/p\u003e\n\u003ch2\u003eDon't use language specific scripts!\u003c/h2\u003e\n\u003cp\u003eI'n not a fan of language specific command runners like \u003ccode\u003epackage.json\u003c/code\u003e in the node community.\u003c/p\u003e\n\u003cp\u003eIt always frustrates me when I start working on a project that heavily uses \u003ccode\u003escripts\u003c/code\u003e in their\npackage.json instead of using a real command runner. \u003ccode\u003ejson\u003c/code\u003e is not a great format for writing\ndiscoverable CLI commands. For example if you wanted to write a \u003ccode\u003enext.js\u003c/code\u003e build script:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e    \u003cspan class=\"hljs-attr\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"predeploy\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"yarn build \u0026#x26;\u0026#x26; yarn export \u0026#x26;\u0026#x26; touch dist/.nojekyll \u0026#x26;\u0026#x26; echo sontek.net \u003e dist/CNAME\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"gh-pages -d dist -t true\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"next build\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"export\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"next export -o dist/\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCombining all those commands is really messy and not easily understandable through \u003ccode\u003eyarn run\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ yarn run\nyarn run v1.22.17\ninfo Commands available from binary scripts: autoprefixer, browserslist, css-blank-pseudo, css-has-pseudo, css-prefers-color-scheme, cssesc, esparse, esvalidate, extract-zip, gh-pages, gh-pages-clean, js-yaml, loose-envify, nanoid, next, prettier, resolve, rimraf, semver, svgo, uvu\ninfo Project commands\n   - build\n      next build\n   - deploy\n      gh-pages -d dist -t \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n   - \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e\n      next \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e -o dist/\n   - predeploy\n      yarn build \u0026#x26;\u0026#x26; yarn \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e \u0026#x26;\u0026#x26; \u003cspan class=\"hljs-built_in\"\u003etouch\u003c/span\u003e dist/.nojekyll \u0026#x26;\u0026#x26; \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e sontek.net \u003e dist/CNAME\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI'd much rather have this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ just\nAvailable recipes:\n    build       \u003cspan class=\"hljs-comment\"\u003e# Build frontend assets\u003c/span\u003e\n    deploy      \u003cspan class=\"hljs-comment\"\u003e# Deploy assets to cloudfront\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e      \u003cspan class=\"hljs-comment\"\u003e# Export to static assets (no SSR)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/casey/just\"\u003eJust\u003c/a\u003e is a wonderful tool for building project specific CLIs without much effort. It is\na great replacement for \u003ccode\u003eMake\u003c/code\u003e if you are using it as a command runner and it has most of the features you'd need.\u003c/p\u003e\n\u003cp\u003eI recommend adding a \u003ccode\u003ejustfile\u003c/code\u003e to your projects today! If you'd like to see a real world example of how to use \u003ccode\u003ejust\u003c/code\u003e,\nyou can check out the one I use to maintain my \u003ca href=\"https://github.com/sontek/homies/blob/master/justfile\"\u003ehome directory\u003c/a\u003e!\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2022/intro_to_just\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2022/intro_to_just\u003c/guid\u003e\n            \u003cpubDate\u003eSat, 26 Feb 2022 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Use asdf to manage Python, NodeJS, GoLang and more!]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=\"https://asdf-vm.com/\"\u003easdf\u003c/a\u003e is a general purpose version manager that\ncan manage versions of most programming language runtimes through a set\nof plugins.\u003c/p\u003e\n\u003cp\u003eWith micro-services being all the rage and the ever changing landscape\nof the development world, it is rare to utilize a single version of\nlanguage runtime. Even when you want to upgrade from one to the other\nyou'll need both usable on your system at the same time.\u003c/p\u003e\n\u003cp\u003eI've used tools like \u003ccode\u003epyenv\u003c/code\u003e and \u003ccode\u003envm\u003c/code\u003e in the past when I needed to change\nversions depending on which project I'm contributing to. But with \u003ccode\u003easdf\u003c/code\u003e\nyou have one tool to rule them all!\u003c/p\u003e\n\u003ch2\u003eGetting Started\u003c/h2\u003e\n\u003cp\u003eThe first thing you need to do when working with \u003ccode\u003easdf\u003c/code\u003e is grab the\nplugins for the languages you are interested in working with. You can list\nwhat plugins are available:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf plugin list all\ngolang                       *https://github.com/kennyp/asdf-golang.git\ngolangci-lint                 https://github.com/hypnoglow/asdf-golangci-lint.git\nnodejs                       *https://github.com/asdf-vm/asdf-nodejs.git\npoetry                       *https://github.com/asdf-community/asdf-poetry.git\npython                       *https://github.com/danhper/asdf-python.git\nyarn                         *https://github.com/twuni/asdf-yarn.git\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn the left will be the name of the plugin and on the right will be the repository\nwhere it lives.  It'll me marked with an asterisk if you already have it installed.\u003c/p\u003e\n\u003cp\u003eTo install a plugin you say \u003ccode\u003easdf plugin add \u0026#x3C;plugin\u003e\u003c/code\u003e to get it installed.  You can\nalso provide the repository where you want it pulled from, for example:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git\n\u003e asdf plugin add python https://github.com/danhper/asdf-python.git\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will not give you any version of those languages, it is only installing the\nplugin that knows how to work with those languages.   You are ready to pull down\nany versions you want at that point:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf install nodejs 14.19.0\n\u003e asdf install python 3.9.10\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce you have the versions installed you will be able to view them like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf list\ngolang\n  1.17.7\nnodejs\n  --\u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e\n  12.22.10\n  14.19.0\n  16.14.0\n  17.5.0\npoetry\n  1.1.13\npython\n  3.9.10\nyarn\n  1.22.17\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eUsing the installed languages\u003c/h2\u003e\n\u003cp\u003eTo activate a specific version of a language you have you have three options:\u003c/p\u003e\n\u003ch3\u003eMake it global\u003c/h3\u003e\n\u003cp\u003eYou can make it global, meaning when you run the tool like \u003ccode\u003epython\u003c/code\u003e it'll use\nthis version for the system:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf global python 3.9.10\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eMake it local\u003c/h3\u003e\n\u003cp\u003eYou can make it local, which means it will generate a file in the current\ndirectory named \u003ccode\u003e.tool-versions\u003c/code\u003e and so whenever you change into a directory\nit will activate the versions defined in there.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e nodejs 12.22.10\n\u003e \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e .tool-versions \nnodejs 12.22.10\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe great thing about this is you can commit that file to git and then anyone\nwho checks out the project and uses \u003ccode\u003easdf\u003c/code\u003e will have the same versions activated!\u003c/p\u003e\n\u003ch3\u003eTemporary\u003c/h3\u003e\n\u003cp\u003eIf you want to activate a version of a language temporarily you can swap to it\nfor the current shell:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf shell golang 1.17.7\n\u003e \u003cspan class=\"hljs-built_in\"\u003eenv\u003c/span\u003e|grep -i ASDF\nASDF_GOLANG_VERSION=1.17.7\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt sets an environment variable that will have preference over the file. If you\never wonder what versions a directory is using you can run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003e asdf current\ngolang          ______          No version \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e. Run \u003cspan class=\"hljs-string\"\u003e\"asdf \u0026#x3C;global|shell|local\u003e golang \u0026#x3C;version\u003e\"\u003c/span\u003e\nnodejs          12.22.10        .tool-versions\npoetry          ______          No version \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e. Run \u003cspan class=\"hljs-string\"\u003e\"asdf \u0026#x3C;global|shell|local\u003e poetry \u0026#x3C;version\u003e\"\u003c/span\u003e\npython          3.9.10          .tool-versions\nyarn            1.22.17         .tool-versions\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://asdf-vm.com/\"\u003easdf\u003c/a\u003e  is an AWESOME tool to utilize if you find yourself using many\ndifferent languages or many different versions of the same language. You should check it out\nand see if it can improve your workflow.\u003c/p\u003e\n\u003cp\u003eI made a video of me using the tool here:\u003c/p\u003e\n\u003ciframe width=\"854\" height=\"480\" src=\"https://www.youtube.com/embed/RTaqWRj-6Lg\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen\u003e\u003c/iframe\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/2022/intro_to_asdf\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/2022/intro_to_asdf\u003c/guid\u003e\n            \u003cpubDate\u003eFri, 18 Feb 2022 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Preparing custom images for OpenStack]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eThis article will show you how to use libvirt to create base images that\ncan be uploaded to OpenStack.\u003c/p\u003e\n\u003ch1\u003eWhy would you want to do this?\u003c/h1\u003e\n\u003cp\u003eLinux distributions like Fedora and Ubuntu already ship \"cloud\" images\nand most providers also have their own custom images for you to use, but\nI find it much more comforting to have full control of the software that\nis installed and I like the ability to easily apply new security patches\nto base images.\u003c/p\u003e\n\u003cp\u003eI wouldn't use images to replace config management (CM) with something\nlike \u003ca href=\"http://www.saltstack.com/\"\u003eSalt\u003c/a\u003e or\n\u003ca href=\"http://www.ansible.com/\"\u003eAnsible\u003c/a\u003e but they are nice to give sane system\ndefaults in things like \u003ccode\u003egrub.conf\u003c/code\u003e, \u003ccode\u003esysctl.conf\u003c/code\u003e, and shipping a Chef\nor Salt agent so that your CM engine can communicate with your server\nright away.\u003c/p\u003e\n\u003ch1\u003eSetting up your environment\u003c/h1\u003e\n\u003cp\u003eThe first thing you need to do is get a minimal install disk for the\nLinux distribution you want to use. I prefer using Fedora netinst disks\nbut another popular option is Ubuntu Server.\u003c/p\u003e\n\u003cp\u003eTo get the latest Fedora here, you can choose \"netinst\" under Direct\nDownloads: \u003ca href=\"http://fedoraproject.org/en/get-fedora-all\"\u003ehttp://fedoraproject.org/en/get-fedora-all\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eTo get the latest Ubuntu you can go here:\n\u003ca href=\"http://www.ubuntu.com/download/server\"\u003ehttp://www.ubuntu.com/download/server\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eOnce you have acquired your distribution of choice you just need to\nverify that you have \u003ccode\u003evirt-install\u003c/code\u003e and \u003ccode\u003evirt-viewer\u003c/code\u003e installed:\u003c/p\u003e\n\u003cp\u003eFedora:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eyum install virt-install virt-viewer\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUbuntu:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eapt-get install virtinst virt-viewer\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf you prefer a graphical user interface, you may use \u003ccode\u003evirt-manager\u003c/code\u003e\ninstead, but I try to keep everything in the CLI; that way it can be\nrepeated easily.\u003c/p\u003e\n\u003ch1\u003ePreparing your disk\u003c/h1\u003e\n\u003cp\u003eNow that you have a base ISO and the tools necessary, let's get started\nby creating a disk to install the virtual server into. Resizing an image\nisn't an impossible task but it is much easier to choose a reasonably\nsized disk for the purpose it will be used for.\u003c/p\u003e\n\u003cp\u003eI primarily use 8 GB disks -- that way we can fit all the system\ncomponents required as well as our own web applications. Any large files\nshould be placed in a SAN or something like Dreamhost's dreamobjects.\u003c/p\u003e\n\u003cp\u003eThe other big decision you must make upfront is what disk format you\nwant to use -- the trade-off is disk space vs performance. The two\nprimary formats are qcow2 (QEMU Copy on Write) and Raw. qcow2 is great\nif you have limited disk space and don't want to allocate the full 8 GB\nup front. Raw is preferred if you want the best performance.\u003c/p\u003e\n\u003cp\u003eIf you choose qcow2, you'll also need to make sure you have \u003ccode\u003eqemu-img\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003eFedora:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eyum install qemu-img\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUbuntu:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eapt-get install qemu-utils\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a raw disk:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efallocate -l 8192M server.img\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a qcow2 disk:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eqemu-img create -f qcow2 server.qcow2 8G\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eInstalling your distribution onto the disk\u003c/h1\u003e\n\u003cp\u003eWe will use the \u003ccode\u003evirt-install\u003c/code\u003e command to get the distribution installed\nonto the disk image.\u003c/p\u003e\n\u003cp\u003eTo install Fedora on a qcow2 disk image:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003evirt-install --name base_server --ram 1024 --cdrom=./Fedora-20-x86_64-netinst.iso \\\n--disk path=./server.qcow2,format=qcow2\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTo install Ubuntu Server on a raw disk image:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003evirt-install --name base_server --ram 1024 --cdrom=./ubuntu-12.04.4-server-amd64.iso \\\n--disk path=./server.img,format=raw\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should follow the standard install steps that you normally would\nwhen setting up your distribution. But here are some tips for each:\u003c/p\u003e\n\u003cp\u003eFedora:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eChoose minimal install -- by default it selects \"GNOME\".\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eUbuntu:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBe sure to select OpenSSH server -- it won't install it by\ndefault.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOn Ubuntu 12.04, there is a bug that makes it hang after running\n\u003ccode\u003efsck\u003c/code\u003e. You will need to edit grub to get it to boot, hit _\u003ca href=\"\"\u003ee\u003c/a\u003e at\nthe boot prompt and add \"nomodeset\" on the linux line. You will\nknow that you need to do this if your boot hangs on fsck:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efsck from util-linux 2.20.1\n/dev/mapper/ubuntu--vg-root: clean, 57106/441504 files, 286779/1764352 blocks\n/dev/sda1: clean, 230/62248 files, 39833/248832 blocks\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003ePreparing image for openstack\u003c/h1\u003e\n\u003cp\u003eTo prepare a virtual machine for the cloud, you will need to install the\n\u003ccode\u003ecloud-init\u003c/code\u003e package, which allows the cloud providers to inject certain\nsystem settings when creating servers based on the image. These are\nthings like hostname and ssh keys.\u003c/p\u003e\n\u003cp\u003eOn Fedora:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eyum install cloud-init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn Ubuntu:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eapt-get install cloud-init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen you need to just configure \u003ccode\u003ecloud-init\u003c/code\u003e by editing\n\u003ccode\u003e/etc/cloud/cloud.cfg\u003c/code\u003e and update the \u003ccode\u003edatasources_list\u003c/code\u003e section to\ninclude EC2. OpenStack uses EC2 metadata for \u003ccode\u003ecloud-init\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eYou should also verify the user setting in this same config and define\nthe user you plan to use, it will be where the \u003ccode\u003eauthorized_keys\u003c/code\u003e file is\nsetup for when the cloud provider injects your SSH key into the server.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ecloud-init\u003c/code\u003e will not create the user for you, it will just assign the\nSSH keypair and reset the password. So make sure the user defined in\n\u003ccode\u003ecloud.cfg\u003c/code\u003e is also created on the system.\u003c/p\u003e\n\u003cp\u003eOnce you have your \u003ccode\u003ecloud-init\u003c/code\u003e settings the way you want them, just\nshutdown and run the \u003ccode\u003evirt-sysprep\u003c/code\u003e command.\u003c/p\u003e\n\u003cp\u003eOn the guest machine:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eshutdown -h now\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn the host machine:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003evirt-sysprep -d base_server\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eUploading your image to OpenStack\u003c/h1\u003e\n\u003cp\u003eUsing the glance API it is very straightforward to upload the image to\nOpenStack. Just run the following command:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eglance image-create --name base_server --disk-format=qcow2 \\\n--container-format=bare --is-public=True --file server.qcow2 --progress\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce the image upload completes you will be able to use it immediately\nwithin nova. You can reference it by name or by the id from [glance\nimage-list]{.title-ref}.\u003c/p\u003e\n\u003cp\u003eTo create your first instance from the image:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enova boot --flavor m1.tiny --image base_server --key-name devops \\\n--security-groups free_for_all test_server\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eObviously the security groups, key name, and flavors are based on your\ninstallation of OpenStack but can all easily be queried from the nova\nAPI:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enova flavor-list\nnova secgroup-list\nnova keypair-list\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd you are done! You'll be able to re-use your new image as a base for\nall new instances you spin up in openstack!\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/old/preparing_cloud_images_with_libvirt\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/old/preparing_cloud_images_with_libvirt\u003c/guid\u003e\n            \u003cpubDate\u003eSun, 03 Aug 2014 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Writing tests for Pyramid and SQLAlchemy]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eTL;DR: Putting it all together, the full code can be found here:\n\u003ca href=\"https://gist.github.com/1420255\"\u003ehttps://gist.github.com/1420255\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eIntro\u003c/h1\u003e\n\u003cp\u003ePyramid's documentation doesn't cover the preferred way to test with\nSQLAlchemy, because Pyramid tries to stay out of your way and allow you\nto make your own decisions. However, I feel i'ts necessary to document\nwhat I think is the best way to test.\u003c/p\u003e\n\u003cp\u003eWhen I first started writing tests with SQLAlchemy I found plenty of\nexamples of how to to get started by doing something like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e db \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e session \u003cspan class=\"hljs-comment\"\u003e# probably a contextbound sessionmaker\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e db \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e model\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e create_engine\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetup\u003c/span\u003e():\n    engine = create_engine(\u003cspan class=\"hljs-string\"\u003e'sqlite:///test.db'\u003c/span\u003e)\n    session.configure(bind=engine)\n    model.metadata.create_all(engine)\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eteardown\u003c/span\u003e():\n    model.metadata.drop_all(engine)\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_something\u003c/span\u003e():\n    \u003cspan class=\"hljs-keyword\"\u003epass\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI have seen this done so many times, but I feel there is so much wrong\nwith it! So let's establish some base rules when testing:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eAlways test your system like it would be used in production.\nSQLite does not enforce the same rules or have the same features\nas Postgres or MySQL and will allow tests to pass that would\notherwise fail in production.\u003c/li\u003e\n\u003cli\u003eTests should be fast! You should be writing tests for all your\ncode. This is the main reason people do test against SQLite, but\nwe can't violate rule number one. We have to make sure tests\nagainst Postgres are fast, so we shouldn't be tearing down and\nrecreating tables for every single test.\u003c/li\u003e\n\u003cli\u003eYou should be able to execute in parallel to speed up when you\nhave thousands of tests. Dropping and creating tables per test\nwould not work in a parallel environment.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFor an example, I have a project with 600+ tests and it would take 2 and\nhalf minutes to execute running against SQLite. But when we swapped our\ntest configuration to execute against Postgres, testing took well over\nan hour. That is unacceptable!\u003c/p\u003e\n\u003cp\u003eBut running them in parallel will give us a huge speed up. Check out the\nresults of the tests running in single proc mode vs using all 4 cores:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e$ \u003cspan class=\"hljs-attr\"\u003epy.test\u003c/span\u003e\n======= 616 passed in 143.67 \u003cspan class=\"hljs-attr\"\u003eseconds\u003c/span\u003e =======\n\n$ py.test \u003cspan class=\"hljs-attr\"\u003e-n4\u003c/span\u003e\n======= 616 passed in 68.12 \u003cspan class=\"hljs-attr\"\u003eseconds\u003c/span\u003e =======\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eThe right way\u003c/h1\u003e\n\u003cp\u003eSo what is the proper way to setup your tests? You should initialize the\ndatabase when you start your test runner and then use transactions to\nrollback any data changes your tests made. This allows you to keep a\nclean database for each test in a very efficient way.\u003c/p\u003e\n\u003cp\u003eIn py.test, you just have to create a file called conftest.py that looks\nsimilar to:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e os\n\nROOT_PATH = os.path.dirname(__file__)\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epytest_sessionstart\u003c/span\u003e():\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e py.test \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e config\n\n    \u003cspan class=\"hljs-comment\"\u003e# Only run database setup on master (in case of xdist/multiproc mode)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ehasattr\u003c/span\u003e(config, \u003cspan class=\"hljs-string\"\u003e'slaveinput'\u003c/span\u003e):\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e initialize_sql\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e pyramid.config \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Configurator\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e paste.deploy.loadwsgi \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e appconfig\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e engine_from_config\n        \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e os\n\n        ROOT_PATH = os.path.dirname(__file__)\n        settings = appconfig(\u003cspan class=\"hljs-string\"\u003e'config:'\u003c/span\u003e + os.path.join(ROOT_PATH, \u003cspan class=\"hljs-string\"\u003e'test.ini'\u003c/span\u003e))\n        engine = engine_from_config(settings, prefix=\u003cspan class=\"hljs-string\"\u003e'sqlalchemy.'\u003c/span\u003e)\n\n        \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Creating the tables on the test database %s'\u003c/span\u003e % engine\n\n        config = Configurator(settings=settings)\n        initialize_sql(settings, config)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWith py.test, when you are running in parallel mode, the\npytest_sessionstart hook gets fired for each node, so we check that we\nare on the master node. Then we just grab our test.ini configuration\nfile and execute the initialize_sql function.\u003c/p\u003e\n\u003cp\u003eNow that you have your initial test configuration finished, you have to\ndefine a base test class that does the transaction management in setUp\nand teardown.\u003c/p\u003e\n\u003cp\u003eFirst, lets setup the Base testing class what will manage our\ntransactions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e unittest\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e pyramid \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e testing\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e paste.deploy.loadwsgi \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e appconfig\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e webtest \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e TestApp\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e mock \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Mock\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e engine_from_config\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy.orm \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sessionmaker\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e app.db \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Session\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e app.db \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Entity  \u003cspan class=\"hljs-comment\"\u003e# base declarative object\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e app \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e main\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e os\nhere = os.path.dirname(__file__)\nsettings = appconfig(\u003cspan class=\"hljs-string\"\u003e'config:'\u003c/span\u003e + os.path.join(here, \u003cspan class=\"hljs-string\"\u003e'../../'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'test.ini'\u003c/span\u003e))\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBaseTestCase\u003c/span\u003e(unittest.TestCase):\n\u003cspan class=\"hljs-meta\"\u003e    @classmethod\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetUpClass\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecls\u003c/span\u003e):\n        cls.engine = engine_from_config(settings, prefix=\u003cspan class=\"hljs-string\"\u003e'sqlalchemy.'\u003c/span\u003e)\n        cls.Session = sessionmaker()\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetUp\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        connection = self.engine.connect()\n\n        \u003cspan class=\"hljs-comment\"\u003e# begin a non-ORM transaction\u003c/span\u003e\n        self.trans = connection.begin()\n\n        \u003cspan class=\"hljs-comment\"\u003e# bind an individual Session to the connection\u003c/span\u003e\n        Session.configure(bind=connection)\n        self.session = self.Session(bind=connection)\n        Entity.session = self.session\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etearDown\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-comment\"\u003e# rollback - everything that happened with the\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# Session above (including calls to commit())\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# is rolled back.\u003c/span\u003e\n        testing.tearDown()\n        self.trans.rollback()\n        self.session.close()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis base test case will wrap all your sessions in an external\ntransaction so that you still have the ability to call flush/commit/etc\nand it will still be able to rollback any data changes you make.\u003c/p\u003e\n\u003ch1\u003eUnit Tests\u003c/h1\u003e\n\u003cp\u003eNow there are a few different types of tests you will want to run.\nFirst, you will want to do unit tests, which are small tests that only\ntest 1 thing at a time. This means you will skip the routes, templates,\netc. So let's setup our Unit Test Base class:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUnitTestBase\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eBaseTestCase\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetUp\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        self.config = testing.setUp(request=testing.DummyRequest())\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e(UnitTestBase, self).setUp()\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eget_csrf_request\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, post=\u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e):\n        csrf = \u003cspan class=\"hljs-string\"\u003e'abc'\u003c/span\u003e\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eu'csrf_token'\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e post.keys():\n            post.update({\n                \u003cspan class=\"hljs-string\"\u003e'csrf_token'\u003c/span\u003e: csrf\n            })\n\n        request = testing.DummyRequest(post)\n\n        request.session = Mock()\n        csrf_token = Mock()\n        csrf_token.return_value = csrf\n\n        request.session.get_csrf_token = csrf_token\n\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e request\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe built in a utility function to help us test requests that require a\ncsrf token as well. Here is how we would use this class:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTestViews\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eUnitTestBase\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_login_fails_empty\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\" Make sure we can't login with empty credentials\"\"\"\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e app.accounts.views \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e LoginView\n        self.config.add_route(\u003cspan class=\"hljs-string\"\u003e'index'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e)\n        self.config.add_route(\u003cspan class=\"hljs-string\"\u003e'dashboard'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e)\n\n        request = testing.DummyRequest(post={\n            \u003cspan class=\"hljs-string\"\u003e'submit'\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e,\n        })\n\n        view = LoginView(request)\n        response = view.post()\n        errors = response[\u003cspan class=\"hljs-string\"\u003e'errors'\u003c/span\u003e]\n\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].node.name == \u003cspan class=\"hljs-string\"\u003eu'csrf_token'\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].msg == \u003cspan class=\"hljs-string\"\u003eu'Required'\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e].node.name == \u003cspan class=\"hljs-string\"\u003eu'Username'\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e].msg == \u003cspan class=\"hljs-string\"\u003eu'Required'\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e].node.name == \u003cspan class=\"hljs-string\"\u003eu'Password'\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e errors[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e].msg == \u003cspan class=\"hljs-string\"\u003eu'Required'\u003c/span\u003e\n\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_login_succeeds\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\" Make sure we can login \"\"\"\u003c/span\u003e\n        admin = User(username=\u003cspan class=\"hljs-string\"\u003e'sontek'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'temp'\u003c/span\u003e, kind=\u003cspan class=\"hljs-string\"\u003eu'admin'\u003c/span\u003e)\n        admin.activated = \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e\n        self.session.add(admin)\n        self.session.flush()\n\n        \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e app.accounts.views \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e LoginView\n        self.config.add_route(\u003cspan class=\"hljs-string\"\u003e'index'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e)\n        self.config.add_route(\u003cspan class=\"hljs-string\"\u003e'dashboard'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'/dashboard'\u003c/span\u003e)\n\n        request = self.get_csrf_request(post={\n                \u003cspan class=\"hljs-string\"\u003e'submit'\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e'Username'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'sontek'\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e'Password'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'temp'\u003c/span\u003e,\n            })\n\n        view = LoginView(request)\n        response = view.post()\n\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e response.status_int == \u003cspan class=\"hljs-number\"\u003e302\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eIntegration Tests\u003c/h1\u003e\n\u003cp\u003eThe second type of test you will want to write is an integration test.\nThis will integrate with the whole web framework and actually hit the\ndefine routes, render the templates, and actually test the full stack of\nyour application.\u003c/p\u003e\n\u003cp\u003eLuckily this is pretty easy to do with Pyramid using WebTest:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIntegrationTestBase\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eBaseTestCase\u003c/span\u003e):\n\u003cspan class=\"hljs-meta\"\u003e    @classmethod\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetUpClass\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecls\u003c/span\u003e):\n        cls.app = main({}, **settings)\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e(IntegrationTestBase, cls).setUpClass()\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetUp\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        self.app = TestApp(self.app)\n        self.config = testing.setUp()\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e(IntegrationTestBase, self).setUp()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn setUpClass, we run the main function of the applications\n__init__.py that sets up the WSGI application and then we wrap it in\na TestApp that gives us the ability to call get/post on it.\u003c/p\u003e\n\u003cp\u003eHere is an example of it in use:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTestViews\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eIntegrationTestBase\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_get_login\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\" Call the login view, make sure routes are working \"\"\"\u003c/span\u003e\n        res = self.app.get(\u003cspan class=\"hljs-string\"\u003e'/login'\u003c/span\u003e)\n        self.assertEqual(res.status_int, \u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e)\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_empty_login\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\" Empty login fails \"\"\"\u003c/span\u003e\n        res = self.app.post(\u003cspan class=\"hljs-string\"\u003e'/login'\u003c/span\u003e, {\u003cspan class=\"hljs-string\"\u003e'submit'\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e})\n\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"There was a problem with your submission\"\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e res.body\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Required\"\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e res.body\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e res.status_int == \u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etest_valid_login\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\" Call the login view, make sure routes are working \"\"\"\u003c/span\u003e\n        admin = User(username=\u003cspan class=\"hljs-string\"\u003e'sontek'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'temp'\u003c/span\u003e, kind=\u003cspan class=\"hljs-string\"\u003eu'admin'\u003c/span\u003e)\n        admin.activated = \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e\n        self.session.add(admin)\n        self.session.flush()\n\n        res = self.app.get(\u003cspan class=\"hljs-string\"\u003e'/login'\u003c/span\u003e)\n\n        csrf = res.form.fields[\u003cspan class=\"hljs-string\"\u003e'csrf_token'\u003c/span\u003e][\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].value\n\n        res = self.app.post(\u003cspan class=\"hljs-string\"\u003e'/login'\u003c/span\u003e,\n            {\n                \u003cspan class=\"hljs-string\"\u003e'submit'\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e'Username'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'sontek'\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e'Password'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'temp'\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e'csrf_token'\u003c/span\u003e: csrf\n            }\n        )\n\n        \u003cspan class=\"hljs-keyword\"\u003eassert\u003c/span\u003e res.status_int == \u003cspan class=\"hljs-number\"\u003e302\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eProblems with this approach\u003c/h1\u003e\n\u003cp\u003eIf a test causes an error that will prevent the transaction from rolling\nback, such as closing the engine, then this approach will leave your\ndatabase in a state that might cause other tests to fail.\u003c/p\u003e\n\u003cp\u003eIf this happens tracing the root cause could be difficult but you should\nbe able to just look at the first failed test unless you are running the\ntests in parallel.\u003c/p\u003e\n\u003cp\u003eIf you are good about writing and running your tests regularly you\nshould be able to catch individual tests causing issues like this fairly\nquickly.\u003c/p\u003e\n\u003ch1\u003eResources\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html\"\u003ehttp://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction\"\u003ehttp://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eJohn Anderson \u0026#x3C;\u003ca href=\"mailto:sontek@gmail.com\"\u003esontek@gmail.com\u003c/a\u003e\u003e 2011\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/old/writing_tests_for_pyramid_and_sqlalchemy\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/old/writing_tests_for_pyramid_and_sqlalchemy\u003c/guid\u003e\n            \u003cpubDate\u003eThu, 01 Dec 2011 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Turning Vim into a modern Python IDE]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eTL;DR:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003egit \u003cspan class=\"hljs-built_in\"\u003eclone\u003c/span\u003e https://github.com/sontek/dotfiles.git\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e dotfiles\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e./install.sh vim\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eIntro\u003c/h1\u003e\n\u003cp\u003eBack in 2008, I wrote the article \u003ca href=\"http://sontek.net/python-with-a-modular-ide-vim\"\u003ePython with a modular IDE\n(Vim)\u003c/a\u003e. Years later, I\nhave people e-mailing me and commenting daily asking for more\ninformation, even though most of the information in it is outdated. Here\nis the modern way to work with Python and Vim to achieve the perfect\nenvironment.\u003c/p\u003e\n\u003cp\u003eBecause one of the most important parts about a development environment\nis the ability to easily reproduce across machines, we are going to\nstore our vim configuration in git:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e ~/.vim/\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e ~/.vim/{\u003cspan class=\"hljs-built_in\"\u003eautoload\u003c/span\u003e,bundle}\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e ~/.vim/\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003egit init\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe purpose of the autoload directory is to automatically load the vim\nplugin \u003ca href=\"https://github.com/tpope/vim-pathogen\"\u003ePathogen\u003c/a\u003e, which we'll\nthen use to load all other plugins that are located in the bundle\ndirectory. So download pathogen and put it in your autoload folder.\u003c/p\u003e\n\u003cp\u003eYou'll need to add the following to your ~/.vimrc so that pathogen\nwill be loaded properly. Filetype detection must be off when you run the\ncommands so its best to execute them first:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-r\"\u003efiletype off\n\u003cspan class=\"hljs-built_in\"\u003ecall\u003c/span\u003e pathogen\u003cspan class=\"hljs-comment\"\u003e#runtime_append_all_bundles()\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003ecall\u003c/span\u003e pathogen\u003cspan class=\"hljs-comment\"\u003e#helptags()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow lets add all of the vim plugins we plan on using as submodules to\nour git repository:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003egit submodule add http://github.com/tpope/vim-fugitive.git bundle/fugitive\ngit submodule add https://github.com/msanders/snipmate.vim.git bundle/snipmate\ngit submodule add https://github.com/tpope/vim-surround.git bundle/surround\ngit submodule add https://github.com/tpope/vim-git.git bundle/git\ngit submodule add https://github.com/ervandew/supertab.git bundle/supertab\ngit submodule add https://github.com/sontek/minibufexpl.vim.git bundle/minibufexpl\ngit submodule add https://github.com/wincent/Command-T.git bundle/command-t\ngit submodule add https://github.com/mitechie/pyflakes-pathogen.git\ngit submodule add https://github.com/mileszs/ack.vim.git bundle/ack\ngit submodule add https://github.com/sjl/gundo.vim.git bundle/gundo\ngit submodule add https://github.com/fs111/pydoc.vim.git bundle/pydoc\ngit submodule add https://github.com/vim-scripts/pep8.git bundle/pep8\ngit submodule add https://github.com/alfredodeza/pytest.vim.git bundle/py.test\ngit submodule add https://github.com/reinh/vim-makegreen bundle/makegreen\ngit submodule add https://github.com/vim-scripts/TaskList.vim.git bundle/tasklist\ngit submodule add https://github.com/vim-scripts/The-NERD-tree.git bundle/nerdtree\ngit submodule add https://github.com/sontek/rope-vim.git bundle/ropevim\ngit submodule init\ngit submodule update\ngit submodule foreach git submodule init\ngit submodule foreach git submodule update\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThats it! Now that we've got our vim configuration in git!\u003c/p\u003e\n\u003cp\u003eNow lets look at how to use each of these plugins to improve the power\nof vim:\u003c/p\u003e\n\u003ch1\u003eBasic Editing and Debugging\u003c/h1\u003e\n\u003ch2\u003eCode Folding\u003c/h2\u003e\n\u003cp\u003eLets first enable code folding. This makes it a lot easier to organize\nyour code and hide portions that you aren't interested in working on.\nThis is quite easy for Python, since whitespace is required.\u003c/p\u003e\n\u003cp\u003eIn your ~/.vimrc just add:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eset \u003cspan class=\"hljs-attr\"\u003efoldmethod\u003c/span\u003e=indent\nset \u003cspan class=\"hljs-attr\"\u003efoldlevel\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e99\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen you will be able to be inside a method and type 'za' to open and\nclose a fold.\u003c/p\u003e\n\u003ch2\u003eWindow Splits\u003c/h2\u003e\n\u003cp\u003eSometimes code folding isn't enough; you may need to start opening up\nmultiple windows and working on multiple files at once or different\nlocations within the same file. To do this in vim, you can use these\nshortcuts:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eVertical Split :\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCtrl+w\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ev\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eHorizontal Split:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCtrl+w\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003es\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eClose current windows:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCtrl+w\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eq\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI also like to bind Ctrl+\u0026#x3C;movement\u003e keys to move around the windows,\ninstead of using Ctrl+w + \u0026#x3C;movement\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003emap \u0026#x3C;c-j\u003e \u0026#x3C;c-w\u003ej\nmap \u0026#x3C;c-k\u003e \u0026#x3C;c-w\u003ek\nmap \u0026#x3C;c-l\u003e \u0026#x3C;c-w\u003el\nmap \u0026#x3C;c-h\u003e \u0026#x3C;c-w\u003eh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/krj0l.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2\u003eSnippets\u003c/h2\u003e\n\u003cp\u003eThe next tweak that really speeds up development is using snipmate.\nWe've already included it in our bundle/ folder so its already enabled.\nTry opening up a python file and typing 'def\u0026#x3C;tab\u003e'. It should stub\nout a method definition for you and allow you to tab through and fill\nout the arguments, doc string, etc.\u003c/p\u003e\n\u003cp\u003eI also like to create my own snippets folder to put in some custom\nsnippets:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e ~/.vim/snippets\u003c/span\u003e\n\u003cspan class=\"hljs-meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"bash\"\u003evim ~/.vim/snippets/python.snippets\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePut this in the file:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003esnippet pdb\n    \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e pdb; pdb.\u003cspan class=\"hljs-built_in\"\u003eset_trace\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow you can type pdb\u0026#x3C;tab\u003e and it'll insert your breakpoint!\u003c/p\u003e\n\u003ch2\u003eTask lists\u003c/h2\u003e\n\u003cp\u003eAnother really useful thing is to mark some of your code as TODO or\nFIXME! I know we all like to think we write perfect code, but sometimes\nyou just have to settle and leave a note for yourself to come back\nlater. One of the plugins we included was the tasklist plugin that will\nallow us to search all open buffers for things to fix. Just add a\nmapping to open it in ~/.vimrc:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003emap \u0026#x3C;leader\u003etd \u0026#x3C;Plug\u003eTaskList\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow you can hit \u0026#x3C;leader\u003etd to open your task list and hit 'q' to\nclose it. You can also hit enter on the task to jump to the buffer and\nline that it is placed on.\u003c/p\u003e\n\u003ch2\u003eRevision History\u003c/h2\u003e\n\u003cp\u003eThe final basic editing tweak I suggest everyone start utilizing is the\nGundo plugin. It'll allow you to view diff's of every save on a file\nyou've made and allow you to quickly revert back and forth:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/2NrPS.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cp\u003eJust bind a key in your .vimrc to toggle the Gundo window:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ruby\"\u003emap \u0026#x3C;leader\u003eg \u003cspan class=\"hljs-symbol\"\u003e:GundoToggle\u0026#x3C;CR\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eSyntax Highlighting and Validation\u003c/h1\u003e\n\u003cp\u003eSimply enable syntax highlighting in your ~/.vimrc:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003esyntax \u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e                           \u003cspan class=\"hljs-string\"\u003e\" syntax highlighing\nfiletype on                          \"\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e detect filetypes\nfiletype plugin indent \u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e    \u003cspan class=\"hljs-string\"\u003e\" enable loading indent file for filetype\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBecause we enabled pyflakes when we added it as a submodule in\n~/.vim/bundle, it will notify you about unused imports and invalid\nsyntax. It will save you a lot of time saving and running just to find\nout you missed a colon. I like to tell it not use the quickfix window:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003elet g:\u003cspan class=\"hljs-attr\"\u003epyflakes_use_quickfix\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/ZfjFe.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2\u003ePep8\u003c/h2\u003e\n\u003cp\u003eThe final plugin that really helps validate your code is the pep8\nplugin, it'll make sure your code is consistent across all projects.\nAdd a key mapping to your ~/.vimrc and then you'll be able to jump to\neach of the pep8 violations in the quickfix window:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003elet g:\u003cspan class=\"hljs-attr\"\u003epep8_map\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'\u0026#x3C;leader\u003e8'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/VU9AB.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch1\u003eTab Completion and Documentation\u003c/h1\u003e\n\u003cp\u003eVim has many different code completion options. We are going to use the\nSuperTab plugin to check the context of the code you are working on and\nchoose the best for the situation. We've already enabled the SuperTab\nplugin in the bundle/ folder, so we just have to configure it to be\ncontext sensitive and to enable omni code completion in your ~/.vimrc:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eau FileType python set \u003cspan class=\"hljs-attr\"\u003eomnifunc\u003c/span\u003e=pythoncomplete\u003cspan class=\"hljs-comment\"\u003e#Complete\u003c/span\u003e\nlet g:\u003cspan class=\"hljs-attr\"\u003eSuperTabDefaultCompletionType\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"context\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we just enable the menu and pydoc preview to get the most useful\ninformation out of the code completion:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eset \u003cspan class=\"hljs-attr\"\u003ecompleteopt\u003c/span\u003e=menuone,longest,preview\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/g4lxP.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cp\u003eWe also enabled the pydoc plugin at the beginning with all the\nsubmodules; that gives us the ability to hit \u0026#x3C;leader\u003epw when our\ncursor is on a module and have a new window open with the whole\ndocumentation page for it.\u003c/p\u003e\n\u003ch1\u003eCode Navigation\u003c/h1\u003e\n\u003ch2\u003eBuffers\u003c/h2\u003e\n\u003cp\u003eThe most important part about navigating code within vim, is to\ncompletely understand how to use buffers. There is no reason to use\ntabs. Open files with :e \u0026#x3C;filename\u003e to place in a buffer. We already\ninstalled the minibufexpl plugin, so you will already visually see every\nbuffer opened. You can also get a list of them doing :buffers.\u003c/p\u003e\n\u003cp\u003eYou can switch between the buffers using b\u0026#x3C;number\u003e, such as :b1 for\nthe first buffer. You can also use its name to match, so you can type :b\nmod\u0026#x3C;tab\u003e to autocomplete opening the models.py buffer. You need to\nmake sure you are using the minibufexpl from my github since it has\npatches that make it much better to work with.\u003c/p\u003e\n\u003cp\u003eTo close a buffer you use :bd or :bw.\u003c/p\u003e\n\u003ch2\u003eFuzzy Text File Search\u003c/h2\u003e\n\u003cp\u003eTo make finding and opening files within your project even easier, we\nare going to use the command-t plugin. It does have some parts that need\nto be compiled, so its not already installed by adding it as a\nsubmodule. Go to your ~/.vim/bundle/command-t folder and run 'rake\nmake'. Yes you need ruby installed. By default, command-t is bound to\n\u0026#x3C;leader\u003et. This will use fuzzy text matching to find any file in your\nproject.\u003c/p\u003e\n\u003cp\u003eIt also supports searching only through opened buffers, instead of files\nusing \u0026#x3C;leader\u003eb.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/hUcSl.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2\u003eFile Browser\u003c/h2\u003e\n\u003cp\u003eNERD Tree is a project file browser. I must admit I used this heavily\nback when I was migrating from Visual Studio and used to the Solution\nExplorer, but I rarely use it anymore. Command-T is usually all you'll\nneed. It is useful when you are getting to know a new codebase for the\nfirst time though. Lets bind a shortcut key for opening it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ruby\"\u003emap \u0026#x3C;leader\u003en \u003cspan class=\"hljs-symbol\"\u003e:NERDTreeToggle\u0026#x3C;CR\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/R4ZzQ.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2\u003eRefactoring and Go to definition\u003c/h2\u003e\n\u003cp\u003eRopevim is also a great tool that will allow you to navigate around your\ncode. It supports automatically inserting import statements, goto\ndefinition, refactoring, and code completion. You'll really want to\nread up on everything it does, but the two big things I use it for is to\njump to function or class definitions quickly and to rename things\n(including all their references).\u003c/p\u003e\n\u003cp\u003eFor instance, if you are using django and you place your cursor over the\nclass models.Model you reference and then called :RopeGotoDefintion, it\nwould jump you straight to the django library to that class definition.\nWe already have it installed in our bundles, so we bind it to a key to\nuse it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ruby\"\u003emap \u0026#x3C;leader\u003ej \u003cspan class=\"hljs-symbol\"\u003e:RopeGotoDefinition\u0026#x3C;CR\u003e\u003c/span\u003e\nmap \u0026#x3C;leader\u003er \u003cspan class=\"hljs-symbol\"\u003e:RopeRename\u0026#x3C;CR\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eSearching\u003c/h2\u003e\n\u003cp\u003eThe final tool that really speeds up navigating your code is the Ack\nplugin. Ack is similar to grep, but much better in my opinion. You can\nfuzzy text search for anything in your code (variable name, class,\nmethod, etc) and it'll give you a list of files and line numbers where\nthey are defined so you can quickly cycle through them. Just bind the\nsearching to a key:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-php-template\"\u003e\u003cspan class=\"xml\"\u003enmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eleader\u003c/span\u003e\u003e\u003c/span\u003ea \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Ack!\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe use ! at the end of it so it doesn't open the first result\nautomatically.\u003c/p\u003e\n\u003ch1\u003eIntegration with Git\u003c/h1\u003e\n\u003cp\u003eWe installed 2 plugins, git.vim and fugitive, that give us all the\nintegration we need. Git.vim will provide us syntax highlighting for git\nconfiguration files; fugitive provides a great interface for interacting\nwith git including getting diffs, status updates, committing, and moving\nfiles.\u003c/p\u003e\n\u003cp\u003eFugitive also allows you to view what branch you are working in directly\nfrom vim. Add this to your statusline in ~/.vimrc:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta prompt_\"\u003e%\u003c/span\u003e\u003cspan class=\"bash\"\u003e{fugitive\u003cspan class=\"hljs-comment\"\u003e#statusline()}\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe big commands you need to know:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eGblame\u003c/strong\u003e: This allows you to view a line by line comparison of who\nthe last person to touch that line of code is.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGwrite\u003c/strong\u003e: This will stage your file for commit, basically doing\ngit add \u0026#x3C;filename\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGread\u003c/strong\u003e: This will basically run a git checkout \u0026#x3C;filename\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGcommit\u003c/strong\u003e: This will just run git commit. Since its in a vim\nbuffer, you can use keyword completion (Ctrl-N), like\ntest_all\u0026#x3C;Ctrl-N\u003e to find the method name in your buffer and\ncomplete it for the commit message. You can also use + and - on the\nfilenames in the message to stage/unstage them for the commit.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/NuRRj.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch1\u003eTest Integration\u003c/h1\u003e\n\u003ch2\u003edjango nose\u003c/h2\u003e\n\u003cp\u003eTest runner integration really depends on the testing library you are\nusing and what type of tests you are running but we included a great\ngeneric plugin called MakeGreen that executes off of vim's makeprg\nvariable. So for instance, if you are using django with django-nose you\ncould define a shortcut key in your ~/.vimrc like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003emap \u0026#x3C;leader\u003edt :set makeprg=python\\ manage.py\\ test\\|:call \u003cspan class=\"hljs-built_in\"\u003eMakeGreen\u003c/span\u003e()\u0026#x3C;CR\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will just give you a green bar at the bottom of vim if your test\npassed or a red bar with the message of the failed test if it doesn't.\nVery simple.\u003c/p\u003e\n\u003ch2\u003epy.test\u003c/h2\u003e\n\u003cp\u003eI also included the py.test vim plugin for those who prefer it. This\nplugin has a lot more functionality including executing individual tests\nby class, file, or method. You can also cycle through the individual\nassertion errors. I have the following bindings:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-php-template\"\u003e\u003cspan class=\"xml\"\u003e\" Execute the tests\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003etf \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest file\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003etc \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest class\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003etm \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest method\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\n\" cycle through test errors\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003etn \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest next\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003etp \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest previous\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\nnmap \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003esilent\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eLeader\u003c/span\u003e\u003e\u003c/span\u003ete \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eEsc\u003c/span\u003e\u003e\u003c/span\u003e:Pytest error\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eCR\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/RAE7v.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch1\u003eVirtualenv\u003c/h1\u003e\n\u003cp\u003eVim doesn't realize that you are in a virtualenv so it wont give you\ncode completion for libraries only installed there. Add the following\nscript to your ~/.vimrc to fix it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\" Add the virtualenv's site-packages to vim path\npy \u0026#x3C;\u0026#x3C; EOF\nimport os.path\nimport sys\nimport vim\nif 'VIRTUAL_ENV' in os.environ:\n    \u003cspan class=\"hljs-attr\"\u003eproject_base_dir\u003c/span\u003e = os.environ[\u003cspan class=\"hljs-string\"\u003e'VIRTUAL_ENV'\u003c/span\u003e]\n    sys.path.insert(0, project_base_dir)\n    \u003cspan class=\"hljs-attr\"\u003eactivate_this\u003c/span\u003e = os.path.join(project_base_dir, \u003cspan class=\"hljs-string\"\u003e'bin/activate_this.py'\u003c/span\u003e)\n    execfile(activate_this, dict(\u003cspan class=\"hljs-attr\"\u003e__file__\u003c/span\u003e=activate_this))\nEOF\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eDjango\u003c/h1\u003e\n\u003cp\u003eThe only true django tweak I make is before I open vim I'll export the\nDJANGO_SETTINGS_MODULE environment so that I get code completion for\ndjango modules as well:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003eexport \u003cspan class=\"hljs-attr\"\u003eDJANGO_SETTINGS_MODULE\u003c/span\u003e=project.settings\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eRandom Tips\u003c/h1\u003e\n\u003cp\u003eIf you want to find a new color scheme just go to\n\u003ca href=\"http://code.google.com/p/vimcolorschemetest/\"\u003ehttp://code.google.com/p/vimcolorschemetest/\u003c/a\u003e to preview a large\nselection.\u003c/p\u003e\n\u003cp\u003eJohn Anderson \u0026#x3C;\u003ca href=\"mailto:sontek@gmail.com\"\u003esontek@gmail.com\u003c/a\u003e\u003e 2011\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/old/turning_vim_into_a_modern_python_ide\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/old/turning_vim_into_a_modern_python_ide\u003c/guid\u003e\n            \u003cpubDate\u003eSat, 07 May 2011 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n        \u003citem\u003e\n            \u003ctitle\u003e\u003c![CDATA[Tips and Tricks for the Python Interpreter]]\u003e\u003c/title\u003e\n            \u003cdescription\u003e\u003c![CDATA[\u003cp\u003eI have seen a lot of people switch over to using ipython, bpython, etc\nto get auto-complete support without realizing that the standard\ninterpreter does have this functionality.\u003c/p\u003e\n\u003cp\u003eTo enable auto-complete support in the python interpreter you need to\ncreate a python startup file that enables readline support. A python\nstartup file is just a bunch of python code that gets executed at\nstartup of the interpreter. To do this you just setup PYTHONSTARTUP in\nyour ~/.bashrc and then create a ~/.pythonrc.py file:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-comment\"\u003e#.bashrc\u003c/span\u003e\nPYTHONSTARTUP=~/.pythonrc.py\nexport PYTHONSTARTUP\n\n\u003cspan class=\"hljs-comment\"\u003e#.pythonrc.py\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e readline\n\u003cspan class=\"hljs-keyword\"\u003eexcept\u003c/span\u003e ImportError:\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Module readline not available.\"\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e rlcompleter\n    readline.parse_and_bind(\u003cspan class=\"hljs-string\"\u003e\"tab: complete\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow when you are in python you have tab completion on importing, calling\nmethods on a module, etc.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-meta\"\u003e\u003e\u003e\u003e \u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e o\n\u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e(  \u003cspan class=\"hljs-built_in\"\u003eoct\u003c/span\u003e(     \u003cspan class=\"hljs-built_in\"\u003eopen\u003c/span\u003e(    \u003cspan class=\"hljs-keyword\"\u003eor\u003c/span\u003e       \u003cspan class=\"hljs-built_in\"\u003eord\u003c/span\u003e(     os\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI always end up using the pretty print module for viewing long lists and\nstrings in the interpreter so I prefer to just use it by default:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# Enable Pretty Printing for stdout\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e pprint\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emy_displayhook\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003evalue\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e value \u003cspan class=\"hljs-keyword\"\u003eis\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e:\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e:\n            \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e __builtin__\n            __builtin__._ = value\n        \u003cspan class=\"hljs-keyword\"\u003eexcept\u003c/span\u003e ImportError:\n            __builtins__._ = value\n\n        pprint.pprint(value)\n\nsys.displayhook = my_displayhook\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt is also very useful to be able to load up your favorite editor to\nedit lines of code from the interpreter, you can do this by adding the\nfollowing into your ~/.pythonrc.py:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e os\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sys\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e code \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e InteractiveConsole\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e tempfile \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e mkstemp\n\nEDITOR = os.environ.get(\u003cspan class=\"hljs-string\"\u003e'EDITOR'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'vi'\u003c/span\u003e)\nEDIT_CMD = \u003cspan class=\"hljs-string\"\u003e'\\e'\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eEditableBufferInteractiveConsole\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eInteractiveConsole\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, *args, **kwargs\u003c/span\u003e):\n        self.last_buffer = [] \u003cspan class=\"hljs-comment\"\u003e# This holds the last executed statement\u003c/span\u003e\n        InteractiveConsole.__init__(self, *args, **kwargs)\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erunsource\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, source, *args\u003c/span\u003e):\n        self.last_buffer = [ source.encode(\u003cspan class=\"hljs-string\"\u003e'latin-1'\u003c/span\u003e) ]\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e InteractiveConsole.runsource(self, source, *args)\n\n    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eraw_input\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, *args\u003c/span\u003e):\n        line = InteractiveConsole.raw_input(self, *args)\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e line == EDIT_CMD:\n            fd, tmpfl = mkstemp(\u003cspan class=\"hljs-string\"\u003e'.py'\u003c/span\u003e)\n            os.write(fd, \u003cspan class=\"hljs-string\"\u003eb'\\n'\u003c/span\u003e.join(self.last_buffer))\n            os.close(fd)\n            os.system(\u003cspan class=\"hljs-string\"\u003e'%s %s'\u003c/span\u003e % (EDITOR, tmpfl))\n            line = \u003cspan class=\"hljs-built_in\"\u003eopen\u003c/span\u003e(tmpfl).read()\n            os.unlink(tmpfl)\n            tmpfl = \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e\n            lines = line.split( \u003cspan class=\"hljs-string\"\u003e'\\n'\u003c/span\u003e )\n            \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003erange\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e(lines) - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e): self.push( lines[i] )\n            line = lines[-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e line\n\nc = EditableBufferInteractiveConsole(\u003cspan class=\"hljs-built_in\"\u003elocals\u003c/span\u003e=\u003cspan class=\"hljs-built_in\"\u003elocals\u003c/span\u003e())\nc.interact(banner=\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e)\n\n\u003cspan class=\"hljs-comment\"\u003e# Exit the Python shell on exiting the InteractiveConsole\u003c/span\u003e\nsys.exit()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor Django developers when you load up the ./manage.py shell it is nice\nto have access to all your models and settings for testing:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# If we're working with a Django project, set up the environment\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'DJANGO_SETTINGS_MODULE'\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e os.environ:\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e django.db.models.loading \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e get_models\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e django.test.client \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Client\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e django.test.utils \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e setup_test_environment, teardown_test_environment\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e django.conf \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e settings \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e S\n\n    \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDjangoModels\u003c/span\u003e(\u003cspan class=\"hljs-title class_ inherited__\"\u003eobject\u003c/span\u003e):\n        \u003cspan class=\"hljs-string\"\u003e\"\"\"Loop through all the models in INSTALLED_APPS and import them.\"\"\"\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\n            \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e m \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e get_models():\n                \u003cspan class=\"hljs-built_in\"\u003esetattr\u003c/span\u003e(self, m.__name__, m)\n\n    A = DjangoModels()\n    C = Client()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter these tweaks the python interpreter is a lot more powerful and you\nreally lose the need for the more interactive shells like ipython and\nbpython. All of these settings work in both python2 and python3.\u003c/p\u003e\n\u003cp\u003eIf you want to see my complete ~/.pythonrc.py you can get it on\n\u003ca href=\"https://github.com/sontek/dotfiles/blob/master/_pythonrc.py\"\u003egithub\u003c/a\u003e\u003c/p\u003e]]\u003e\u003c/description\u003e\n            \u003clink\u003ehttps://sontek.net/blog/old/tips_and_tricks_for_the_python_interpreter\u003c/link\u003e\n            \u003cguid isPermaLink=\"true\"\u003ehttps://sontek.net/blog/old/tips_and_tricks_for_the_python_interpreter\u003c/guid\u003e\n            \u003cpubDate\u003eTue, 28 Dec 2010 00:00:00 GMT\u003c/pubDate\u003e\n        \u003c/item\u003e\n    \u003c/channel\u003e\n\u003c/rss\u003e"},"__N_SSG":true},"page":"/rss","query":{},"buildId":"or2yRsjMlE6FOwtaFG-IP","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>