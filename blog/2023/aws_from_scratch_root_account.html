<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>AWS From Scratch with Terraform - Setting up your Root Account for IaC (using Terraform Cloud)</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/4e645f88d9d5f47b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e645f88d9d5f47b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/95e79f6f6f52c645.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95e79f6f6f52c645.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2e2b8b955a26d1f2.js" defer=""></script><script src="/_next/static/chunks/664-41844e7ff48658f9.js" defer=""></script><script src="/_next/static/chunks/494-fa03e5491fc3b3a9.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-62742065773be53f.js" defer=""></script><script src="/_next/static/tP8bGBoCIY4QddVqUXuR9/_buildManifest.js" defer=""></script><script src="/_next/static/tP8bGBoCIY4QddVqUXuR9/_ssgManifest.js" defer=""></script><script src="/_next/static/tP8bGBoCIY4QddVqUXuR9/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">AWS From Scratch with Terraform - Setting up your Root Account for IaC (using Terraform Cloud)</h1><div class="util_lightText__xcqUE"><time dateTime="2023-04-01T00:00:00Z">April 1, 2023</time></div><div><p>Starting a new AWS account from scratch can be overwhelming but following this
article will get you setup with an AWS Root (Payer) account that can be
managed through through Terraform Cloud with OIDC. As a best practice you
should no longer keep long-lived access keys in your CI/CD pipelines when
deploying to AWS. These days you should use OIDC (OpenID Connect) to securely
deploy to AWS when using Terraform Cloud or Github Actions.</p>
<h1>TL;DR</h1>
<p>Download all the source from the blog post here:</p>
<p><a href="https://github.com/sontek/aws-terraform-bootstrap">https://github.com/sontek/aws-terraform-bootstrap</a></p>
<h1>How does OIDC work</h1>
<p>OIDC enables us to request a short-lived access token directly from AWS. We
just have to trust relationship that controls which workflows are able to
request the access tokens.</p>
<ul>
<li>No need to duplicate AWS credentials as long-lived GitHub secrets.</li>
<li>Since we are using a short-lived access token that is only valid for a single
job there is no reason to worry about rotating secrets.</li>
</ul>
<p>The following diagram gives an overview of how we can use Terraform Cloud's
OIDC provider to integrate with AWS:</p>
<div class="remark-mermaid remark-mermaid-default"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 843.078125 320" style="max-width: 843.078px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1680486021491"><style>#mermaid-1680486021491{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1680486021491 .error-icon{fill:#552222;}#mermaid-1680486021491 .error-text{fill:#552222;stroke:#552222;}#mermaid-1680486021491 .edge-thickness-normal{stroke-width:2px;}#mermaid-1680486021491 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1680486021491 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1680486021491 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1680486021491 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1680486021491 .marker{fill:#333333;stroke:#333333;}#mermaid-1680486021491 .marker.cross{stroke:#333333;}#mermaid-1680486021491 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1680486021491 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-1680486021491 .cluster-label text{fill:#333;}#mermaid-1680486021491 .cluster-label span{color:#333;}#mermaid-1680486021491 .label text,#mermaid-1680486021491 span{fill:#333;color:#333;}#mermaid-1680486021491 .node rect,#mermaid-1680486021491 .node circle,#mermaid-1680486021491 .node ellipse,#mermaid-1680486021491 .node polygon,#mermaid-1680486021491 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1680486021491 .node .label{text-align:center;}#mermaid-1680486021491 .node.clickable{cursor:pointer;}#mermaid-1680486021491 .arrowheadPath{fill:#333333;}#mermaid-1680486021491 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1680486021491 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1680486021491 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1680486021491 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1680486021491 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1680486021491 .cluster text{fill:#333;}#mermaid-1680486021491 .cluster span{color:#333;}#mermaid-1680486021491 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1680486021491 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1680486021491 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="10" viewBox="0 0 12 20" class="marker flowchart" id="flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="0" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart" id="flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart" id="flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token" id="L-AWS-Token-0" d="M185.671875,134.5L181.50520833333334,134.5C177.33854166666666,134.5,169.00520833333334,134.5,152.378260969764,145.875C135.75131360619469,157.25,110.83075221238937,180,98.37047151548673,191.375L85.91019081858407,202.75"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform" id="L-Token-Terraform-0" d="M85.91019081858407,235.75L98.37047151548673,247.125C110.83075221238937,258.5,135.75131360619469,281.25,164.46289638643069,292.625C193.17447916666666,304,225.67708333333334,304,258.1796875,304C290.6822916666667,304,323.1848958333333,304,359.3528645833333,304C395.5208333333333,304,435.3541666666667,304,475.1875,304C515.0208333333334,304,554.8541666666666,304,585.6956312991642,296.7916666666667C616.5370959316618,289.5833333333333,638.3866918633236,275.1666666666667,649.3114898291544,267.9583333333333L660.2362877949853,260.75"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT" id="L-Terraform-JWT-0" d="M660.2362877949853,177.75L649.3114898291544,170.54166666666666C638.3866918633236,163.33333333333334,616.5370959316618,148.91666666666666,601.4456312991642,141.70833333333334C586.3541666666666,134.5,578.0208333333334,134.5,573.8541666666666,134.5L569.6875,134.5"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS" id="L-JWT-AWS-0" d="M380.6875,134.5L376.5208333333333,134.5C372.3541666666667,134.5,364.0208333333333,134.5,355.6875,134.5C347.3541666666667,134.5,339.0208333333333,134.5,334.8541666666667,134.5L330.6875,134.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(621.1171875, 169.75)" class="root"><g class="clusters"><g id="Terraform" class="cluster default"><rect height="83" width="206.890625" y="8" x="-0.9296875" ry="0" rx="0" style=""></rect><g transform="translate(-0.9296875, 8)" class="cluster-label"><foreignObject height="18" width="206.890625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Terraform Cloud Workflow #2</span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(102.515625, 49.5)" id="flowchart-OIDCProvider-23" class="node default default"><rect height="33" width="119.03125" y="-16.5" x="-59.515625" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-52.015625, -9)" style="" class="label"><foreignObject height="18" width="104.03125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">OIDC Provider</span></div></foreignObject></g></g></g></g><g transform="translate(178.171875, -8)" class="root"><g class="clusters"><g id="AWS" class="cluster default"><rect height="269" width="145.015625" y="8" x="8" ry="0" rx="0" style=""></rect><g transform="translate(51.4609375, 8)" class="cluster-label"><foreignObject height="18" width="58.09375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">AWS #1</span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(80.5078125, 59.5)" id="flowchart-OIDC-20" class="node default default"><rect height="33" width="95.015625" y="-16.5" x="-47.5078125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-40.0078125, -9)" style="" class="label"><foreignObject height="18" width="80.015625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">OIDC Trust</span></div></foreignObject></g></g><g transform="translate(80.5078125, 142.5)" id="flowchart-Roles-21" class="node default default"><rect height="33" width="55.90625" y="-16.5" x="-27.953125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-20.453125, -9)" style="" class="label"><foreignObject height="18" width="40.90625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Roles</span></div></foreignObject></g></g><g transform="translate(80.5078125, 225.5)" id="flowchart-Resources-22" class="node default default"><rect height="33" width="91.484375" y="-16.5" x="-45.7421875" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-38.2421875, -9)" style="" class="label"><foreignObject height="18" width="76.484375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Resources</span></div></foreignObject></g></g></g></g><g transform="translate(67.8359375, 219.25)" id="flowchart-Token-25" class="node default default"><rect height="33" width="135.671875" y="-16.5" x="-67.8359375" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-60.3359375, -9)" style="" class="label"><foreignObject height="18" width="120.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Access Token #4</span></div></foreignObject></g></g><g transform="translate(475.1875, 134.5)" id="flowchart-JWT-28" class="node default default"><rect height="33" width="189" y="-16.5" x="-94.5" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-87, -9)" style="" class="label"><foreignObject height="18" width="174"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JWT &#x26; Cloud Role ID #3</span></div></foreignObject></g></g></g></g></g></svg></div>
<ol>
<li>In AWS, create an OIDC trust between a role and our terraform cloud
workflow(s) that need access to the cloud.</li>
<li>Every time a job runs, TFC's OIDC Provider auto-generates an OIDC token.
This token contains multiple claims to establish a security-hardened and
verifiable identity about the specific workflow that is trying to authenticate.</li>
<li>Request this token from TFC's OIDC provider, and present it to AWS</li>
<li>Once AWS successfully validates the claims presented in the token, it then
provides a short-lived cloud access token that is available only for the duration
of the job.</li>
</ol>
<h1>What does this post accomplish</h1>
<ul>
<li>Setup a root AWS account that is managed througuh terraform</li>
<li>Setup OIDC authentication with Terraform Cloud so it can talk to AWS</li>
<li>Setup Github Actions authentication with Terraform Cloud so we can run plan
and apply through the CI/CD pipeline.</li>
</ul>
<h1>Setup AWS Access</h1>
<p>It is very bad practice to use the root account for much of anything but for
bootstrapping the account it is necessary, so the first step is to get your
<code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></p>
<p>To do this click your account and choose <code>Security Credentials</code> in the top
right:</p>
<center>
<img src="/images/posts/aws_root_account/security_credentials.png" height="200">
</center>
<p>Then choose <code>Create Access key</code>:</p>
<center>
<img src="/images/posts/aws_root_account/create_access_token.png" width="200">
</center>
<p>You need to set these environment variables in your shell so that your local
shell has access to AWS. After you set them you can verify you set them correct
by running:</p>
<pre><code class="hljs language-bash">❯ aws sts get-caller-identity
</code></pre>
<p>and you should get a result similar to:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"UserId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"777777777777"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Account"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"888888888888"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Arn"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arn:aws:iam::888888888888:root"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2>Bootstrap</h2>
<p>Before you can manage any of your accounts through Terraform Cloud you'll need
bootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate
securely and manage AWS Resources on your behalf.</p>
<p>I personally prefer doing this in two repositories:</p>
<ul>
<li>
<p><code>infra-bootstrap</code>: This repository does the bare minimum to hook up terraform
cloud with your AWS account and stores the state in git.  Its the only infra
that will not be controlled by your CI/CD pipeline.</p>
</li>
<li>
<p><code>infra</code>: The actual repository where all the rest of your AWS resources are
managed.  It will store state in Terraform Cloud and you can introduce a
CI/CD pipeline for approving changes.</p>
<p><strong>Note</strong>: This repository will be generated with the terraform code.</p>
</li>
</ul>
<p>After manually creating the git repository <code>infra-boostrap</code> in your Github
account We will need 3 providers to bootstrap the account <code>aws</code>, <code>github</code>, and
<code>tfe</code>.</p>
<h3>Variables</h3>
<p>Create a <code>1-variables.tf</code> where we can define the variables we'll need
for creating these resources.</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_aws_audience"</span> {
  type        = string
  default     = <span class="hljs-string">"aws.workload.identity"</span>
  description = <span class="hljs-string">"The audience value to use in run identity tokens"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_hostname"</span> {
  type        = string
  default     = <span class="hljs-string">"app.terraform.io"</span>
  description = <span class="hljs-string">"The hostname of the TFC or TFE instance you'd like to use with AWS"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_project_name"</span> {
  type        = string
  default     = <span class="hljs-string">"Default Project"</span>
  description = <span class="hljs-string">"The project under which a workspace will be created"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_organization_name"</span> {
  type        = string
  description = <span class="hljs-string">"The name of your Terraform Cloud organization"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_organization_owner"</span> {
  type        = string
  description = <span class="hljs-string">"The owner of the TFC organization"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"tfc_workspaces"</span> {
  type        = list(string)
  description = <span class="hljs-string">"The list of TFC workspaces"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"github_organization"</span> {
  description = <span class="hljs-string">"The organization the repositories are owned by"</span>
  type        = string
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"github_repo_name"</span> {
  description = <span class="hljs-string">"The name of the git reppository we'll create for managing infra"</span>
  type        = string
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"github_default_branch"</span> {
  description = <span class="hljs-string">"The default branch to utilize"</span>
  type        = string
  default     = <span class="hljs-string">"main"</span>
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"github_oauth_client_id"</span> {
  description = <span class="hljs-string">"The token for the TFC OAuth client shown under VCS providers"</span>
  type        = string
  default     = null
}

<span class="hljs-keyword">variable</span> <span class="hljs-string">"aws_root_account_id"</span> {
  description = <span class="hljs-string">"The AWS root account we want to apply these changes to"</span>
  type        = string
}
</code></pre>
<p>We will use these variables in the later modules but they are mostly metadata
around the terraform and github accounts you'll need to setup manually.</p>
<h3>Providers</h3>
<p>Create a file called <code>2-main.tf</code> and define the providers:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">terraform</span> {
  required_providers {
    tfe = {
      source  = <span class="hljs-string">"hashicorp/tfe"</span>
      version = <span class="hljs-string">"0.41.0"</span>
    }

    aws = {
      source  = <span class="hljs-string">"hashicorp/aws"</span>
      version = <span class="hljs-string">"4.58.0"</span>
    }

    github = {
      source  = <span class="hljs-string">"integrations/github"</span>
      version = <span class="hljs-string">"5.18.3"</span>
    }
  }
}

<span class="hljs-keyword">provider</span> <span class="hljs-string">"aws"</span> {
  region = <span class="hljs-string">"us-east-1"</span>

  <span class="hljs-comment"># Root account, all other accounts should be provisioned</span>
  <span class="hljs-comment"># via pull requests</span>
  allowed_account_ids = [var.aws_root_account_id]
}

<span class="hljs-keyword">provider</span> <span class="hljs-string">"github"</span> {
  owner = var.github_organization
}
</code></pre>
<p>The key things there are we define <code>allowed_account_ids</code> to prevent us from
working against any account that isn't the root and we are using one of the
variables we defines earlier.</p>
<h3>Github</h3>
<p>We will utilize <code>terraform</code> to create the second git repository where the rest
of the infrastructure will go. Create a file called <code>3-github.tf</code>:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">resource</span> <span class="hljs-string">"github_repository"</span> <span class="hljs-string">"repo"</span> {
  name        = var.github_repo_name
  description = <span class="hljs-string">"Infrastructure Repository"</span>
  visibility  = <span class="hljs-string">"private"</span>
  auto_init   = true
  has_issues  = true
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"github_branch_default"</span> <span class="hljs-string">"default"</span> {
  repository = github_repository.repo.name
  branch     = var.github_default_branch
}

<span class="hljs-keyword">output</span> <span class="hljs-string">"repository_id"</span> {
  value = github_repository.repo.id
}
</code></pre>
<p>This will generate a new repository in your account called <code>infra</code>.</p>
<h3>Terraform Cloud</h3>
<p>Now we need to setup dynamic credentials so the terraform cloud agent is
allowed to take actions on your behalf.   To do this we'll setup an IAM
role and an OIDC provider. Create a file called <code>4-tfc.tf</code>:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">resource</span> <span class="hljs-string">"tfe_organization"</span> <span class="hljs-string">"organization"</span> {
  name  = var.tfc_organization_name
  email = var.tfc_organization_owner
}

/* AWS will use this TLS certificate to verify that requests for dynamic
credentials come from Terraform Cloud.*/
<span class="hljs-keyword">data</span> <span class="hljs-string">"tls_certificate"</span> <span class="hljs-string">"tfc_certificate"</span> {
  url = <span class="hljs-string">"https://<span class="hljs-variable">${var.tfc_hostname}</span>"</span>
}

/* sets up an OIDC <span class="hljs-keyword">provider</span> in AWS with Terraform Cloud's TLS certificate,
the SHA1 fingerprint from the TLS certificate 
*/
<span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_iam_openid_connect_provider"</span> <span class="hljs-string">"tfc_provider"</span> {
  url            = <span class="hljs-keyword">data</span>.tls_certificate.tfc_certificate.url
  client_id_list = [var.tfc_aws_audience]
  thumbprint_list = [
    <span class="hljs-keyword">data</span>.tls_certificate.tfc_certificate.certificates[<span class="hljs-number">0</span>].sha1_fingerprint
  ]
}

/* Policy to allow TFC to assume the AWS IAM role in our account */
<span class="hljs-keyword">data</span> <span class="hljs-string">"aws_iam_policy_document"</span> <span class="hljs-string">"assume_role"</span> {
  statement {
    effect = <span class="hljs-string">"Allow"</span>

    principals {
      type        = <span class="hljs-string">"Federated"</span>
      identifiers = [aws_iam_openid_connect_provider.tfc_provider.arn]
    }
    condition {
      test     = <span class="hljs-string">"StringEquals"</span>
      <span class="hljs-keyword">variable</span> = <span class="hljs-string">"<span class="hljs-variable">${var.tfc_hostname}</span>:aud"</span>

      values = [
        <span class="hljs-string">"<span class="hljs-variable">${<span class="hljs-meta">one(aws_iam_openid_connect_provider.tfc_provider.client_id_list)</span>}</span>"</span>
      ]
    }

    condition {
      test     = <span class="hljs-string">"StringLike"</span>
      <span class="hljs-keyword">variable</span> = <span class="hljs-string">"<span class="hljs-variable">${var.tfc_hostname}</span>:sub"</span>

      values = [
        for workspace in var.tfc_workspaces : <span class="hljs-string">"organization:<span class="hljs-variable">${tfe_organization.organization.name}</span>:project:<span class="hljs-variable">${var.tfc_project_name}</span>:workspace:<span class="hljs-variable">${workspace}</span>:run_phase:*"</span>
      ]
    }
    actions = [<span class="hljs-string">"sts:AssumeRoleWithWebIdentity"</span>]
  }
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_iam_role"</span> <span class="hljs-string">"tfc-agent"</span> {
  name               = <span class="hljs-string">"tfc-agent"</span>
  assume_role_policy = <span class="hljs-keyword">data</span>.aws_iam_policy_document.assume_role.json
}

/* Policy for what the TFC agent is allowed to do */
<span class="hljs-keyword">data</span> <span class="hljs-string">"aws_iam_policy_document"</span> <span class="hljs-string">"tfc-agent"</span> {
  version = <span class="hljs-string">"2012-10-17"</span>

  statement {
    actions   = [<span class="hljs-string">"*"</span>]
    effect    = <span class="hljs-string">"Allow"</span>
    resources = [<span class="hljs-string">"*"</span>]
  }
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_iam_policy"</span> <span class="hljs-string">"tfc-agent"</span> {
  name        = <span class="hljs-string">"tfc-agent-access-policy"</span>
  description = <span class="hljs-string">"Access policy for the TFC agent"</span>
  policy      = <span class="hljs-keyword">data</span>.aws_iam_policy_document.tfc-agent.json
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_iam_role_policy_attachment"</span> <span class="hljs-string">"tfc-access-attach"</span> {
  role       = aws_iam_role.tfc-agent.name
  policy_arn = aws_iam_policy.tfc-agent.arn
}

/* Fetch an oauth token from the client */
<span class="hljs-keyword">data</span> <span class="hljs-string">"tfe_oauth_client"</span> <span class="hljs-string">"github"</span> {
  /* Don't fetch the client if we don't have the client_id */
  count           = var.github_oauth_client_id != null ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>
  oauth_client_id = var.github_oauth_client_id
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"tfe_workspace"</span> <span class="hljs-string">"workspaces"</span> {
  count        = length(var.tfc_workspaces)
  name         = var.tfc_workspaces[count.index]
  organization = tfe_organization.organization.name

  working_directory = var.tfc_workspaces[count.index]

  /* This generates a webhook on the github repository so plans are triggered
  automatically.   We dynamically set the setting because we will not have the
  oauth client ID on first pass.
  */
  dynamic <span class="hljs-string">"vcs_repo"</span> {
    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []
    content {
      identifier     = format(<span class="hljs-string">"%s/%s"</span>, var.github_organization, github_repository.repo.name)
      oauth_token_id = <span class="hljs-keyword">data</span>.tfe_oauth_client.github[<span class="hljs-number">0</span>].oauth_token_id
    }
  }
}

/* These variables tell the agent to use dynamic credentials */
<span class="hljs-keyword">resource</span> <span class="hljs-string">"tfe_variable"</span> <span class="hljs-string">"tfc-auth"</span> {
  count        = length(var.tfc_workspaces)
  key          = <span class="hljs-string">"TFC_AWS_PROVIDER_AUTH"</span>
  value        = true
  category     = <span class="hljs-string">"env"</span>
  workspace_id = tfe_workspace.workspaces[count.index].id
  description  = <span class="hljs-string">"Enable dynamic auth on the TFC agents"</span>
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"tfe_variable"</span> <span class="hljs-string">"tfc-role"</span> {
  count        = length(var.tfc_workspaces)
  key          = <span class="hljs-string">"TFC_AWS_RUN_ROLE_ARN"</span>
  value        = aws_iam_role.tfc-agent.arn
  category     = <span class="hljs-string">"env"</span>
  workspace_id = tfe_workspace.workspaces[count.index].id
  description  = <span class="hljs-string">"Tell TFC what Role to run as"</span>
}
</code></pre>
<p>This module is dynamic because there is one piece that will require a
manul oauth setup for github.  So the first pass will apply without it
and then later on we'll create it and run the apply again.</p>
<h2>Applying the changes</h2>
<p>Now we just need to define our settings for the module and we'll get our
infrastructure applied.  Create a file called <code>settings.auto.tfvars</code> and
populate it with the content for your account.  This is an example of what
this should look like:</p>
<pre><code class="hljs language-hcl">tfc_organization_name  = <span class="hljs-string">"sontek"</span>
tfc_organization_owner = <span class="hljs-string">"john@sontek.net"</span>

<span class="hljs-comment"># The workspaces you want to create and be able to manage with IaC</span>
tfc_workspaces = [
  <span class="hljs-string">"root"</span>
]
<span class="hljs-comment"># this can be your username</span>
github_organization    = <span class="hljs-string">"sontek"</span>
github_repo_name       = <span class="hljs-string">"sontek-infra"</span>
aws_root_account_id    =  <span class="hljs-string">"888888888888"</span>
</code></pre>
<p>Now run:</p>
<pre><code class="hljs language-bash">❯ terraform login
❯ terraform init
</code></pre>
<p>and you should see:</p>
<pre><code class="hljs">Terraform has been successfully initialized!
</code></pre>
<p>Now lets run our plan:</p>
<pre><code class="hljs language-hcl">❯ <span class="hljs-keyword">terraform</span> plan
</code></pre>
<p>You should see a result:</p>
<pre><code class="hljs language-vbnet"><span class="hljs-symbol">Plan:</span> <span class="hljs-number">10</span> <span class="hljs-keyword">to</span> add, <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> change, <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> destroy.
</code></pre>
<p>Apply it to make those resources:</p>
<pre><code class="hljs language-hcl">❯ <span class="hljs-keyword">terraform</span> apply
</code></pre>
<p>At this point it:</p>
<ol>
<li>Created a terraform cloud organization</li>
<li>Created a terraform cloud workspace</li>
<li>Created a git repository</li>
</ol>
<h1>Verify TFC can talk to AWS</h1>
<p>To verify that TFC can communicate with AWS through the dynamic credentials,
lets clone the repository and make some dummy resources. After you've cloned
the repository lets make a folder for the workspace <code>root</code> that we defined in
bootstrap:</p>
<pre><code class="hljs language-bash">❯ <span class="hljs-built_in">mkdir</span> root
❯ <span class="hljs-built_in">cd</span> root
</code></pre>
<p>Now create a <code>1-providers.tf</code>:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">terraform</span> {
  cloud {
    organization = <span class="hljs-string">"sontek"</span>

    workspaces {
      name = <span class="hljs-string">"root"</span>
    }
  }

  required_providers {
    aws = {
      source  = <span class="hljs-string">"hashicorp/aws"</span>
      version = <span class="hljs-string">"4.58.0"</span>
    }

    tfe = {
      source  = <span class="hljs-string">"hashicorp/tfe"</span>
      version = <span class="hljs-string">"0.42.0"</span>
    }
  }
}

<span class="hljs-keyword">provider</span> <span class="hljs-string">"aws"</span> {
  region = <span class="hljs-string">"us-east-1"</span>

  default_tags {
    tags = {
      Owner   = <span class="hljs-string">"john@sontek.net"</span>
      Env     = <span class="hljs-string">"Root"</span>
      Service = <span class="hljs-string">"BusinessOperations"</span>
    }
  }
}
</code></pre>
<p><strong>NOTE</strong>: You should replace <code>organization</code>, <code>workspaces.name</code>, and
<code>tags.Owner</code> to be your own values.</p>
<p>Now create a small resource to prove everything is working, we'll use SQS for
this. Create a file called <code>2-sqs.tf</code>:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_sqs_queue"</span> <span class="hljs-string">"example-sqs"</span> {
  name                        = <span class="hljs-string">"example-sqs"</span>
  message_retention_seconds = <span class="hljs-number">86400</span>
  receive_wait_time_seconds = <span class="hljs-number">10</span>
}
</code></pre>
<p>If you run the plan you should see the resource it wants to create:</p>
<pre><code class="hljs language-bash">❯ terraform init
❯ terraform plan

</code></pre>
<p>and you should see the run is executing in terraform cloud:</p>
<pre><code class="hljs language-arduino">Running plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C
will stop streaming the logs, but will <span class="hljs-keyword">not</span> stop the plan running remotely.
</code></pre>
<p>You can click the link it provides to see the logs. Now lets apply this
resource to see it all working:</p>
<pre><code class="hljs language-hcl">❯ <span class="hljs-keyword">terraform</span> apply
</code></pre>
<p>You should get a response like:</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">Apply</span> <span class="hljs-string">complete!</span> <span class="hljs-attr">Resources:</span> <span class="hljs-number">1</span> <span class="hljs-string">added,</span> <span class="hljs-number">0</span> <span class="hljs-string">changed,</span> <span class="hljs-number">0</span> <span class="hljs-string">destroyed.</span>
</code></pre>
<p>So Terraform Cloud has full access to create AWS resources!   The final step
is to get github running the plan/apply on pull requests. Commit these files
to your repository and we'll remove them in a pull request. Create a
<code>.gitignore</code> file in the root:</p>
<pre><code class="hljs language-hcl">.<span class="hljs-keyword">terraform</span>*
</code></pre>
<p>and commit all the files:</p>
<pre><code class="hljs language-bash">❯ git add *
❯ git commit -m <span class="hljs-string">"initial infra"</span>
❯ git push origin <span class="hljs-built_in">head</span>
</code></pre>
<h1>Github VCS Provider</h1>
<p>To setup oauth between github and terraform cloud so it can manage the webhooks
you need to login to the [https://app.terraform.io](Terraform Cloud Console) and
initiate the connection.</p>
<p>Select the newly created organization and then click <code>Settings</code>.  In the sidebar
there will be a section <code>Version Control</code> and you want to select <code>Providers</code> under
that.</p>
<p>At this point you should see an <code>Add a VCS Provider</code> button, you want to select
<code>Github.com (Custom)</code>:</p>
<center>
<img src="/images/posts/aws_root_account/tfc_vcs_provider.png" height="250">
</center>
<p>Follow the on-screen instructions to create a new GitHub OAuth application on your
account. For me, I went to <a href="https://github.com/settings/applications/new">here</a> and
provided the information TFC displayed:</p>
<center>
<img src="/images/posts/aws_root_account/tfc_github_app.png" height="300">
</center>
<p>On the Github side you need to save the <code>Client ID</code> and you need to click
<code>Generate a new client secret</code>.   Provide those details to terraform cloud and
then we should be ready to send our first PR!</p>
<center>
<img src="/images/posts/aws_root_account/tfc_oauth_settings.png" height="300">
</center>
<h2>Finish Bootstrap</h2>
<p>At this point we need to return to the bootstrap repository and provide it the
new OAuth Client ID for its <code>github_oauth_client_id</code> setting.  To get the value
for this the easiest way is to drill into the VCS provider in terraform and click
<code>Edit Client</code>.   In the URL you'll see the Client ID, it should start with
<code>oc-...</code>.</p>
<p>Now return back to the <code>bootstrap</code> repository and edit <code>settings.auto.tfvars</code> and
set the final setting:</p>
<pre><code class="hljs language-ini"><span class="hljs-attr">github_oauth_client_id</span> = <span class="hljs-string">"oc-......"</span>
</code></pre>
<p>Now you should be able to run a plan and see the <code>vcs_repo</code> get added in-place:</p>
<pre><code class="hljs language-bash">❯ terraform plan

  ~ update in-place

Terraform will perform the following actions:

  <span class="hljs-comment"># tfe_workspace.workspaces[0] will be updated in-place</span>
  ~ resource <span class="hljs-string">"tfe_workspace"</span> <span class="hljs-string">"workspaces"</span> {
        <span class="hljs-built_in">id</span>                            = <span class="hljs-string">"ws-..."</span>
        name                          = <span class="hljs-string">"root"</span>
        <span class="hljs-comment"># (20 unchanged attributes hidden)</span>

      + vcs_repo {
          + identifier         = <span class="hljs-string">"sontek/sontek-infra"</span>
          + ingress_submodules = <span class="hljs-literal">false</span>
          + oauth_token_id     = <span class="hljs-string">"ot-..."</span>
        }
    }

Plan: 0 to add, 1 to change, 0 to destroy.
</code></pre>
<p>Apply the change!</p>
<pre><code class="hljs language-hcl">❯ <span class="hljs-keyword">terraform</span> apply
</code></pre>
<p>After you apply the change, if you go to <code>Settings</code> -> <code>Webhooks</code> of the <code>infra</code>
repository that was created earlier you should see a new terraform cloud webhook
was created.</p>
<center>
<img src="/images/posts/aws_root_account/github_webhooks.png" width="350">
</center>
<h1>Send your first pull request</h1>
<p>Now you should be able to send a pull request tearing down the SQS resource we
generated at the beginning and terraform cloud will take care of the rest! Make
sure you are on the generated <code>infra</code> repo and:</p>
<pre><code class="hljs language-bash">❯ <span class="hljs-built_in">rm</span> root/sqs.tf
</code></pre>
<p>and commit / push that to a branch and open a pull request. When you merge it
will apply the changes.</p>
<h1>Next Steps</h1>
<p>This should be good enough for you to manage your AWS cloud infrastructure as
code with terraform but I <strong>personally</strong> don't like that terraform cloud applies
the changes on merge.  There are a lot of ways where a <code>plan</code> can succeed but an
<code>apply</code> will fail and you end up with broken configuration in <code>main</code>.</p>
<p>I prefer a worfklow called <code>apply-before-merge</code> and in my next post I'll show you
how to do that through github actions instead of utilizing the TFC webhook.</p>
<p>Check out that post <a href="/blog/2023/aws_from_scratch_apply_before_merge">here</a>!</p>
<h1>Helpful Resources</h1>
<ul>
<li><a href="https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform">Terraform Dynamic Credentials Tutorial</a></li>
<li><a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration">Terraform docs on Dynamic Credentials</a></li>
<li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token">Github's understanding OIDC</a></li>
</ul></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2023","aws_from_scratch_root_account"],"path":"2023/aws_from_scratch_root_account","contentHtml":"\u003cp\u003eStarting a new AWS account from scratch can be overwhelming but following this\narticle will get you setup with an AWS Root (Payer) account that can be\nmanaged through through Terraform Cloud with OIDC. As a best practice you\nshould no longer keep long-lived access keys in your CI/CD pipelines when\ndeploying to AWS. These days you should use OIDC (OpenID Connect) to securely\ndeploy to AWS when using Terraform Cloud or Github Actions.\u003c/p\u003e\n\u003ch1\u003eTL;DR\u003c/h1\u003e\n\u003cp\u003eDownload all the source from the blog post here:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/sontek/aws-terraform-bootstrap\"\u003ehttps://github.com/sontek/aws-terraform-bootstrap\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eHow does OIDC work\u003c/h1\u003e\n\u003cp\u003eOIDC enables us to request a short-lived access token directly from AWS. We\njust have to trust relationship that controls which workflows are able to\nrequest the access tokens.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNo need to duplicate AWS credentials as long-lived GitHub secrets.\u003c/li\u003e\n\u003cli\u003eSince we are using a short-lived access token that is only valid for a single\njob there is no reason to worry about rotating secrets.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe following diagram gives an overview of how we can use Terraform Cloud's\nOIDC provider to integrate with AWS:\u003c/p\u003e\n\u003cdiv class=\"remark-mermaid remark-mermaid-default\"\u003e\u003csvg aria-roledescription=\"flowchart-v2\" role=\"graphics-document document\" viewBox=\"-8 -8 843.078125 320\" style=\"max-width: 843.078px; background-color: transparent;\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"mermaid-1680486021491\"\u003e\u003cstyle\u003e#mermaid-1680486021491{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1680486021491 .error-icon{fill:#552222;}#mermaid-1680486021491 .error-text{fill:#552222;stroke:#552222;}#mermaid-1680486021491 .edge-thickness-normal{stroke-width:2px;}#mermaid-1680486021491 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1680486021491 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1680486021491 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1680486021491 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1680486021491 .marker{fill:#333333;stroke:#333333;}#mermaid-1680486021491 .marker.cross{stroke:#333333;}#mermaid-1680486021491 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1680486021491 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-1680486021491 .cluster-label text{fill:#333;}#mermaid-1680486021491 .cluster-label span{color:#333;}#mermaid-1680486021491 .label text,#mermaid-1680486021491 span{fill:#333;color:#333;}#mermaid-1680486021491 .node rect,#mermaid-1680486021491 .node circle,#mermaid-1680486021491 .node ellipse,#mermaid-1680486021491 .node polygon,#mermaid-1680486021491 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1680486021491 .node .label{text-align:center;}#mermaid-1680486021491 .node.clickable{cursor:pointer;}#mermaid-1680486021491 .arrowheadPath{fill:#333333;}#mermaid-1680486021491 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1680486021491 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1680486021491 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1680486021491 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1680486021491 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1680486021491 .cluster text{fill:#333;}#mermaid-1680486021491 .cluster span{color:#333;}#mermaid-1680486021491 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1680486021491 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1680486021491 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}\u003c/style\u003e\u003cg\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"10\" viewBox=\"0 0 12 20\" class=\"marker flowchart\" id=\"flowchart-pointEnd\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"0\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointStart\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleEnd\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleStart\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossEnd\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossStart\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cg class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token\" id=\"L-AWS-Token-0\" d=\"M185.671875,134.5L181.50520833333334,134.5C177.33854166666666,134.5,169.00520833333334,134.5,152.378260969764,145.875C135.75131360619469,157.25,110.83075221238937,180,98.37047151548673,191.375L85.91019081858407,202.75\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform\" id=\"L-Token-Terraform-0\" d=\"M85.91019081858407,235.75L98.37047151548673,247.125C110.83075221238937,258.5,135.75131360619469,281.25,164.46289638643069,292.625C193.17447916666666,304,225.67708333333334,304,258.1796875,304C290.6822916666667,304,323.1848958333333,304,359.3528645833333,304C395.5208333333333,304,435.3541666666667,304,475.1875,304C515.0208333333334,304,554.8541666666666,304,585.6956312991642,296.7916666666667C616.5370959316618,289.5833333333333,638.3866918633236,275.1666666666667,649.3114898291544,267.9583333333333L660.2362877949853,260.75\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT\" id=\"L-Terraform-JWT-0\" d=\"M660.2362877949853,177.75L649.3114898291544,170.54166666666666C638.3866918633236,163.33333333333334,616.5370959316618,148.91666666666666,601.4456312991642,141.70833333333334C586.3541666666666,134.5,578.0208333333334,134.5,573.8541666666666,134.5L569.6875,134.5\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS\" id=\"L-JWT-AWS-0\" d=\"M380.6875,134.5L376.5208333333333,134.5C372.3541666666667,134.5,364.0208333333333,134.5,355.6875,134.5C347.3541666666667,134.5,339.0208333333333,134.5,334.8541666666667,134.5L330.6875,134.5\"\u003e\u003c/path\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(621.1171875, 169.75)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"Terraform\" class=\"cluster default\"\u003e\u003crect height=\"83\" width=\"206.890625\" y=\"8\" x=\"-0.9296875\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-0.9296875, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18\" width=\"206.890625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eTerraform Cloud Workflow #2\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(102.515625, 49.5)\" id=\"flowchart-OIDCProvider-23\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"119.03125\" y=\"-16.5\" x=\"-59.515625\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-52.015625, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"104.03125\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Provider\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(178.171875, -8)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"AWS\" class=\"cluster default\"\u003e\u003crect height=\"269\" width=\"145.015625\" y=\"8\" x=\"8\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(51.4609375, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18\" width=\"58.09375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAWS #1\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(80.5078125, 59.5)\" id=\"flowchart-OIDC-20\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"95.015625\" y=\"-16.5\" x=\"-47.5078125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-40.0078125, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"80.015625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Trust\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(80.5078125, 142.5)\" id=\"flowchart-Roles-21\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"55.90625\" y=\"-16.5\" x=\"-27.953125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-20.453125, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"40.90625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eRoles\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(80.5078125, 225.5)\" id=\"flowchart-Resources-22\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"91.484375\" y=\"-16.5\" x=\"-45.7421875\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-38.2421875, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"76.484375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eResources\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(67.8359375, 219.25)\" id=\"flowchart-Token-25\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"135.671875\" y=\"-16.5\" x=\"-67.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-60.3359375, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"120.671875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAccess Token #4\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(475.1875, 134.5)\" id=\"flowchart-JWT-28\" class=\"node default default\"\u003e\u003crect height=\"33\" width=\"189\" y=\"-16.5\" x=\"-94.5\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-87, -9)\" style=\"\" class=\"label\"\u003e\u003cforeignObject height=\"18\" width=\"174\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eJWT \u0026#x26; Cloud Role ID #3\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/svg\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003eIn AWS, create an OIDC trust between a role and our terraform cloud\nworkflow(s) that need access to the cloud.\u003c/li\u003e\n\u003cli\u003eEvery time a job runs, TFC's OIDC Provider auto-generates an OIDC token.\nThis token contains multiple claims to establish a security-hardened and\nverifiable identity about the specific workflow that is trying to authenticate.\u003c/li\u003e\n\u003cli\u003eRequest this token from TFC's OIDC provider, and present it to AWS\u003c/li\u003e\n\u003cli\u003eOnce AWS successfully validates the claims presented in the token, it then\nprovides a short-lived cloud access token that is available only for the duration\nof the job.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eWhat does this post accomplish\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eSetup a root AWS account that is managed througuh terraform\u003c/li\u003e\n\u003cli\u003eSetup OIDC authentication with Terraform Cloud so it can talk to AWS\u003c/li\u003e\n\u003cli\u003eSetup Github Actions authentication with Terraform Cloud so we can run plan\nand apply through the CI/CD pipeline.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eSetup AWS Access\u003c/h1\u003e\n\u003cp\u003eIt is very bad practice to use the root account for much of anything but for\nbootstrapping the account it is necessary, so the first step is to get your\n\u003ccode\u003eAWS_ACCESS_KEY_ID\u003c/code\u003e and \u003ccode\u003eAWS_SECRET_ACCESS_KEY\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eTo do this click your account and choose \u003ccode\u003eSecurity Credentials\u003c/code\u003e in the top\nright:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/security_credentials.png\" height=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eThen choose \u003ccode\u003eCreate Access key\u003c/code\u003e:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/create_access_token.png\" width=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou need to set these environment variables in your shell so that your local\nshell has access to AWS. After you set them you can verify you set them correct\nby running:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ aws sts get-caller-identity\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should get a result similar to:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"UserId\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"Account\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"Arn\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::888888888888:root\"\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eBootstrap\u003c/h2\u003e\n\u003cp\u003eBefore you can manage any of your accounts through Terraform Cloud you'll need\nbootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate\nsecurely and manage AWS Resources on your behalf.\u003c/p\u003e\n\u003cp\u003eI personally prefer doing this in two repositories:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra-bootstrap\u003c/code\u003e: This repository does the bare minimum to hook up terraform\ncloud with your AWS account and stores the state in git.  Its the only infra\nthat will not be controlled by your CI/CD pipeline.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra\u003c/code\u003e: The actual repository where all the rest of your AWS resources are\nmanaged.  It will store state in Terraform Cloud and you can introduce a\nCI/CD pipeline for approving changes.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNote\u003c/strong\u003e: This repository will be generated with the terraform code.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAfter manually creating the git repository \u003ccode\u003einfra-boostrap\u003c/code\u003e in your Github\naccount We will need 3 providers to bootstrap the account \u003ccode\u003eaws\u003c/code\u003e, \u003ccode\u003egithub\u003c/code\u003e, and\n\u003ccode\u003etfe\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eVariables\u003c/h3\u003e\n\u003cp\u003eCreate a \u003ccode\u003e1-variables.tf\u003c/code\u003e where we can define the variables we'll need\nfor creating these resources.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_aws_audience\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"aws.workload.identity\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The audience value to use in run identity tokens\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_hostname\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"app.terraform.io\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The hostname of the TFC or TFE instance you'd like to use with AWS\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_project_name\"\u003c/span\u003e {\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"Default Project\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"The project under which a workspace will be created\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_organization_name\"\u003c/span\u003e {\n  type        = string\n  description = \u003cspan class=\"hljs-string\"\u003e\"The name of your Terraform Cloud organization\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_organization_owner\"\u003c/span\u003e {\n  type        = string\n  description = \u003cspan class=\"hljs-string\"\u003e\"The owner of the TFC organization\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_workspaces\"\u003c/span\u003e {\n  type        = list(string)\n  description = \u003cspan class=\"hljs-string\"\u003e\"The list of TFC workspaces\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_organization\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The organization the repositories are owned by\"\u003c/span\u003e\n  type        = string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_repo_name\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The name of the git reppository we'll create for managing infra\"\u003c/span\u003e\n  type        = string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_default_branch\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The default branch to utilize\"\u003c/span\u003e\n  type        = string\n  default     = \u003cspan class=\"hljs-string\"\u003e\"main\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_oauth_client_id\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The token for the TFC OAuth client shown under VCS providers\"\u003c/span\u003e\n  type        = string\n  default     = null\n}\n\n\u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_root_account_id\"\u003c/span\u003e {\n  description = \u003cspan class=\"hljs-string\"\u003e\"The AWS root account we want to apply these changes to\"\u003c/span\u003e\n  type        = string\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe will use these variables in the later modules but they are mostly metadata\naround the terraform and github accounts you'll need to setup manually.\u003c/p\u003e\n\u003ch3\u003eProviders\u003c/h3\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003e2-main.tf\u003c/code\u003e and define the providers:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e {\n  required_providers {\n    tfe = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"0.41.0\"\u003c/span\u003e\n    }\n\n    aws = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"4.58.0\"\u003c/span\u003e\n    }\n\n    github = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"integrations/github\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"5.18.3\"\u003c/span\u003e\n    }\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n\n  \u003cspan class=\"hljs-comment\"\u003e# Root account, all other accounts should be provisioned\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# via pull requests\u003c/span\u003e\n  allowed_account_ids = [var.aws_root_account_id]\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github\"\u003c/span\u003e {\n  owner = var.github_organization\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe key things there are we define \u003ccode\u003eallowed_account_ids\u003c/code\u003e to prevent us from\nworking against any account that isn't the root and we are using one of the\nvariables we defines earlier.\u003c/p\u003e\n\u003ch3\u003eGithub\u003c/h3\u003e\n\u003cp\u003eWe will utilize \u003ccode\u003eterraform\u003c/code\u003e to create the second git repository where the rest\nof the infrastructure will go. Create a file called \u003ccode\u003e3-github.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_repository\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"repo\"\u003c/span\u003e {\n  name        = var.github_repo_name\n  description = \u003cspan class=\"hljs-string\"\u003e\"Infrastructure Repository\"\u003c/span\u003e\n  visibility  = \u003cspan class=\"hljs-string\"\u003e\"private\"\u003c/span\u003e\n  auto_init   = true\n  has_issues  = true\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_branch_default\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"default\"\u003c/span\u003e {\n  repository = github_repository.repo.name\n  branch     = var.github_default_branch\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eoutput\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"repository_id\"\u003c/span\u003e {\n  value = github_repository.repo.id\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will generate a new repository in your account called \u003ccode\u003einfra\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eTerraform Cloud\u003c/h3\u003e\n\u003cp\u003eNow we need to setup dynamic credentials so the terraform cloud agent is\nallowed to take actions on your behalf.   To do this we'll setup an IAM\nrole and an OIDC provider. Create a file called \u003ccode\u003e4-tfc.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_organization\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"organization\"\u003c/span\u003e {\n  name  = var.tfc_organization_name\n  email = var.tfc_organization_owner\n}\n\n/* AWS will use this TLS certificate to verify that requests for dynamic\ncredentials come from Terraform Cloud.*/\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tls_certificate\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_certificate\"\u003c/span\u003e {\n  url = \u003cspan class=\"hljs-string\"\u003e\"https://\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e\"\u003c/span\u003e\n}\n\n/* sets up an OIDC \u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e in AWS with Terraform Cloud's TLS certificate,\nthe SHA1 fingerprint from the TLS certificate \n*/\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_openid_connect_provider\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc_provider\"\u003c/span\u003e {\n  url            = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tls_certificate.tfc_certificate.url\n  client_id_list = [var.tfc_aws_audience]\n  thumbprint_list = [\n    \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tls_certificate.tfc_certificate.certificates[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].sha1_fingerprint\n  ]\n}\n\n/* Policy to allow TFC to assume the AWS IAM role in our account */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"assume_role\"\u003c/span\u003e {\n  statement {\n    effect = \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\n\n    principals {\n      type        = \u003cspan class=\"hljs-string\"\u003e\"Federated\"\u003c/span\u003e\n      identifiers = [aws_iam_openid_connect_provider.tfc_provider.arn]\n    }\n    condition {\n      test     = \u003cspan class=\"hljs-string\"\u003e\"StringEquals\"\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e:aud\"\u003c/span\u003e\n\n      values = [\n        \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${\u003cspan class=\"hljs-meta\"\u003eone(aws_iam_openid_connect_provider.tfc_provider.client_id_list)\u003c/span\u003e}\u003c/span\u003e\"\u003c/span\u003e\n      ]\n    }\n\n    condition {\n      test     = \u003cspan class=\"hljs-string\"\u003e\"StringLike\"\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003evariable\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${var.tfc_hostname}\u003c/span\u003e:sub\"\u003c/span\u003e\n\n      values = [\n        for workspace in var.tfc_workspaces : \u003cspan class=\"hljs-string\"\u003e\"organization:\u003cspan class=\"hljs-variable\"\u003e${tfe_organization.organization.name}\u003c/span\u003e:project:\u003cspan class=\"hljs-variable\"\u003e${var.tfc_project_name}\u003c/span\u003e:workspace:\u003cspan class=\"hljs-variable\"\u003e${workspace}\u003c/span\u003e:run_phase:*\"\u003c/span\u003e\n      ]\n    }\n    actions = [\u003cspan class=\"hljs-string\"\u003e\"sts:AssumeRoleWithWebIdentity\"\u003c/span\u003e]\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_role\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  name               = \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e\n  assume_role_policy = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.aws_iam_policy_document.assume_role.json\n}\n\n/* Policy for what the TFC agent is allowed to do */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  version = \u003cspan class=\"hljs-string\"\u003e\"2012-10-17\"\u003c/span\u003e\n\n  statement {\n    actions   = [\u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e]\n    effect    = \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\n    resources = [\u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e]\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_policy\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e {\n  name        = \u003cspan class=\"hljs-string\"\u003e\"tfc-agent-access-policy\"\u003c/span\u003e\n  description = \u003cspan class=\"hljs-string\"\u003e\"Access policy for the TFC agent\"\u003c/span\u003e\n  policy      = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.aws_iam_policy_document.tfc-agent.json\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-access-attach\"\u003c/span\u003e {\n  role       = aws_iam_role.tfc-agent.name\n  policy_arn = aws_iam_policy.tfc-agent.arn\n}\n\n/* Fetch an oauth token from the client */\n\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_oauth_client\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github\"\u003c/span\u003e {\n  /* Don't fetch the client if we don't have the client_id */\n  count           = var.github_oauth_client_id != null ? \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e : \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n  oauth_client_id = var.github_oauth_client_id\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_workspace\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"workspaces\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  name         = var.tfc_workspaces[count.index]\n  organization = tfe_organization.organization.name\n\n  working_directory = var.tfc_workspaces[count.index]\n\n  /* This generates a webhook on the github repository so plans are triggered\n  automatically.   We dynamically set the setting because we will not have the\n  oauth client ID on first pass.\n  */\n  dynamic \u003cspan class=\"hljs-string\"\u003e\"vcs_repo\"\u003c/span\u003e {\n    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []\n    content {\n      identifier     = format(\u003cspan class=\"hljs-string\"\u003e\"%s/%s\"\u003c/span\u003e, var.github_organization, github_repository.repo.name)\n      oauth_token_id = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tfe_oauth_client.github[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].oauth_token_id\n    }\n  }\n}\n\n/* These variables tell the agent to use dynamic credentials */\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_variable\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-auth\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  key          = \u003cspan class=\"hljs-string\"\u003e\"TFC_AWS_PROVIDER_AUTH\"\u003c/span\u003e\n  value        = true\n  category     = \u003cspan class=\"hljs-string\"\u003e\"env\"\u003c/span\u003e\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = \u003cspan class=\"hljs-string\"\u003e\"Enable dynamic auth on the TFC agents\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_variable\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfc-role\"\u003c/span\u003e {\n  count        = length(var.tfc_workspaces)\n  key          = \u003cspan class=\"hljs-string\"\u003e\"TFC_AWS_RUN_ROLE_ARN\"\u003c/span\u003e\n  value        = aws_iam_role.tfc-agent.arn\n  category     = \u003cspan class=\"hljs-string\"\u003e\"env\"\u003c/span\u003e\n  workspace_id = tfe_workspace.workspaces[count.index].id\n  description  = \u003cspan class=\"hljs-string\"\u003e\"Tell TFC what Role to run as\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis module is dynamic because there is one piece that will require a\nmanul oauth setup for github.  So the first pass will apply without it\nand then later on we'll create it and run the apply again.\u003c/p\u003e\n\u003ch2\u003eApplying the changes\u003c/h2\u003e\n\u003cp\u003eNow we just need to define our settings for the module and we'll get our\ninfrastructure applied.  Create a file called \u003ccode\u003esettings.auto.tfvars\u003c/code\u003e and\npopulate it with the content for your account.  This is an example of what\nthis should look like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003etfc_organization_name  = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\ntfc_organization_owner = \u003cspan class=\"hljs-string\"\u003e\"john@sontek.net\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# The workspaces you want to create and be able to manage with IaC\u003c/span\u003e\ntfc_workspaces = [\n  \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n]\n\u003cspan class=\"hljs-comment\"\u003e# this can be your username\u003c/span\u003e\ngithub_organization    = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\ngithub_repo_name       = \u003cspan class=\"hljs-string\"\u003e\"sontek-infra\"\u003c/span\u003e\naws_root_account_id    =  \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform login\n❯ terraform init\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should see:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs\"\u003eTerraform has been successfully initialized!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow lets run our plan:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e plan\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should see a result:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003e\u003cspan class=\"hljs-symbol\"\u003ePlan:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e add, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e change, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e destroy.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eApply it to make those resources:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt this point it:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eCreated a terraform cloud organization\u003c/li\u003e\n\u003cli\u003eCreated a terraform cloud workspace\u003c/li\u003e\n\u003cli\u003eCreated a git repository\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eVerify TFC can talk to AWS\u003c/h1\u003e\n\u003cp\u003eTo verify that TFC can communicate with AWS through the dynamic credentials,\nlets clone the repository and make some dummy resources. After you've cloned\nthe repository lets make a folder for the workspace \u003ccode\u003eroot\u003c/code\u003e that we defined in\nbootstrap:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e root\n❯ \u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e root\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow create a \u003ccode\u003e1-providers.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e {\n  cloud {\n    organization = \u003cspan class=\"hljs-string\"\u003e\"sontek\"\u003c/span\u003e\n\n    workspaces {\n      name = \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n    }\n  }\n\n  required_providers {\n    aws = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"4.58.0\"\u003c/span\u003e\n    }\n\n    tfe = {\n      source  = \u003cspan class=\"hljs-string\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\n      version = \u003cspan class=\"hljs-string\"\u003e\"0.42.0\"\u003c/span\u003e\n    }\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eprovider\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n\n  default_tags {\n    tags = {\n      Owner   = \u003cspan class=\"hljs-string\"\u003e\"john@sontek.net\"\u003c/span\u003e\n      Env     = \u003cspan class=\"hljs-string\"\u003e\"Root\"\u003c/span\u003e\n      Service = \u003cspan class=\"hljs-string\"\u003e\"BusinessOperations\"\u003c/span\u003e\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: You should replace \u003ccode\u003eorganization\u003c/code\u003e, \u003ccode\u003eworkspaces.name\u003c/code\u003e, and\n\u003ccode\u003etags.Owner\u003c/code\u003e to be your own values.\u003c/p\u003e\n\u003cp\u003eNow create a small resource to prove everything is working, we'll use SQS for\nthis. Create a file called \u003ccode\u003e2-sqs.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_sqs_queue\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e {\n  name                        = \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e\n  message_retention_seconds = \u003cspan class=\"hljs-number\"\u003e86400\u003c/span\u003e\n  receive_wait_time_seconds = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf you run the plan you should see the resource it wants to create:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform init\n❯ terraform plan\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand you should see the run is executing in terraform cloud:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-arduino\"\u003eRunning plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C\nwill stop streaming the logs, but will \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e stop the plan running remotely.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can click the link it provides to see the logs. Now lets apply this\nresource to see it all working:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should get a response like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-string\"\u003eApply\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecomplete!\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eResources:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eadded,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003echanged,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edestroyed.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo Terraform Cloud has full access to create AWS resources!   The final step\nis to get github running the plan/apply on pull requests. Commit these files\nto your repository and we'll remove them in a pull request. Create a\n\u003ccode\u003e.gitignore\u003c/code\u003e file in the root:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e.\u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e*\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand commit all the files:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ git add *\n❯ git commit -m \u003cspan class=\"hljs-string\"\u003e\"initial infra\"\u003c/span\u003e\n❯ git push origin \u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eGithub VCS Provider\u003c/h1\u003e\n\u003cp\u003eTo setup oauth between github and terraform cloud so it can manage the webhooks\nyou need to login to the [https://app.terraform.io](Terraform Cloud Console) and\ninitiate the connection.\u003c/p\u003e\n\u003cp\u003eSelect the newly created organization and then click \u003ccode\u003eSettings\u003c/code\u003e.  In the sidebar\nthere will be a section \u003ccode\u003eVersion Control\u003c/code\u003e and you want to select \u003ccode\u003eProviders\u003c/code\u003e under\nthat.\u003c/p\u003e\n\u003cp\u003eAt this point you should see an \u003ccode\u003eAdd a VCS Provider\u003c/code\u003e button, you want to select\n\u003ccode\u003eGithub.com (Custom)\u003c/code\u003e:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_vcs_provider.png\" height=\"250\"\u003e\n\u003c/center\u003e\n\u003cp\u003eFollow the on-screen instructions to create a new GitHub OAuth application on your\naccount. For me, I went to \u003ca href=\"https://github.com/settings/applications/new\"\u003ehere\u003c/a\u003e and\nprovided the information TFC displayed:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_github_app.png\" height=\"300\"\u003e\n\u003c/center\u003e\n\u003cp\u003eOn the Github side you need to save the \u003ccode\u003eClient ID\u003c/code\u003e and you need to click\n\u003ccode\u003eGenerate a new client secret\u003c/code\u003e.   Provide those details to terraform cloud and\nthen we should be ready to send our first PR!\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/tfc_oauth_settings.png\" height=\"300\"\u003e\n\u003c/center\u003e\n\u003ch2\u003eFinish Bootstrap\u003c/h2\u003e\n\u003cp\u003eAt this point we need to return to the bootstrap repository and provide it the\nnew OAuth Client ID for its \u003ccode\u003egithub_oauth_client_id\u003c/code\u003e setting.  To get the value\nfor this the easiest way is to drill into the VCS provider in terraform and click\n\u003ccode\u003eEdit Client\u003c/code\u003e.   In the URL you'll see the Client ID, it should start with\n\u003ccode\u003eoc-...\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eNow return back to the \u003ccode\u003ebootstrap\u003c/code\u003e repository and edit \u003ccode\u003esettings.auto.tfvars\u003c/code\u003e and\nset the final setting:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003egithub_oauth_client_id\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"oc-......\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow you should be able to run a plan and see the \u003ccode\u003evcs_repo\u003c/code\u003e get added in-place:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform plan\n\n  ~ update in-place\n\nTerraform will perform the following actions:\n\n  \u003cspan class=\"hljs-comment\"\u003e# tfe_workspace.workspaces[0] will be updated in-place\u003c/span\u003e\n  ~ resource \u003cspan class=\"hljs-string\"\u003e\"tfe_workspace\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"workspaces\"\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e                            = \u003cspan class=\"hljs-string\"\u003e\"ws-...\"\u003c/span\u003e\n        name                          = \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# (20 unchanged attributes hidden)\u003c/span\u003e\n\n      + vcs_repo {\n          + identifier         = \u003cspan class=\"hljs-string\"\u003e\"sontek/sontek-infra\"\u003c/span\u003e\n          + ingress_submodules = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n          + oauth_token_id     = \u003cspan class=\"hljs-string\"\u003e\"ot-...\"\u003c/span\u003e\n        }\n    }\n\nPlan: 0 to add, 1 to change, 0 to destroy.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eApply the change!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e❯ \u003cspan class=\"hljs-keyword\"\u003eterraform\u003c/span\u003e apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter you apply the change, if you go to \u003ccode\u003eSettings\u003c/code\u003e -\u003e \u003ccode\u003eWebhooks\u003c/code\u003e of the \u003ccode\u003einfra\u003c/code\u003e\nrepository that was created earlier you should see a new terraform cloud webhook\nwas created.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/github_webhooks.png\" width=\"350\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eSend your first pull request\u003c/h1\u003e\n\u003cp\u003eNow you should be able to send a pull request tearing down the SQS resource we\ngenerated at the beginning and terraform cloud will take care of the rest! Make\nsure you are on the generated \u003ccode\u003einfra\u003c/code\u003e repo and:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003erm\u003c/span\u003e root/sqs.tf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand commit / push that to a branch and open a pull request. When you merge it\nwill apply the changes.\u003c/p\u003e\n\u003ch1\u003eNext Steps\u003c/h1\u003e\n\u003cp\u003eThis should be good enough for you to manage your AWS cloud infrastructure as\ncode with terraform but I \u003cstrong\u003epersonally\u003c/strong\u003e don't like that terraform cloud applies\nthe changes on merge.  There are a lot of ways where a \u003ccode\u003eplan\u003c/code\u003e can succeed but an\n\u003ccode\u003eapply\u003c/code\u003e will fail and you end up with broken configuration in \u003ccode\u003emain\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eI prefer a worfklow called \u003ccode\u003eapply-before-merge\u003c/code\u003e and in my next post I'll show you\nhow to do that through github actions instead of utilizing the TFC webhook.\u003c/p\u003e\n\u003cp\u003eCheck out that post \u003ca href=\"/blog/2023/aws_from_scratch_apply_before_merge\"\u003ehere\u003c/a\u003e!\u003c/p\u003e\n\u003ch1\u003eHelpful Resources\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform\"\u003eTerraform Dynamic Credentials Tutorial\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration\"\u003eTerraform docs on Dynamic Credentials\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token\"\u003eGithub's understanding OIDC\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","category":"AWS","date":"2023-04-01T00:00:00Z","tags":["AWS","DevOps","SRE"],"title":"AWS From Scratch with Terraform - Setting up your Root Account for IaC (using Terraform Cloud)"}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["2023","aws_from_scratch_root_account"]},"buildId":"tP8bGBoCIY4QddVqUXuR9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>