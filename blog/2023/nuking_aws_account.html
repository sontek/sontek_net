<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="alternate" type="application/rss+xml" title="sontek&#x27;s Engineering Blog" href="/rss.xml"/><title>Wiping an AWS Account with aws-nuke</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/4e645f88d9d5f47b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e645f88d9d5f47b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/95e79f6f6f52c645.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95e79f6f6f52c645.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2e2b8b955a26d1f2.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/771-5e4a02ed896d5599.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-426e76fedd45ec38.js" defer=""></script><script src="/_next/static/dW21R8i18ojKqdpmyQuyF/_buildManifest.js" defer=""></script><script src="/_next/static/dW21R8i18ojKqdpmyQuyF/_ssgManifest.js" defer=""></script><script src="/_next/static/dW21R8i18ojKqdpmyQuyF/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">Wiping an AWS Account with aws-nuke</h1><div class="util_lightText__xcqUE"><time dateTime="2023-06-21T20:00:00-04:00">June 21, 2023</time></div><div><p>When you're an SRE/DevOps engineer you'll end up making AWS accounts and
create a lot of cruft in your sandbox and development accounts. AWS
does not make it easy to clear these up but there is a tool called
<a href="https://github.com/rebuy-de/aws-nuke">aws-nuke</a> that will do it for you!</p>
<h1>Safe Guards</h1>
<p>aws-nuke has a few safeguards in place to prevent inadvertent data loss.
The first of which is it requires you to alias the targetted account. I
like to put <code>nuke</code> in the alias to make it clear.</p>
<pre><code class="hljs language-bash">aws iam create-account-alias --account-alias nuke-&#x3C;account>
</code></pre>
<p>The second safe-guard is the config takes a key called <code>account-blocklist</code>
that will guarantee nuke will not run against it no matter what.</p>
<p>The final safety switch it has is it will not take any action by default,
it will only execute a dry-run.   You need to run the CLI with
<code>--no-dry-run</code> if you want it to take action.</p>
<h1>Getting Started</h1>
<p>You configure <code>aws-nuke</code> with YAML, so the first step is to define that:</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">regions:</span>
  - us-east-1
  - global

<span class="hljs-section">account-blocklist:</span>
  - <span class="hljs-string">"888888888888"</span> <span class="hljs-comment"># production</span>

<span class="hljs-section">accounts:</span>
  <span class="hljs-string">"777777777777"</span>: {} <span class="hljs-comment"># nuke-&#x3C;account></span>
</code></pre>
<p>This will prevent us from nuking our production account and target all resources
in the account we actually want to nuke.</p>
<p>You might want to have it nuke <em>ALL REGIONS</em> in AWS since you may not know which
regions resources are deployed in.   To do this you can query the regions from AWS:</p>
<pre><code class="hljs language-bash">❯ aws ec2 describe-regions --all-regions --query <span class="hljs-string">"Regions[*].RegionName"</span> --output text | xargs -n 1 | <span class="hljs-built_in">sort</span>

af-south-1
ap-east-1
ap-northeast-1
ap-northeast-2
ap-northeast-3
ap-south-1
ap-south-2
ap-southeast-1
ap-southeast-2
ap-southeast-3
ap-southeast-4
ca-central-1
eu-central-1
eu-central-2
eu-north-1
eu-south-1
eu-south-2
eu-west-1
eu-west-2
eu-west-3
me-central-1
me-south-1
sa-east-1
us-east-1
us-east-2
us-west-1
us-west-2
</code></pre>
<p>Which would give you an updated config of:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">regions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">global</span>  <span class="hljs-comment"># Global resources like IAM</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">af-south-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-east-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-northeast-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-northeast-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-northeast-3</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-south-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-south-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-southeast-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-southeast-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-southeast-3</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ap-southeast-4</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ca-central-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-central-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-central-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-north-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-south-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-south-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-west-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-west-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eu-west-3</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">me-central-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">me-south-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">sa-east-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">us-east-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">us-east-2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">us-west-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">us-west-2</span>
</code></pre>
<p>I personally don't recommend targetting all AWS regions at the same time.  It
will generate a lot of output and be slow.  You could do it if necessary but
most people only have a few regions they use and so they can set those directly.
For example it, maybe you only use <code>us-</code> based regions?</p>
<p>So lets run the dry-run and see what it wants to nuke:</p>
<pre><code class="hljs language-bash">❯ aws-nuke -c nuke.yaml
</code></pre>
<p>This should output something like:</p>
<pre><code class="hljs language-bash">Do you really want to nuke the account with the ID 777777777777 and the <span class="hljs-built_in">alias</span> <span class="hljs-string">'nuke-sandbox'</span>?
Do you want to <span class="hljs-built_in">continue</span>? Enter account <span class="hljs-built_in">alias</span> to <span class="hljs-built_in">continue</span>.
> nuke-sandbox
us-east-1 - EC2Subnet - subnet-0cd9975a443a6304b - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2Subnet - subnet-0be39d02e399a371c - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2Subnet - subnet-02d7017bd4730ea63 - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2Subnet - subnet-0ec04b28c32708ab2 - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2Subnet - subnet-0eea1b4be084840ed - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2Subnet - subnet-05a294cc04736012e - [DefaultForAz: <span class="hljs-string">"true"</span>, DefaultVPC: <span class="hljs-string">"true"</span>, OwnerID: <span class="hljs-string">"777777777777"</span>] - would remove
us-east-1 - EC2RouteTable - rtb-0abda0e94015064ca - [DefaultVPC: <span class="hljs-string">"true"</span>] - would remove
us-east-1 - EC2DefaultSecurityGroupRule - sgr-0368525f77bf566ac - [SecurityGroupId: <span class="hljs-string">"sg-0a59900b52ced5e10"</span>] - would remove
us-east-1 - EC2DefaultSecurityGroupRule - sgr-0890a837ed6148729 - [SecurityGroupId: <span class="hljs-string">"sg-0a59900b52ced5e10"</span>] - would remove
us-east-1 - EC2InternetGatewayAttachment - igw-0acfb474f1fd71375 -> vpc-0be5d310ab44c239a - [DefaultVPC: <span class="hljs-string">"true"</span>] - would remove
us-east-1 - SQSQueue - https://sqs.us-east-1.amazonaws.com/777777777777/example-sqs - would remove
global - IAMSAMLProvider - arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE - would remove
global - IAMOpenIDConnectProvider - arn:aws:iam::777777777777:oidc-provider/app.terraform.io - [Arn: <span class="hljs-string">"arn:aws:iam::777777777777:oidc-provider/app.terraform.io"</span>] - would remove
global - IAMPolicy - arn:aws:iam::777777777777:policy/tfc-agent-access-policy - [ARN: <span class="hljs-string">"arn:aws:iam::777777777777:policy/tfc-agent-access-policy"</span>, Name: <span class="hljs-string">"tfc-agent-access-policy"</span>, Path: <span class="hljs-string">"/"</span>, PolicyID: <span class="hljs-string">"ANPA2T6PZOBNWI76TKQRF"</span>] - would remove
global - IAMRole - tfc-agent - [CreateDate: <span class="hljs-string">"2023-04-02T17:55:23Z"</span>, LastUsedDate: <span class="hljs-string">"2023-06-22T13:45:02Z"</span>, Name: <span class="hljs-string">"tfc-agent"</span>, Path: <span class="hljs-string">"/"</span>] - would remove
global - IAMRolePolicyAttachment - tfc-agent -> tfc-agent-access-policy - [PolicyArn: <span class="hljs-string">"arn:aws:iam::777777777777:policy/tfc-agent-access-policy"</span>, PolicyName: <span class="hljs-string">"tfc-agent-access-policy"</span>, RoleCreateDate: <span class="hljs-string">"2023-04-02T17:55:23Z"</span>, RoleLastUsed: <span class="hljs-string">"2023-06-22T13:45:02Z"</span>, RoleName: <span class="hljs-string">"tfc-agent"</span>, RolePath: <span class="hljs-string">"/"</span>] - would remove
Scan complete: 85 total, 19 nukeable, 66 filtered.

The above resources would be deleted with the supplied configuration. Provide --no-dry-run to actually destroy resources.
</code></pre>
<p>This is great, it fully scanned the account and found every resource to delete!
It even wants to delete the DefaultVPC which is usually a good idea.  The one
resource that should catch your eye that you probably do not want to delete:</p>
<ul>
<li><code>arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE</code></li>
</ul>
<p>AWS clearly doesn't want us to delete that!</p>
<h1>Filters</h1>
<p>To prevent nuke from deleting resources you want to keep you can define presets
that you use on each account.  So with our SSO example we want to prevent it
from deleting those resources in a preset.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">presets:</span>
  <span class="hljs-attr">sso:</span>
    <span class="hljs-attr">filters:</span>
      <span class="hljs-attr">IAMSAMLProvider:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"regex"</span>
        <span class="hljs-attr">value:</span> <span class="hljs-string">"AWSSSO_.*_DO_NOT_DELETE"</span>
      <span class="hljs-attr">IAMRole:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"glob"</span>
        <span class="hljs-attr">value:</span> <span class="hljs-string">"AWSReservedSSO_*"</span>
      <span class="hljs-attr">IAMRolePolicyAttachment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"glob"</span>
        <span class="hljs-attr">value:</span> <span class="hljs-string">"AWSReservedSSO_*"</span>
</code></pre>
<p>You can see in this example I'm targetting specific resource types and then
matching them with both <code>regex</code> and <code>glob</code> filter types. These are super
powerful but a lot of times the simpler filters can be used.  I start with
<code>contains</code> filter and then go from there:</p>
<pre><code class="hljs language-yaml">      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">contains</span>
        <span class="hljs-attr">value:</span> <span class="hljs-string">AWSReservedSSO</span>
</code></pre>
<p>Then the other thing you may have noticed is that I was repeating
<code>AWSReservedSSO</code> multiple times.  To reduce that you can use standard YAML
anchors.   So the final config for your preset would look like this:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">presets:</span>
  <span class="hljs-attr">sso:</span>
    <span class="hljs-attr">filters:</span>
      <span class="hljs-attr">_DEFAULT_FILTERS:</span> <span class="hljs-meta">&#x26;DEFAULT</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"contains"</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"DO_NOT_DELETE"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"contains"</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"AWSReservedSSO"</span>

      <span class="hljs-attr">IAMSAMLProvider:</span> <span class="hljs-meta">*DEFAULT</span>
      <span class="hljs-attr">IAMRole:</span> <span class="hljs-meta">*DEFAULT</span>
      <span class="hljs-attr">IAMRolePolicyAttachment:</span> <span class="hljs-meta">*DEFAULT</span>
</code></pre>
<p>Now we can use that preset in our accounts configuration:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">accounts:</span>
  <span class="hljs-attr">"777777777777":</span>
    <span class="hljs-attr">"presets":</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">sso</span>
</code></pre>
<p>So your final config should look something like this:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">regions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">us-east-1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">global</span>

<span class="hljs-attr">account-blocklist:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"888888888888"</span> <span class="hljs-comment"># production</span>


<span class="hljs-attr">presets:</span>
  <span class="hljs-attr">sso:</span>
    <span class="hljs-attr">filters:</span>
      <span class="hljs-attr">_DEFAULT_FILTERS:</span> <span class="hljs-meta">&#x26;DEFAULT</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"contains"</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"DO_NOT_DELETE"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"contains"</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"AWSReservedSSO"</span>

      <span class="hljs-attr">IAMSAMLProvider:</span> <span class="hljs-meta">*DEFAULT</span>
      <span class="hljs-attr">IAMRole:</span> <span class="hljs-meta">*DEFAULT</span>
      <span class="hljs-attr">IAMRolePolicyAttachment:</span> <span class="hljs-meta">*DEFAULT</span>

<span class="hljs-attr">accounts:</span>
  <span class="hljs-attr">"777777777777":</span>
    <span class="hljs-attr">"presets":</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">sso</span>
</code></pre>
<p>When you run this you should see now the resources we want to keep are filtered
out:</p>
<pre><code class="hljs language-bash">global - IAMSAMLProvider - arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE - filtered by config
</code></pre>
<p>Once you are ready and have your filters in place you can run it for real!</p>
<pre><code class="hljs language-bash">❯ aws-nuke -c nuke.yaml --no-dry-run
</code></pre>
<h1>Next steps</h1>
<p>One final note about it is that it does not understand the relationship between
resources and so it could try deleting an EBS volume that is still in use by an
EC2 instance.  There isn't a great solution for this outside of running nuke a
few times.</p>
<p>The tool is well documented and so you can find the rest of information going to
<a href="https://github.com/rebuy-de/aws-nuke">https://github.com/rebuy-de/aws-nuke</a>!</p></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2023","nuking_aws_account"],"path":"2023/nuking_aws_account","contentHtml":"\u003cp\u003eWhen you're an SRE/DevOps engineer you'll end up making AWS accounts and\ncreate a lot of cruft in your sandbox and development accounts. AWS\ndoes not make it easy to clear these up but there is a tool called\n\u003ca href=\"https://github.com/rebuy-de/aws-nuke\"\u003eaws-nuke\u003c/a\u003e that will do it for you!\u003c/p\u003e\n\u003ch1\u003eSafe Guards\u003c/h1\u003e\n\u003cp\u003eaws-nuke has a few safeguards in place to prevent inadvertent data loss.\nThe first of which is it requires you to alias the targetted account. I\nlike to put \u003ccode\u003enuke\u003c/code\u003e in the alias to make it clear.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eaws iam create-account-alias --account-alias nuke-\u0026#x3C;account\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe second safe-guard is the config takes a key called \u003ccode\u003eaccount-blocklist\u003c/code\u003e\nthat will guarantee nuke will not run against it no matter what.\u003c/p\u003e\n\u003cp\u003eThe final safety switch it has is it will not take any action by default,\nit will only execute a dry-run.   You need to run the CLI with\n\u003ccode\u003e--no-dry-run\u003c/code\u003e if you want it to take action.\u003c/p\u003e\n\u003ch1\u003eGetting Started\u003c/h1\u003e\n\u003cp\u003eYou configure \u003ccode\u003eaws-nuke\u003c/code\u003e with YAML, so the first step is to define that:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-makefile\"\u003e\u003cspan class=\"hljs-section\"\u003eregions:\u003c/span\u003e\n  - us-east-1\n  - global\n\n\u003cspan class=\"hljs-section\"\u003eaccount-blocklist:\u003c/span\u003e\n  - \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# production\u003c/span\u003e\n\n\u003cspan class=\"hljs-section\"\u003eaccounts:\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e: {} \u003cspan class=\"hljs-comment\"\u003e# nuke-\u0026#x3C;account\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will prevent us from nuking our production account and target all resources\nin the account we actually want to nuke.\u003c/p\u003e\n\u003cp\u003eYou might want to have it nuke \u003cem\u003eALL REGIONS\u003c/em\u003e in AWS since you may not know which\nregions resources are deployed in.   To do this you can query the regions from AWS:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ aws ec2 describe-regions --all-regions --query \u003cspan class=\"hljs-string\"\u003e\"Regions[*].RegionName\"\u003c/span\u003e --output text | xargs -n 1 | \u003cspan class=\"hljs-built_in\"\u003esort\u003c/span\u003e\n\naf-south-1\nap-east-1\nap-northeast-1\nap-northeast-2\nap-northeast-3\nap-south-1\nap-south-2\nap-southeast-1\nap-southeast-2\nap-southeast-3\nap-southeast-4\nca-central-1\neu-central-1\neu-central-2\neu-north-1\neu-south-1\neu-south-2\neu-west-1\neu-west-2\neu-west-3\nme-central-1\nme-south-1\nsa-east-1\nus-east-1\nus-east-2\nus-west-1\nus-west-2\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhich would give you an updated config of:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eregions:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eglobal\u003c/span\u003e  \u003cspan class=\"hljs-comment\"\u003e# Global resources like IAM\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eaf-south-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-east-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-northeast-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-northeast-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-northeast-3\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-south-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-south-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-southeast-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-southeast-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-southeast-3\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eap-southeast-4\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eca-central-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-central-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-central-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-north-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-south-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-south-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-west-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-west-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eeu-west-3\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eme-central-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eme-south-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esa-east-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus-east-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus-east-2\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus-west-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus-west-2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI personally don't recommend targetting all AWS regions at the same time.  It\nwill generate a lot of output and be slow.  You could do it if necessary but\nmost people only have a few regions they use and so they can set those directly.\nFor example it, maybe you only use \u003ccode\u003eus-\u003c/code\u003e based regions?\u003c/p\u003e\n\u003cp\u003eSo lets run the dry-run and see what it wants to nuke:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ aws-nuke -c nuke.yaml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis should output something like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eDo you really want to nuke the account with the ID 777777777777 and the \u003cspan class=\"hljs-built_in\"\u003ealias\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'nuke-sandbox'\u003c/span\u003e?\nDo you want to \u003cspan class=\"hljs-built_in\"\u003econtinue\u003c/span\u003e? Enter account \u003cspan class=\"hljs-built_in\"\u003ealias\u003c/span\u003e to \u003cspan class=\"hljs-built_in\"\u003econtinue\u003c/span\u003e.\n\u003e nuke-sandbox\nus-east-1 - EC2Subnet - subnet-0cd9975a443a6304b - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2Subnet - subnet-0be39d02e399a371c - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2Subnet - subnet-02d7017bd4730ea63 - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2Subnet - subnet-0ec04b28c32708ab2 - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2Subnet - subnet-0eea1b4be084840ed - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2Subnet - subnet-05a294cc04736012e - [DefaultForAz: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e, OwnerID: \u003cspan class=\"hljs-string\"\u003e\"777777777777\"\u003c/span\u003e] - would remove\nus-east-1 - EC2RouteTable - rtb-0abda0e94015064ca - [DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e] - would remove\nus-east-1 - EC2DefaultSecurityGroupRule - sgr-0368525f77bf566ac - [SecurityGroupId: \u003cspan class=\"hljs-string\"\u003e\"sg-0a59900b52ced5e10\"\u003c/span\u003e] - would remove\nus-east-1 - EC2DefaultSecurityGroupRule - sgr-0890a837ed6148729 - [SecurityGroupId: \u003cspan class=\"hljs-string\"\u003e\"sg-0a59900b52ced5e10\"\u003c/span\u003e] - would remove\nus-east-1 - EC2InternetGatewayAttachment - igw-0acfb474f1fd71375 -\u003e vpc-0be5d310ab44c239a - [DefaultVPC: \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e] - would remove\nus-east-1 - SQSQueue - https://sqs.us-east-1.amazonaws.com/777777777777/example-sqs - would remove\nglobal - IAMSAMLProvider - arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE - would remove\nglobal - IAMOpenIDConnectProvider - arn:aws:iam::777777777777:oidc-provider/app.terraform.io - [Arn: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::777777777777:oidc-provider/app.terraform.io\"\u003c/span\u003e] - would remove\nglobal - IAMPolicy - arn:aws:iam::777777777777:policy/tfc-agent-access-policy - [ARN: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::777777777777:policy/tfc-agent-access-policy\"\u003c/span\u003e, Name: \u003cspan class=\"hljs-string\"\u003e\"tfc-agent-access-policy\"\u003c/span\u003e, Path: \u003cspan class=\"hljs-string\"\u003e\"/\"\u003c/span\u003e, PolicyID: \u003cspan class=\"hljs-string\"\u003e\"ANPA2T6PZOBNWI76TKQRF\"\u003c/span\u003e] - would remove\nglobal - IAMRole - tfc-agent - [CreateDate: \u003cspan class=\"hljs-string\"\u003e\"2023-04-02T17:55:23Z\"\u003c/span\u003e, LastUsedDate: \u003cspan class=\"hljs-string\"\u003e\"2023-06-22T13:45:02Z\"\u003c/span\u003e, Name: \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e, Path: \u003cspan class=\"hljs-string\"\u003e\"/\"\u003c/span\u003e] - would remove\nglobal - IAMRolePolicyAttachment - tfc-agent -\u003e tfc-agent-access-policy - [PolicyArn: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::777777777777:policy/tfc-agent-access-policy\"\u003c/span\u003e, PolicyName: \u003cspan class=\"hljs-string\"\u003e\"tfc-agent-access-policy\"\u003c/span\u003e, RoleCreateDate: \u003cspan class=\"hljs-string\"\u003e\"2023-04-02T17:55:23Z\"\u003c/span\u003e, RoleLastUsed: \u003cspan class=\"hljs-string\"\u003e\"2023-06-22T13:45:02Z\"\u003c/span\u003e, RoleName: \u003cspan class=\"hljs-string\"\u003e\"tfc-agent\"\u003c/span\u003e, RolePath: \u003cspan class=\"hljs-string\"\u003e\"/\"\u003c/span\u003e] - would remove\nScan complete: 85 total, 19 nukeable, 66 filtered.\n\nThe above resources would be deleted with the supplied configuration. Provide --no-dry-run to actually destroy resources.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is great, it fully scanned the account and found every resource to delete!\nIt even wants to delete the DefaultVPC which is usually a good idea.  The one\nresource that should catch your eye that you probably do not want to delete:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003earn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAWS clearly doesn't want us to delete that!\u003c/p\u003e\n\u003ch1\u003eFilters\u003c/h1\u003e\n\u003cp\u003eTo prevent nuke from deleting resources you want to keep you can define presets\nthat you use on each account.  So with our SSO example we want to prevent it\nfrom deleting those resources in a preset.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003epresets:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003esso:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003efilters:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMSAMLProvider:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"regex\"\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"AWSSSO_.*_DO_NOT_DELETE\"\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRole:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"glob\"\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"AWSReservedSSO_*\"\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRolePolicyAttachment:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"glob\"\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"AWSReservedSSO_*\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can see in this example I'm targetting specific resource types and then\nmatching them with both \u003ccode\u003eregex\u003c/code\u003e and \u003ccode\u003eglob\u003c/code\u003e filter types. These are super\npowerful but a lot of times the simpler filters can be used.  I start with\n\u003ccode\u003econtains\u003c/code\u003e filter and then go from there:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003econtains\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eAWSReservedSSO\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen the other thing you may have noticed is that I was repeating\n\u003ccode\u003eAWSReservedSSO\u003c/code\u003e multiple times.  To reduce that you can use standard YAML\nanchors.   So the final config for your preset would look like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003epresets:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003esso:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003efilters:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e_DEFAULT_FILTERS:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e\u0026#x26;DEFAULT\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"contains\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"DO_NOT_DELETE\"\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"contains\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"AWSReservedSSO\"\u003c/span\u003e\n\n      \u003cspan class=\"hljs-attr\"\u003eIAMSAMLProvider:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRole:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRolePolicyAttachment:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can use that preset in our accounts configuration:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eaccounts:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\"777777777777\":\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"presets\":\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esso\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo your final config should look something like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eregions:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus-east-1\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eglobal\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eaccount-blocklist:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"888888888888\"\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# production\u003c/span\u003e\n\n\n\u003cspan class=\"hljs-attr\"\u003epresets:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003esso:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003efilters:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e_DEFAULT_FILTERS:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e\u0026#x26;DEFAULT\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"contains\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"DO_NOT_DELETE\"\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"contains\"\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003evalue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"AWSReservedSSO\"\u003c/span\u003e\n\n      \u003cspan class=\"hljs-attr\"\u003eIAMSAMLProvider:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRole:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eIAMRolePolicyAttachment:\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003e*DEFAULT\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eaccounts:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\"777777777777\":\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"presets\":\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esso\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen you run this you should see now the resources we want to keep are filtered\nout:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eglobal - IAMSAMLProvider - arn:aws:iam::777777777777:saml-provider/AWSSSO_254abb4071f10b25_DO_NOT_DELETE - filtered by config\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce you are ready and have your filters in place you can run it for real!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ aws-nuke -c nuke.yaml --no-dry-run\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eNext steps\u003c/h1\u003e\n\u003cp\u003eOne final note about it is that it does not understand the relationship between\nresources and so it could try deleting an EBS volume that is still in use by an\nEC2 instance.  There isn't a great solution for this outside of running nuke a\nfew times.\u003c/p\u003e\n\u003cp\u003eThe tool is well documented and so you can find the rest of information going to\n\u003ca href=\"https://github.com/rebuy-de/aws-nuke\"\u003ehttps://github.com/rebuy-de/aws-nuke\u003c/a\u003e!\u003c/p\u003e","category":"AWS","date":"2023-06-21T20:00:00-04:00","tags":["AWS","DevOps","SRE"],"title":"Wiping an AWS Account with aws-nuke"}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["2023","nuking_aws_account"]},"buildId":"dW21R8i18ojKqdpmyQuyF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>