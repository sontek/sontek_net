<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="alternate" type="application/rss+xml" title="sontek&#x27;s Engineering Blog" href="/rss.xml"/><title>AWS From Scratch with Terraform - Setting up your Root Account for IaC  with Terraform Cloud and Github actions.</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/c9439d4f00292099.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c9439d4f00292099.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e64130af1ba1a327.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e64130af1ba1a327.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e535547a4fdaa691.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/790-a3aa35eb62ec874e.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-c6e585d86e012327.js" defer=""></script><script src="/_next/static/AoGbC8xlMEkyyIwWs3twS/_buildManifest.js" defer=""></script><script src="/_next/static/AoGbC8xlMEkyyIwWs3twS/_ssgManifest.js" defer=""></script><script src="/_next/static/AoGbC8xlMEkyyIwWs3twS/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">AWS From Scratch with Terraform - Setting up your Root Account for IaC  with Terraform Cloud and Github actions.</h1><div class="util_lightText__xcqUE"><time dateTime="2023-06-23T00:00:00Z">June 23, 2023</time></div><div><p>Following this article will get you setup with an AWS Root account that can be
managed through through Terraform Cloud with OIDC and github actions. As a best practice you
should not keep long-lived access keys in your CI/CD pipelines when
deploying to AWS, instead you should use OIDC (OpenID Connect) to securely
deploy to AWS when using Terraform Cloud or Github Actions.</p>
<iframe width="854" height="480" src="https://www.youtube.com/embed/3oZd1m8_KIo" title="AWS From Scratch - Preparing your account to be managed by IaC via Terraform and Github Actions" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;web-share" allowfullscreen></iframe>
<h1>TL;DR</h1>
<p>Download all the terraform from the blog post here:</p>
<ul>
<li><a href="https://github.com/sontek/aws-apply-before-merge">https://github.com/sontek/aws-apply-before-merge</a></li>
<li><a href="https://github.com/sontek/aws-terraform-github-actions">https://github.com/sontek/aws-terraform-github-actions</a></li>
</ul>
<h1>How does OIDC work</h1>
<p>OIDC enables us to request a short-lived access token directly from AWS. We
just have to create trust relationship that controls which workflows are able
to request the access tokens.</p>
<ul>
<li>No need to duplicate AWS credentials as long-lived GitHub secrets.</li>
<li>Since we are using a short-lived access token that is only valid for a single
job there is no reason to worry about rotating secrets.</li>
</ul>
<p>The following diagram gives an overview of how we can use Terraform Cloud's
OIDC provider to integrate with AWS:</p>
<div class="remark-mermaid remark-mermaid-default"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 843.078125 320" style="max-width: 843.078px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:2px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span,#my-svg p{color:#333;}#my-svg .label text,#my-svg span,#my-svg p{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .flowchart-label text{text-anchor:middle;}#my-svg .node .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:#e8e8e8;text-align:center;}#my-svg .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span,#my-svg p{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="6" viewBox="0 0 10 10" class="marker flowchart" id="my-svg_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart" id="my-svg_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart" id="my-svg_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart" id="my-svg_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart" id="my-svg_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart" id="my-svg_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token" id="L-AWS-Token-0" d="M185.671875,134.5L181.50520833333334,134.5C177.33854166666666,134.5,169.00520833333334,134.5,153.0306361743634,145.2794461651524C137.05606401539345,156.0588923303048,113.4402530307869,177.61778466060957,101.63234753848364,188.39723082576197L89.82444204618037,199.17667699091436"></path><path marker-end="url(#my-svg_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform" id="L-Token-Terraform-0" d="M85.91019081858407,235.75L98.37047151548673,247.125C110.83075221238937,258.5,135.75131360619469,281.25,164.46289638643069,292.625C193.17447916666666,304,225.67708333333334,304,258.1796875,304C290.6822916666667,304,323.1848958333333,304,359.3528645833333,304C395.5208333333333,304,435.3541666666667,304,475.1875,304C515.0208333333334,304,554.8541666666666,304,584.9583299079444,297.2781483582884C615.0624931492222,290.55629671657675,635.4374862984442,277.1125934331535,645.6249828730553,270.3907417914419L655.8124794476664,263.66889014973026"></path><path marker-end="url(#my-svg_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT" id="L-Terraform-JWT-0" d="M660.2362877949853,177.75L649.3114898291544,170.54166666666666C638.3866918633236,163.33333333333334,616.5370959316618,148.91666666666666,602.3289646324976,141.70833333333334C588.1208333333333,134.5,581.5541666666667,134.5,578.2708333333334,134.5L574.9875,134.5"></path><path marker-end="url(#my-svg_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS" id="L-JWT-AWS-0" d="M380.6875,134.5L376.5208333333333,134.5C372.3541666666667,134.5,364.0208333333333,134.5,356.5708333333334,134.5C349.12083333333334,134.5,342.5541666666666,134.5,339.2708333333333,134.5L335.9875,134.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(621.1171875, 169.75)" class="root"><g class="clusters"><g id="Terraform" class="cluster default flowchart-label"><rect height="83" width="206.890625" y="8" x="-0.9296875" ry="0" rx="0" style=""></rect><g transform="translate(-0.9296875, 8)" class="cluster-label"><foreignObject height="18" width="206.890625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Terraform Cloud Workflow #2</span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(102.515625, 49.5)" id="flowchart-OIDCProvider-3" class="node default default flowchart-label"><rect height="33" width="119.03125" y="-16.5" x="-59.515625" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-52.015625, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="104.03125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">OIDC Provider</span></div></foreignObject></g></g></g></g><g transform="translate(178.171875, -8)" class="root"><g class="clusters"><g id="AWS" class="cluster default flowchart-label"><rect height="269" width="145.015625" y="8" x="8" ry="0" rx="0" style=""></rect><g transform="translate(51.4609375, 8)" class="cluster-label"><foreignObject height="18" width="58.09375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">AWS #1</span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(80.5078125, 59.5)" id="flowchart-OIDC-0" class="node default default flowchart-label"><rect height="33" width="95.015625" y="-16.5" x="-47.5078125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-40.0078125, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="80.015625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">OIDC Trust</span></div></foreignObject></g></g><g transform="translate(80.5078125, 142.5)" id="flowchart-Roles-1" class="node default default flowchart-label"><rect height="33" width="55.90625" y="-16.5" x="-27.953125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-20.453125, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="40.90625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Roles</span></div></foreignObject></g></g><g transform="translate(80.5078125, 225.5)" id="flowchart-Resources-2" class="node default default flowchart-label"><rect height="33" width="91.484375" y="-16.5" x="-45.7421875" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-38.2421875, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="76.484375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Resources</span></div></foreignObject></g></g></g></g><g transform="translate(67.8359375, 219.25)" id="flowchart-Token-5" class="node default default flowchart-label"><rect height="33" width="135.671875" y="-16.5" x="-67.8359375" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-60.3359375, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="120.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Access Token #4</span></div></foreignObject></g></g><g transform="translate(475.1875, 134.5)" id="flowchart-JWT-8" class="node default default flowchart-label"><rect height="33" width="189" y="-16.5" x="-94.5" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-87, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="174"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JWT &#x26; Cloud Role ID #3</span></div></foreignObject></g></g></g></g></g></svg></div>
<ol>
<li>In AWS, create an OIDC trust between a role and our terraform cloud
workflow(s) that need access to the cloud.</li>
<li>Every time a job runs, TFC's OIDC Provider auto-generates an OIDC token.
This token contains multiple claims to establish a security-hardened and
verifiable identity about the specific workflow that is trying to authenticate.</li>
<li>Request this token from TFC's OIDC provider, and present it to AWS</li>
<li>Once AWS successfully validates the claims presented in the token, it then
provides a short-lived cloud access token that is available only for the duration
of the job.</li>
</ol>
<h1>What does this post accomplish</h1>
<ul>
<li>Setup a root AWS account that is managed througuh terraform</li>
<li>Setup OIDC authentication with Terraform Cloud so it can talk to AWS</li>
<li>Setup Github Actions authentication with Terraform Cloud so we can run plan
and apply through the CI/CD pipeline.</li>
</ul>
<h1>Setup AWS Access</h1>
<p>It is very bad practice to use the root account for much of anything but for
bootstrapping the account it is necessary, so the first step is to get your
<code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></p>
<p>To do this click your account and choose <code>Security Credentials</code> in the top
right:</p>
<center>
<img src="/images/posts/aws_root_account/security_credentials.png" height="200">
</center>
<p>Then choose <code>Create Access key</code>:</p>
<center>
<img src="/images/posts/aws_root_account/create_access_token.png" width="200">
</center>
<p>You need to set these environment variables in your shell so that your local
shell has access to AWS. After you set them you can verify you set them correct
by running:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">aws</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">sts</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">get-caller-identity</span></span></code></pre></div>
<p>and you should get a result similar to:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="json" data-theme="default"><code data-language="json" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">"UserId"</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">"777777777777"</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">"Account"</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">"888888888888"</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">"Arn"</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">"arn:aws:iam::888888888888:root"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<h2>Bootstrap</h2>
<p>Before you can manage any of your accounts through Terraform Cloud you'll need
bootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate
securely and manage AWS Resources on your behalf.</p>
<p>I personally prefer doing this in two repositories:</p>
<ul>
<li>
<p><code>infra-bootstrap</code>: This repository does the bare minimum to hook up terraform
cloud with your AWS account and stores the state in git.  Its the only infra
that will not be controlled by your CI/CD pipeline.ccccccug</p>
</li>
<li>
<p><code>infra</code>: The actual repository where all the rest of your AWS resources are
managed.  It will store state in Terraform Cloud and you can introduce a
CI/CD pipeline for approving changes.</p>
<p><strong>Note</strong>: This repository will be generated with the terraform code.</p>
</li>
</ul>
<p>After manually creating the git repository <code>infra-boostrap</code> in your Github
account We will need 3 providers to bootstrap the account <code>aws</code>, <code>github</code>, and
<code>tfe</code>.</p>
<h3>Variables</h3>
<p>Create a <code>1-variables.tf</code> where we can define the variables we'll need
for creating these resources.</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_aws_audience"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  default</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"aws.workload.identity"</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The audience value to use in run identity tokens"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_hostname"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  default</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"app.terraform.io"</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The hostname of the TFC or TFE instance you'd like to use with AWS"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_project_name"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  default</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Default Project"</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The project under which a workspace will be created"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_organization_name"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The name of your Terraform Cloud organization"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_organization_owner"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The owner of the TFC organization"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_workspaces"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">list</span><span style="color: #ADBAC7">(</span><span style="color: #F47067">string</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The list of TFC workspaces"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_organization"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The organization the repositories are owned by"</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_repo_name"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The name of the git reppository we'll create for managing infra"</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_default_branch"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The default branch to utilize"</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">  default</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"main"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">variable</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_root_account_id"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"The AWS root account we want to apply these changes to"</span></span>
<span data-line=""><span style="color: #ADBAC7">  type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #F47067">string</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p>We will use these variables in the later modules but they are mostly metadata
around the terraform and github accounts you'll need to setup manually.</p>
<h3>Providers</h3>
<p>Create a file called <code>2-providers.tf</code> and define the providers:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">terraform</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">required_providers</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    tfe</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      source  </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"hashicorp/tfe"</span></span>
<span data-line=""><span style="color: #ADBAC7">      version </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"0.41.0"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    aws</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      source  </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"hashicorp/aws"</span></span>
<span data-line=""><span style="color: #ADBAC7">      version </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"4.58.0"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    github</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      source  </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"integrations/github"</span></span>
<span data-line=""><span style="color: #ADBAC7">      version </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"5.18.3"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">provider</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  region</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"us-east-1"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #768390"># Root account, all other accounts should be provisioned</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #768390"># via pull requests</span></span>
<span data-line=""><span style="color: #ADBAC7">  allowed_account_ids</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">aws_root_account_id]</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">provider</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  owner</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">github_organization</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p>The key things there are we define <code>allowed_account_ids</code> to prevent us from
working against any account that isn't the root and we are using one of the
variables we defines earlier.</p>
<h3>Github</h3>
<p>We will utilize <code>terraform</code> to create the second git repository where the rest
of the infrastructure will go. Create a file called <code>3-github.tf</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_repository"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"repo"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">github_repo_name</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Infrastructure Repository"</span></span>
<span data-line=""><span style="color: #ADBAC7">  visibility</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"private"</span></span>
<span data-line=""><span style="color: #ADBAC7">  auto_init</span><span style="color: #F69D50">   </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">true</span></span>
<span data-line=""><span style="color: #ADBAC7">  has_issues</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">true</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_branch_default"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"default"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  repository</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">github_repository</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">repo</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span></span>
<span data-line=""><span style="color: #ADBAC7">  branch</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">github_default_branch</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">data</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_team"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"owners"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">         </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"owners"</span></span>
<span data-line=""><span style="color: #ADBAC7">  organization</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">tfe_organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_team_token"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_actions_token"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  team_id</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">data</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfe_team</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">owners</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">id</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"github_actions_secret"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_secret"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  repository</span><span style="color: #F69D50">      </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">github_repository</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">repo</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span></span>
<span data-line=""><span style="color: #ADBAC7">  secret_name</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"TFE_TOKEN"</span></span>
<span data-line=""><span style="color: #ADBAC7">  plaintext_value</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">tfe_team_token</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">github_actions_token</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">token</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">output</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"repository_id"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  value</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">github_repository</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">repo</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">id</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p>This will generate a new repository in your account called <code>infra</code>.</p>
<p>For the terraform provider to have access to github you need to create a new
personal access token with full <code>repo</code> access and set it as an environment
variable named <code>GITHUB_TOKEN</code>.</p>
<h3>Terraform Cloud</h3>
<p>Now we need to setup dynamic credentials so the terraform cloud agent is
allowed to take actions on your behalf.   To do this we'll setup an IAM
role and an OIDC provider. Create a file called <code>4-tfc.tf</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_organization"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"organization"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_organization_name</span></span>
<span data-line=""><span style="color: #ADBAC7">  email</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_organization_owner</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390">/* AWS will use this TLS certificate to verify that requests for dynamic</span></span>
<span data-line=""><span style="color: #768390">credentials come from Terraform Cloud.*/</span></span>
<span data-line=""><span style="color: #F69D50">data</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tls_certificate"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_certificate"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  url</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"https://</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_hostname</span><span style="color: #F47067">}</span><span style="color: #96D0FF">"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390">/* sets up an OIDC provider in AWS with Terraform Cloud's TLS certificate,</span></span>
<span data-line=""><span style="color: #768390">the SHA1 fingerprint from the TLS certificate</span></span>
<span data-line=""><span style="color: #768390">*/</span></span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_openid_connect_provider"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc_provider"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  url</span><span style="color: #F69D50">            </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">data</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tls_certificate</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_certificate</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">url</span></span>
<span data-line=""><span style="color: #ADBAC7">  client_id_list</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_aws_audience]</span></span>
<span data-line=""><span style="color: #ADBAC7">  thumbprint_list</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span></span>
<span data-line=""><span style="color: #ADBAC7">    data</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tls_certificate</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_certificate</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">certificates[</span><span style="color: #6CB6FF">0</span><span style="color: #ADBAC7">]</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">sha1_fingerprint</span></span>
<span data-line=""><span style="color: #ADBAC7">  ]</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390">/* Policy to allow TFC to assume the AWS IAM role in our account */</span></span>
<span data-line=""><span style="color: #F69D50">data</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_policy_document"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"assume_role"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">statement</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    effect</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Allow"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">principals</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">      type</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Federated"</span></span>
<span data-line=""><span style="color: #ADBAC7">      identifiers</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[aws_iam_openid_connect_provider</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_provider</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">arn]</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">condition</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">      test</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"StringEquals"</span></span>
<span data-line=""><span style="color: #ADBAC7">      variable</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_hostname</span><span style="color: #F47067">}</span><span style="color: #96D0FF">:aud"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">      values</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">"</span><span style="color: #F47067">${</span><span style="color: #6CB6FF">one</span><span style="color: #96D0FF">(aws_iam_openid_connect_provider</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_provider</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">client_id_list</span><span style="color: #96D0FF">)</span><span style="color: #F47067">}</span><span style="color: #96D0FF">"</span></span>
<span data-line=""><span style="color: #ADBAC7">      ]</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">condition</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">      test</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"StringLike"</span></span>
<span data-line=""><span style="color: #ADBAC7">      variable</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_hostname</span><span style="color: #F47067">}</span><span style="color: #96D0FF">:sub"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">      values</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">for</span><span style="color: #ADBAC7"> workspace </span><span style="color: #F47067">in</span><span style="color: #ADBAC7"> var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces </span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"organization:</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">tfe_organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span><span style="color: #F47067">}</span><span style="color: #96D0FF">:project:</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_project_name</span><span style="color: #F47067">}</span><span style="color: #96D0FF">:workspace:</span><span style="color: #F47067">${</span><span style="color: #ADBAC7">workspace</span><span style="color: #F47067">}</span><span style="color: #96D0FF">:run_phase:*"</span></span>
<span data-line=""><span style="color: #ADBAC7">      ]</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">    actions</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span><span style="color: #96D0FF">"sts:AssumeRoleWithWebIdentity"</span><span style="color: #ADBAC7">]</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_role"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-agent"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">               </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"tfc-agent"</span></span>
<span data-line=""><span style="color: #ADBAC7">  assume_role_policy</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">data</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">aws_iam_policy_document</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">assume_role</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">json</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390">/* Policy for what the TFC agent is allowed to do */</span></span>
<span data-line=""><span style="color: #F69D50">data</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_policy_document"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-agent"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  version</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"2012-10-17"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">statement</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    actions</span><span style="color: #F69D50">   </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span><span style="color: #96D0FF">"*"</span><span style="color: #ADBAC7">]</span></span>
<span data-line=""><span style="color: #ADBAC7">    effect</span><span style="color: #F69D50">    </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Allow"</span></span>
<span data-line=""><span style="color: #ADBAC7">    resources</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span><span style="color: #96D0FF">"*"</span><span style="color: #ADBAC7">]</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_policy"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-agent"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"tfc-agent-access-policy"</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Access policy for the TFC agent"</span></span>
<span data-line=""><span style="color: #ADBAC7">  policy</span><span style="color: #F69D50">      </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">data</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">aws_iam_policy_document</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc-agent</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">json</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_iam_role_policy_attachment"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-access-attach"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  role</span><span style="color: #F69D50">       </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">aws_iam_role</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc-agent</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span></span>
<span data-line=""><span style="color: #ADBAC7">  policy_arn</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">aws_iam_policy</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc-agent</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">arn</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_workspace"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"workspaces"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  count</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">length</span><span style="color: #ADBAC7">(var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces)</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">         </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces[count</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">index]</span></span>
<span data-line=""><span style="color: #ADBAC7">  organization</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">tfe_organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">organization</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">name</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  working_directory</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces[count</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">index]</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390">/* These variables tell the agent to use dynamic credentials */</span></span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_variable"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-auth"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  count</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">length</span><span style="color: #ADBAC7">(var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces)</span></span>
<span data-line=""><span style="color: #ADBAC7">  key</span><span style="color: #F69D50">          </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"TFC_AWS_PROVIDER_AUTH"</span></span>
<span data-line=""><span style="color: #ADBAC7">  value</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">true</span></span>
<span data-line=""><span style="color: #ADBAC7">  category</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"env"</span></span>
<span data-line=""><span style="color: #ADBAC7">  workspace_id</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">tfe_workspace</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">workspaces[count</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">index]</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">id</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Enable dynamic auth on the TFC agents"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfe_variable"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"tfc-role"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  count</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">length</span><span style="color: #ADBAC7">(var</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc_workspaces)</span></span>
<span data-line=""><span style="color: #ADBAC7">  key</span><span style="color: #F69D50">          </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"TFC_AWS_RUN_ROLE_ARN"</span></span>
<span data-line=""><span style="color: #ADBAC7">  value</span><span style="color: #F69D50">        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">aws_iam_role</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">tfc-agent</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">arn</span></span>
<span data-line=""><span style="color: #ADBAC7">  category</span><span style="color: #F69D50">     </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"env"</span></span>
<span data-line=""><span style="color: #ADBAC7">  workspace_id</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">tfe_workspace</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">workspaces[count</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">index]</span><span style="color: #F47067">.</span><span style="color: #ADBAC7">id</span></span>
<span data-line=""><span style="color: #ADBAC7">  description</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"Tell TFC what Role to run as"</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p>This module is dynamic because there is one piece that will require a
manual oauth setup for github.  So the first pass will apply without it
and then later on we'll create it and run the apply again.</p>
<h2>Applying the changes</h2>
<p>Now we just need to define our settings for the module and we'll get our
infrastructure applied.  Create a file called <code>settings.auto.tfvars</code> and
populate it with the content for your account.  This is an example of what
this should look like:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #ADBAC7">tfc_organization_name</span><span style="color: #F69D50">  </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"sontek"</span></span>
<span data-line=""><span style="color: #ADBAC7">tfc_organization_owner</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"john@sontek.net"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390"># The workspaces you want to create and be able to manage with IaC</span></span>
<span data-line=""><span style="color: #ADBAC7">tfc_workspaces</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">[</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #96D0FF">"root"</span></span>
<span data-line=""><span style="color: #ADBAC7">]</span></span>
<span data-line=""><span style="color: #768390"># this can be your username</span></span>
<span data-line=""><span style="color: #ADBAC7">github_organization</span><span style="color: #F69D50">    </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"sontek"</span></span>
<span data-line=""><span style="color: #ADBAC7">github_repo_name</span><span style="color: #F69D50">       </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"sontek-infra"</span></span>
<span data-line=""><span style="color: #ADBAC7">aws_root_account_id</span><span style="color: #F69D50">    </span><span style="color: #F47067">=</span><span style="color: #F69D50">  </span><span style="color: #96D0FF">"888888888888"</span></span></code></pre></div>
<p>Now run:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">terraform</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">login</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">terraform</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">init</span></span></code></pre></div>
<p>and you should see:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">Terraform has been successfully initialized!</span></span></code></pre></div>
<p>Now lets run our plan:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">❯ terraform plan</span></span></code></pre></div>
<p>You should see a result:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">Plan: 10 to add, 0 to change, 0 to destroy.</span></span></code></pre></div>
<p>Apply it to make those resources:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">❯ terraform apply</span></span></code></pre></div>
<p>At this point it:</p>
<ol>
<li>Created a terraform cloud organization</li>
<li>Created a terraform cloud workspace</li>
<li>Created a git repository</li>
</ol>
<h1>Verify TFC can talk to AWS</h1>
<p>To verify that TFC can communicate with AWS through the dynamic credentials,
lets clone the <em>NEW</em> repository we just generated and make some dummy resources. After
you've cloned the repository lets make a folder for the workspace <code>root</code> that we
defined in bootstrap:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">mkdir</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">root</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">cd</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">root</span></span></code></pre></div>
<p>Now create a <code>1-providers.tf</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">terraform</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">cloud</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    organization</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"sontek"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">workspaces</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">      name</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"root"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">required_providers</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    aws</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      source  </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"hashicorp/aws"</span></span>
<span data-line=""><span style="color: #ADBAC7">      version </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"4.58.0"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    tfe</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      source  </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"hashicorp/tfe"</span></span>
<span data-line=""><span style="color: #ADBAC7">      version </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"0.42.0"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F69D50">provider</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  region</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"us-east-1"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #F69D50">default_tags</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">    tags</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">      Owner   </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"john@sontek.net"</span></span>
<span data-line=""><span style="color: #ADBAC7">      Env     </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"Root"</span></span>
<span data-line=""><span style="color: #ADBAC7">      Service </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"BusinessOperations"</span></span>
<span data-line=""><span style="color: #ADBAC7">    }</span></span>
<span data-line=""><span style="color: #ADBAC7">  }</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p><strong>NOTE</strong>: You should replace <code>organization</code>, <code>workspaces.name</code>, and
<code>tags.Owner</code> to be your own values.</p>
<p>Now create a small resource to prove everything is working, we'll use SQS for
this. Create a file called <code>2-sqs.tf</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="hcl" data-theme="default"><code data-language="hcl" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">resource</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"aws_sqs_queue"</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">"example-sqs"</span><span style="color: #ADBAC7"> {</span></span>
<span data-line=""><span style="color: #ADBAC7">  name</span><span style="color: #F69D50">                        </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #96D0FF">"example-sqs"</span></span>
<span data-line=""><span style="color: #ADBAC7">  message_retention_seconds</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">86400</span></span>
<span data-line=""><span style="color: #ADBAC7">  receive_wait_time_seconds</span><span style="color: #F69D50"> </span><span style="color: #F47067">=</span><span style="color: #F69D50"> </span><span style="color: #6CB6FF">10</span></span>
<span data-line=""><span style="color: #ADBAC7">}</span></span></code></pre></div>
<p>If you run the plan you should see the resource it wants to create:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">terraform</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">init</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">terraform</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">plan</span></span>
<span data-line=""> </span></code></pre></div>
<p>and you should see the run is executing in terraform cloud:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">Running plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C</span></span>
<span data-line=""><span style="color: #adbac7">will stop streaming the logs, but will not stop the plan running remotely.</span></span></code></pre></div>
<p>You can click the link it provides to see the logs. Now lets apply this
resource to see it all working:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">❯ terraform apply</span></span></code></pre></div>
<p>You should get a response like:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span></span></code></pre></div>
<p>So Terraform Cloud has full access to create AWS resources!   The final step
is to get github running the plan/apply on pull requests. Commit these files
to your repository and we'll remove them in a pull request. Create a
<code>.gitignore</code> file in the root:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">.terraform*</span></span></code></pre></div>
<p>and commit all the files:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">add</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">*</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">commit</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">-m</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"initial infra"</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">push</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">origin</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">head</span></span></code></pre></div>
<h1>Github Actions</h1>
<p>The two most popular workflows when using terraform are:</p>
<ul>
<li>
<p><strong>Apply after Merge</strong>: This is the default for things like
<a href="https://terraform.io">terraform cloud</a> and most github actions.</p>
</li>
<li>
<p><strong>Apply before Merge</strong>: This is the default for things like
<a href="https://www.runatlantis.io/">Atlantis</a>.</p>
</li>
</ul>
<p>I don't like apply-after-merge.  There are a lot of ways where a <code>plan</code>
can succeed but an <code>apply</code> will fail and you end up with broken configuration
in <code>main</code>.</p>
<p>So in this article I'll show you how to implement <strong>apply-before-merge</strong> with
github actions.</p>
<p>All of these changes will be in the <code>infra</code> repository that was generated from
<code>bootstrap</code>.  We are done with the bootstrap at this point.</p>
<p>First, lets setup the <code>.github</code> folder, the end result we want is:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">.github/</span></span>
<span data-line=""><span style="color: #F69D50">└──</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">workflows</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">├──</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">on-apply-finished.yml</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">├──</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">on-pull-request-labeled.yml</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F69D50">└──</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">on-pull-request.yml</span></span></code></pre></div>
<p>So create the folders:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">mkdir</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">-p</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">.github/workflows</span></span></code></pre></div>
<h1>On Pull Request</h1>
<p>The first flow we'll create is the <code>terraform plan</code> workflow which should be
ran whenever a pull request is opened. Create the file
<code>.github/workflows/on-pull-request.yml</code> and put this content in it:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="yml" data-theme="default"><code data-language="yml" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">pr_build</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #6CB6FF">on</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">pull_request</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">branches</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #96D0FF">main</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #8DDB8C">env</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">TERRAFORM_CLOUD_TOKENS</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">app.terraform.io=${{ secrets.TFE_TOKEN }}</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">GITHUB_TOKEN</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ secrets.GITHUB_TOKEN }}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #8DDB8C">jobs</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">terraform_validate</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">runs-on</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">ubuntu-22.04</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">strategy</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">fail-fast</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">false</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">matrix</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">folder</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          - </span><span style="color: #96D0FF">root</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">steps</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">Checkout</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">actions/checkout@v3</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">terraform validate</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">dflook/terraform-validate@v1</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">path</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">workspace</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">terraform_fmt</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">runs-on</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">ubuntu-22.04</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">strategy</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">fail-fast</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">false</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">matrix</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">folder</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          - </span><span style="color: #96D0FF">root</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">steps</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">actions/checkout@v3</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">terraform fmt</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">dflook/terraform-fmt-check@v1</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">path</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">workspace</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">terraform_plan</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">runs-on</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">ubuntu-22.04</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">permissions</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">contents</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">read</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">pull-requests</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">write</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">strategy</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">fail-fast</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">false</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">matrix</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">folder</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          - </span><span style="color: #96D0FF">root</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">steps</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">actions/checkout@v3</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">terraform plan</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">dflook/terraform-plan@v1</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">path</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">workspace</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span></code></pre></div>
<p>This creates three jobs:</p>
<ul>
<li><strong>terraform_validate</strong>: This validates the terraform via <code>terraform validate</code>
command to make sure that it is correct and doesn't have duplicate resources
or anything like that.</li>
<li><strong>terraform_fmt</strong>: This verifies that the terraform is well formatted by
running the <code>terraform fmt</code> command.`</li>
<li><strong>terraform_plan</strong>: This runs the <code>terraform</code> plan and comments on the PR a
diff of the changes for you to verify.</li>
</ul>
<p>To verify this is working, lets delete <code>root/2-sqs.tf</code>, then lets push a branch
and make a pull request to see the result so far:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">rm</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">root/2-sqs.tf</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">add</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">.github/</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">root/</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">checkout</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">-b</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">apply-before-merge</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">commit</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">-m</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"Implemented on-pull-request"</span></span>
<span data-line=""><span style="color: #F69D50">❯</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">git</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">push</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">origin</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">head</span></span></code></pre></div>
<p>After you make the pull request you should 3 checks on it and a comment that
shows the plan:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/github_comment.png" width="400">
<img src="/images/posts/aws_apply_before_merge/github_checks.png" width="400">
</center>
<h1>Apply on Label</h1>
<p>So now that the plan is working we need some way to <code>apply</code> the changes. I've
found the best way to do this is via a label rather than a comment because of
the way github actions work. Their event based actions like <code>on-comment</code> aren't
executed in the context of a pull-request.</p>
<p>Since we will be using a label to signal a plan is ready to be applied lets
create a new file <code>.github/workflows/on-pull-request-labeled.yml</code> and provide
this content:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="yaml" data-theme="default"><code data-language="yaml" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">pr_apply</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #6CB6FF">on</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">pull_request</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">types</span><span style="color: #ADBAC7">: [ </span><span style="color: #96D0FF">labeled</span><span style="color: #ADBAC7"> ]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #8DDB8C">env</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">TERRAFORM_CLOUD_TOKENS</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">app.terraform.io=${{ secrets.TFE_TOKEN }}</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">GITHUB_TOKEN</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ secrets.GITHUB_TOKEN }}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #8DDB8C">jobs</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">terraform_apply</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">if</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ github.event.label.name == 'tfc-apply' }}</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">runs-on</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">ubuntu-22.04</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">permissions</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">contents</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">read</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">pull-requests</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">write</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">strategy</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">fail-fast</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">false</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">matrix</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">folder</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          - </span><span style="color: #96D0FF">root</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">steps</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">actions/checkout@v3</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">dflook/terraform-apply@v1</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">path</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">workspace</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ matrix.folder }}</span></span></code></pre></div>
<p>This will fire whenever a pull request is labeled with the <code>tfc-apply</code> label.
You will need to create this label for the repository.</p>
<p>It will run the <code>apply</code> and update the previous plan comment to let you
know the status.</p>
<center>
<img src="/images/posts/aws_apply_before_merge/tfc_applying.png" width="400">
<img src="/images/posts/aws_apply_before_merge/tfc_applying_comment.png" width="400">
</center>
<h1>Merge on Apply</h1>
<p>One thing you'll notice is that the pull request stayed open even after the
infrastructure is applied and we don't want that. We want any changes that have
made it into the environment to be merged into <code>main</code> automatically. To do
this we'll create our final action.</p>
<p>Create a new file <code>.github/workflows/on-apply-finished.yml</code> with this content:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="yaml" data-theme="default"><code data-language="yaml" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">pr_merge</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #768390"># Only trigger, when the build workflow succeeded</span></span>
<span data-line=""><span style="color: #6CB6FF">on</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">workflow_run</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">workflows</span><span style="color: #ADBAC7">: [</span><span style="color: #96D0FF">pr_apply</span><span style="color: #ADBAC7">]</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">types</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #96D0FF">completed</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #8DDB8C">jobs</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">  </span><span style="color: #8DDB8C">merge</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">if</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ github.event.workflow_run.conclusion == 'success' }}</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">runs-on</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">ubuntu-22.04</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">permissions</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">contents</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">write</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">pull-requests</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">write</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">checks</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">read</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">statuses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">read</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">actions</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">read</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">outputs</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      </span><span style="color: #8DDB8C">pullRequestNumber</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ steps.workflow-run-info.outputs.pullRequestNumber }}</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #8DDB8C">steps</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">"Get information about the current run"</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">potiuk/get-workflow-origin@v1_5</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">id</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">workflow-run-info</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">token</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ secrets.GITHUB_TOKEN }}</span></span>
<span data-line=""><span style="color: #ADBAC7">          </span><span style="color: #8DDB8C">sourceRunId</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ github.event.workflow_run.id }}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">      - </span><span style="color: #8DDB8C">name</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">merge a pull request after terraform apply</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">uses</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">sudo-bot/action-pull-request-merge@v1.2.0</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #8DDB8C">with</span><span style="color: #ADBAC7">:</span></span>
<span data-line=""><span style="color: #ADBAC7">            </span><span style="color: #8DDB8C">github-token</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ secrets.GITHUB_TOKEN }}</span></span>
<span data-line=""><span style="color: #ADBAC7">            </span><span style="color: #8DDB8C">number</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">${{ steps.workflow-run-info.outputs.pullRequestNumber }}</span></span></code></pre></div>
<p>This will wait until the <code>pr_apply</code> job completes and as long as it was
successful it'll merge the branch!</p>
<p><strong>NOTE</strong>: As I mentioned earlier, the event based actions do not run in the
context of the pull request which means you cannot test changes to them during
the PR either.  You must merge the <code>on-apply-finished.yml</code> file to <code>main</code>
before it starts working.</p>
<h1>Branch Protection</h1>
<p>The final step to the process is to make sure you go to your github settings
and make sure these status checks are required before merging. Branch protection
is a feature that will prevent merging changes into a branch unless all
required checks are passing.</p>
<p>Go to <code>Settings</code> -> <code>Branches</code> -> <code>Branch Protection</code> and add a branch
protection rule:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/branch_protection.png" width="500">
</center>
<p>You want to enable the following settings:</p>
<ul>
<li><strong>Branch Name</strong>: main</li>
<li>✅ Require a pull request before merging</li>
<li>✅ Require status checks to pass before merging</li>
</ul>
<p>Then for <code>Status checks that are required.</code> select all of the ones we've
created:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/required_checks.png" height="200">
</center>
<h1>Helpful Resources</h1>
<ul>
<li><a href="https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform">Terraform Dynamic Credentials Tutorial</a></li>
<li><a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration">Terraform docs on Dynamic Credentials</a></li>
<li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token">Github's understanding OIDC</a></li>
</ul></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2023","aws_from_scratch_apply_before_merge"],"path":"2023/aws_from_scratch_apply_before_merge","contentHtml":"\u003cp\u003eFollowing this article will get you setup with an AWS Root account that can be\nmanaged through through Terraform Cloud with OIDC and github actions. As a best practice you\nshould not keep long-lived access keys in your CI/CD pipelines when\ndeploying to AWS, instead you should use OIDC (OpenID Connect) to securely\ndeploy to AWS when using Terraform Cloud or Github Actions.\u003c/p\u003e\n\u003ciframe width=\"854\" height=\"480\" src=\"https://www.youtube.com/embed/3oZd1m8_KIo\" title=\"AWS From Scratch - Preparing your account to be managed by IaC via Terraform and Github Actions\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;web-share\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003ch1\u003eTL;DR\u003c/h1\u003e\n\u003cp\u003eDownload all the terraform from the blog post here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/sontek/aws-apply-before-merge\"\u003ehttps://github.com/sontek/aws-apply-before-merge\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/sontek/aws-terraform-github-actions\"\u003ehttps://github.com/sontek/aws-terraform-github-actions\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eHow does OIDC work\u003c/h1\u003e\n\u003cp\u003eOIDC enables us to request a short-lived access token directly from AWS. We\njust have to create trust relationship that controls which workflows are able\nto request the access tokens.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNo need to duplicate AWS credentials as long-lived GitHub secrets.\u003c/li\u003e\n\u003cli\u003eSince we are using a short-lived access token that is only valid for a single\njob there is no reason to worry about rotating secrets.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe following diagram gives an overview of how we can use Terraform Cloud's\nOIDC provider to integrate with AWS:\u003c/p\u003e\n\u003cdiv class=\"remark-mermaid remark-mermaid-default\"\u003e\u003csvg aria-roledescription=\"flowchart-v2\" role=\"graphics-document document\" viewBox=\"-8 -8 843.078125 320\" style=\"max-width: 843.078px; background-color: transparent;\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"my-svg\"\u003e\u003cstyle\u003e#my-svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:2px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#my-svg .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span,#my-svg p{color:#333;}#my-svg .label text,#my-svg span,#my-svg p{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .flowchart-label text{text-anchor:middle;}#my-svg .node .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:#e8e8e8;text-align:center;}#my-svg .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span,#my-svg p{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}\u003c/style\u003e\u003cg\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"6\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"my-svg_flowchart-pointEnd\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"4.5\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"my-svg_flowchart-pointStart\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"my-svg_flowchart-circleEnd\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"my-svg_flowchart-circleStart\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"my-svg_flowchart-crossEnd\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"my-svg_flowchart-crossStart\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cg class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003cpath marker-end=\"url(#my-svg_flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-AWS LE-Token\" id=\"L-AWS-Token-0\" d=\"M185.671875,134.5L181.50520833333334,134.5C177.33854166666666,134.5,169.00520833333334,134.5,153.0306361743634,145.2794461651524C137.05606401539345,156.0588923303048,113.4402530307869,177.61778466060957,101.63234753848364,188.39723082576197L89.82444204618037,199.17667699091436\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#my-svg_flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Token LE-Terraform\" id=\"L-Token-Terraform-0\" d=\"M85.91019081858407,235.75L98.37047151548673,247.125C110.83075221238937,258.5,135.75131360619469,281.25,164.46289638643069,292.625C193.17447916666666,304,225.67708333333334,304,258.1796875,304C290.6822916666667,304,323.1848958333333,304,359.3528645833333,304C395.5208333333333,304,435.3541666666667,304,475.1875,304C515.0208333333334,304,554.8541666666666,304,584.9583299079444,297.2781483582884C615.0624931492222,290.55629671657675,635.4374862984442,277.1125934331535,645.6249828730553,270.3907417914419L655.8124794476664,263.66889014973026\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#my-svg_flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Terraform LE-JWT\" id=\"L-Terraform-JWT-0\" d=\"M660.2362877949853,177.75L649.3114898291544,170.54166666666666C638.3866918633236,163.33333333333334,616.5370959316618,148.91666666666666,602.3289646324976,141.70833333333334C588.1208333333333,134.5,581.5541666666667,134.5,578.2708333333334,134.5L574.9875,134.5\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#my-svg_flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-JWT LE-AWS\" id=\"L-JWT-AWS-0\" d=\"M380.6875,134.5L376.5208333333333,134.5C372.3541666666667,134.5,364.0208333333333,134.5,356.5708333333334,134.5C349.12083333333334,134.5,342.5541666666666,134.5,339.2708333333333,134.5L335.9875,134.5\"\u003e\u003c/path\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(621.1171875, 169.75)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"Terraform\" class=\"cluster default flowchart-label\"\u003e\u003crect height=\"83\" width=\"206.890625\" y=\"8\" x=\"-0.9296875\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-0.9296875, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18\" width=\"206.890625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eTerraform Cloud Workflow #2\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(102.515625, 49.5)\" id=\"flowchart-OIDCProvider-3\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"119.03125\" y=\"-16.5\" x=\"-59.515625\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-52.015625, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"104.03125\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Provider\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(178.171875, -8)\" class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003cg id=\"AWS\" class=\"cluster default flowchart-label\"\u003e\u003crect height=\"269\" width=\"145.015625\" y=\"8\" x=\"8\" ry=\"0\" rx=\"0\" style=\"\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(51.4609375, 8)\" class=\"cluster-label\"\u003e\u003cforeignObject height=\"18\" width=\"58.09375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAWS #1\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(80.5078125, 59.5)\" id=\"flowchart-OIDC-0\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"95.015625\" y=\"-16.5\" x=\"-47.5078125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-40.0078125, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"80.015625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eOIDC Trust\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(80.5078125, 142.5)\" id=\"flowchart-Roles-1\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"55.90625\" y=\"-16.5\" x=\"-27.953125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-20.453125, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"40.90625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eRoles\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(80.5078125, 225.5)\" id=\"flowchart-Resources-2\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"91.484375\" y=\"-16.5\" x=\"-45.7421875\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-38.2421875, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"76.484375\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eResources\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(67.8359375, 219.25)\" id=\"flowchart-Token-5\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"135.671875\" y=\"-16.5\" x=\"-67.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-60.3359375, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"120.671875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eAccess Token #4\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(475.1875, 134.5)\" id=\"flowchart-JWT-8\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"189\" y=\"-16.5\" x=\"-94.5\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-87, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"174\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eJWT \u0026#x26; Cloud Role ID #3\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/svg\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003eIn AWS, create an OIDC trust between a role and our terraform cloud\nworkflow(s) that need access to the cloud.\u003c/li\u003e\n\u003cli\u003eEvery time a job runs, TFC's OIDC Provider auto-generates an OIDC token.\nThis token contains multiple claims to establish a security-hardened and\nverifiable identity about the specific workflow that is trying to authenticate.\u003c/li\u003e\n\u003cli\u003eRequest this token from TFC's OIDC provider, and present it to AWS\u003c/li\u003e\n\u003cli\u003eOnce AWS successfully validates the claims presented in the token, it then\nprovides a short-lived cloud access token that is available only for the duration\nof the job.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eWhat does this post accomplish\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eSetup a root AWS account that is managed througuh terraform\u003c/li\u003e\n\u003cli\u003eSetup OIDC authentication with Terraform Cloud so it can talk to AWS\u003c/li\u003e\n\u003cli\u003eSetup Github Actions authentication with Terraform Cloud so we can run plan\nand apply through the CI/CD pipeline.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eSetup AWS Access\u003c/h1\u003e\n\u003cp\u003eIt is very bad practice to use the root account for much of anything but for\nbootstrapping the account it is necessary, so the first step is to get your\n\u003ccode\u003eAWS_ACCESS_KEY_ID\u003c/code\u003e and \u003ccode\u003eAWS_SECRET_ACCESS_KEY\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eTo do this click your account and choose \u003ccode\u003eSecurity Credentials\u003c/code\u003e in the top\nright:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/security_credentials.png\" height=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eThen choose \u003ccode\u003eCreate Access key\u003c/code\u003e:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_root_account/create_access_token.png\" width=\"200\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou need to set these environment variables in your shell so that your local\nshell has access to AWS. After you set them you can verify you set them correct\nby running:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eaws\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ests\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eget-caller-identity\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand you should get a result similar to:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"json\" data-theme=\"default\"\u003e\u003ccode data-language=\"json\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003e\"UserId\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"777777777777\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003e\"Account\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"888888888888\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003e\"Arn\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"arn:aws:iam::888888888888:root\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eBootstrap\u003c/h2\u003e\n\u003cp\u003eBefore you can manage any of your accounts through Terraform Cloud you'll need\nbootstrap some core infrastructure like OIDC so Terraform Cloud can authenticate\nsecurely and manage AWS Resources on your behalf.\u003c/p\u003e\n\u003cp\u003eI personally prefer doing this in two repositories:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra-bootstrap\u003c/code\u003e: This repository does the bare minimum to hook up terraform\ncloud with your AWS account and stores the state in git.  Its the only infra\nthat will not be controlled by your CI/CD pipeline.ccccccug\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003einfra\u003c/code\u003e: The actual repository where all the rest of your AWS resources are\nmanaged.  It will store state in Terraform Cloud and you can introduce a\nCI/CD pipeline for approving changes.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNote\u003c/strong\u003e: This repository will be generated with the terraform code.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAfter manually creating the git repository \u003ccode\u003einfra-boostrap\u003c/code\u003e in your Github\naccount We will need 3 providers to bootstrap the account \u003ccode\u003eaws\u003c/code\u003e, \u003ccode\u003egithub\u003c/code\u003e, and\n\u003ccode\u003etfe\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eVariables\u003c/h3\u003e\n\u003cp\u003eCreate a \u003ccode\u003e1-variables.tf\u003c/code\u003e where we can define the variables we'll need\nfor creating these resources.\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_aws_audience\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  default\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"aws.workload.identity\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The audience value to use in run identity tokens\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_hostname\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  default\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"app.terraform.io\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The hostname of the TFC or TFE instance you'd like to use with AWS\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_project_name\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  default\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Default Project\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The project under which a workspace will be created\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_organization_name\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The name of your Terraform Cloud organization\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_organization_owner\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The owner of the TFC organization\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_workspaces\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003elist\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The list of TFC workspaces\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_organization\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The organization the repositories are owned by\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_repo_name\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The name of the git reppository we'll create for managing infra\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_default_branch\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The default branch to utilize\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  default\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"main\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003evariable\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_root_account_id\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"The AWS root account we want to apply these changes to\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003estring\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe will use these variables in the later modules but they are mostly metadata\naround the terraform and github accounts you'll need to setup manually.\u003c/p\u003e\n\u003ch3\u003eProviders\u003c/h3\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003e2-providers.tf\u003c/code\u003e and define the providers:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003erequired_providers\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    tfe\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      source  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      version \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"0.41.0\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    aws\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      source  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"hashicorp/aws\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      version \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"4.58.0\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    github\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      source  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"integrations/github\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      version \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"5.18.3\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eprovider\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  region\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"us-east-1\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# Root account, all other accounts should be provisioned\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# via pull requests\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  allowed_account_ids\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_root_account_id]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eprovider\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  owner\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_organization\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe key things there are we define \u003ccode\u003eallowed_account_ids\u003c/code\u003e to prevent us from\nworking against any account that isn't the root and we are using one of the\nvariables we defines earlier.\u003c/p\u003e\n\u003ch3\u003eGithub\u003c/h3\u003e\n\u003cp\u003eWe will utilize \u003ccode\u003eterraform\u003c/code\u003e to create the second git repository where the rest\nof the infrastructure will go. Create a file called \u003ccode\u003e3-github.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_repository\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"repo\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_repo_name\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Infrastructure Repository\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  visibility\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"private\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  auto_init\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e   \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  has_issues\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_branch_default\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"default\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  repository\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_repository\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003erepo\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  branch\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_default_branch\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_team\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"owners\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e         \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"owners\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  organization\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_organization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eorganization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_team_token\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_actions_token\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  team_id\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_team\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eowners\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eid\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"github_actions_secret\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_secret\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  repository\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_repository\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003erepo\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  secret_name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"TFE_TOKEN\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  plaintext_value\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_team_token\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_actions_token\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etoken\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"repository_id\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  value\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_repository\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003erepo\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eid\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis will generate a new repository in your account called \u003ccode\u003einfra\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eFor the terraform provider to have access to github you need to create a new\npersonal access token with full \u003ccode\u003erepo\u003c/code\u003e access and set it as an environment\nvariable named \u003ccode\u003eGITHUB_TOKEN\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eTerraform Cloud\u003c/h3\u003e\n\u003cp\u003eNow we need to setup dynamic credentials so the terraform cloud agent is\nallowed to take actions on your behalf.   To do this we'll setup an IAM\nrole and an OIDC provider. Create a file called \u003ccode\u003e4-tfc.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_organization\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"organization\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_organization_name\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  email\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_organization_owner\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e/* AWS will use this TLS certificate to verify that requests for dynamic\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003ecredentials come from Terraform Cloud.*/\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tls_certificate\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_certificate\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  url\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"https://\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_hostname\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e/* sets up an OIDC provider in AWS with Terraform Cloud's TLS certificate,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003ethe SHA1 fingerprint from the TLS certificate\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e*/\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_openid_connect_provider\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc_provider\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  url\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e            \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etls_certificate\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_certificate\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eurl\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  client_id_list\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_aws_audience]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  thumbprint_list\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    data\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etls_certificate\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_certificate\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ecertificates[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e0\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003esha1_fingerprint\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e/* Policy to allow TFC to assume the AWS IAM role in our account */\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"assume_role\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003estatement\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    effect\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Allow\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eprincipals\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      type\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Federated\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      identifiers\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[aws_iam_openid_connect_provider\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_provider\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003earn]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003econdition\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      test\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"StringEquals\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      variable\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_hostname\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e:aud\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      values\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eone\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e(aws_iam_openid_connect_provider\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_provider\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eclient_id_list\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003econdition\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      test\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"StringLike\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      variable\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_hostname\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e:sub\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      values\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efor\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e workspace \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003ein\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"organization:\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_organization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eorganization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e:project:\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_project_name\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e:workspace:\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eworkspace\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e:run_phase:*\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    actions\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"sts:AssumeRoleWithWebIdentity\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_role\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-agent\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e               \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"tfc-agent\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  assume_role_policy\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_iam_policy_document\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eassume_role\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ejson\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e/* Policy for what the TFC agent is allowed to do */\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-agent\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  version\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"2012-10-17\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003estatement\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    actions\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e   \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"*\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    effect\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Allow\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    resources\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"*\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_policy\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-agent\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"tfc-agent-access-policy\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Access policy for the TFC agent\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  policy\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003edata\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_iam_policy_document\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc-agent\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ejson\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-access-attach\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  role\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e       \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_iam_role\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc-agent\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  policy_arn\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_iam_policy\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc-agent\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003earn\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_workspace\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"workspaces\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  count\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003elength\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e         \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces[count\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eindex]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  organization\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_organization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eorganization\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003ename\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  working_directory\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces[count\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eindex]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e/* These variables tell the agent to use dynamic credentials */\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_variable\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-auth\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  count\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003elength\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  key\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"TFC_AWS_PROVIDER_AUTH\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  value\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  category\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"env\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  workspace_id\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_workspace\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eworkspaces[count\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eindex]\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eid\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Enable dynamic auth on the TFC agents\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfe_variable\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"tfc-role\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  count\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003elength\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(var\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  key\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"TFC_AWS_RUN_ROLE_ARN\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  value\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_iam_role\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc-agent\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003earn\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  category\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"env\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  workspace_id\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfe_workspace\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eworkspaces[count\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eindex]\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eid\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  description\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Tell TFC what Role to run as\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis module is dynamic because there is one piece that will require a\nmanual oauth setup for github.  So the first pass will apply without it\nand then later on we'll create it and run the apply again.\u003c/p\u003e\n\u003ch2\u003eApplying the changes\u003c/h2\u003e\n\u003cp\u003eNow we just need to define our settings for the module and we'll get our\ninfrastructure applied.  Create a file called \u003ccode\u003esettings.auto.tfvars\u003c/code\u003e and\npopulate it with the content for your account.  This is an example of what\nthis should look like:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_organization_name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"sontek\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_organization_owner\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"john@sontek.net\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e# The workspaces you want to create and be able to manage with IaC\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003etfc_workspaces\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e[\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"root\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e# this can be your username\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_organization\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"sontek\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003egithub_repo_name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e       \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"sontek-infra\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003eaws_root_account_id\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"888888888888\"\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow run:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003elogin\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003einit\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand you should see:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003eTerraform has been successfully initialized!\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow lets run our plan:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e❯ terraform plan\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eYou should see a result:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003ePlan: 10 to add, 0 to change, 0 to destroy.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eApply it to make those resources:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e❯ terraform apply\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAt this point it:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eCreated a terraform cloud organization\u003c/li\u003e\n\u003cli\u003eCreated a terraform cloud workspace\u003c/li\u003e\n\u003cli\u003eCreated a git repository\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003eVerify TFC can talk to AWS\u003c/h1\u003e\n\u003cp\u003eTo verify that TFC can communicate with AWS through the dynamic credentials,\nlets clone the \u003cem\u003eNEW\u003c/em\u003e repository we just generated and make some dummy resources. After\nyou've cloned the repository lets make a folder for the workspace \u003ccode\u003eroot\u003c/code\u003e that we\ndefined in bootstrap:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003emkdir\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ecd\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow create a \u003ccode\u003e1-providers.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ecloud\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    organization\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"sontek\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eworkspaces\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"root\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003erequired_providers\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    aws\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      source  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"hashicorp/aws\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      version \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"4.58.0\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    tfe\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      source  \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"hashicorp/tfe\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      version \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"0.42.0\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eprovider\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  region\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"us-east-1\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003edefault_tags\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    tags\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      Owner   \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"john@sontek.net\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      Env     \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Root\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      Service \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"BusinessOperations\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: You should replace \u003ccode\u003eorganization\u003c/code\u003e, \u003ccode\u003eworkspaces.name\u003c/code\u003e, and\n\u003ccode\u003etags.Owner\u003c/code\u003e to be your own values.\u003c/p\u003e\n\u003cp\u003eNow create a small resource to prove everything is working, we'll use SQS for\nthis. Create a file called \u003ccode\u003e2-sqs.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"hcl\" data-theme=\"default\"\u003e\u003ccode data-language=\"hcl\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003eresource\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"aws_sqs_queue\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e\"example-sqs\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  name\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e                        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"example-sqs\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  message_retention_seconds\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e86400\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  receive_wait_time_seconds\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e10\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf you run the plan you should see the resource it wants to create:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003einit\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eplan\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand you should see the run is executing in terraform cloud:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003eRunning plan in Terraform Cloud. Output will stream here. Pressing Ctrl-C\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003ewill stop streaming the logs, but will not stop the plan running remotely.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eYou can click the link it provides to see the logs. Now lets apply this\nresource to see it all working:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e❯ terraform apply\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eYou should get a response like:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003eApply complete! Resources: 1 added, 0 changed, 0 destroyed.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSo Terraform Cloud has full access to create AWS resources!   The final step\nis to get github running the plan/apply on pull requests. Commit these files\nto your repository and we'll remove them in a pull request. Create a\n\u003ccode\u003e.gitignore\u003c/code\u003e file in the root:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e.terraform*\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand commit all the files:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eadd\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e*\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ecommit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e-m\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"initial infra\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epush\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eorigin\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ehead\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eGithub Actions\u003c/h1\u003e\n\u003cp\u003eThe two most popular workflows when using terraform are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply after Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://terraform.io\"\u003eterraform cloud\u003c/a\u003e and most github actions.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply before Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://www.runatlantis.io/\"\u003eAtlantis\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI don't like apply-after-merge.  There are a lot of ways where a \u003ccode\u003eplan\u003c/code\u003e\ncan succeed but an \u003ccode\u003eapply\u003c/code\u003e will fail and you end up with broken configuration\nin \u003ccode\u003emain\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eSo in this article I'll show you how to implement \u003cstrong\u003eapply-before-merge\u003c/strong\u003e with\ngithub actions.\u003c/p\u003e\n\u003cp\u003eAll of these changes will be in the \u003ccode\u003einfra\u003c/code\u003e repository that was generated from\n\u003ccode\u003ebootstrap\u003c/code\u003e.  We are done with the bootstrap at this point.\u003c/p\u003e\n\u003cp\u003eFirst, lets setup the \u003ccode\u003e.github\u003c/code\u003e folder, the end result we want is:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e.github/\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e└──\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eworkflows\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e├──\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eon-apply-finished.yml\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e├──\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eon-pull-request-labeled.yml\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003e└──\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eon-pull-request.yml\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSo create the folders:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003emkdir\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e-p\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e.github/workflows\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eOn Pull Request\u003c/h1\u003e\n\u003cp\u003eThe first flow we'll create is the \u003ccode\u003eterraform plan\u003c/code\u003e workflow which should be\nran whenever a pull request is opened. Create the file\n\u003ccode\u003e.github/workflows/on-pull-request.yml\u003c/code\u003e and put this content in it:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yml\" data-theme=\"default\"\u003e\u003ccode data-language=\"yml\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epr_build\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #6CB6FF\"\u003eon\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epull_request\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ebranches\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003emain\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003eenv\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eTERRAFORM_CLOUD_TOKENS\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eapp.terraform.io=${{ secrets.TFE_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eGITHUB_TOKEN\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ secrets.GITHUB_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ejobs\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eterraform_validate\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eruns-on\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eubuntu-22.04\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003estrategy\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efail-fast\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ematrix\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efolder\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esteps\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eCheckout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eactions/checkout@v3\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform validate\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003edflook/terraform-validate@v1\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epath\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkspace\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eterraform_fmt\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eruns-on\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eubuntu-22.04\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003estrategy\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efail-fast\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ematrix\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efolder\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esteps\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eactions/checkout@v3\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform fmt\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003edflook/terraform-fmt-check@v1\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epath\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkspace\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eterraform_plan\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eruns-on\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eubuntu-22.04\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epermissions\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003econtents\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eread\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epull-requests\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ewrite\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003estrategy\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efail-fast\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ematrix\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efolder\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esteps\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eactions/checkout@v3\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eterraform plan\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003edflook/terraform-plan@v1\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epath\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkspace\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis creates three jobs:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_validate\u003c/strong\u003e: This validates the terraform via \u003ccode\u003eterraform validate\u003c/code\u003e\ncommand to make sure that it is correct and doesn't have duplicate resources\nor anything like that.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_fmt\u003c/strong\u003e: This verifies that the terraform is well formatted by\nrunning the \u003ccode\u003eterraform fmt\u003c/code\u003e command.`\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_plan\u003c/strong\u003e: This runs the \u003ccode\u003eterraform\u003c/code\u003e plan and comments on the PR a\ndiff of the changes for you to verify.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTo verify this is working, lets delete \u003ccode\u003eroot/2-sqs.tf\u003c/code\u003e, then lets push a branch\nand make a pull request to see the result so far:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"bash\" data-theme=\"default\"\u003e\u003ccode data-language=\"bash\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003erm\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot/2-sqs.tf\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eadd\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e.github/\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot/\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003echeckout\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e-b\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eapply-before-merge\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ecommit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e-m\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Implemented on-pull-request\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F69D50\"\u003e❯\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003egit\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epush\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eorigin\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ehead\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter you make the pull request you should 3 checks on it and a comment that\nshows the plan:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_comment.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_checks.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eApply on Label\u003c/h1\u003e\n\u003cp\u003eSo now that the plan is working we need some way to \u003ccode\u003eapply\u003c/code\u003e the changes. I've\nfound the best way to do this is via a label rather than a comment because of\nthe way github actions work. Their event based actions like \u003ccode\u003eon-comment\u003c/code\u003e aren't\nexecuted in the context of a pull-request.\u003c/p\u003e\n\u003cp\u003eSince we will be using a label to signal a plan is ready to be applied lets\ncreate a new file \u003ccode\u003e.github/workflows/on-pull-request-labeled.yml\u003c/code\u003e and provide\nthis content:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"\u003e\u003ccode data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epr_apply\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #6CB6FF\"\u003eon\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epull_request\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003etypes\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: [ \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003elabeled\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003eenv\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eTERRAFORM_CLOUD_TOKENS\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eapp.terraform.io=${{ secrets.TFE_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eGITHUB_TOKEN\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ secrets.GITHUB_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ejobs\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eterraform_apply\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ github.event.label.name == 'tfc-apply' }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eruns-on\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eubuntu-22.04\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epermissions\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003econtents\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eread\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epull-requests\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ewrite\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003estrategy\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efail-fast\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ematrix\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003efolder\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eroot\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esteps\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eactions/checkout@v3\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003edflook/terraform-apply@v1\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epath\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkspace\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ matrix.folder }}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis will fire whenever a pull request is labeled with the \u003ccode\u003etfc-apply\u003c/code\u003e label.\nYou will need to create this label for the repository.\u003c/p\u003e\n\u003cp\u003eIt will run the \u003ccode\u003eapply\u003c/code\u003e and update the previous plan comment to let you\nknow the status.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying_comment.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eMerge on Apply\u003c/h1\u003e\n\u003cp\u003eOne thing you'll notice is that the pull request stayed open even after the\ninfrastructure is applied and we don't want that. We want any changes that have\nmade it into the environment to be merged into \u003ccode\u003emain\u003c/code\u003e automatically. To do\nthis we'll create our final action.\u003c/p\u003e\n\u003cp\u003eCreate a new file \u003ccode\u003e.github/workflows/on-apply-finished.yml\u003c/code\u003e with this content:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"yaml\" data-theme=\"default\"\u003e\u003ccode data-language=\"yaml\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epr_merge\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #768390\"\u003e# Only trigger, when the build workflow succeeded\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #6CB6FF\"\u003eon\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkflow_run\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eworkflows\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: [\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epr_apply\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003etypes\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ecompleted\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #8DDB8C\"\u003ejobs\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003emerge\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ github.event.workflow_run.conclusion == 'success' }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eruns-on\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eubuntu-22.04\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epermissions\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003econtents\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ewrite\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epull-requests\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003ewrite\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003echecks\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eread\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003estatuses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eread\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eactions\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eread\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eoutputs\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003epullRequestNumber\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ steps.workflow-run-info.outputs.pullRequestNumber }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esteps\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Get information about the current run\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003epotiuk/get-workflow-origin@v1_5\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003eid\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003eworkflow-run-info\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003etoken\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ secrets.GITHUB_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e          \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003esourceRunId\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ github.event.workflow_run.id }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e      - \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003emerge a pull request after terraform apply\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003euses\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003esudo-bot/action-pull-request-merge@v1.2.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003ewith\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003egithub-token\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ secrets.GITHUB_TOKEN }}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            \u003c/span\u003e\u003cspan style=\"color: #8DDB8C\"\u003enumber\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e${{ steps.workflow-run-info.outputs.pullRequestNumber }}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis will wait until the \u003ccode\u003epr_apply\u003c/code\u003e job completes and as long as it was\nsuccessful it'll merge the branch!\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: As I mentioned earlier, the event based actions do not run in the\ncontext of the pull request which means you cannot test changes to them during\nthe PR either.  You must merge the \u003ccode\u003eon-apply-finished.yml\u003c/code\u003e file to \u003ccode\u003emain\u003c/code\u003e\nbefore it starts working.\u003c/p\u003e\n\u003ch1\u003eBranch Protection\u003c/h1\u003e\n\u003cp\u003eThe final step to the process is to make sure you go to your github settings\nand make sure these status checks are required before merging. Branch protection\nis a feature that will prevent merging changes into a branch unless all\nrequired checks are passing.\u003c/p\u003e\n\u003cp\u003eGo to \u003ccode\u003eSettings\u003c/code\u003e -\u003e \u003ccode\u003eBranches\u003c/code\u003e -\u003e \u003ccode\u003eBranch Protection\u003c/code\u003e and add a branch\nprotection rule:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/branch_protection.png\" width=\"500\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou want to enable the following settings:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBranch Name\u003c/strong\u003e: main\u003c/li\u003e\n\u003cli\u003e✅ Require a pull request before merging\u003c/li\u003e\n\u003cli\u003e✅ Require status checks to pass before merging\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThen for \u003ccode\u003eStatus checks that are required.\u003c/code\u003e select all of the ones we've\ncreated:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/required_checks.png\" height=\"200\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eHelpful Resources\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/tutorials/cloud/dynamic-credentials?product_intent=terraform\"\u003eTerraform Dynamic Credentials Tutorial\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration\"\u003eTerraform docs on Dynamic Credentials\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token\"\u003eGithub's understanding OIDC\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","category":"AWS","date":"2023-06-23T00:00:00Z","tags":["AWS","DevOps","SRE"],"title":"AWS From Scratch with Terraform - Setting up your Root Account for IaC  with Terraform Cloud and Github actions."}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["2023","aws_from_scratch_apply_before_merge"]},"buildId":"AoGbC8xlMEkyyIwWs3twS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>