<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>AWS From Scratch with Terraform - Apply before Merge with Github Actions</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/4e645f88d9d5f47b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e645f88d9d5f47b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/95e79f6f6f52c645.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95e79f6f6f52c645.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2e2b8b955a26d1f2.js" defer=""></script><script src="/_next/static/chunks/664-41844e7ff48658f9.js" defer=""></script><script src="/_next/static/chunks/494-fa03e5491fc3b3a9.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-62742065773be53f.js" defer=""></script><script src="/_next/static/4vZnC0vsg19sm_oc5ANpG/_buildManifest.js" defer=""></script><script src="/_next/static/4vZnC0vsg19sm_oc5ANpG/_ssgManifest.js" defer=""></script><script src="/_next/static/4vZnC0vsg19sm_oc5ANpG/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">AWS From Scratch with Terraform - Apply before Merge with Github Actions</h1><div class="util_lightText__xcqUE"><time dateTime="2023-04-01T20:00:00-04:00">April 1, 2023</time></div><div><p>The two most popular workflows when using terraform are:</p>
<ul>
<li>
<p><strong>Apply after Merge</strong>: This is the default for things like
<a href="https://terraform.io">terraform cloud</a> and most github actions.</p>
</li>
<li>
<p><strong>Apply before Merge</strong>: This is the default for things like
<a href="https://www.runatlantis.io/">Atlantis</a>.</p>
</li>
</ul>
<p>I don't like apply-after-merge.  There are a lot of ways where a <code>plan</code>
can succeed but an <code>apply</code> will fail and you end up with broken configuration
in <code>main</code>.</p>
<p>So in this article I'll show you how to implement <strong>apply-before-merge</strong> with
github actions.</p>
<p>If you haven't ready my <a href="/blog/2023/aws_from_scratch_root_account">previous article</a>,
it covers how to setup terraform cloud with apply after merge and bootstrap your AWS
account with terraform.  I will assume you have read that article going forward.</p>
<h1>TL;DR</h1>
<p>The code for the github actions we create in this post can be found
<a href="https://github.com/sontek/aws-terraform-github-actions">here</a></p>
<h1>Repairing the bootstrap</h1>
<p>With apply-before-merge we need to implement it in github actions rather than
utilizing the terraform cloud webhooks.  So lets drop the VCS repo and usage of
the webhook from our github repository. Basically anything that references
<code>github_oauth_client</code> can be removed because we will no longer be using OAuth
with Github for our CI/CD pipeline.</p>
<pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/1-variables.tf b/1-variables.tf</span>
<span class="hljs-comment">index bf1f434..7109924 100644</span>
<span class="hljs-comment">--- a/1-variables.tf</span>
<span class="hljs-comment">+++ b/1-variables.tf</span>
<span class="hljs-meta">@@ -47,12 +47,6 @@</span> variable "github_default_branch" {
   default     = "main"
 }
 
<span class="hljs-deletion">-variable "github_oauth_client_id" {</span>
<span class="hljs-deletion">-  description = "The token for the TFC OAuth client shown under VCS providers"</span>
<span class="hljs-deletion">-  type        = string</span>
<span class="hljs-deletion">-  default     = null</span>
<span class="hljs-deletion">-}</span>
<span class="hljs-deletion">-</span>
 variable "aws_root_account_id" {
   description = "The AWS root account we want to apply these changes to"
   type        = string
<span class="hljs-comment">diff --git a/4-tfc.tf b/4-tfc.tf</span>
<span class="hljs-comment">index a8217b7..9852228 100644</span>
<span class="hljs-comment">--- a/4-tfc.tf</span>
<span class="hljs-comment">+++ b/4-tfc.tf</span>
<span class="hljs-meta">@@ -77,31 +77,12 @@</span> resource "aws_iam_role_policy_attachment" "tfc-access-attach" {
   policy_arn = aws_iam_policy.tfc-agent.arn
 }
 
<span class="hljs-deletion">-/* Fetch an oauth token from the client */</span>
<span class="hljs-deletion">-data "tfe_oauth_client" "github" {</span>
<span class="hljs-deletion">-  /* Don't fetch the client if we don't have the client_id */</span>
<span class="hljs-deletion">-  count           = var.github_oauth_client_id != null ? 1 : 0</span>
<span class="hljs-deletion">-  oauth_client_id = var.github_oauth_client_id</span>
<span class="hljs-deletion">-}</span>
<span class="hljs-deletion">-</span>
 resource "tfe_workspace" "workspaces" {
   count        = length(var.tfc_workspaces)
   name         = var.tfc_workspaces[count.index]
   organization = tfe_organization.organization.name
 
   working_directory = var.tfc_workspaces[count.index]
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-  /* This generates a webhook on the github repository so plans are triggered</span>
<span class="hljs-deletion">-  automatically.   We dynamically set the setting because we will not have the</span>
<span class="hljs-deletion">-  oauth client ID on first pass.</span>
<span class="hljs-deletion">-  */</span>
<span class="hljs-deletion">-  dynamic "vcs_repo" {</span>
<span class="hljs-deletion">-    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []</span>
<span class="hljs-deletion">-    content {</span>
<span class="hljs-deletion">-      identifier     = format("%s/%s", var.github_organization, github_repository.repo.name)</span>
<span class="hljs-deletion">-      oauth_token_id = data.tfe_oauth_client.github[0].oauth_token_id</span>
<span class="hljs-deletion">-    }</span>
<span class="hljs-deletion">-  }</span>
 }
 
 /* These variables tell the agent to use dynamic credentials */
<span class="hljs-comment">diff --git a/settings.auto.tfvars.example b/settings.auto.tfvars.example</span>
<span class="hljs-comment">index 3327f02..79221c1 100644</span>
<span class="hljs-comment">--- a/settings.auto.tfvars.example</span>
<span class="hljs-comment">+++ b/settings.auto.tfvars.example</span>
<span class="hljs-meta">@@ -4,6 +4,5 @@</span> tfc_workspaces = [
   "root"
 ]
 github_organization    = "github-org"
<span class="hljs-deletion">-github_oauth_client_id = "oc-..."</span>
 github_repo_name       = "my-infra"
 aws_root_account_id    =  "888888888888"
</code></pre>
<p>Once that is removed from your <code>infra-bootstrap</code> repository we need to create
a new github secret with a token for Github to be able to talk with TFC. Make
a new file called <code>5-github-actions.tf</code> with the following content:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">data</span> <span class="hljs-string">"tfe_team"</span> <span class="hljs-string">"owners"</span> {
  name         = <span class="hljs-string">"owners"</span>
  organization = tfe_organization.organization.name
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"tfe_team_token"</span> <span class="hljs-string">"github_actions_token"</span> {
  team_id = <span class="hljs-keyword">data</span>.tfe_team.owners.id
}

<span class="hljs-keyword">resource</span> <span class="hljs-string">"github_actions_secret"</span> <span class="hljs-string">"tfe_secret"</span> {
  repository      = github_repository.repo.name
  secret_name     = <span class="hljs-string">"TFE_TOKEN"</span>
  plaintext_value = tfe_team_token.github_actions_token.token
}
</code></pre>
<p>Then you should <code>plan</code> and <code>apply</code> the change:</p>
<pre><code class="hljs language-bash">❯ terraform plan
❯ terraform apply
</code></pre>
<p>The only change to the infrastructure should be to remove the VCS link and
adding the secret:</p>
<pre><code class="hljs language-diff">  # tfe_workspace.workspaces[0] will be updated in-place
  ~ resource "tfe_workspace" "workspaces" {
        id                            = "ws-K1M4tdXUUeASgmUR"
        name                          = "root"
        # (20 unchanged attributes hidden)

<span class="hljs-deletion">-       vcs_repo {</span>
<span class="hljs-deletion">-           identifier         = "sontek/sontek-infra" -> null</span>
<span class="hljs-deletion">-           ingress_submodules = false -> null</span>
<span class="hljs-deletion">-           oauth_token_id     = "ot-nMYJRbBb2SH9zCP7" -> null</span>
        }
    }

  # github_actions_secret.tfe_secret will be created
<span class="hljs-addition">+   resource "github_actions_secret" "tfe_secret" {</span>
<span class="hljs-addition">+       created_at      = (known after apply)</span>
<span class="hljs-addition">+       id              = (known after apply)</span>
<span class="hljs-addition">+       plaintext_value = (sensitive value)</span>
<span class="hljs-addition">+       repository      = "sontek-infra"</span>
<span class="hljs-addition">+       secret_name     = "TFE_TOKEN"</span>
<span class="hljs-addition">+       updated_at      = (known after apply)</span>
    }

  # tfe_team_token.github_actions_token will be created
<span class="hljs-addition">+   resource "tfe_team_token" "github_actions_token" {</span>
<span class="hljs-addition">+       id      = (known after apply)</span>
<span class="hljs-addition">+       team_id = "team-..."</span>
<span class="hljs-addition">+       token   = (sensitive value)</span>
    }
</code></pre>
<h1>Github Actions</h1>
<p>Now we need to connect the github actions to replace the plan and apply actions
that were being taken by the TFC webhook previously. All of these changes will
be in the <code>infra</code> repository that was generated from <code>bootstrap</code>.  We are done
with the bootstrap at this point.</p>
<p>First, lets setup the <code>.github</code> folder, the end result we want is:</p>
<pre><code class="hljs language-bash">.github/
└── workflows
    ├── on-apply-finished.yml
    ├── on-pull-request-labeled.yml
    └── on-pull-request.yml
</code></pre>
<p>So create the folders:</p>
<pre><code class="hljs language-bash">❯ <span class="hljs-built_in">mkdir</span> -p .github/workflows
❯ terraform apply
</code></pre>
<h1>On Pull Request</h1>
<p>The first flow we'll create is the <code>terraform plan</code> workflow which should be
ran whenever a pull request is opened. Create the file
<code>.github/workflows/on-pull-request.yml</code> and put this content in it:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">name:</span> <span class="hljs-string">pr_build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">TERRAFORM_CLOUD_TOKENS:</span> <span class="hljs-string">app.terraform.io=${{</span> <span class="hljs-string">secrets.TFE_TOKEN</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">GITHUB_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">terraform_validate:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-22.04</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">fail-fast:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">folder:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">validate</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dflook/terraform-validate@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">workspace:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>

  <span class="hljs-attr">terraform_fmt:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-22.04</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">fail-fast:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">folder:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">fmt</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dflook/terraform-fmt-check@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">workspace:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>

  <span class="hljs-attr">terraform_plan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-22.04</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">pull-requests:</span> <span class="hljs-string">write</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">fail-fast:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">folder:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">plan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dflook/terraform-plan@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">workspace:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
</code></pre>
<p>This creates three jobs:</p>
<ul>
<li><strong>terraform_validate</strong>: This validates the terraform via <code>terraform validate</code>
command to make sure that it is correct and doesn't have duplicate resources
or anything like that.</li>
<li><strong>terraform_fmt</strong>: This verifies that the terraform is well formatted by
running the <code>terraform fmt</code> command.`</li>
<li><strong>terraform_plan</strong>: This runs the <code>terraform</code> plan and comments on the PR a
diff of the changes for you to verify.</li>
</ul>
<p>To verify this is working, lets make a change to the infrastructure so that we
can see a plan executed. We can bring back the <code>SQS</code> resource we destroyed in
the previous article. Create a file called <code>root/2-sqs.tf</code>:</p>
<pre><code class="hljs language-hcl"><span class="hljs-keyword">resource</span> <span class="hljs-string">"aws_sqs_queue"</span> <span class="hljs-string">"example-sqs"</span> {
  name                      = <span class="hljs-string">"example-sqs"</span>
  message_retention_seconds = <span class="hljs-number">86400</span>
  receive_wait_time_seconds = <span class="hljs-number">10</span>
}
</code></pre>
<p>Lets push a branch and make a pull request to see the result so far:</p>
<pre><code class="hljs language-bash">❯ git add .github/ root/
❯ git checkout -b apply-before-merge
❯ git commit -m <span class="hljs-string">"Implemented on-pull-request"</span>
❯ git push origin <span class="hljs-built_in">head</span>
</code></pre>
<p>After you make the pull request you should 3 checks on it and a comment that
shows the plan:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/github_comment.png" width="400">
<img src="/images/posts/aws_apply_before_merge/github_checks.png" width="400">
</center>
<h1>Apply on Label</h1>
<p>So now that the plan is working we need some way to <code>apply</code> the changes. I've
found the best way to do this is via a label rather than a comment because of
the way github actions work. Their event based actions like <code>on-comment</code> aren't
executed in the context of a pull-request.</p>
<p>Since we will be using a label to signal a plan is ready to be applied lets
create a new file <code>.github/workflows/on-pull-request-labeled.yml</code> and provide
this content:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">pr_apply</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">types:</span> [ <span class="hljs-string">labeled</span> ]

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">TERRAFORM_CLOUD_TOKENS:</span> <span class="hljs-string">app.terraform.io=${{</span> <span class="hljs-string">secrets.TFE_TOKEN</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">GITHUB_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">terraform_apply:</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.event.label.name</span> <span class="hljs-string">==</span> <span class="hljs-string">'tfc-apply'</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-22.04</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">pull-requests:</span> <span class="hljs-string">write</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">fail-fast:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">folder:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">dflook/terraform-apply@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">workspace:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.folder</span> <span class="hljs-string">}}</span>
</code></pre>
<p>This will fire whenever a pull request is labeled with the <code>tfc-apply</code> label.
It will run the <code>apply</code> and update the previous plan comment to let you
know the status.</p>
<center>
<img src="/images/posts/aws_apply_before_merge/tfc_applying.png" width="400">
<img src="/images/posts/aws_apply_before_merge/tfc_applying_comment.png" width="400">
</center>
<h1>Merge on Apply</h1>
<p>One thing you'll notice is that the pull request stayed open even after the
infrastructure is applied and we don't want that. We want any changes that have
made it into the environment to be merged into <code>main</code> automatically. To do
this we'll create our final action.</p>
<p>Create a new file <code>.github/workflows/on-apply-finished.yml</code> with this content:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">pr_merge</span>

<span class="hljs-comment"># Only trigger, when the build workflow succeeded</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_run:</span>
    <span class="hljs-attr">workflows:</span> [<span class="hljs-string">pr_apply</span>]
    <span class="hljs-attr">types:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">completed</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">merge:</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.event.workflow_run.conclusion</span> <span class="hljs-string">==</span> <span class="hljs-string">'success'</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-22.04</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">write</span>
      <span class="hljs-attr">pull-requests:</span> <span class="hljs-string">write</span>
      <span class="hljs-attr">checks:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">statuses:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">actions:</span> <span class="hljs-string">read</span>
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-attr">pullRequestNumber:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.workflow-run-info.outputs.pullRequestNumber</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"Get information about the current run"</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">potiuk/get-workflow-origin@v1_5</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">workflow-run-info</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">sourceRunId:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.event.workflow_run.id</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">merge</span> <span class="hljs-string">a</span> <span class="hljs-string">pull</span> <span class="hljs-string">request</span> <span class="hljs-string">after</span> <span class="hljs-string">terraform</span> <span class="hljs-string">apply</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">sudo-bot/action-pull-request-merge@v1.2.0</span>
        <span class="hljs-attr">with:</span>
            <span class="hljs-attr">github-token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
            <span class="hljs-attr">number:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.workflow-run-info.outputs.pullRequestNumber</span> <span class="hljs-string">}}</span>
</code></pre>
<p>This will wait until the <code>pr_apply</code> job completes and as long as it was
successful it'll merge the branch!</p>
<p><strong>NOTE</strong>: As I mentioned earlier, the event based actions do not run in the
context of the pull request which means you cannot test changes to them during
the PR either.  You must merge the <code>on-apply-finished.yml</code> file to <code>main</code>
before it starts working.</p>
<h1>Branch Protection</h1>
<p>The final step to the process is to make sure you go to your github settings
and make sure these status checks are required before merging. Branch protection
is a feature that will prevent merging changes into a branch unless all
required checks are passing.</p>
<p>Go to <code>Settings</code> -> <code>Branches</code> -> <code>Branch Protection</code> and add a branch
protection rule:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/branch_protection.png" width="500">
</center>
<p>You want to enable the following settings:</p>
<ul>
<li><strong>Branch Name</strong>: main</li>
<li>✅ Require a pull request before merging</li>
<li>✅ Require status checks to pass before merging</li>
</ul>
<p>Then for <code>Status checks that are required.</code> select all of the ones we've
created:</p>
<center>
<img src="/images/posts/aws_apply_before_merge/required_checks.png" height="200">
</center></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2023","aws_from_scratch_apply_before_merge"],"path":"2023/aws_from_scratch_apply_before_merge","contentHtml":"\u003cp\u003eThe two most popular workflows when using terraform are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply after Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://terraform.io\"\u003eterraform cloud\u003c/a\u003e and most github actions.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eApply before Merge\u003c/strong\u003e: This is the default for things like\n\u003ca href=\"https://www.runatlantis.io/\"\u003eAtlantis\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI don't like apply-after-merge.  There are a lot of ways where a \u003ccode\u003eplan\u003c/code\u003e\ncan succeed but an \u003ccode\u003eapply\u003c/code\u003e will fail and you end up with broken configuration\nin \u003ccode\u003emain\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eSo in this article I'll show you how to implement \u003cstrong\u003eapply-before-merge\u003c/strong\u003e with\ngithub actions.\u003c/p\u003e\n\u003cp\u003eIf you haven't ready my \u003ca href=\"/blog/2023/aws_from_scratch_root_account\"\u003eprevious article\u003c/a\u003e,\nit covers how to setup terraform cloud with apply after merge and bootstrap your AWS\naccount with terraform.  I will assume you have read that article going forward.\u003c/p\u003e\n\u003ch1\u003eTL;DR\u003c/h1\u003e\n\u003cp\u003eThe code for the github actions we create in this post can be found\n\u003ca href=\"https://github.com/sontek/aws-terraform-github-actions\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eRepairing the bootstrap\u003c/h1\u003e\n\u003cp\u003eWith apply-before-merge we need to implement it in github actions rather than\nutilizing the terraform cloud webhooks.  So lets drop the VCS repo and usage of\nthe webhook from our github repository. Basically anything that references\n\u003ccode\u003egithub_oauth_client\u003c/code\u003e can be removed because we will no longer be using OAuth\nwith Github for our CI/CD pipeline.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e\u003cspan class=\"hljs-comment\"\u003ediff --git a/1-variables.tf b/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex bf1f434..7109924 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/1-variables.tf\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -47,12 +47,6 @@\u003c/span\u003e variable \"github_default_branch\" {\n   default     = \"main\"\n }\n \n\u003cspan class=\"hljs-deletion\"\u003e-variable \"github_oauth_client_id\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  description = \"The token for the TFC OAuth client shown under VCS providers\"\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  type        = string\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  default     = null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-}\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n variable \"aws_root_account_id\" {\n   description = \"The AWS root account we want to apply these changes to\"\n   type        = string\n\u003cspan class=\"hljs-comment\"\u003ediff --git a/4-tfc.tf b/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex a8217b7..9852228 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/4-tfc.tf\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -77,31 +77,12 @@\u003c/span\u003e resource \"aws_iam_role_policy_attachment\" \"tfc-access-attach\" {\n   policy_arn = aws_iam_policy.tfc-agent.arn\n }\n \n\u003cspan class=\"hljs-deletion\"\u003e-/* Fetch an oauth token from the client */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-data \"tfe_oauth_client\" \"github\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  /* Don't fetch the client if we don't have the client_id */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  count           = var.github_oauth_client_id != null ? 1 : 0\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  oauth_client_id = var.github_oauth_client_id\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-}\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n resource \"tfe_workspace\" \"workspaces\" {\n   count        = length(var.tfc_workspaces)\n   name         = var.tfc_workspaces[count.index]\n   organization = tfe_organization.organization.name\n \n   working_directory = var.tfc_workspaces[count.index]\n\u003cspan class=\"hljs-deletion\"\u003e-\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  /* This generates a webhook on the github repository so plans are triggered\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  automatically.   We dynamically set the setting because we will not have the\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  oauth client ID on first pass.\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  */\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  dynamic \"vcs_repo\" {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    for_each = var.github_oauth_client_id != null ? [var.github_oauth_client_id] : []\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    content {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-      identifier     = format(\"%s/%s\", var.github_organization, github_repository.repo.name)\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-      oauth_token_id = data.tfe_oauth_client.github[0].oauth_token_id\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-    }\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-  }\u003c/span\u003e\n }\n \n /* These variables tell the agent to use dynamic credentials */\n\u003cspan class=\"hljs-comment\"\u003ediff --git a/settings.auto.tfvars.example b/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003eindex 3327f02..79221c1 100644\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e--- a/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e+++ b/settings.auto.tfvars.example\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@@ -4,6 +4,5 @@\u003c/span\u003e tfc_workspaces = [\n   \"root\"\n ]\n github_organization    = \"github-org\"\n\u003cspan class=\"hljs-deletion\"\u003e-github_oauth_client_id = \"oc-...\"\u003c/span\u003e\n github_repo_name       = \"my-infra\"\n aws_root_account_id    =  \"888888888888\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce that is removed from your \u003ccode\u003einfra-bootstrap\u003c/code\u003e repository we need to create\na new github secret with a token for Github to be able to talk with TFC. Make\na new file called \u003ccode\u003e5-github-actions.tf\u003c/code\u003e with the following content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_team\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"owners\"\u003c/span\u003e {\n  name         = \u003cspan class=\"hljs-string\"\u003e\"owners\"\u003c/span\u003e\n  organization = tfe_organization.organization.name\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_team_token\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_actions_token\"\u003c/span\u003e {\n  team_id = \u003cspan class=\"hljs-keyword\"\u003edata\u003c/span\u003e.tfe_team.owners.id\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"github_actions_secret\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"tfe_secret\"\u003c/span\u003e {\n  repository      = github_repository.repo.name\n  secret_name     = \u003cspan class=\"hljs-string\"\u003e\"TFE_TOKEN\"\u003c/span\u003e\n  plaintext_value = tfe_team_token.github_actions_token.token\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen you should \u003ccode\u003eplan\u003c/code\u003e and \u003ccode\u003eapply\u003c/code\u003e the change:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ terraform plan\n❯ terraform apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe only change to the infrastructure should be to remove the VCS link and\nadding the secret:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e  # tfe_workspace.workspaces[0] will be updated in-place\n  ~ resource \"tfe_workspace\" \"workspaces\" {\n        id                            = \"ws-K1M4tdXUUeASgmUR\"\n        name                          = \"root\"\n        # (20 unchanged attributes hidden)\n\n\u003cspan class=\"hljs-deletion\"\u003e-       vcs_repo {\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           identifier         = \"sontek/sontek-infra\" -\u003e null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           ingress_submodules = false -\u003e null\u003c/span\u003e\n\u003cspan class=\"hljs-deletion\"\u003e-           oauth_token_id     = \"ot-nMYJRbBb2SH9zCP7\" -\u003e null\u003c/span\u003e\n        }\n    }\n\n  # github_actions_secret.tfe_secret will be created\n\u003cspan class=\"hljs-addition\"\u003e+   resource \"github_actions_secret\" \"tfe_secret\" {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       created_at      = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       id              = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       plaintext_value = (sensitive value)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       repository      = \"sontek-infra\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       secret_name     = \"TFE_TOKEN\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       updated_at      = (known after apply)\u003c/span\u003e\n    }\n\n  # tfe_team_token.github_actions_token will be created\n\u003cspan class=\"hljs-addition\"\u003e+   resource \"tfe_team_token\" \"github_actions_token\" {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       id      = (known after apply)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       team_id = \"team-...\"\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+       token   = (sensitive value)\u003c/span\u003e\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eGithub Actions\u003c/h1\u003e\n\u003cp\u003eNow we need to connect the github actions to replace the plan and apply actions\nthat were being taken by the TFC webhook previously. All of these changes will\nbe in the \u003ccode\u003einfra\u003c/code\u003e repository that was generated from \u003ccode\u003ebootstrap\u003c/code\u003e.  We are done\nwith the bootstrap at this point.\u003c/p\u003e\n\u003cp\u003eFirst, lets setup the \u003ccode\u003e.github\u003c/code\u003e folder, the end result we want is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e.github/\n└── workflows\n    ├── on-apply-finished.yml\n    ├── on-pull-request-labeled.yml\n    └── on-pull-request.yml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo create the folders:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p .github/workflows\n❯ terraform apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eOn Pull Request\u003c/h1\u003e\n\u003cp\u003eThe first flow we'll create is the \u003ccode\u003eterraform plan\u003c/code\u003e workflow which should be\nran whenever a pull request is opened. Create the file\n\u003ccode\u003e.github/workflows/on-pull-request.yml\u003c/code\u003e and put this content in it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_build\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epull_request:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebranches:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emain\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eTERRAFORM_CLOUD_TOKENS:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapp.terraform.io=${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.TFE_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eGITHUB_TOKEN:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eterraform_validate:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCheckout\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003evalidate\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-validate@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003eterraform_fmt:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efmt\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-fmt-check@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n  \u003cspan class=\"hljs-attr\"\u003eterraform_plan:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eplan\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-plan@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis creates three jobs:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_validate\u003c/strong\u003e: This validates the terraform via \u003ccode\u003eterraform validate\u003c/code\u003e\ncommand to make sure that it is correct and doesn't have duplicate resources\nor anything like that.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_fmt\u003c/strong\u003e: This verifies that the terraform is well formatted by\nrunning the \u003ccode\u003eterraform fmt\u003c/code\u003e command.`\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eterraform_plan\u003c/strong\u003e: This runs the \u003ccode\u003eterraform\u003c/code\u003e plan and comments on the PR a\ndiff of the changes for you to verify.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTo verify this is working, lets make a change to the infrastructure so that we\ncan see a plan executed. We can bring back the \u003ccode\u003eSQS\u003c/code\u003e resource we destroyed in\nthe previous article. Create a file called \u003ccode\u003eroot/2-sqs.tf\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\u003cspan class=\"hljs-keyword\"\u003eresource\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"aws_sqs_queue\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e {\n  name                      = \u003cspan class=\"hljs-string\"\u003e\"example-sqs\"\u003c/span\u003e\n  message_retention_seconds = \u003cspan class=\"hljs-number\"\u003e86400\u003c/span\u003e\n  receive_wait_time_seconds = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets push a branch and make a pull request to see the result so far:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e❯ git add .github/ root/\n❯ git checkout -b apply-before-merge\n❯ git commit -m \u003cspan class=\"hljs-string\"\u003e\"Implemented on-pull-request\"\u003c/span\u003e\n❯ git push origin \u003cspan class=\"hljs-built_in\"\u003ehead\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter you make the pull request you should 3 checks on it and a comment that\nshows the plan:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_comment.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/github_checks.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eApply on Label\u003c/h1\u003e\n\u003cp\u003eSo now that the plan is working we need some way to \u003ccode\u003eapply\u003c/code\u003e the changes. I've\nfound the best way to do this is via a label rather than a comment because of\nthe way github actions work. Their event based actions like \u003ccode\u003eon-comment\u003c/code\u003e aren't\nexecuted in the context of a pull-request.\u003c/p\u003e\n\u003cp\u003eSince we will be using a label to signal a plan is ready to be applied lets\ncreate a new file \u003ccode\u003e.github/workflows/on-pull-request-labeled.yml\u003c/code\u003e and provide\nthis content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_apply\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003epull_request:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003etypes:\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003elabeled\u003c/span\u003e ]\n\n\u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eTERRAFORM_CLOUD_TOKENS:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapp.terraform.io=${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.TFE_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eGITHUB_TOKEN:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eterraform_apply:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eif:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.label.name\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'tfc-apply'\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estrategy:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003efail-fast:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ematrix:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003efolder:\u003c/span\u003e\n          \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eactions/checkout@v3\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edflook/terraform-apply@v1\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003epath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eworkspace:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ematrix.folder\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will fire whenever a pull request is labeled with the \u003ccode\u003etfc-apply\u003c/code\u003e label.\nIt will run the \u003ccode\u003eapply\u003c/code\u003e and update the previous plan comment to let you\nknow the status.\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying.png\" width=\"400\"\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/tfc_applying_comment.png\" width=\"400\"\u003e\n\u003c/center\u003e\n\u003ch1\u003eMerge on Apply\u003c/h1\u003e\n\u003cp\u003eOne thing you'll notice is that the pull request stayed open even after the\ninfrastructure is applied and we don't want that. We want any changes that have\nmade it into the environment to be merged into \u003ccode\u003emain\u003c/code\u003e automatically. To do\nthis we'll create our final action.\u003c/p\u003e\n\u003cp\u003eCreate a new file \u003ccode\u003e.github/workflows/on-apply-finished.yml\u003c/code\u003e with this content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epr_merge\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Only trigger, when the build workflow succeeded\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eon:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eworkflow_run:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eworkflows:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003epr_apply\u003c/span\u003e]\n    \u003cspan class=\"hljs-attr\"\u003etypes:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecompleted\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr\"\u003ejobs:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003emerge:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eif:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.workflow_run.conclusion\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'success'\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eruns-on:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eubuntu-22.04\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003epermissions:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003econtents:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epull-requests:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewrite\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003echecks:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003estatuses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eactions:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eread\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eoutputs:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003epullRequestNumber:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esteps.workflow-run-info.outputs.pullRequestNumber\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003esteps:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Get information about the current run\"\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epotiuk/get-workflow-origin@v1_5\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eworkflow-run-info\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003etoken:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003esourceRunId:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egithub.event.workflow_run.id\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emerge\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ea\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erequest\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eafter\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eterraform\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapply\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003euses:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esudo-bot/action-pull-request-merge@v1.2.0\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ewith:\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003egithub-token:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esecrets.GITHUB_TOKEN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003enumber:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${{\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esteps.workflow-run-info.outputs.pullRequestNumber\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will wait until the \u003ccode\u003epr_apply\u003c/code\u003e job completes and as long as it was\nsuccessful it'll merge the branch!\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e: As I mentioned earlier, the event based actions do not run in the\ncontext of the pull request which means you cannot test changes to them during\nthe PR either.  You must merge the \u003ccode\u003eon-apply-finished.yml\u003c/code\u003e file to \u003ccode\u003emain\u003c/code\u003e\nbefore it starts working.\u003c/p\u003e\n\u003ch1\u003eBranch Protection\u003c/h1\u003e\n\u003cp\u003eThe final step to the process is to make sure you go to your github settings\nand make sure these status checks are required before merging. Branch protection\nis a feature that will prevent merging changes into a branch unless all\nrequired checks are passing.\u003c/p\u003e\n\u003cp\u003eGo to \u003ccode\u003eSettings\u003c/code\u003e -\u003e \u003ccode\u003eBranches\u003c/code\u003e -\u003e \u003ccode\u003eBranch Protection\u003c/code\u003e and add a branch\nprotection rule:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/branch_protection.png\" width=\"500\"\u003e\n\u003c/center\u003e\n\u003cp\u003eYou want to enable the following settings:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBranch Name\u003c/strong\u003e: main\u003c/li\u003e\n\u003cli\u003e✅ Require a pull request before merging\u003c/li\u003e\n\u003cli\u003e✅ Require status checks to pass before merging\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThen for \u003ccode\u003eStatus checks that are required.\u003c/code\u003e select all of the ones we've\ncreated:\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"/images/posts/aws_apply_before_merge/required_checks.png\" height=\"200\"\u003e\n\u003c/center\u003e","category":"AWS","date":"2023-04-01T20:00:00-04:00","tags":["AWS","DevOps","SRE"],"title":"AWS From Scratch with Terraform - Apply before Merge with Github Actions"}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["2023","aws_from_scratch_apply_before_merge"]},"buildId":"4vZnC0vsg19sm_oc5ANpG","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>