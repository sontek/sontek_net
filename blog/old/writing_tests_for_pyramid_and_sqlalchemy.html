<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="alternate" type="application/rss+xml" title="sontek&#x27;s Engineering Blog" href="/rss.xml"/><title>Writing tests for Pyramid and SQLAlchemy</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/c9439d4f00292099.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c9439d4f00292099.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e3e8d9bb9a664264.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e3e8d9bb9a664264.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-2a9c662ddd7329fb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e535547a4fdaa691.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/790-a3aa35eb62ec874e.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...id%5D-13b90f409a03d315.js" defer=""></script><script src="/_next/static/Q4Ztqby-K8_DMGM3CPruu/_buildManifest.js" defer=""></script><script src="/_next/static/Q4Ztqby-K8_DMGM3CPruu/_ssgManifest.js" defer=""></script><script src="/_next/static/Q4Ztqby-K8_DMGM3CPruu/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div class="grid"><div class="col"><header id="banner" class="body"><h1><a href="/">sontek.net</a></h1></header></div><div class="col menu"><nav><ul><li><a href="/">Home</a></li><li><a href="/blog">Blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/about">About</a></li></ul></nav></div></div><div class="container"><article class="blog_article__NoEy4"><h1 class="util_headingXl__knZ_h">Writing tests for Pyramid and SQLAlchemy</h1><div class="util_lightText__xcqUE">Published on <time dateTime="2011-11-30T20:00:00-04:00">November 30, 2011</time></div><div class="util_lightText__xcqUE">Tagged with: <a class="blog_tag__RvKKS" href="/blog/tags/Python">Python</a></div><div><p>TL;DR: Putting it all together, the full code can be found here:
<a href="https://gist.github.com/1420255">https://gist.github.com/1420255</a></p>
<h1>Intro</h1>
<p>Pyramid's documentation doesn't cover the preferred way to test with
SQLAlchemy, because Pyramid tries to stay out of your way and allow you
to make your own decisions. However, I feel i'ts necessary to document
what I think is the best way to test.</p>
<p>When I first started writing tests with SQLAlchemy I found plenty of
examples of how to to get started by doing something like this:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> db </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> session </span><span style="color: #768390"># probably a contextbound sessionmaker</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> db </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> model</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> sqlalchemy </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> create_engine</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setup</span><span style="color: #ADBAC7">():</span></span>
<span data-line=""><span style="color: #ADBAC7">    engine </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> create_engine(</span><span style="color: #96D0FF">'sqlite:///test.db'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">    session.configure(</span><span style="color: #F69D50">bind</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">engine)</span></span>
<span data-line=""><span style="color: #ADBAC7">    model.metadata.create_all(engine)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">teardown</span><span style="color: #ADBAC7">():</span></span>
<span data-line=""><span style="color: #ADBAC7">    model.metadata.drop_all(engine)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_something</span><span style="color: #ADBAC7">():</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">pass</span></span></code></pre></div>
<p>I have seen this done so many times, but I feel there is so much wrong
with it! So let's establish some base rules when testing:</p>
<blockquote>
<ul>
<li>Always test your system like it would be used in production.
SQLite does not enforce the same rules or have the same features
as Postgres or MySQL and will allow tests to pass that would
otherwise fail in production.</li>
<li>Tests should be fast! You should be writing tests for all your
code. This is the main reason people do test against SQLite, but
we can't violate rule number one. We have to make sure tests
against Postgres are fast, so we shouldn't be tearing down and
recreating tables for every single test.</li>
<li>You should be able to execute in parallel to speed up when you
have thousands of tests. Dropping and creating tables per test
would not work in a parallel environment.</li>
</ul>
</blockquote>
<p>For an example, I have a project with 600+ tests and it would take 2 and
half minutes to execute running against SQLite. But when we swapped our
test configuration to execute against Postgres, testing took well over
an hour. That is unacceptable!</p>
<p>But running them in parallel will give us a huge speed up. Check out the
results of the tests running in single proc mode vs using all 4 cores:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="" data-theme="default"><code data-language="" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #adbac7">$ py.test</span></span>
<span data-line=""><span style="color: #adbac7">======= 616 passed in 143.67 seconds =======</span></span>
<span data-line=""><span style="color: #adbac7"></span></span>
<span data-line=""><span style="color: #adbac7">$ py.test -n4</span></span>
<span data-line=""><span style="color: #adbac7">======= 616 passed in 68.12 seconds =======</span></span></code></pre></div>
<h1>The right way</h1>
<p>So what is the proper way to setup your tests? You should initialize the
database when you start your test runner and then use transactions to
rollback any data changes your tests made. This allows you to keep a
clean database for each test in a very efficient way.</p>
<p>In py.test, you just have to create a file called conftest.py that looks
similar to:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">import</span><span style="color: #ADBAC7"> os</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #6CB6FF">ROOT_PATH</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> os.path.dirname(</span><span style="color: #6CB6FF">__file__</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">pytest_sessionstart</span><span style="color: #ADBAC7">():</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> py.test </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> config</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #768390"># Only run database setup on master (in case of xdist/multiproc mode)</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">if</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">not</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">hasattr</span><span style="color: #ADBAC7">(config, </span><span style="color: #96D0FF">'slaveinput'</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> models </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> initialize_sql</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> pyramid.config </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> Configurator</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> paste.deploy.loadwsgi </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> appconfig</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> sqlalchemy </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> engine_from_config</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> os</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">ROOT_PATH</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> os.path.dirname(</span><span style="color: #6CB6FF">__file__</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        settings </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> appconfig(</span><span style="color: #96D0FF">'config:'</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">+</span><span style="color: #ADBAC7"> os.path.join(</span><span style="color: #6CB6FF">ROOT_PATH</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'test.ini'</span><span style="color: #ADBAC7">))</span></span>
<span data-line=""><span style="color: #ADBAC7">        engine </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> engine_from_config(settings, </span><span style="color: #F69D50">prefix</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'sqlalchemy.'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">print</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">'Creating the tables on the test database </span><span style="color: #F47067">%s</span><span style="color: #96D0FF">'</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">%</span><span style="color: #ADBAC7"> engine</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        config </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> Configurator(</span><span style="color: #F69D50">settings</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">settings)</span></span>
<span data-line=""><span style="color: #ADBAC7">        initialize_sql(settings, config)</span></span></code></pre></div>
<p>With py.test, when you are running in parallel mode, the
pytest_sessionstart hook gets fired for each node, so we check that we
are on the master node. Then we just grab our test.ini configuration
file and execute the initialize_sql function.</p>
<p>Now that you have your initial test configuration finished, you have to
define a base test class that does the transaction management in setUp
and teardown.</p>
<p>First, lets setup the Base testing class what will manage our
transactions:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">import</span><span style="color: #ADBAC7"> unittest</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> pyramid </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> testing</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> paste.deploy.loadwsgi </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> appconfig</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> webtest </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> TestApp</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> mock </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> Mock</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> sqlalchemy </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> engine_from_config</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> sqlalchemy.orm </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> sessionmaker</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> app.db </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> Session</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> app.db </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> Entity  </span><span style="color: #768390"># base declarative object</span></span>
<span data-line=""><span style="color: #F47067">from</span><span style="color: #ADBAC7"> app </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> main</span></span>
<span data-line=""><span style="color: #F47067">import</span><span style="color: #ADBAC7"> os</span></span>
<span data-line=""><span style="color: #ADBAC7">here </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> os.path.dirname(</span><span style="color: #6CB6FF">__file__</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">settings </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> appconfig(</span><span style="color: #96D0FF">'config:'</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">+</span><span style="color: #ADBAC7"> os.path.join(here, </span><span style="color: #96D0FF">'../../'</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'test.ini'</span><span style="color: #ADBAC7">))</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #F47067">class</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">BaseTestCase</span><span style="color: #ADBAC7">(</span><span style="color: #6CB6FF">unittest</span><span style="color: #ADBAC7">.</span><span style="color: #6CB6FF">TestCase</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #DCBDFB">@</span><span style="color: #6CB6FF">classmethod</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setUpClass</span><span style="color: #ADBAC7">(cls):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">cls</span><span style="color: #ADBAC7">.engine </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> engine_from_config(settings, </span><span style="color: #F69D50">prefix</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'sqlalchemy.'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">cls</span><span style="color: #ADBAC7">.Session </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> sessionmaker()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setUp</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        connection </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.engine.connect()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #768390"># begin a non-ORM transaction</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.trans </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> connection.begin()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #768390"># bind an individual Session to the connection</span></span>
<span data-line=""><span style="color: #ADBAC7">        Session.configure(</span><span style="color: #F69D50">bind</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">connection)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.Session(</span><span style="color: #F69D50">bind</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">connection)</span></span>
<span data-line=""><span style="color: #ADBAC7">        Entity.session </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">tearDown</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #768390"># rollback - everything that happened with the</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #768390"># Session above (including calls to commit())</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #768390"># is rolled back.</span></span>
<span data-line=""><span style="color: #ADBAC7">        testing.tearDown()</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.trans.rollback()</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session.close()</span></span></code></pre></div>
<p>This base test case will wrap all your sessions in an external
transaction so that you still have the ability to call flush/commit/etc
and it will still be able to rollback any data changes you make.</p>
<h1>Unit Tests</h1>
<p>Now there are a few different types of tests you will want to run.
First, you will want to do unit tests, which are small tests that only
test 1 thing at a time. This means you will skip the routes, templates,
etc. So let's setup our Unit Test Base class:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">class</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">UnitTestBase</span><span style="color: #ADBAC7">(</span><span style="color: #6CB6FF">BaseTestCase</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setUp</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> testing.setUp(</span><span style="color: #F69D50">request</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">testing.DummyRequest())</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">super</span><span style="color: #ADBAC7">(UnitTestBase, </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">).setUp()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">get_csrf_request</span><span style="color: #ADBAC7">(self, post</span><span style="color: #F47067">=</span><span style="color: #6CB6FF">None</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">        csrf </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">'abc'</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">if</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">not</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'csrf_token'</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">in</span><span style="color: #ADBAC7"> post.keys():</span></span>
<span data-line=""><span style="color: #ADBAC7">            post.update({</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'csrf_token'</span><span style="color: #ADBAC7">: csrf</span></span>
<span data-line=""><span style="color: #ADBAC7">            })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        request </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> testing.DummyRequest(post)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        request.session </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> Mock()</span></span>
<span data-line=""><span style="color: #ADBAC7">        csrf_token </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> Mock()</span></span>
<span data-line=""><span style="color: #ADBAC7">        csrf_token.return_value </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> csrf</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        request.session.get_csrf_token </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> csrf_token</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">return</span><span style="color: #ADBAC7"> request</span></span></code></pre></div>
<p>We built in a utility function to help us test requests that require a
csrf token as well. Here is how we would use this class:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">class</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">TestViews</span><span style="color: #ADBAC7">(</span><span style="color: #6CB6FF">UnitTestBase</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_login_fails_empty</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">""" Make sure we can't login with empty credentials"""</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> app.accounts.views </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> LoginView</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config.add_route(</span><span style="color: #96D0FF">'index'</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'/'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config.add_route(</span><span style="color: #96D0FF">'dashboard'</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'/'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        request </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> testing.DummyRequest(</span><span style="color: #F69D50">post</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">            </span><span style="color: #96D0FF">'submit'</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">True</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">        })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        view </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> LoginView(request)</span></span>
<span data-line=""><span style="color: #ADBAC7">        response </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> view.post()</span></span>
<span data-line=""><span style="color: #ADBAC7">        errors </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> response[</span><span style="color: #96D0FF">'errors'</span><span style="color: #ADBAC7">]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">0</span><span style="color: #ADBAC7">].node.name </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'csrf_token'</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">0</span><span style="color: #ADBAC7">].msg </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'Required'</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">1</span><span style="color: #ADBAC7">].node.name </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'Username'</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">1</span><span style="color: #ADBAC7">].msg </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'Required'</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">2</span><span style="color: #ADBAC7">].node.name </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'Password'</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> errors[</span><span style="color: #6CB6FF">2</span><span style="color: #ADBAC7">].msg </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">u</span><span style="color: #96D0FF">'Required'</span></span>
<span data-line=""> </span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_login_succeeds</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">""" Make sure we can login """</span></span>
<span data-line=""><span style="color: #ADBAC7">        admin </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> User(</span><span style="color: #F69D50">username</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'sontek'</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">password</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'temp'</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">kind</span><span style="color: #F47067">=</span><span style="color: #F47067">u</span><span style="color: #96D0FF">'admin'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        admin.activated </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">True</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session.add(admin)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session.flush()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">from</span><span style="color: #ADBAC7"> app.accounts.views </span><span style="color: #F47067">import</span><span style="color: #ADBAC7"> LoginView</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config.add_route(</span><span style="color: #96D0FF">'index'</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'/'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config.add_route(</span><span style="color: #96D0FF">'dashboard'</span><span style="color: #ADBAC7">, </span><span style="color: #96D0FF">'/dashboard'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        request </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.get_csrf_request(</span><span style="color: #F69D50">post</span><span style="color: #F47067">=</span><span style="color: #ADBAC7">{</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'submit'</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">True</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'Username'</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">'sontek'</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'Password'</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">'temp'</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">            })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        view </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> LoginView(request)</span></span>
<span data-line=""><span style="color: #ADBAC7">        response </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> view.post()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> response.status_int </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">302</span></span></code></pre></div>
<h1>Integration Tests</h1>
<p>The second type of test you will want to write is an integration test.
This will integrate with the whole web framework and actually hit the
define routes, render the templates, and actually test the full stack of
your application.</p>
<p>Luckily this is pretty easy to do with Pyramid using WebTest:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">class</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">IntegrationTestBase</span><span style="color: #ADBAC7">(</span><span style="color: #6CB6FF">BaseTestCase</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #DCBDFB">@</span><span style="color: #6CB6FF">classmethod</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setUpClass</span><span style="color: #ADBAC7">(cls):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">cls</span><span style="color: #ADBAC7">.app </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> main({}, </span><span style="color: #F47067">**</span><span style="color: #ADBAC7">settings)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">super</span><span style="color: #ADBAC7">(IntegrationTestBase, </span><span style="color: #6CB6FF">cls</span><span style="color: #ADBAC7">).setUpClass()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">setUp</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> TestApp(</span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.config </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> testing.setUp()</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">super</span><span style="color: #ADBAC7">(IntegrationTestBase, </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">).setUp()</span></span></code></pre></div>
<p>In setUpClass, we run the main function of the applications
__init__.py that sets up the WSGI application and then we wrap it in
a TestApp that gives us the ability to call get/post on it.</p>
<p>Here is an example of it in use:</p>
<div data-rehype-pretty-code-fragment=""><pre class="github-dark-dimmed" style="background-color: #22272e" tabindex="0" data-language="python" data-theme="default"><code data-language="python" data-theme="default" style="display: grid;"><span data-line=""><span style="color: #F47067">class</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">TestViews</span><span style="color: #ADBAC7">(</span><span style="color: #6CB6FF">IntegrationTestBase</span><span style="color: #ADBAC7">):</span></span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_get_login</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">""" Call the login view, make sure routes are working """</span></span>
<span data-line=""><span style="color: #ADBAC7">        res </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app.get(</span><span style="color: #96D0FF">'/login'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.assertEqual(res.status_int, </span><span style="color: #6CB6FF">200</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_empty_login</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">""" Empty login fails """</span></span>
<span data-line=""><span style="color: #ADBAC7">        res </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app.post(</span><span style="color: #96D0FF">'/login'</span><span style="color: #ADBAC7">, {</span><span style="color: #96D0FF">'submit'</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">True</span><span style="color: #ADBAC7">})</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"There was a problem with your submission"</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">in</span><span style="color: #ADBAC7"> res.body</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> </span><span style="color: #96D0FF">"Required"</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">in</span><span style="color: #ADBAC7"> res.body</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> res.status_int </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">200</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">    </span><span style="color: #F47067">def</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">test_valid_login</span><span style="color: #ADBAC7">(self):</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #96D0FF">""" Call the login view, make sure routes are working """</span></span>
<span data-line=""><span style="color: #ADBAC7">        admin </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> User(</span><span style="color: #F69D50">username</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'sontek'</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">password</span><span style="color: #F47067">=</span><span style="color: #96D0FF">'temp'</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">kind</span><span style="color: #F47067">=</span><span style="color: #F47067">u</span><span style="color: #96D0FF">'admin'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""><span style="color: #ADBAC7">        admin.activated </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">True</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session.add(admin)</span></span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.session.flush()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        res </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app.get(</span><span style="color: #96D0FF">'/login'</span><span style="color: #ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        csrf </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> res.form.fields[</span><span style="color: #96D0FF">'csrf_token'</span><span style="color: #ADBAC7">][</span><span style="color: #6CB6FF">0</span><span style="color: #ADBAC7">].value</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        res </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">self</span><span style="color: #ADBAC7">.app.post(</span><span style="color: #96D0FF">'/login'</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">            {</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'submit'</span><span style="color: #ADBAC7">: </span><span style="color: #6CB6FF">True</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'Username'</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">'sontek'</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'Password'</span><span style="color: #ADBAC7">: </span><span style="color: #96D0FF">'temp'</span><span style="color: #ADBAC7">,</span></span>
<span data-line=""><span style="color: #ADBAC7">                </span><span style="color: #96D0FF">'csrf_token'</span><span style="color: #ADBAC7">: csrf</span></span>
<span data-line=""><span style="color: #ADBAC7">            }</span></span>
<span data-line=""><span style="color: #ADBAC7">        )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color: #ADBAC7">        </span><span style="color: #F47067">assert</span><span style="color: #ADBAC7"> res.status_int </span><span style="color: #F47067">==</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">302</span></span></code></pre></div>
<h1>Problems with this approach</h1>
<p>If a test causes an error that will prevent the transaction from rolling
back, such as closing the engine, then this approach will leave your
database in a state that might cause other tests to fail.</p>
<p>If this happens tracing the root cause could be difficult but you should
be able to just look at the first failed test unless you are running the
tests in parallel.</p>
<p>If you are good about writing and running your tests regularly you
should be able to catch individual tests causing issues like this fairly
quickly.</p>
<h1>Resources</h1>
<p><a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html">http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html</a></p>
<p><a href="http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction">http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction</a></p>
<p>John Anderson &#x3C;<a href="mailto:sontek@gmail.com">sontek@gmail.com</a>> 2011</p></div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["old","writing_tests_for_pyramid_and_sqlalchemy"],"path":"old/writing_tests_for_pyramid_and_sqlalchemy","contentHtml":"\u003cp\u003eTL;DR: Putting it all together, the full code can be found here:\n\u003ca href=\"https://gist.github.com/1420255\"\u003ehttps://gist.github.com/1420255\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eIntro\u003c/h1\u003e\n\u003cp\u003ePyramid's documentation doesn't cover the preferred way to test with\nSQLAlchemy, because Pyramid tries to stay out of your way and allow you\nto make your own decisions. However, I feel i'ts necessary to document\nwhat I think is the best way to test.\u003c/p\u003e\n\u003cp\u003eWhen I first started writing tests with SQLAlchemy I found plenty of\nexamples of how to to get started by doing something like this:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e db \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e session \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# probably a contextbound sessionmaker\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e db \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e model\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sqlalchemy \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e create_engine\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetup\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e():\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    engine \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e create_engine(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sqlite:///test.db'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    session.configure(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ebind\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003eengine)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    model.metadata.create_all(engine)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003eteardown\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e():\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    model.metadata.drop_all(engine)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_something\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e():\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003epass\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI have seen this done so many times, but I feel there is so much wrong\nwith it! So let's establish some base rules when testing:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eAlways test your system like it would be used in production.\nSQLite does not enforce the same rules or have the same features\nas Postgres or MySQL and will allow tests to pass that would\notherwise fail in production.\u003c/li\u003e\n\u003cli\u003eTests should be fast! You should be writing tests for all your\ncode. This is the main reason people do test against SQLite, but\nwe can't violate rule number one. We have to make sure tests\nagainst Postgres are fast, so we shouldn't be tearing down and\nrecreating tables for every single test.\u003c/li\u003e\n\u003cli\u003eYou should be able to execute in parallel to speed up when you\nhave thousands of tests. Dropping and creating tables per test\nwould not work in a parallel environment.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFor an example, I have a project with 600+ tests and it would take 2 and\nhalf minutes to execute running against SQLite. But when we swapped our\ntest configuration to execute against Postgres, testing took well over\nan hour. That is unacceptable!\u003c/p\u003e\n\u003cp\u003eBut running them in parallel will give us a huge speed up. Check out the\nresults of the tests running in single proc mode vs using all 4 cores:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"\" data-theme=\"default\"\u003e\u003ccode data-language=\"\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e$ py.test\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e======= 616 passed in 143.67 seconds =======\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e$ py.test -n4\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #adbac7\"\u003e======= 616 passed in 68.12 seconds =======\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eThe right way\u003c/h1\u003e\n\u003cp\u003eSo what is the proper way to setup your tests? You should initialize the\ndatabase when you start your test runner and then use transactions to\nrollback any data changes your tests made. This allows you to keep a\nclean database for each test in a very efficient way.\u003c/p\u003e\n\u003cp\u003eIn py.test, you just have to create a file called conftest.py that looks\nsimilar to:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #6CB6FF\"\u003eROOT_PATH\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os.path.dirname(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e__file__\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003epytest_sessionstart\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e():\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e py.test \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e config\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# Only run database setup on master (in case of xdist/multiproc mode)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003enot\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003ehasattr\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(config, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'slaveinput'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e models \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e initialize_sql\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e pyramid.config \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Configurator\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e paste.deploy.loadwsgi \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e appconfig\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sqlalchemy \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e engine_from_config\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eROOT_PATH\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os.path.dirname(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e__file__\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        settings \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e appconfig(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'config:'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e+\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os.path.join(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eROOT_PATH\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'test.ini'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e))\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        engine \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e engine_from_config(settings, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eprefix\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sqlalchemy.'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eprint\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Creating the tables on the test database \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e%s\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e%\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e engine\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        config \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Configurator(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003esettings\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003esettings)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        initialize_sql(settings, config)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWith py.test, when you are running in parallel mode, the\npytest_sessionstart hook gets fired for each node, so we check that we\nare on the master node. Then we just grab our test.ini configuration\nfile and execute the initialize_sql function.\u003c/p\u003e\n\u003cp\u003eNow that you have your initial test configuration finished, you have to\ndefine a base test class that does the transaction management in setUp\nand teardown.\u003c/p\u003e\n\u003cp\u003eFirst, lets setup the Base testing class what will manage our\ntransactions:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e unittest\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e pyramid \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e testing\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e paste.deploy.loadwsgi \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e appconfig\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e webtest \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e TestApp\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e mock \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Mock\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sqlalchemy \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e engine_from_config\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sqlalchemy.orm \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sessionmaker\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e app.db \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Session\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e app.db \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Entity  \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# base declarative object\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e app \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e main\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003ehere \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os.path.dirname(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e__file__\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003esettings \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e appconfig(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'config:'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e+\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e os.path.join(here, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'../../'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'test.ini'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e))\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eBaseTestCase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eunittest\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTestCase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003e@\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eclassmethod\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetUpClass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(cls):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003ecls\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.engine \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e engine_from_config(settings, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eprefix\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sqlalchemy.'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003ecls\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.Session \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e sessionmaker()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetUp\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        connection \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.engine.connect()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# begin a non-ORM transaction\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.trans \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e connection.begin()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# bind an individual Session to the connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        Session.configure(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ebind\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003econnection)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.Session(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ebind\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003econnection)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        Entity.session \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etearDown\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# rollback - everything that happened with the\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# Session above (including calls to commit())\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #768390\"\u003e# is rolled back.\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        testing.tearDown()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.trans.rollback()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session.close()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis base test case will wrap all your sessions in an external\ntransaction so that you still have the ability to call flush/commit/etc\nand it will still be able to rollback any data changes you make.\u003c/p\u003e\n\u003ch1\u003eUnit Tests\u003c/h1\u003e\n\u003cp\u003eNow there are a few different types of tests you will want to run.\nFirst, you will want to do unit tests, which are small tests that only\ntest 1 thing at a time. This means you will skip the routes, templates,\netc. So let's setup our Unit Test Base class:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eUnitTestBase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eBaseTestCase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetUp\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e testing.setUp(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003erequest\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003etesting.DummyRequest())\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003esuper\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(UnitTestBase, \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e).setUp()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003eget_csrf_request\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self, post\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eNone\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        csrf \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'abc'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003enot\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'csrf_token'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003ein\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e post.keys():\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            post.update({\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'csrf_token'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: csrf\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            })\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        request \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e testing.DummyRequest(post)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        request.session \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Mock()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        csrf_token \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e Mock()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        csrf_token.return_value \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e csrf\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        request.session.get_csrf_token \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e csrf_token\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e request\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe built in a utility function to help us test requests that require a\ncsrf token as well. Here is how we would use this class:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eTestViews\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eUnitTestBase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_login_fails_empty\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\"\" Make sure we can't login with empty credentials\"\"\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e app.accounts.views \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e LoginView\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config.add_route(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'index'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config.add_route(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'dashboard'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        request \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e testing.DummyRequest(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003epost\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'submit'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        })\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        view \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e LoginView(request)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        response \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e view.post()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        errors \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e response[\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'errors'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e0\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].node.name \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'csrf_token'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e0\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].msg \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Required'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e1\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].node.name \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Username'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e1\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].msg \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Required'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e2\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].node.name \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Password'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e errors[\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e2\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].msg \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Required'\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_login_succeeds\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\"\" Make sure we can login \"\"\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        admin \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e User(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eusername\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sontek'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003epassword\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'temp'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ekind\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'admin'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        admin.activated \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session.add(admin)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session.flush()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e app.accounts.views \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e LoginView\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config.add_route(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'index'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config.add_route(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'dashboard'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/dashboard'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        request \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.get_csrf_request(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003epost\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'submit'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Username'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sontek'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Password'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'temp'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            })\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        view \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e LoginView(request)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        response \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e view.post()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e response.status_int \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e302\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eIntegration Tests\u003c/h1\u003e\n\u003cp\u003eThe second type of test you will want to write is an integration test.\nThis will integrate with the whole web framework and actually hit the\ndefine routes, render the templates, and actually test the full stack of\nyour application.\u003c/p\u003e\n\u003cp\u003eLuckily this is pretty easy to do with Pyramid using WebTest:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eIntegrationTestBase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eBaseTestCase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003e@\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eclassmethod\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetUpClass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(cls):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003ecls\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e main({}, \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e**\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003esettings)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003esuper\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(IntegrationTestBase, \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003ecls\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e).setUpClass()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003esetUp\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e TestApp(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.config \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e testing.setUp()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003esuper\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(IntegrationTestBase, \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e).setUp()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIn setUpClass, we run the main function of the applications\n__init__.py that sets up the WSGI application and then we wrap it in\na TestApp that gives us the ability to call get/post on it.\u003c/p\u003e\n\u003cp\u003eHere is an example of it in use:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre class=\"github-dark-dimmed\" style=\"background-color: #22272e\" tabindex=\"0\" data-language=\"python\" data-theme=\"default\"\u003e\u003ccode data-language=\"python\" data-theme=\"default\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #F47067\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eTestViews\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eIntegrationTestBase\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_get_login\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\"\" Call the login view, make sure routes are working \"\"\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        res \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app.get(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/login'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.assertEqual(res.status_int, \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e200\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_empty_login\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\"\" Empty login fails \"\"\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        res \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app.post(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/login'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, {\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'submit'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e})\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"There was a problem with your submission\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003ein\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e res.body\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"Required\"\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003ein\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e res.body\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e res.status_int \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e200\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003edef\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCBDFB\"\u003etest_valid_login\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e(self):\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e\"\"\" Call the login view, make sure routes are working \"\"\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        admin \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e User(\u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003eusername\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sontek'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003epassword\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'temp'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #F69D50\"\u003ekind\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eu\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'admin'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        admin.activated \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session.add(admin)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.session.flush()\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        res \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app.get(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/login'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        csrf \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e res.form.fields[\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'csrf_token'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e][\u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e0\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e].value\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        res \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eself\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e.app.post(\u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'/login'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'submit'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003eTrue\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Username'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'sontek'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'Password'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'temp'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e                \u003c/span\u003e\u003cspan style=\"color: #96D0FF\"\u003e'csrf_token'\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e: csrf\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        )\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color: #ADBAC7\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003eassert\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e res.status_int \u003c/span\u003e\u003cspan style=\"color: #F47067\"\u003e==\u003c/span\u003e\u003cspan style=\"color: #ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6CB6FF\"\u003e302\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eProblems with this approach\u003c/h1\u003e\n\u003cp\u003eIf a test causes an error that will prevent the transaction from rolling\nback, such as closing the engine, then this approach will leave your\ndatabase in a state that might cause other tests to fail.\u003c/p\u003e\n\u003cp\u003eIf this happens tracing the root cause could be difficult but you should\nbe able to just look at the first failed test unless you are running the\ntests in parallel.\u003c/p\u003e\n\u003cp\u003eIf you are good about writing and running your tests regularly you\nshould be able to catch individual tests causing issues like this fairly\nquickly.\u003c/p\u003e\n\u003ch1\u003eResources\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html\"\u003ehttp://docs.pylonsproject.org/projects/pyramid/en/latest/narr/testing.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction\"\u003ehttp://www.sqlalchemy.org/docs/orm/session.html#joining-a-session-into-an-external-transaction\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eJohn Anderson \u0026#x3C;\u003ca href=\"mailto:sontek@gmail.com\"\u003esontek@gmail.com\u003c/a\u003e\u003e 2011\u003c/p\u003e","category":"Python","date":"2011-11-30T20:00:00-04:00","tags":["Python"],"title":"Writing tests for Pyramid and SQLAlchemy"}},"__N_SSG":true},"page":"/blog/[...id]","query":{"id":["old","writing_tests_for_pyramid_and_sqlalchemy"]},"buildId":"Q4Ztqby-K8_DMGM3CPruu","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>